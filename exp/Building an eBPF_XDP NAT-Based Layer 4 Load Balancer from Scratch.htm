<!DOCTYPE html>
<html lang="en" data-theme="cmyk"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Building an eBPF/XDP NAT-Based Layer 4 Load Balancer from Scratch</title><link nonce="" rel="stylesheet" href="Building%20an%20eBPF_XDP%20NAT-Based%20Layer%204%20Load%20Balancer%20from%20Scratch_files/inter.css"><link nonce="" rel="stylesheet" href="Building%20an%20eBPF_XDP%20NAT-Based%20Layer%204%20Load%20Balancer%20from%20Scratch_files/Source_Code_Pro.css"><link nonce="" integrity="sha384-W0UkFG5ktUlCLBh/tZDw+slzbqWhSr7IE92M0sRiua5PJAa1/rQ1oZeywI2xmhma" rel="stylesheet" href="Building%20an%20eBPF_XDP%20NAT-Based%20Layer%204%20Load%20Balancer%20from%20Scratch_files/css-tokens-theme.css"><style nonce="">.layout-enter-active,.layout-leave-active{transition:all .2s}.layout-enter-from,.layout-leave-to{filter:grayscale(1)}.page-enter-active,.page-leave-active{transition:all .2s}.page-enter-from,.page-leave-to{filter:blur(1rem);opacity:0}</style><style nonce="">.tutorial-header[data-v-0d30d5a9]{display:block;font-family:var(--typography-font-display);font-size:40px;font-weight:var(--prose-h1-fontWeight);letter-spacing:var(--prose-h1-letterSpacing);line-height:var(--prose-h1-lineHeight);margin:var(--prose-h1-margin);margin-bottom:20px;margin-top:20px}</style><style nonce="">#site-header[data-v-7f8ed6a6]{transition:border .25s ease}</style><style nonce="">a[data-v-c294bba9]{font-family:var(--typography-font-sans);font-weight:400}</style><style nonce="">[data-v-6adfc778]{font-family:var(--typography-font-body);font-size:.85rem;line-height:var(--prose-p-lineHeight)}</style><style nonce="">.fade-out[data-v-200caef3]{position:relative}.fade-out[data-v-200caef3]:after{background:linear-gradient(180deg,#fff0 0,#fff);bottom:0;content:"";height:200px;left:0;position:absolute;width:100%}.unit-title[data-v-200caef3]{font-family:var(--typography-font-display);font-size:1.25rem;font-weight:var(--prose-h3-fontWeight);letter-spacing:var(--prose-h3-letterSpacing);line-height:var(--prose-h3-lineHeight);margin-bottom:16px;margin-top:16px}@media(min-width:768px){.unit-title[data-v-200caef3]{font-size:var(--prose-h3-fontSize)}}.expand-all .unit-title[data-v-200caef3]{border-bottom:1px solid #eee;margin-bottom:4px;padding-bottom:.3em}.prose-h1[data-v-200caef3]{margin-top:24px}</style><style nonce="">p[data-v-b025fb9f]{font-family:var(--typography-font-body);font-size:var(--prose-p-fontSize);line-height:var(--prose-p-lineHeight);margin:var(--prose-p-margin)}p[data-v-b025fb9f] br{content:"";display:block;margin:var(--prose-p-br-margin)}</style><style nonce="">a[data-v-abeb6555]{color:#4078c0;font-family:var(--typography-font-body);font-weight:400;text-decoration:none}a[data-v-abeb6555]:hover{text-decoration:underline}a[data-v-abeb6555]:has(img){border-width:0}</style><style nonce="">strong[data-v-24022f14]{font-family:var(--typography-font-body);font-weight:var(--prose-strong-fontWeight)}</style><style nonce="">h2[data-v-b9b1576a]{border-bottom:1px solid #eee;display:block;font-family:var(--typography-font-display);font-size:var(--prose-h2-fontSize);font-weight:var(--prose-h2-fontWeight);letter-spacing:var(--prose-h2-letterSpacing);line-height:var(--prose-h2-lineHeight);margin:var(--prose-h2-margin);padding-bottom:.3em}h2[data-v-b9b1576a] .icon{display:inline-block;height:var(--prose-h2-iconSize);margin-inline-start:12px;opacity:0;transition:opacity .1s;width:var(--prose-h2-iconSize)}h2 a[data-v-b9b1576a]:hover .icon{opacity:1}</style><style nonce="">ul[data-v-533e29f3]{font-family:var(--typography-font-body);list-style-type:var(--prose-ul-listStyleType);margin:var(--prose-ul-margin);padding-inline-start:var(--prose-ul-paddingInlineStart)}ul[data-v-533e29f3]>li::marker{color:var(--prose-ul-li-markerColor)}ul[data-v-533e29f3]>li ol,ul[data-v-533e29f3]>li ul{margin:0}</style><style nonce="">li[data-v-2969431c]{font-family:var(--typography-font-body);list-style-position:var(--prose-li-listStylePosition);margin:var(--prose-li-margin)}</style><style nonce="">pre code .line{display:block;min-height:1rem}</style><style nonce="">.prose-code[data-v-4578ab24]{-webkit-backdrop-filter:var(--prose-code-block-backdropFilter);backdrop-filter:var(--prose-code-block-backdropFilter);background-color:var(--prose-code-block-backgroundColor);border-color:var(--prose-code-block-borderColor);border-radius:var(--prose-code-block-borderRadius);border-style:var(--prose-code-block-borderStyle);border-width:var(--prose-code-block-borderWidth);color:var(--prose-code-block-color);font-size:var(--prose-code-block-fontSize);margin:var(--prose-code-block-margin);overflow:hidden;position:relative;width:100%}.prose-code[data-v-4578ab24] code{flex-grow:1}.copy-button[data-v-4578ab24]{background-color:#3c3c3c99;bottom:0;color:#e6e6e6cc;inset-inline-end:0;opacity:0;position:absolute}.prose-code:hover .copy-button[data-v-4578ab24]{opacity:1}.prose-code:hover .copy-button[data-v-4578ab24]:hover{color:#e6e6e6}.copy-button[data-v-4578ab24]:focus{box-shadow:none!important}[data-v-4578ab24] code{display:flex;flex-direction:column}[data-v-4578ab24] .line{display:inline-table;min-height:1.5rem}.filename[data-v-4578ab24]{-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px);border-radius:var(--typography-radii-lg);color:#e6e6e6;font-family:var(--typography-font-code);font-size:var(--typography-fontSize-xs);inset-inline-end:0;line-height:var(--typography-lead-normal);padding:.5rem .75rem;position:absolute;top:0;transition:opacity .2s}.prose-code:hover .filename[data-v-4578ab24]:hover{opacity:1}[data-v-4578ab24] pre{display:flex;flex:1;line-height:var(--typography-lead-relaxed);margin:0;overflow-x:auto;padding:var(--prose-code-block-pre-padding)}[data-v-4578ab24] .line.highlight{background-color:#000;margin:0 -16px;padding:0 16px}[data-v-4578ab24] .line:not(.highlight)+.line.highlight{border-top:1px solid #444}[data-v-4578ab24] .line.highlight+.line:not(.highlight){border-top:1px solid #444;margin:0 -16px;padding:0 16px}[data-v-4578ab24] .line.highlight:first-child{border-top:1px solid #444}[data-v-4578ab24] .line.highlight:last-child{border-bottom:1px solid #444}</style><style nonce="">button[data-v-134dddac]{border-radius:3px;margin:4px;opacity:0;padding:4px;transform:scale(.75);transition:all .2s}button[data-v-134dddac]:focus{box-shadow:0 0 0 2px var(--typography-color-primary-500);opacity:1;outline:none}button.show[data-v-134dddac]{opacity:1;transform:scale(1)}button .icon-wrapper[data-v-134dddac]{display:block;height:18px;position:relative;width:18px}button .icon-wrapper .icon[data-v-134dddac]{display:block;position:absolute}button .icon-wrapper .fade-enter-active[data-v-134dddac],button .icon-wrapper .fade-leave-active[data-v-134dddac]{transition:opacity .2s}button .icon-wrapper .fade-enter-from[data-v-134dddac],button .icon-wrapper .fade-leave-to[data-v-134dddac]{opacity:0}</style><style nonce="">details>summary[data-v-370f298d]{font-size:var(--prose-p-fontSize)}</style><style nonce="">code[data-v-a031129a]{border-radius:var(--prose-code-inline-borderRadius);font-family:var(--typography-font-code);padding:var(--prose-code-inline-padding);mx:1px;background-color:var(--prose-code-inline-backgroundColor);color:var(--prose-code-inline-color);font-size:var(--prose-code-inline-fontSize);font-weight:var(--prose-code-inline-fontWeight)}tbody code[data-v-a031129a]{font-size:var(--prose-tbody-code-inline-fontSize)}h1 a code[data-v-a031129a],h2 a code[data-v-a031129a],h3 a code[data-v-a031129a],h4 a code[data-v-a031129a],h5 a code[data-v-a031129a],h6 a code[data-v-a031129a]{border-radius:var(--prose-code-inline-borderRadius);color:var(--prose-code-inline-color);font-size:.777777em;padding:.15em .5em}a code[data-v-a031129a]{border-color:var(--prose-a-code-border-color-static);border-style:var(--prose-a-code-border-style);border-width:var(--prose-a-code-border-width);color:var(--prose-a-code-color-static)}a:hover code[data-v-a031129a]{background-color:var(--prose-a-code-background-hover);border-color:var(--prose-a-code-border-color-hover);color:var(--prose-a-code-color-hover)}</style><style nonce="">blockquote[data-v-5c66202a]{border-inline-start-color:var(--prose-blockquote-border-color);border-inline-start-style:var(--prose-blockquote-border-style);border-inline-start-width:var(--prose-blockquote-border-width);color:var(--prose-blockquote-color);font-family:var(--typography-font-body);margin:var(--prose-blockquote-margin);padding-inline-start:var(--prose-blockquote-paddingInlineStart);quotes:none}</style><style nonce="">hr[data-v-34b8dd49]{border-top:var(--prose-hr-width) var(--prose-hr-style) var(--prose-hr-color);margin:var(--prose-hr-margin)}</style><link nonce="" integrity="sha384-VgdaralgzMMDKoxbvggz88cSHbXjvjsd7NI4i46uVtHp/jjxBeJak6GsR2cO7GHi" rel="stylesheet" href="Building%20an%20eBPF_XDP%20NAT-Based%20Layer%204%20Load%20Balancer%20from%20Scratch_files/entry.DO90-MQw.css" crossorigin=""><link nonce="" integrity="sha384-K18nopic+X0JunSv2KJqsE7W6KB015nwBWeFR+Jh5SQtvXW7Yy4WjDfxnYjG/Q6g" rel="modulepreload" as="script" crossorigin="" href="Building%20an%20eBPF_XDP%20NAT-Based%20Layer%204%20Load%20Balancer%20from%20Scratch_files/A538-Xd4.js"><link nonce="" integrity="sha384-Wc22hz0UYZLeSexsNb8aBw3zxHJlH2ESymLXu3JHi6m3sR49j4dleLGt1BVOkDjD" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CiaVwNEs.js"><link nonce="" integrity="sha384-wV/FyIfkoKuneA9gx32UbcC1rWydYJhlr+cMCHu0oN57ZtVcBz8nUCI/A5rPOyHo" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/DlAUqK2U.js"><link nonce="" integrity="sha384-JBRondsjCje9uCAk+glC4LA43omHrNK2Afdoafa36EDjES+Za12EFI00uupOcyt9" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/BGeBmTCG.js"><link nonce="" integrity="sha384-iOrs0N2+i+e0F5pOd4kyCQpmnc35XQjz3RZS60HpeqOwIhinqlaiSmxKCbvBJsW1" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CMnvrPLD.js"><link nonce="" integrity="sha384-CEUXna7zyFjV1aUCqrEskDTDcYt8x65beb5ECylmP2u4a3XjjuBUt/selECdFNZK" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/B1saq5Fe.js"><link nonce="" integrity="sha384-syA1913w37X8NLuSOALbgW9QS2EPUV6mM/Ff8nCauX6ZiD/sHqOLDthOqDMKckCB" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/D1KxtS4O.js"><link nonce="" integrity="sha384-M0JTRKVfKGOUYhocKYuV/WMSR+qOluNgGUQsIG3GYlIiO+jnxgHfMO2WJmrUEqcK" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/Cd08WlCA.js"><link nonce="" integrity="sha384-2W8FPc/1+bG0TweePWS4uRwvvuxGyDDRF59Oq4c+38RHPjntjyyWlD7v1Sa6zpkX" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/DTtjwkpk.js"><link nonce="" integrity="sha384-L1CRgqloambsm3q9dC2rb+ifjcv/8Hpqm7EHEDie0lhu2KclJZ/sSVOkeDGM9zDX" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/C82fcFPv.js"><link nonce="" integrity="sha384-0hD5FZjIYmNI9RitylIyG4efbmRl6kOaKiNnJAhMuCYGphbCEU2T/NgpXk32OXh5" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/4AR0jMDd.js"><link nonce="" integrity="sha384-DPKYF61GYn/kB6dn/ABdKqapefAnD2W9nBAk2ofHesgnyMnqMJkO7Too4t+mNYYP" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/B0C1x6gY.js"><link nonce="" integrity="sha384-YgqV0R4URFlIK0f7PeExV/RhB0jCgDJ9GeV41VNl6GAEEwy6vHA/PoQ3VSH8s56f" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/DwrbW19N.js"><link nonce="" integrity="sha384-0BznfphaLvyEnFT1usV091akUax6dLFoMcZMmzjansRVn5BItWKgsDDCoo8iT/TY" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CwAYGw04.js"><link nonce="" integrity="sha384-b3SarygGZMZbGN79KG/bEqtJ2xVRemDnvZgqDewtIpgFuNBh75kpOVhZZYbBBlV/" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/B6Ia1wBT.js"><link nonce="" integrity="sha384-WRh3x9Ejk0elAhcgJQ8ETP2IGNgvqNr91aJXHrH9yZxCCLgchCR41NgV3E7vAodd" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/ChZSQl3-.js"><link nonce="" integrity="sha384-F2pzDKtK6Wor8cY0Y3zbRz+fFovMZFLX8BsggEVAPXGz2+Ycy1I3P2cDE2KS/wOh" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/dzq8fjun.js"><link nonce="" integrity="sha384-I2aMPU2PaXlVS4e/fOmYY9zmZzsm1trtgIbztBZU0wObDOs1VIroOVWNsDhl6wHN" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/M8Go6PQG.js"><link nonce="" integrity="sha384-uodls5TYxZ8s/FGmTB1Xi3Eu1LUqit11VZ0fVdqtz16nO/2EG8G6ftEpI1QClK52" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/A7blpOo1.js"><link nonce="" integrity="sha384-wZXyrgfemDfNvKK67noacMWWCC0zKLBCwby1agqLAZk1PYstO1pYXd5LJ1vuq0JB" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/BsfvSMgi.js"><link nonce="" integrity="sha384-Vs+CUGTU4JWQD2L1q1QN40N3Zvq9rYcfTbmA5eOdrmD/VMyI1iDmCHzMLPSdnCqv" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/BWcS6GWa.js"><link nonce="" integrity="sha384-VVomnY5chwSXkMawT1OSXWNPPAe86IfpyIKeWX688WzzJ7lq/B0rADiyVnYOh6HM" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/JEhZ6VKh.js"><link nonce="" integrity="sha384-AbnqAjVFi3AmpARRzjM6+16Kv+rETq5s6nmZjsBv+hcl6SxoewxvHT+bGBjAhXeK" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/Ci8QyKoZ.js"><link nonce="" integrity="sha384-td3wGu7krmhEJ5seMu1AU/xkFk7vUdQ3suaalpFhM4fwTaVN1h/H9rGaxFj5hmG8" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/Btqf3kJo.js"><link nonce="" integrity="sha384-yQp3ZlUZQ0DO+FYouwTSmaxweszONpQqBRmj0jPaUrGPs6qVDenMPabcBy7ZVLmy" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/Bxj5g83y.js"><link nonce="" integrity="sha384-n1bd298ysXlcokRTgpfLCRSQT0AXTmnPEQXg4ZJzQHwX1PKezwdaLv1OJ/b4mzD0" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CvPDKjD7.js"><link nonce="" integrity="sha384-ZTF2eLLsj0u4hMXoY82NP13biwgJDAwMzR2d+xBY6rQLO4f3t7LajO3uzq/vZqRX" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/BcqSyfqL.js"><link nonce="" integrity="sha384-R5RBPCrYygxUzDyczdS9hiczqgYiS67n5heUG2T1GpfHtDEsmXSBLEmEO/BQzJaN" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/kvsfWoeJ.js"><link nonce="" integrity="sha384-tb1vqM45YGGFhc7XMYx4bDtjYSaXzAs9cnrgfmG8GKlE7RhDH4qAyu26XzuJ2YIC" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CzEdsMlG.js"><link nonce="" integrity="sha384-sUqEz/7mCozcDTVa3220YpCuurG9+lxtT39mpvAKoTCj9QExlOBwmCIFpsInI+s1" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/-3BZtTVG.js"><link nonce="" integrity="sha384-tnmwzNkA0rvNInwTi3QoUuQf2RJ/bW02kX94g7tDAOWaYuCg85E9BWXXixucWjqZ" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/BupvEF6F.js"><link nonce="" integrity="sha384-cv5eYt8EdzDHogT9noRhAtFPV9+Lrtkd/pkrKyTuN5tJroumDowpyUzCzhwVtaiC" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CxmcBoAF.js"><link nonce="" integrity="sha384-Y8UFu09ps1XTln8sVqrgbr/U3lz2Dhm/dACnR9sMrlzgij55P2HmnGCWzPoBSYyu" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/BSSuG8K0.js"><link nonce="" integrity="sha384-z9/ospmVZd5cw4nwu5/8Qp5hJ8LT0YLR5aprKBlth8ZdKwPYddtBV4lpwoGmUwfN" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CCu705Yd.js"><link nonce="" integrity="sha384-ZSbWNj1OjFWl7HowKKC8kafoBc1s/7LHOfE9M7ljrgu/wf1sJhfQbLAYyRCzhZdY" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/C_Jn_tlQ.js"><link nonce="" integrity="sha384-agWmXONfzBbTvKJgUzocvOAVtRahUQJ22dVI+EIlQcdvlhE/n+dJRuMKYyjQZNAJ" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/DVSoXPMN.js"><link nonce="" integrity="sha384-mgFzSSjDqczZLwcbehdgDcFRYeUW6C3GqxjgZTu/SLT01MGi+dpHHVI922F+X7C3" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CCTXTz88.js"><link nonce="" integrity="sha384-M74HEk3mc8nvuopWlZzTsK144Edv+f2lEjDaYoh2m4d7U7/KfZbi4AusDL0KhPHH" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CjdH43sM.js"><link nonce="" integrity="sha384-1gFXWiA9BubdJu/94hOlNp2XvvHoVIz4IGNQv59ibBQfiufGbZxQNBNhF8TAG/RV" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CDvDm27B.js"><link nonce="" integrity="sha384-jJcANp9lIArTZ9yN4OBsQ++lCuSSt2pGu3Scy2GlEgU3+8NcDeS7dyssrIUitInI" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/7kwUfJ3d.js"><link nonce="" integrity="sha384-EbtRkNeZD9um6+KMX5jCfluq+qSLTrv0RoysLc7gM+g4HZFMODnEaMGiOldAKh8/" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/Bnu8tQBb.js"><link nonce="" integrity="sha384-UO8ijEdqHf7NyXBUpuq/GC4PXT75sLLrNgF2uqVsvASmGCRpiewQ2SHk9ea1IUqb" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CDzRe_IS.js"><link nonce="" integrity="sha384-cKyEWFmQQXO6kDxrNQo20qgZ4VMzQi2uSYiRl05tv1cNyQqU0PJtKu5fqUe4Ki1o" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/BzCtePKg.js"><link nonce="" integrity="sha384-COlwUySgtGE6J2TePCYfL/nRrHywmQ1Jwo60ID/objGu8uiCIxttVy2yMr+jbpxj" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/Db0ou0G2.js"><link nonce="" integrity="sha384-Rzk+8Cz0gBXmLuLBTSGp80a8fquQIqhPvRlo1IiJeo7hkgncIWi34YKwBlxVgsHt" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/BARAL6rY.js"><link nonce="" integrity="sha384-/ZmdKieFBiaYx+w0UksW/OG8Hb72bs89W/nKPICK6PZl+kuDHDmuEvI4mRNPXLSv" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CM8tEzsp.js"><link nonce="" integrity="sha384-giGL5jqk/0PqHOOqxQuvp4G+iXuMqkfE+1Zlf/2kKJV7sYQ+BxSclVpba3tX/wh+" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CZ8UCyxH.js"><link nonce="" integrity="sha384-Jh+iKjfe7e7mgPtH9IYjVPHoUbiLzg8mm+xLGL/iff4u64ibokFnUpv/+RGj9dCO" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/D8ksmjjz.js"><link nonce="" integrity="sha384-PvErhVuPH41hvqTZ49vsoFCpIC/z4slDP48GmOyo1IxCgXgMmhZYcqWmXvxmDdE1" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/BnA2AwGF.js"><link nonce="" integrity="sha384-ML7907U1uYAjBfEawIa16NlkvQLFs4sBc0O+ZsHqG36bs2G6qYgIBKOtB3fbDcm3" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/mB6xp2LS.js"><link nonce="" integrity="sha384-obBf3ueJAL8aoDGeHfEgrAtpJ3qVSgFbWLFfi8i9I1zn7Fh9bL6xCWKRkSAsBPpf" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/DOnqS9Sz.js"><link nonce="" integrity="sha384-ozfcbqESKh4t4toPRMlI7E/LSfwducV89LLckOM/iIRj/4KZI3Wvkzv1IIlXs4/c" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/BUutWmwC.js"><link nonce="" integrity="sha384-WlWOhcPtQ/Kad84KA6wzn0gQeGRjnbnHA6YbAmrjb3x1h3Z2xgzDQn6hhPZNCoTd" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CYc7oDxg.js"><link nonce="" integrity="sha384-mrDm7dap5ABkEwphhcEecvmbqNbeRsvBYymtq9QRTG7VpTjjYlz8cKc81RROUeFA" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/iModbmJm.js"><link nonce="" integrity="sha384-p4j3LmYqWA9vFZi8KI2yZhEabBARpNL/Oi3nVD0aXbx96P85FplA/9FgQDD2BLdP" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/BttOikXX.js"><link nonce="" integrity="sha384-l/XpZEHaHpHdyvYueKCjFu/1G9Azm0MCiXUSR+fyOtckk4NeLZF8k6zYCoBVDUUg" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CAUFPZS4.js"><link nonce="" integrity="sha384-Av0300jLea50veBs6pE41xEXCjESbAfDNYm2yxz8d97vI9SoWmI0Hcp+uma/jcX+" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/D4i9E6T8.js"><link nonce="" integrity="sha384-Kt/+bu7AOzFl0uwSyv3X04YhXDK4jzHtjffPy2aGEnk/FoJB9cOsHGnPwPSskKMh" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/Bv083VCc.js"><link nonce="" integrity="sha384-r/TOwaK7QKJSt/5vwLwCOITevVrg2DX1lGIdwdfBFVrN7yuzTWlORu7/uf2dJC9y" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/B57yXAr8.js"><link nonce="" integrity="sha384-0N5RM4kElInS4Fp1qFMxOc4OF69GD5JOJhCTDN1uFON4zETYzLPQhMF0kskTRzMM" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/Bg33dJBS.js"><link nonce="" integrity="sha384-u3VmYVbrqSkrQNLkzFveD/vvLINNY0yl3cddefGwPydaEYiUQCs1uV/KRVUjPTa8" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/DQwRZosE.js"><link nonce="" integrity="sha384-fH3nLz2uDngAE48/eCpdZrqWvpG0xiHSwlUR8aF2ihSqvqmN4OmDS/TVNCNTWnqR" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CArlX-cu.js"><link nonce="" integrity="sha384-u74iMlKyC0kRP5BMHYNGkp5S9orN2/gCeJgj5aZX1XDbtHuAdZFrU8qFOFz/eNLm" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/DZyGvdVe.js"><link nonce="" integrity="sha384-GS5VYkWxfL4u4MdDC6Qo0DGKGF+lrWyOqK9ZJe2lisyIa7Svve0Ttt78PZZTwqY3" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/BDKlkuys.js"><link nonce="" integrity="sha384-y80+/9hrjJwiVyHBE8AWXREf/wof34st0opT/h4kvDrEb2laljm3R8wJKQseme/J" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/1LkmMtl7.js"><link nonce="" integrity="sha384-9c95hdmG6ReSHzePMhSkOHTJSopHenH0otWJ8vMBjpF9X3CPHtYIcbCAQTX8PdOl" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/xOp4NLFu.js"><link nonce="" integrity="sha384-gMSBshNkqG1tBeB+L2gKaoY4oMW4+hYd4oWv9iLWHw9xBx0xV1OUHKMirXddsFRw" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/BioJOeeE.js"><link nonce="" integrity="sha384-MwA0Sdu4AakDulpLReqjqw1RIa5qrB2TUqLJo+Db5G6CvTRTTDx4a8tEaOdSVNLx" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/BHPsZYYG.js"><link nonce="" integrity="sha384-0L2Td2nqsSLt4fMliUjq+dvceWfLxnsNNeggJgFL+z1RP6q2lY3dIpBRDM2ObZAH" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CQUe4kzL.js"><link nonce="" integrity="sha384-53XwglVJLtGDmmynrYM9rgyETBLrmhyLZ7rrMhSo2SBjK3WgMof9cVczfk/F/Jzl" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/BXoysCvc.js"><link nonce="" integrity="sha384-gzXIriZQL0YJn1tbOutH7KABTCI37AxDXpfsDegtUpa5c156iQBTuhrfNROu5Thk" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/bVVUK1Up.js"><link nonce="" integrity="sha384-NbmkXIRw/iEsysuJXcicjZ+p6w1q/BKa/sqxFk9dzfKtkUVNHl2dlWdzjczq3hQJ" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/ChpWfMYt.js"><link nonce="" integrity="sha384-MiEIX+8nvVcF4/C2AnakM/xZVOSZUwgp9sX3M0dp9xuVHHHrJlv91nJQRgHk0Quv" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/csMlMc7I.js"><link nonce="" integrity="sha384-svAxaky+wOkSm0FK3/zqjV14+w8HlkJNStl5PbW1q/6YLYNXa3TVQlNdyRs25Pg0" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/C7GKAtGK.js"><link nonce="" integrity="sha384-jWKAGfP+O3ErHtWOlwouqobnwxC2DN29v588eTZITOrTc2R01ngtrouBsqVdbCT7" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/BL7qTDAr.js"><link nonce="" integrity="sha384-4pI+RYdvJhid05b/siB7KHnNxZlPTOdPojDRfnbIxjZho/sWNJcNQ1SNb5Qjo3I9" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CK0M71lT.js"><link nonce="" integrity="sha384-0+pxV72C5SbjyQwCXwgd4DF8SkZtG84RqBISsq7+Ml6e6P5t2g9o94DWGpB0Oy0b" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/c4uxQ8Wc.js"><link nonce="" integrity="sha384-1oAGdh3Ob3DhjeaIvvoAMwPn11xKR5BGJKypl8udvI7FxRd5094e7LiGBU+AXQNc" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/DAsZ60qF.js"><link nonce="" integrity="sha384-B9ZNtOQnOJzP0adjSA7vD9KFGE8wq8Az8dT/U/qpIgJb/YyEYs6uz2CgKvr2PUoX" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/DUAqYmp4.js"><link nonce="" integrity="sha384-pe7HW9XccXxhUCVvMVOXq3zlfWNDJ8M1xHyOt/JxJgJmlR0CXQ6TyVUa8J0WQabY" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/DQyuHP0A.js"><link nonce="" integrity="sha384-4wAUkozzIJ0JmwD1ZWcwBO3VV7yJaa/KFi+K84/CamYjheklx4BVD8U8q8BtGJRe" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/D6_gAmFJ.js"><link nonce="" integrity="sha384-j+AUYc7gZxlxcek5ud0DEYE8my+mwN+Q+N4Dz4yL+oXAeag33srrntaaKZzvhKnQ" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/BSBUAEYG.js"><link nonce="" integrity="sha384-FTHPQttPFF935jU0Dnu/R56VxY4WBQgpU2LGNNDf92i3nank9Q5S7x0bLH1PaLft" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/lTI5I4yu.js"><link nonce="" integrity="sha384-16L8vZm+5D4i9uhUuw6JV1TqCb9BMniQikxfKnswEUlRtfwDol+s4uqDhaZXwny2" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/91A8zhHS.js"><link nonce="" integrity="sha384-f+e1FVNE/T2lDce76NJMfxcdawJLbJnxqwGE8hcbh294/PD2/w5Ic3KQhSaNEleM" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/BkeRmi07.js"><link nonce="" integrity="sha384-Q2DxEGTJ8Qr8IWjOnEEarTzTz8gde4A/QHCSgTH3rWp5dsGATv7Scyjkhy7ULO3K" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/UbdPEwEM.js"><link nonce="" integrity="sha384-qfRcPAxqaf0zA/FjgoER7vbIrE7mKhDttRFftIiUGQpYjDdPRSBKwCgFcrcAzDni" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/DuAV58dt.js"><link nonce="" integrity="sha384-kQvyEBtLdEc9VGMkIeoQTjia1w52BsUjOJOYQhO4IcjAiViZDvVuQppZBRTqH6so" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/BtTtLD25.js"><link nonce="" integrity="sha384-I039ANJGHhr2CaXH4icET/UUPslTqPGKPSOSoyofSjqe6+kwX8LAdMPMrVjkYrPH" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CUCNVA8S.js"><link nonce="" integrity="sha384-N1WfKiEg3SzR9CdokLFytZKVFw0H9QQCVqRyJABaCEAs5CF4oufjdkW9IgG+YoCf" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CvNiyATc.js"><link nonce="" integrity="sha384-Nmn6sUp07EnvYHCFN+bm3FSRVXMCEptrev8HKT04oml9cqtToSvJbrZa587R6Jwb" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/B5MQNTTm.js"><link nonce="" integrity="sha384-lKen8cvcDypP/BHrDug0k6q7J8SZJeaXgkUHjMjsguHHEFpwkiGYT1OhbXnethxH" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/4GYs45G9.js"><link nonce="" integrity="sha384-Ag2b5l4eEdsPCf7PE351pdvuMKZoAl2xcMge7HTtClEW6Y/izToOCEUSitNE2G0O" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/3oipLbd9.js"><link nonce="" integrity="sha384-gKkSnsBfMx5E3ar0WuTrpQkwVTJ/xlB3mCvlZvaxovj/RFWY82iBUBMnBhmMYWdk" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/m68L2hpN.js"><link nonce="" integrity="sha384-rkv14JDYlXj9BOiAfZaprkgZxm/Svqudu1oS7XH2J9epB768Yl/3zi4ob/iKWKym" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/C5V8Z8ce.js"><link nonce="" integrity="sha384-C+9gFHof4xuWApmZD1yxSrq3zSFoAfCSJ7GdAqhtTlnwokHdyo/RUdleazn2uUBU" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/ctsQ0uQd.js"><link nonce="" integrity="sha384-6tGyJ7ePyQ9JREwDJFMygzTwMd3wV8grp9oPlS9f/f1eN55FC53MZQTJ5AfrnQk3" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CukEpSyf.js"><link nonce="" integrity="sha384-73mTlv6HnG9Y/nbl0pGyJZFeOvmZSPbu+1me5Mne55cH/oo55VPSkVNTAdt/S4dn" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/C0Gi0Wkx.js"><link nonce="" integrity="sha384-E/lIGMB3s8lSmW1Wb/y2n/Xeh8yv8M/bycUj4DFXJIUCtLirrzQjYAvrr0cPGR4v" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/Ct22R-2H.js"><link nonce="" integrity="sha384-HyGGNaFK3pSrLQbrCgicHYpnukgAQRnDKB0DsuokPeKmwta157YZJprLDc9ghWyt" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/Cw8bpxEW.js"><link nonce="" integrity="sha384-hbTX8CKF7jYJP0G/fLUHf6Den+wClgVnJM1tYFtts3mz+w8q91kwvb63K+slJYPm" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/BUWl0FAQ.js"><link nonce="" integrity="sha384-ajwUaldUJ12nDzWlFnlolk74utt0j8jJqaMTyAkzRI4MV1e4V2dGQQoabzLyE8Xe" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/D9dB82Sf.js"><link nonce="" integrity="sha384-NBfcaWnmGwIH21ubW2vAcjF5699xmBnT3JrjgLtznuxJo9CV0BleGMglS1rDKfyR" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/X_eaGsVb.js"><link nonce="" integrity="sha384-h5b/dAqAQnOmyK0J7Vl3n449/pgGKSEVcqhv2SdhBz1ubaugKj7Ma97Nqb2DXIEc" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/D4qSbAf1.js"><link nonce="" integrity="sha384-Za9VTnFnNXdDtfx8qy++/h46z9Q8Jws8W3x5v9jOAxh+6EiKNw6DLPuuqZGnPBFl" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/C54he5AG.js"><link nonce="" integrity="sha384-CVqcfYSVKDtGTSEQ43quuif5kNqhnHhBpbUB8cXrZ9XY45Lw7b9Fpm1XjVnQIBXi" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/Dfjlac11.js"><link nonce="" integrity="sha384-lXI1SLhL09RmXzya8PN1uIOpbeLOUMZ6NRszs0Ei2Ntq0QMx1Dtp7vtZwND57Fjb" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/BHRJrsMd.js"><link nonce="" integrity="sha384-p3t8bYj/Hb0MfjRxSxTVT3ovtJYHYJpNPl9pLF9ZR7TsXzJthhqJnBokc3sonzUL" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CLdKaltm.js"><link nonce="" integrity="sha384-WWKOB22oIiKi5I2OAXMQHZvQGDu0ovNny41vF0l4CE7v1XVyrnWC7qJHtcZ/IgSS" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/BQOI21vo.js"><link nonce="" integrity="sha384-68SI/6ff1AXkeHD7fvD6HrZ4dVe0xaR9VHWFPFZD/uWGZ49pd2beFXIJsAMJr5o+" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CqhnfTvz.js"><link nonce="" integrity="sha384-WZ5pik+7iVzN8oC3Y6RQG7ykH7JWlg+LnbNtCJuIgr0SDvTrcNYt94c3oKm89tU8" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/DSbDmzAv.js"><link nonce="" integrity="sha384-6vY3TSy/Jbx4OzC1mO+pTJFKXG5FsZoX5U9pKycyll2vzak4TaVhz3DJEuKwpLRF" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/DdSWIcVP.js"><link nonce="" integrity="sha384-/RmA7E98f7Q+6zOjyOE/ULDtygrXc/5K2AOI63oUjHAthpiOMd+llFdIZM+w25yC" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CMBSaFfM.js"><link nonce="" integrity="sha384-ZBrMqdnfEdCkyyr7sKgzP5miIfpBq3c5XQvM1BXGyTo7SH4zallfB+4uxSClt8bo" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/B7uvIniN.js"><link nonce="" integrity="sha384-UD9yC2AzbDdD5EK1l9Mi59WZoGGYcyprdctRDEEkzv3ZSjNThlQvozKYNZuIsbSd" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/B8VfGPME.js"><link nonce="" integrity="sha384-KdUIrGSVNZI3k3A9OXg9Qiq9DO7CACohQnp26o19gGJlijOSgUwjfEbDqUe9OMEJ" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/DdAcxpHr.js"><link nonce="" integrity="sha384-TR45iesdfuTCrAoS6OxSaJTVi+OQWD0mM/PKB2g7vrV8xHJ47GlcGoY0YduedI38" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/Bp3dZx8A.js"><link nonce="" integrity="sha384-nOA2SAWnorgZE/YX8hKE6WZILbbK3iGh5o5j2evHngy3atd0PpBbO3INKw47qiaR" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/DbHZS3kB.js"><link nonce="" integrity="sha384-RM/Mo1ghfGkllOi+CDGLnd20DWVN1t08mtTcwNUiXBEJRjpZkQtDRx/jVXtJz41Y" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CwRp0Xpq.js"><link nonce="" integrity="sha384-RyM4rUhyBSz8fmPFNbPomNhEGNVOzjIOLiaXC4Ko2qfim2oQsUxgSF5Ph2aIRqlG" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/Bp1_D2AQ.js"><link nonce="" integrity="sha384-lBee+EBxJwlQT/EIkkt/pTv4vAQOc0fgN5o5eYkpq9gdj9noR5zDkusN3ShaWaF5" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/9AJ66TUp.js"><link nonce="" integrity="sha384-vRjC9eer2LRI5TZCe1KoMcxRls7jex5ZFTsZ8MolJE1t7J7JVgbbbDulHcGIldMB" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CEXEj78B.js"><link nonce="" integrity="sha384-GIbFX+zhMJCEH4XGvK7kQyWHeRgqwPN1WYH9cBaw+k8RSsY9HxSg153f0yqDf/Ax" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CRfmA1bm.js"><link nonce="" integrity="sha384-mirQ9xkJWaO21ywpuWop5HjFICi9zbBXBKWFO3UK5YfsCSSehmyHqf4oZVWQqsID" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/BZIEhpEc.js"><link nonce="" integrity="sha384-ZS0dy5T81natV7R6Dk5VaYA2d5MlO4t0nPsBc5NZh+R5t4Vbdx8QCONwl3Z7GDJQ" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/6INMPEbM.js"><link nonce="" integrity="sha384-Hk6ffNtPiGoxfI8TygjqdFsxfFzqEojGwc/bGLgoLpAkbU2dGn4aFOTdHmsF/tTv" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/BiHU9HLl.js"><link nonce="" integrity="sha384-VB229iY445N1sGEQKoH4OhWJJorS/KVSits7FB+9fCBfjVkYDrceq435k4P/wIjI" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/D54rIIIu.js"><link nonce="" integrity="sha384-/NzF5r7B5Dd9FZj2VNaIuUf10brer8kf1ljNa8vxn96g7ELxSkQUU6OB5BSA14xl" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/_DUMccsq.js"><link nonce="" integrity="sha384-6RpWbACR1dR1X7lSttskfK8FjGSyc0vdg96WfBK+gn30b9+6pazk5ECO0XvxHMBF" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CwXlw7iE.js"><link nonce="" integrity="sha384-YEMzifEwiJDrTS+mZ8hRwFwDa9JRLZwCu8jNct/772Gz16vMt0IuCII9JLrUy45b" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/KpUMbPIU.js"><link nonce="" integrity="sha384-/qMPJ8gBan0mMr3YZ5j73nUXWbZcvlhzMBqC0s02HA33Er86ElDUEbyXHCHhsaM7" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/O5G_pKvf.js"><link nonce="" integrity="sha384-P+EqG43aviqK4615K2MQKC1g5znE1pq/eZuAsbh3ZIgRjCWM22s+4kgKYbw3GaAc" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/BmSZo5vd.js"><link nonce="" integrity="sha384-vz7JjgW2QWGQncY16HiNPYbLYQ+OKtUb5KNndUdhuJw4j/5OrjTMCXQOuctsCP/s" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CqKT32sS.js"><link nonce="" integrity="sha384-9RFXdF3e3K3vvdvkDo9c/yTeofhQZot5z25S1RN+Gmd6uku2vAhs2PTN1Z15ttpO" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CVIvuSKk.js"><link nonce="" integrity="sha384-n0vfE37Xgk0xpViNLpNToKUiZ7I246oSVD3z0aUq+8u1upLNRhCTOuhKkPeV7UdH" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/yV0BN1R6.js"><link nonce="" integrity="sha384-hD3pihvQqvqOb47clwfGM7eoP30EGCxJA8mKCiPLx1iIGLnt/Jj0nJbDldzbdhe5" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/DwLVdadC.js"><link nonce="" integrity="sha384-onBDVMoGwRE3QRfuzFk7cP7dUqrPv6fClKp0ZBgbBIHdiCztqd3MiVEkF8Kx2USa" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/1_iL_gOK.js"><link nonce="" integrity="sha384-4JErMhMwN9S+EdU+QgZJzIlMhxCePhDvuitEv+BAwMEfUXGh2ZmhItHg6LYCTlIC" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/DDrhJvbN.js"><link nonce="" integrity="sha384-+mbTzQrAM16+5gzKhruDRbvkgzrWryRjppDLh3QORGSvAMtoFwNFY4SVnGcPIWxi" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CdgWLbM0.js"><link nonce="" integrity="sha384-8RFJigfxYGzVgxWTW2gy45MzjdX190pIR9DLZlr/+cIgm4WKj5QtEtMI3ZKn8SsN" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/C9xFUvHG.js"><link nonce="" integrity="sha384-w++Jp76+dXZEGKN3ApKy8R4s6Zclm1L+60MWfMkYKu1lSjOQ3E4GmzgXuQidTOaG" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/W7wjYkEu.js"><link nonce="" integrity="sha384-z7e7yUXQAueL7WeJPCaj0rMxioMrr9TNZXplqJCaL3WhmIMAQgePZfyLFq4pZqcJ" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/C0vOX3wI.js"><link nonce="" integrity="sha384-LHr9km/b9aujaROdMqpErXj2bbnZRPOSioFSLi5HEVZSRbpzxAEYzr8rKzs1LelZ" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/DzRmAYvD.js"><link nonce="" integrity="sha384-/h2WZsDQgkoa7UZm/WayhkhqEod4IvIrmVY92WHHwcnpksYuurXZ5mnAkh/kpvjd" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/DRoURJIp.js"><link nonce="" integrity="sha384-cZ/Tz5zzHCOCUuJEGiqP1GPVQAEDCVhznrO/05dCFh4sBdXf8Vrwq61VUyRjGX6C" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/BFQR5dwQ.js"><link nonce="" integrity="sha384-h/1ej+nEzHZyUTfGxz1GJ9y2bcEZAZ7aj7KXLaWnzA2v1yuPXAJnbJ/htYw3jg/O" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/BGlOD76I.js"><link nonce="" integrity="sha384-1MYNPSB37FmA6FdFj077+wWfewzVbTpTR38q0rpWUoxDaqYBZ//322fFFzvDBozK" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/C7L-Qewe.js"><link nonce="" integrity="sha384-s7UennnA5+uKAXflJQSOiBFQyIuyesh7AMB9UevZ/tjSKbYxYRCDt0BVDI7nG/ZR" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/BACt5QkB.js"><link nonce="" integrity="sha384-enuNAZc5uQxVc+Wi9HoS2wrqZ8AMvxq+MsAo0Q+nli3WKKMt5R8oDcZee7O5N3Ch" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/EsYxSuUn.js"><link nonce="" integrity="sha384-ijeWYzm10n+O+h47muVibKFhyxzTB5Lo+2bXVOgyJ992mRj3HWrKlCMTU4cid++L" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/TfVQFkXD.js"><link nonce="" integrity="sha384-fYZWSwq465LUeZBu+yR0gIqFWxVYMJkeADsDLAxHQi5iGoN4SU7i9tYfqjlqv3GG" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/Cwv0wPrA.js"><link nonce="" integrity="sha384-dmAK1hhiumNXMs/NjWqR1YxMm3vyiMg16sggZx3HjlYKju1wCeiJzsSNr9NEW6TG" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/Ddhl0Rna.js"><link nonce="" integrity="sha384-NhF4xsrG33Hrmoyk0CtdRHWVv5kuNSXCmoaxIiALakeXaeXpiAr3xrIcNMZMa082" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/Ajydhuh8.js"><link nonce="" integrity="sha384-4KEL6vU2/FPVbey71ms9mHVcOWBDBscJKZQ7289cjR0vhRCd+b8CKqHDRAR/3Xxz" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/DHj0I4qo.js"><link nonce="" integrity="sha384-jGINj1ShftWKDI7S23mVZ+L6D2f9piqFpjk0Pzqu1vUKQJ4qE55dJD6e7E5C0bPG" rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/BBTDB2dI.js"><script nonce="" integrity="sha384-K18nopic+X0JunSv2KJqsE7W6KB015nwBWeFR+Jh5SQtvXW7Yy4WjDfxnYjG/Q6g" type="module" src="Building%20an%20eBPF_XDP%20NAT-Based%20Layer%204%20Load%20Balancer%20from%20Scratch_files/A538-Xd4.js" crossorigin=""></script><meta name="description" content="Learn how an eBPF/XDP-based NAT Layer 4 load balancer works by building one from scratch. We implement simple connection tracking, deterministic hashing, and IP/MAC rewriting with a small, easy-to-follow example."><link nonce="" rel="icon" type="image/png" href="https://labs.iximiuz.com/favicon.ico"><link nonce="" rel="apple-touch-icon" type="image/png" href="Building%20an%20eBPF_XDP%20NAT-Based%20Layer%204%20Load%20Balancer%20from%20Scratch_files/logo.webp"><meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1"><meta name="title" content="Building an eBPF/XDP NAT-Based Layer 4 Load Balancer from Scratch | iximiuz Labs"><meta name="keywords" content="eBPF"><meta name="author" content="Teodor Janez Podobnik"><meta property="og:type" content="article"><meta property="og:title" content="Building an eBPF/XDP NAT-Based Layer 4 Load Balancer from Scratch | iximiuz Labs"><meta property="og:description" content="Learn how an eBPF/XDP-based NAT Layer 4 load balancer works by building one from scratch. We implement simple connection tracking, deterministic hashing, and IP/MAC rewriting with a small, easy-to-follow example."><meta property="og:url" content="https://labs.iximiuz.com/tutorials/xdp-load-balancer-700a1d74"><meta property="og:image" content="https://labs.iximiuz.com/content/files/tutorials/xdp-load-balancer-700a1d74/__static__/cover-lb.png"><meta property="og:site_name" content="iximiuz Labs"><meta name="twitter:dnt" content="on"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:creator" content="@iximiuz"><meta name="twitter:title" content="Building an eBPF/XDP NAT-Based Layer 4 Load Balancer from Scratch | iximiuz Labs"><meta name="twitter:description" content="Learn how an eBPF/XDP-based NAT Layer 4 load balancer works by building one from scratch. We implement simple connection tracking, deterministic hashing, and IP/MAC rewriting with a small, easy-to-follow example."><meta name="twitter:image" content="https://labs.iximiuz.com/content/files/tutorials/xdp-load-balancer-700a1d74/__static__/cover-lb.png"><link nonce="" rel="canonical" href="https://labs.iximiuz.com/tutorials/xdp-load-balancer-700a1d74"><link nonce="" rel="image_src" href="https://labs.iximiuz.com/content/files/tutorials/xdp-load-balancer-700a1d74/__static__/cover-lb.png"><style>:is([id*='google_ads_iframe'],[id*='taboola-'],.taboolaHeight,.taboola-placeholder,#top-ad,#credential_picker_container,#credentials-picker-container,#credential_picker_iframe,[id*='google-one-tap-iframe'],#google-one-tap-popup-container,.google-one-tap__module,.google-one-tap-modal-div,#amp_floatingAdDiv,#ez-content-blocker-container) {display:none!important;min-height:0!important;height:0!important;}</style><link rel="stylesheet" crossorigin="" href="Building%20an%20eBPF_XDP%20NAT-Based%20Layer%204%20Load%20Balancer%20from%20Scratch_files/SiteHeaderContent.DrFmd9xY.css"><link rel="stylesheet" crossorigin="" href="Building%20an%20eBPF_XDP%20NAT-Based%20Layer%204%20Load%20Balancer%20from%20Scratch_files/ContentTable.ChTBbrAh.css"><link rel="stylesheet" crossorigin="" href="Building%20an%20eBPF_XDP%20NAT-Based%20Layer%204%20Load%20Balancer%20from%20Scratch_files/ContentMetaFoot.DFr8HVAl.css"><link rel="stylesheet" crossorigin="" href="Building%20an%20eBPF_XDP%20NAT-Based%20Layer%204%20Load%20Balancer%20from%20Scratch_files/ContentBox.rEdLfu6t.css"><link rel="stylesheet" crossorigin="" href="Building%20an%20eBPF_XDP%20NAT-Based%20Layer%204%20Load%20Balancer%20from%20Scratch_files/PlayBoxContentTab.CDHpeXMx.css"><link rel="stylesheet" crossorigin="" href="Building%20an%20eBPF_XDP%20NAT-Based%20Layer%204%20Load%20Balancer%20from%20Scratch_files/_name_.BsyFxT4E.css"><link rel="stylesheet" crossorigin="" href="Building%20an%20eBPF_XDP%20NAT-Based%20Layer%204%20Load%20Balancer%20from%20Scratch_files/ProseP.DVN8_MMS.css"><link rel="stylesheet" crossorigin="" href="Building%20an%20eBPF_XDP%20NAT-Based%20Layer%204%20Load%20Balancer%20from%20Scratch_files/ProseA.CGc139Ky.css"><link rel="stylesheet" crossorigin="" href="Building%20an%20eBPF_XDP%20NAT-Based%20Layer%204%20Load%20Balancer%20from%20Scratch_files/ProseStrong.DAaF5VAD.css"><link rel="stylesheet" crossorigin="" href="Building%20an%20eBPF_XDP%20NAT-Based%20Layer%204%20Load%20Balancer%20from%20Scratch_files/ProseH2.BDlwlsRA.css"><link rel="stylesheet" crossorigin="" href="Building%20an%20eBPF_XDP%20NAT-Based%20Layer%204%20Load%20Balancer%20from%20Scratch_files/ProseUl.5leepCZD.css"><link rel="stylesheet" crossorigin="" href="Building%20an%20eBPF_XDP%20NAT-Based%20Layer%204%20Load%20Balancer%20from%20Scratch_files/ProseLi.BqrAa653.css"><link rel="stylesheet" crossorigin="" href="Building%20an%20eBPF_XDP%20NAT-Based%20Layer%204%20Load%20Balancer%20from%20Scratch_files/ProseCodeCopyButton.dhGBryGn.css"><link rel="stylesheet" crossorigin="" href="Building%20an%20eBPF_XDP%20NAT-Based%20Layer%204%20Load%20Balancer%20from%20Scratch_files/ProseCode.CdJo3ouR.css"><link rel="stylesheet" crossorigin="" href="Building%20an%20eBPF_XDP%20NAT-Based%20Layer%204%20Load%20Balancer%20from%20Scratch_files/ProsePre.B_fgAJq0.css"><link rel="stylesheet" crossorigin="" href="Building%20an%20eBPF_XDP%20NAT-Based%20Layer%204%20Load%20Balancer%20from%20Scratch_files/DetailsBox.3wfYThLq.css"><link rel="stylesheet" crossorigin="" href="Building%20an%20eBPF_XDP%20NAT-Based%20Layer%204%20Load%20Balancer%20from%20Scratch_files/ProseCodeInline.BhuXSD4-.css"><link rel="stylesheet" crossorigin="" href="Building%20an%20eBPF_XDP%20NAT-Based%20Layer%204%20Load%20Balancer%20from%20Scratch_files/ProseBlockquote.B6iPdvPh.css"><link rel="stylesheet" crossorigin="" href="Building%20an%20eBPF_XDP%20NAT-Based%20Layer%204%20Load%20Balancer%20from%20Scratch_files/ProseHr.BdCZvnSy.css"><link rel="preconnect" href="https://plausible.io/"><link rel="image_src" href="https://labs.iximiuz.com/content/files/tutorials/xdp-load-balancer-700a1d74/__static__/cover-lb.png"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/3yJMaxvi.js"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/C8wdN3Ik.js"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/Bq0UkCYT.js"><link rel="stylesheet" crossorigin="" href="Building%20an%20eBPF_XDP%20NAT-Based%20Layer%204%20Load%20Balancer%20from%20Scratch_files/SiteHeaderDefault.CQ-9yJ45.css"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/GriQ8B2M.js"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CrYjDOdC.js"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CXxrP7zL.js"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/DUA4yL51.js"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/MTJvKNbD.js"><link rel="stylesheet" crossorigin="" href="Building%20an%20eBPF_XDP%20NAT-Based%20Layer%204%20Load%20Balancer%20from%20Scratch_files/AuthorProfileCard.B2bdkgLl.css"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/D5PaCUAZ.js"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/C4h4q3zH.js"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/Dg959Yt1.js"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CJ7oOdLD.js"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/Hmopn4U9.js"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/Dv2DOayU.js"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/4J4r8vMm.js"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CAUMgW0h.js"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/QwXPddex.js"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/InMlYjVK.js"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/Dzr_TBnN.js"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/BWu6ZW-1.js"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/8O-YeDGZ.js"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/Ch3sV4Nw.js"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/Jz7gehop.js"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CreFxVwq.js"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/djRO7Jx5.js"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/Dx5dmUye.js"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/OfFSSdU4.js"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/BDLepdqL.js"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/DF8Kb1Fe.js"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/DGl8mbvI.js"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/BkPnT0P4.js"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/D9IPNEg4.js"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/CSKsp-sX.js"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/BLGyX_7H.js"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/sTy7mATY.js"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/5aprXXgQ.js"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/BEhoFAvJ.js"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/DNFnU2Va.js"><link rel="modulepreload" as="script" crossorigin="" href="https://labs.iximiuz.com/_nuxt/Ddtg1Dbv.js"></head><body><div id="__nuxt"><div class="bg-[length:100%_250px] bg-fixed bg-gradient-to-b bg-mist bg-no-repeat from-[#a6d7f7] min-w-[300px]"><!--[--><div data-v-0d30d5a9=""><header id="site-header" class="bg-base-100 border-b-[1px] border-base-content/40 flex min-h-[3rem] sticky top-0 z-50" data-v-0d30d5a9="" data-v-7f8ed6a6=""><nav class="flex grow items-center justify-between min-w-0 mx-auto px-2 sm:px-4 text-primary-content" data-v-7f8ed6a6=""><div data-headlessui-state="" class="mr-2 relative self-center shrink-0 sm:mr-4" data-v-7f8ed6a6=""><div><button id="button-header-nav-menu-left" type="button" aria-haspopup="menu" aria-expanded="false" data-headlessui-state="" class="flex items-center rounded-full text-primary-content text-sm"><img class="align-text-bottom h-6 inline mr-1 w-auto" src="Building%20an%20eBPF_XDP%20NAT-Based%20Layer%204%20Load%20Balancer%20from%20Scratch_files/logo.webp" alt="iximiuz Labs"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="h-4 hover:opacity-100 hover:scale-110 opacity-70 w-4"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5"></path></svg></button></div><!----></div><div class="flex grow min-w-0" data-v-7f8ed6a6=""><div class="flex flex-col min-w-0 mr-5" data-v-7f8ed6a6=""><div class="flex gap-1 items-center" data-v-7f8ed6a6=""><!--[--><a aria-current="page" href="https://labs.iximiuz.com/tutorials/xdp-load-balancer-700a1d74" class="router-link-active router-link-exact-active font-semibold text-md truncate" title="Building an eBPF/XDP NAT-Based Layer 4 Load Balancer from Scratch" data-v-7f8ed6a6=""><h1 class="truncate" data-v-7f8ed6a6="">Building an eBPF/XDP NAT-Based Layer 4 Load Balancer from Scratch</h1></a><!--]--><!--[--><!--]--></div><span title="Teodor Janez Podobnik" class="text-base-content/85 text-xs truncate" data-v-7f8ed6a6="">Tutorial by <!--[--><!--[--><a href="https://labs.iximiuz.com/a/teodor-janez-podobnik" class="hover:underline decoration-dotted" title="Teodor Janez Podobnik">Teodor Janez Podobnik</a><!----><!----><!--]--><!--]--></span></div></div><!--[--><div class="flex gap-x-3 items-center shrink-0" data-v-0d30d5a9=""><!----><!----><!----><!----></div><!--]--><div class="flex items-center ml-2 shrink-0 sm:ml-3" data-v-7f8ed6a6=""><!--[--><a href="https://labs.iximiuz.com/signin?return_to=%2Ftutorials%2Fxdp-load-balancer-700a1d74" class="leading-6 ml-3 mr-4 shrink-0 text-base"> Sign in </a><a href="https://labs.iximiuz.com/signup?return_to=%2Ftutorials%2Fxdp-load-balancer-700a1d74" class="bg-base-100 border border-primary-content leading-6 px-1.5 rounded-md shrink-0 text-base"> Sign up </a><!--]--></div></nav></header><div class="hidden bg-gradient-to-b flex flex-col from-base-200 gap-y-2 max-h-96 overflow-y-auto p-4 scrollbar-styled to-transparent w-full z-[999999] fixed" data-v-0d30d5a9=""><!--[--><!--]--></div><div class="flex justify-center relative" data-v-0d30d5a9=""><div class="hidden lg:flex lg:h-[calc(100vh-3rem)] lg:sticky lg:top-[3rem] shrink-0 transition-all"><!--[--><div class="duration-300 ease-in-out flex flex-col mb-[3px] mt-1.5 overflow-hidden relative transition-all bg-base-100 border border-slate-400 rounded-lg w-[320px] ml-1.5" data-v-0d30d5a9=""><div class="absolute left-0 right-0 top-0 cursor-pointer flex group h-8 items-center"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="group-hover:opacity-100 mr-2 opacity-60 stroke-[2.5px] ml-auto h-3 w-3"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5"></path></svg></div><div class="flex flex-col min-h-0 overflow-hidden pl-3 pr-0 pt-2 pt-3" style="" data-v-c294bba9=""><h3 class="flex mb-3 text-[0.875rem] text-base-content/80 text-nowrap tracking-tight" data-v-c294bba9=""> Table of contents <!----></h3><div class="flex-1 mb-3 min-h-0 relative" data-v-c294bba9=""><nav class="h-full overflow-y-auto pr-2 scrollbar-styled" data-v-c294bba9=""><ul data-v-c294bba9=""><!--[--><li data-v-c294bba9=""><a href="#nat-network-address-translation-and-ebpf" class="block border-l-[3px] duration-150 hover:bg-mist no-underline px-2 py-1.5 rounded rounded-l-none text-[0.85rem] text-base-content/80 transition-colors pl-4 border-slate-500 !text-base-content/100" data-v-c294bba9="">NAT (Network Address Translation) and eBPF</a><!----></li><li data-v-c294bba9=""><a href="#load-balancing" class="pl-4 border-slate-200 block border-l-[3px] duration-150 hover:bg-mist no-underline px-2 py-1.5 rounded rounded-l-none text-[0.85rem] text-base-content/80 transition-colors" data-v-c294bba9="">Load Balancing</a><!----></li><li data-v-c294bba9=""><a href="#rewriting-ip-and-mac-addresses" class="pl-4 border-slate-200 block border-l-[3px] duration-150 hover:bg-mist no-underline px-2 py-1.5 rounded rounded-l-none text-[0.85rem] text-base-content/80 transition-colors" data-v-c294bba9="">Rewriting IP and MAC Addresses</a><!----></li><li data-v-c294bba9=""><a href="#running-the-load-balancer" class="pl-4 border-slate-200 block border-l-[3px] duration-150 hover:bg-mist no-underline px-2 py-1.5 rounded rounded-l-none text-[0.85rem] text-base-content/80 transition-colors" data-v-c294bba9="">Running the Load Balancer</a><!----></li><!--]--></ul></nav><!----></div></div><div class="bg-[#a6d7f7]/70 border-slate-400 border-t mt-auto p-2 py-4" style=""><div class="flex items-center justify-center"><a href="https://labs.iximiuz.com/signup?return_to=%2Ftutorials%2Fxdp-load-balancer-700a1d74" class="btn bg-base-100 btn-outline btn-sm" role="button"><!--[--> Start tutorial <!--]--></a></div></div><div class="flex flex-col gap-y-5 !gap-y-4 border-slate-400 border-t px-4 py-5" style="" data-v-6adfc778=""><div class="flex flex-wrap items-center" data-v-6adfc778=""><span class="font-semibold" data-v-6adfc778="">Tutorial on&nbsp;</span><!--[--><!--[--><!----><a href="https://labs.iximiuz.com/tutorials?category=linux" class="font-normal hover:opacity-100 hover:underline no-underline opacity-80" data-v-6adfc778="">Linux</a><!--]--><!--[--><span data-v-6adfc778="">,&nbsp;</span><a href="https://labs.iximiuz.com/tutorials?category=programming" class="font-normal hover:opacity-100 hover:underline no-underline opacity-80" data-v-6adfc778="">Programming</a><!--]--><!--]--></div><div class="flex flex-wrap items-center" data-v-6adfc778=""><span class="font-semibold" data-v-6adfc778="">Discussion&nbsp;</span><a href="https://discord.gg/p6nxaHm46p" rel="noopener noreferrer" target="_blank noopener noreferrer" class="font-normal hover:opacity-100 hover:underline no-underline opacity-80" data-v-6adfc778=""> Discord <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="h-[1em] inline pb-[3px] stroke-[2px] w-[1em]" data-v-6adfc778=""><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 0 0 3 8.25v10.5A2.25 2.25 0 0 0 5.25 21h10.5A2.25 2.25 0 0 0 18 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25"></path></svg></a></div><div class="flex flex-wrap gap-y-2 items-center mt-1" data-v-6adfc778=""><!--[--><a href="https://labs.iximiuz.com/tutorials?tag=eBPF" class="bg-mist cursor-pointer duration-200 ease-in-out font-medium hover:bg-slate-200 hover:text-gray-800 inline-flex items-center min-w-0 no-underline py-0.5 rounded-md text-gray-600 transition-all px-2.5 text-sm mx-1 not-prose" title="#eBPF" data-v-6adfc778=""><span class="truncate">eBPF</span></a><!--]--></div></div></div><!--]--></div><div class="flex lg:basis-[950px] transition-[flex-basis] duration-300 ease-in-out grow justify-center lg:grow-0 lg:pb-[3px] min-h-[calc(100vh-3rem)] min-w-0 mx-auto overflow-hidden p-1.5 pb-14"><div class="w-full"><!--[--><article class="flex grow min-h-full min-w-0" data-v-0d30d5a9=""><meta itemprop="name" content="Building an eBPF/XDP NAT-Based Layer 4 Load Balancer from Scratch"><meta itemprop="abstract" content="Learn how an eBPF/XDP-based NAT Layer 4 load balancer works by building one from scratch. We implement simple connection tracking, deterministic hashing, and IP/MAC rewriting with a small, easy-to-follow example."><meta itemprop="dateCreated" content="2026-01-06T00:00:00.000Z"><meta itemprop="datePublished" content="2026-01-06T00:00:00.000Z"><meta itemprop="dateModified" content="2026-01-06T00:00:00.000Z"><!--[--><div class="flex flex-col grow min-h-full min-w-0" data-v-0d30d5a9="" data-v-200caef3=""><!--[--><!--]--><div class="bg-base-100 border-[1px] border-slate-400 flex flex-col grow overflow-hidden relative rounded-lg shadow-lg" data-v-200caef3=""><div class="px-4 md:px-8 xl:px-12" data-v-200caef3=""><!--[--><div class="flex flex-col mb-8" data-v-0d30d5a9=""><div class="-mx-4 bg-content-tutorial border-b-[1px] border-b-slate-400 flex flex-nowrap items-center md:-mx-8 min-w-0 px-3 py-1.5 rounded-t-lg text-primary-content/70 text-sm xl:-mx-12"><div class="group/content-icon relative cursor-help"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="h-[1.2em] mr-2 w-[1.2em]"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-2.885a.562.562 0 0 0-.586 0L6.982 20.54a.562.562 0 0 1-.84-.61l1.285-5.386a.562.562 0 0 0-.182-.557l-4.204-3.602a.562.562 0 0 1 .321-.988l5.518-.442a.563.563 0 0 0 .475-.345L11.48 3.5Z"></path></svg><div class="absolute bg-base-content duration-300 ease-in-out group-hover/content-icon:opacity-100 group-hover/content-icon:visible invisible left-0 mt-1 opacity-0 px-3 py-2 right-0 rounded-md text-slate-200 transition-all w-[20em] z-20">This tutorial was carefully crafted by an independent author and proudly hosted by iximiuz Labs.</div></div> Tutorial <span> &nbsp;on&nbsp; </span><!--[--><!--[--><!----><a href="https://labs.iximiuz.com/tutorials?category=linux" class="font-normal hover:underline no-underline truncate">Linux</a><!--]--><!--[--><span>,&nbsp;</span><a href="https://labs.iximiuz.com/tutorials?category=programming" class="font-normal hover:underline no-underline truncate">Programming</a><!--]--><!--]--><!--[--><span class="cursor-help hover:tooltip-open ml-auto pl-4 shrink-0 tooltip tooltip-left" data-tip="Published: Jan 6, 2026"><time datetime="createdAt"> Published: Jan 6, 2026</time></span><!--[--><button type="button" class="hidden lg:flex ml-2" title="Expand content to full width" data-v-0d30d5a9=""><svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--material-symbols-light h-5 w-5" style="" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M6 18v-5h1v4h4v1zm11-7V7h-4V6h5v5z"></path></svg></button><!--]--><!----><!--]--></div><!----></div><h1 class="tutorial-header" data-v-0d30d5a9="">Building an eBPF/XDP NAT-Based Layer 4 Load Balancer from Scratch</h1><!--]--></div><!----><!--[--><!--[--><div class="flex flex-col" data-v-200caef3=""><!----><div class="h-auto pb-5 px-4 md:px-8 xl:px-12 duration-200 ease-out max-w-full overflow-hidden prose relative transition-all" data-v-200caef3=""><div class="" data-v-200caef3=""><p class="prose-p" data-v-b025fb9f=""><!--[-->Traditional load balancers like <a href="https://nginx.org/" rel="nofollow" target="_blank" class="prose-a" data-v-abeb6555=""><!--[-->NGINX<!--]--><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="h-[1rem] inline ml-[1px] pb-[5px] stroke-[2px] w-[1rem]" data-v-abeb6555=""><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 0 0 3 8.25v10.5A2.25 2.25 0 0 0 5.25 21h10.5A2.25 2.25 0 0 0 18 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25"></path></svg></a> and <a href="https://www.haproxy.org/" rel="nofollow" target="_blank" class="prose-a" data-v-abeb6555=""><!--[-->HAProxy<!--]--><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="h-[1rem] inline ml-[1px] pb-[5px] stroke-[2px] w-[1rem]" data-v-abeb6555=""><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 0 0 3 8.25v10.5A2.25 2.25 0 0 0 5.25 21h10.5A2.25 2.25 0 0 0 18 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25"></path></svg></a>
 typically operate in user space. Even when used purely for Layer 4 
forwarding, every incoming packet must traverse the kernels networking 
stack to reach the user-space socket and then travel back down to the 
kernel before being forwarded to a backend.<!--]--></p><p class="prose-p" data-v-b025fb9f=""><!--[-->Each
 of these traversals  crossing the userkernel boundary, context 
switching, and buffer copying  adds microseconds of latency. It may 
sound small, but at millions of packets per second, this overhead 
quickly becomes a performance bottleneck that even modern hardware 
struggles to overcome.<!--]--></p><p class="prose-p" data-v-b025fb9f=""><!--[-->To address this, eBPF/XDP-based Layer 4 load balancers were introduced  a concept that companies like <a href="https://github.com/facebookincubator/katran" rel="nofollow" target="_blank" class="prose-a" data-v-abeb6555=""><!--[-->Meta (Katran)<!--]--><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="h-[1rem] inline ml-[1px] pb-[5px] stroke-[2px] w-[1rem]" data-v-abeb6555=""><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 0 0 3 8.25v10.5A2.25 2.25 0 0 0 5.25 21h10.5A2.25 2.25 0 0 0 18 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25"></path></svg></a> and <a href="https://cilium.io/use-cases/load-balancer/" rel="nofollow" target="_blank" class="prose-a" data-v-abeb6555=""><!--[-->Cisco/Isovalent (Cilium)<!--]--><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="h-[1rem] inline ml-[1px] pb-[5px] stroke-[2px] w-[1rem]" data-v-abeb6555=""><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 0 0 3 8.25v10.5A2.25 2.25 0 0 0 5.25 21h10.5A2.25 2.25 0 0 0 18 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25"></path></svg></a> have already turned into production-grade systems.<!--]--></p><div class="bg-base-100" style="padding:0;margin:30px auto;max-width:700px;"><div class="text-center"><img src="Building%20an%20eBPF_XDP%20NAT-Based%20Layer%204%20Load%20Balancer%20from%20Scratch_files/transparent-lb.webp" alt="eBPF/XDP NAT Load Balancer" class="cursor-pointer m-0 max-w-full" style=""><!--[--><!--]--></div><!----></div><div class="border-[2px] my-[24px] px-6 py-0 rounded-lg border-primary/50 bg-[#f7fbfe]"><!--[--><p class="prose-p" data-v-b025fb9f=""><!--[-->
 Im referring specifically to Layer 4, since while eBPF-based Layer 7 
load balancing is possible, so far I haven't seen any mature production 
solution yetlikely because implementing L7 features is too complex, 
outweighing the potential performance gains.<!--]--></p><!--]--></div><p class="prose-p" data-v-b025fb9f=""><!--[--><strong class="prose-strong" data-v-24022f14=""><!--[-->But how do these eBPF-based load balancers actually work?<!--]--></strong><!--]--></p><p class="prose-p" data-v-b025fb9f=""><!--[-->Understanding
 how these projects leverage eBPF is quite hard  especially because 
there are no minimal, easy-to-run examples that clearly demonstrate the 
fundamentals.<!--]--></p><p class="prose-p" data-v-b025fb9f=""><!--[-->This
 tutorial aims to fill that gap. Well walk through a simple XDP NAT 
Load Balancer implementation in roughly 200 lines of code (plus some 
boilerplate). And then in the upcoming tutorial, well build on this 
foundation with features like DSR (Direct Server Return) Layer 2 load 
balancing and IPIP encapsulation.<!--]--></p><h2 id="nat-network-address-translation-and-ebpf" class="prose-h2" data-v-b9b1576a=""><!--[-->NAT (Network Address Translation) and eBPF<!--]--><!----></h2><p class="prose-p" data-v-b025fb9f=""><!--[-->Before
 even putting load balancing into context, its important to first 
understand NAT (Network Address Translation) and how it would fit into 
the eBPF implementation.<!--]--></p><p class="prose-p" data-v-b025fb9f=""><!--[-->In
 short, NAT is a mechanism that modifies/replaces IP address (and often 
port as well) in the packet header as it passes through the (routing) 
node that runs it.<!--]--></p><p class="prose-p" data-v-b025fb9f=""><!--[-->We typically see it used on <strong class="prose-strong" data-v-24022f14=""><!--[-->routers or gateways<!--]--></strong> that connect two different networks (for example, a private LAN and the public internet), and on <strong class="prose-strong" data-v-24022f14=""><!--[-->load balancers<!--]--></strong> that rewrite packet destinations when forwarding traffic to backend servers.<!--]--></p><p class="prose-p" data-v-b025fb9f=""><!--[-->Regardless of the use case, if you are new to this topic think of it like this (intentionally simplified):<!--]--></p><div class="bg-base-100" style="padding:0;margin:30px auto;max-width:800px;"><div class="text-center"><img src="Building%20an%20eBPF_XDP%20NAT-Based%20Layer%204%20Load%20Balancer%20from%20Scratch_files/nat-basic.webp" alt="NAT Concept" class="cursor-pointer m-0 max-w-full" style=""><!--[--><!--]--></div><!----></div><p class="prose-p" data-v-b025fb9f=""><!--[-->Without going into too much details, NAT relies on a NAT table to define these translation rules and uses:<!--]--></p><ul class="prose-ul" data-v-533e29f3=""><!--[--><li class="prose-li" data-v-2969431c=""><!--[--><strong class="prose-strong" data-v-24022f14=""><!--[-->Source Network Address Translation (SNAT)<!--]--></strong> (outbound request) to replace the source IP address, and<!--]--></li><li class="prose-li" data-v-2969431c=""><!--[--><strong class="prose-strong" data-v-24022f14=""><!--[-->Destination Network Address Translation (DNAT)<!--]--></strong> (incoming response) to replace the destination IP address.<!--]--></li><!--]--></ul><p class="prose-p" data-v-b025fb9f=""><!--[-->And this is similar to what a NAT-based Load Balancer (LB) also does (intentionally simplified):<!--]--></p><div class="bg-base-100" style="padding:0;margin:30px auto;max-width:800px;"><div class="text-center"><img src="Building%20an%20eBPF_XDP%20NAT-Based%20Layer%204%20Load%20Balancer%20from%20Scratch_files/xdp-nat-lb-new.webp" alt="NAT Concept in Load Balancer" class="cursor-pointer m-0 max-w-full" style=""><!--[--><!--]--></div><!----></div><p class="prose-p" data-v-b025fb9f=""><!--[-->Its
 actually a bit trickier than that when you put virtual IPs (VIPs) and 
Direct Server Return (DSR) into the context, but well get to that.<!--]--></p><p class="prose-p" data-v-b025fb9f=""><!--[-->And
 while a load balancer doesnt necessarily store this information in a 
NAT table like a router or gateway, it instead keeps it in some local 
variable or table  but the concept remains the same  <strong class="prose-strong" data-v-24022f14=""><!--[-->it must remember which client made the request so it can send the backends response back to that same client.<!--]--></strong><!--]--></p><p class="prose-p" data-v-b025fb9f=""><!--[-->Depending
 on the setup, the load balancer typically retains a 5-tuple client 
information  the client source IP, load balancer destination IP, client
 source port, load balancer destination port, and protocol (TCP/UDP).<!--]--></p><p class="prose-p" data-v-b025fb9f=""><!--[-->This
 way, when the response comes back, the load balancer receives it from a
 connection defined by the backends source IP and port, the load 
balancers destination IP and port, and the specific protocol. Using 
this information, it knows exactly which client initiated the request.<!--]--></p><p class="prose-p" data-v-b025fb9f=""><!--[-->Heres an image that illustrates these mappings.<!--]--></p><div class="bg-base-100" style="padding:0;margin:30px auto;max-width:700px;"><div class="text-center"><img src="Building%20an%20eBPF_XDP%20NAT-Based%20Layer%204%20Load%20Balancer%20from%20Scratch_files/nat-mappings.webp" alt="NAT Mappings" class="cursor-pointer m-0 max-w-full" style=""><!--[--><!--]--></div><!----></div><p class="prose-p" data-v-b025fb9f=""><!--[-->And
 when you think about this conceptstoring client information on the 
request as it travels through the load balancer and retrieving it on the
 backends responseits relatively straightforward to implement in 
eBPF. We just need an eBPF map to hold this 5-tuple connection 
information.<!--]--></p><!--[--><div class="highlight-c prose-code" meta="" data-v-4578ab24=""><span class="filename" data-v-4578ab24="">lab/lb.c</span><!--[--><pre class="language-c shiki shiki-themes slack-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#E6E6E6">  ...
</span></span><span class="line highlight" line="2"><span style="--shiki-default:#6A9955">  // Lookup conntrack (connection tracking) information - actually eBPF map
</span></span><span class="line highlight" line="3"><span style="--shiki-default:#6A9955">  // NO EXISTING CONNECTION: client request
</span></span><span class="line highlight" line="4"><span style="--shiki-default:#6A9955">  // EXISTING CONNECTION: backend response
</span></span><span class="line highlight" line="5"><span style="--shiki-default:#569CD6">  struct</span><span style="--shiki-default:#4EC9B0"> five_tuple_t</span><span style="--shiki-default:#E6E6E6"> in </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#E6E6E6"> {};
</span></span><span class="line highlight" line="6"><span style="--shiki-default:#E6E6E6">  in.src_ip </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#E6E6E6"> ip</span><span style="--shiki-default:#D4D4D4">-&gt;</span><span style="--shiki-default:#E6E6E6">daddr;</span><span style="--shiki-default:#6A9955">     // LB destination IP
</span></span><span class="line highlight" line="7"><span style="--shiki-default:#E6E6E6">  in.dst_ip </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#E6E6E6"> ip</span><span style="--shiki-default:#D4D4D4">-&gt;</span><span style="--shiki-default:#E6E6E6">saddr;</span><span style="--shiki-default:#6A9955">     // Client or Backend source IP
</span></span><span class="line highlight" line="8"><span style="--shiki-default:#E6E6E6">  in.src_port </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#E6E6E6"> tcp</span><span style="--shiki-default:#D4D4D4">-&gt;</span><span style="--shiki-default:#E6E6E6">dest;</span><span style="--shiki-default:#6A9955">   // LB destination port same as source port from which it redirected the request to backend
</span></span><span class="line highlight" line="9"><span style="--shiki-default:#E6E6E6">  in.dst_port </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#E6E6E6"> tcp</span><span style="--shiki-default:#D4D4D4">-&gt;</span><span style="--shiki-default:#E6E6E6">source;</span><span style="--shiki-default:#6A9955"> // Client or Backend source port
</span></span><span class="line highlight" line="10"><span style="--shiki-default:#E6E6E6">  in.protocol </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#E6E6E6"> IPPROTO_TCP;</span><span style="--shiki-default:#6A9955"> // TCP protocol
</span></span><span class="line highlight" line="11"><span style="--shiki-default:#569CD6">  struct</span><span style="--shiki-default:#E6E6E6"> endpoint </span><span style="--shiki-default:#D4D4D4">*</span><span style="--shiki-default:#E6E6E6">out </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#DCDCAA"> bpf_map_lookup_elem</span><span style="--shiki-default:#E6E6E6">(</span><span style="--shiki-default:#D4D4D4">&amp;</span><span style="--shiki-default:#9CDCFE">conntrack</span><span style="--shiki-default:#E6E6E6">, </span><span style="--shiki-default:#D4D4D4">&amp;</span><span style="--shiki-default:#9CDCFE">in</span><span style="--shiki-default:#E6E6E6">);
</span></span><span class="line" line="12"><span style="--shiki-default:#C586C0">  if</span><span style="--shiki-default:#E6E6E6"> (</span><span style="--shiki-default:#D4D4D4">!</span><span style="--shiki-default:#E6E6E6">out) {
</span></span><span class="line" line="13"><span style="--shiki-default:#DCDCAA">    bpf_printk</span><span style="--shiki-default:#E6E6E6">(</span><span style="--shiki-default:#CE9178">"Packet from client because no such connection exists yet"</span><span style="--shiki-default:#E6E6E6">);
</span></span><span class="line" line="14"><span style="--shiki-default:#E6E6E6">    ...
</span></span><span class="line highlight" line="15"><span style="--shiki-default:#6A9955">    // Store connection in the conntrack eBPF map so we can
</span></span><span class="line highlight" line="16"><span style="--shiki-default:#6A9955">    // redirect backends response to the "correct" client
</span></span><span class="line highlight" line="17"><span style="--shiki-default:#569CD6">    struct</span><span style="--shiki-default:#4EC9B0"> five_tuple_t</span><span style="--shiki-default:#E6E6E6"> in_loadbalancer </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#E6E6E6"> {};
</span></span><span class="line highlight" line="18"><span style="--shiki-default:#9CDCFE">    in_loadbalancer</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">src_ip</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#9CDCFE"> ip</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">daddr</span><span style="--shiki-default:#E6E6E6">;</span><span style="--shiki-default:#6A9955">     // LB IP
</span></span><span class="line highlight" line="19"><span style="--shiki-default:#9CDCFE">    in_loadbalancer</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">dst_ip</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#9CDCFE"> backend</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">ip</span><span style="--shiki-default:#E6E6E6">;</span><span style="--shiki-default:#6A9955">   // Backend IP
</span></span><span class="line highlight" line="20"><span style="--shiki-default:#9CDCFE">    in_loadbalancer</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">src_port</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#9CDCFE"> tcp</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">source</span><span style="--shiki-default:#E6E6E6">;</span><span style="--shiki-default:#6A9955"> // Client source port - equal to the LB source port since we don't modify it!
</span></span><span class="line highlight" line="21"><span style="--shiki-default:#9CDCFE">    in_loadbalancer</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">dst_port</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#9CDCFE"> tcp</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">dest</span><span style="--shiki-default:#E6E6E6">;</span><span style="--shiki-default:#6A9955">   // LB destination port
</span></span><span class="line highlight" line="22"><span style="--shiki-default:#9CDCFE">    in_loadbalancer</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">protocol</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#E6E6E6"> IPPROTO_TCP;</span><span style="--shiki-default:#6A9955"> // TCP protocol 
</span></span><span class="line highlight" line="23"><span style="--shiki-default:#569CD6">    struct</span><span style="--shiki-default:#E6E6E6"> endpoint client;
</span></span><span class="line highlight" line="24"><span style="--shiki-default:#9CDCFE">    client</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">ip</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#9CDCFE"> ip</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">saddr</span><span style="--shiki-default:#E6E6E6">;</span><span style="--shiki-default:#6A9955"> // Store Client IP as value in the eBPF map
</span></span><span class="line highlight" line="25"><span style="--shiki-default:#569CD6">    int</span><span style="--shiki-default:#E6E6E6"> ret </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#DCDCAA"> bpf_map_update_elem</span><span style="--shiki-default:#E6E6E6">(</span><span style="--shiki-default:#D4D4D4">&amp;</span><span style="--shiki-default:#E6E6E6">conntrack, </span><span style="--shiki-default:#D4D4D4">&amp;</span><span style="--shiki-default:#E6E6E6">in_loadbalancer, </span><span style="--shiki-default:#D4D4D4">&amp;</span><span style="--shiki-default:#E6E6E6">client, BPF_ANY);
</span></span><span class="line" line="26"><span style="--shiki-default:#E6E6E6">    ...
</span></span><span class="line" line="27"><span style="--shiki-default:#E6E6E6">  } </span><span style="--shiki-default:#C586C0">else</span><span style="--shiki-default:#E6E6E6"> {
</span></span><span class="line" line="28"><span style="--shiki-default:#DCDCAA">    bpf_printk</span><span style="--shiki-default:#E6E6E6">(</span><span style="--shiki-default:#CE9178">"Packet from backend because the connection exists - "
</span></span><span class="line" line="29"><span style="--shiki-default:#CE9178">               "redirecting back to client"</span><span style="--shiki-default:#E6E6E6">);
</span></span><span class="line" line="30"><span style="--shiki-default:#E6E6E6">    ...
</span></span><span class="line" line="31"><span style="--shiki-default:#E6E6E6">  }
</span></span><span class="line" line="32"><span style="--shiki-default:#E6E6E6">  ...
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-4578ab24="" data-v-134dddac=""><span class="sr-only" data-v-134dddac="">Copy to clipboard</span><span class="icon-wrapper" data-v-134dddac=""><svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--ph" style="font-size:18px;" width="1em" height="1em" viewBox="0 0 256 256" data-v-134dddac=""><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"></path></svg></span></button></div><!--]--><div class="border-[2px] my-[24px] px-6 py-0 rounded-lg border-primary/50 bg-[#f7fbfe]" data-v-370f298d=""><!--[--><details data-v-370f298d=""><summary class="cursor-pointer my-3 select-none text-[#4078c0]" data-v-370f298d="">Still confusing?</summary><!--[--><p class="prose-p" data-v-b025fb9f=""><!--[-->Whenever
 a client sends a request, our eBPF map (which acts like a simple NAT 
table) doesnt yet contain any connection information. In that case, we 
create and store a new entry:<!--]--></p><!--[--><div class="highlight-c prose-code" meta="" data-v-4578ab24=""><span class="filename" data-v-4578ab24="">lab/lb.c</span><!--[--><pre class="language-c shiki shiki-themes slack-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#E6E6E6">  ...
</span></span><span class="line" line="2"><span style="--shiki-default:#6A9955">  // Lookup conntrack (connection tracking) information - actually eBPF map
</span></span><span class="line" line="3"><span style="--shiki-default:#6A9955">  // NO EXISTING CONNECTION: client request
</span></span><span class="line" line="4"><span style="--shiki-default:#6A9955">  // EXISTING CONNECTION: backend response
</span></span><span class="line" line="5"><span style="--shiki-default:#569CD6">  struct</span><span style="--shiki-default:#4EC9B0"> five_tuple_t</span><span style="--shiki-default:#E6E6E6"> in </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#E6E6E6"> {};
</span></span><span class="line" line="6"><span style="--shiki-default:#E6E6E6">  in.src_ip </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#E6E6E6"> ip</span><span style="--shiki-default:#D4D4D4">-&gt;</span><span style="--shiki-default:#E6E6E6">daddr;</span><span style="--shiki-default:#6A9955">     // LB destination IP
</span></span><span class="line" line="7"><span style="--shiki-default:#E6E6E6">  in.dst_ip </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#E6E6E6"> ip</span><span style="--shiki-default:#D4D4D4">-&gt;</span><span style="--shiki-default:#E6E6E6">saddr;</span><span style="--shiki-default:#6A9955">     // Client or Backend source IP
</span></span><span class="line" line="8"><span style="--shiki-default:#E6E6E6">  in.src_port </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#E6E6E6"> tcp</span><span style="--shiki-default:#D4D4D4">-&gt;</span><span style="--shiki-default:#E6E6E6">dest;</span><span style="--shiki-default:#6A9955">   // LB destination port same as source port from which it redirected the request to backend
</span></span><span class="line" line="9"><span style="--shiki-default:#E6E6E6">  in.dst_port </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#E6E6E6"> tcp</span><span style="--shiki-default:#D4D4D4">-&gt;</span><span style="--shiki-default:#E6E6E6">source;</span><span style="--shiki-default:#6A9955"> // Client or Backend source port
</span></span><span class="line" line="10"><span style="--shiki-default:#E6E6E6">  in.protocol </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#E6E6E6"> IPPROTO_TCP;</span><span style="--shiki-default:#6A9955"> // TCP protocol
</span></span><span class="line highlight" line="11"><span style="--shiki-default:#569CD6">  struct</span><span style="--shiki-default:#E6E6E6"> endpoint </span><span style="--shiki-default:#D4D4D4">*</span><span style="--shiki-default:#E6E6E6">out </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#DCDCAA"> bpf_map_lookup_elem</span><span style="--shiki-default:#E6E6E6">(</span><span style="--shiki-default:#D4D4D4">&amp;</span><span style="--shiki-default:#9CDCFE">conntrack</span><span style="--shiki-default:#E6E6E6">, </span><span style="--shiki-default:#D4D4D4">&amp;</span><span style="--shiki-default:#9CDCFE">in</span><span style="--shiki-default:#E6E6E6">);</span><span style="--shiki-default:#6A9955"> // &lt;- returns a NULL!
</span></span><span class="line" line="12"><span style="--shiki-default:#C586C0">  if</span><span style="--shiki-default:#E6E6E6"> (</span><span style="--shiki-default:#D4D4D4">!</span><span style="--shiki-default:#E6E6E6">out) {
</span></span><span class="line" line="13"><span style="--shiki-default:#DCDCAA">    bpf_printk</span><span style="--shiki-default:#E6E6E6">(</span><span style="--shiki-default:#CE9178">"Packet from client because no such connection exists yet"</span><span style="--shiki-default:#E6E6E6">);
</span></span><span class="line" line="14"><span style="--shiki-default:#E6E6E6">    ...
</span></span><span class="line highlight" line="15"><span style="--shiki-default:#6A9955">    // Store connection in the conntrack eBPF map so we can
</span></span><span class="line highlight" line="16"><span style="--shiki-default:#6A9955">    // redirect backends response to the "correct" client
</span></span><span class="line highlight" line="17"><span style="--shiki-default:#569CD6">    struct</span><span style="--shiki-default:#4EC9B0"> five_tuple_t</span><span style="--shiki-default:#E6E6E6"> in_loadbalancer </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#E6E6E6"> {};
</span></span><span class="line highlight" line="18"><span style="--shiki-default:#9CDCFE">    in_loadbalancer</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">src_ip</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#9CDCFE"> ip</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">daddr</span><span style="--shiki-default:#E6E6E6">;</span><span style="--shiki-default:#6A9955">     // LB IP
</span></span><span class="line highlight" line="19"><span style="--shiki-default:#9CDCFE">    in_loadbalancer</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">dst_ip</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#9CDCFE"> backend</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">ip</span><span style="--shiki-default:#E6E6E6">;</span><span style="--shiki-default:#6A9955">   // Backend IP
</span></span><span class="line highlight" line="20"><span style="--shiki-default:#9CDCFE">    in_loadbalancer</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">src_port</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#9CDCFE"> tcp</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">source</span><span style="--shiki-default:#E6E6E6">;</span><span style="--shiki-default:#6A9955"> // Client source port - equal to the LB source port since we don't modify it!
</span></span><span class="line highlight" line="21"><span style="--shiki-default:#9CDCFE">    in_loadbalancer</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">dst_port</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#9CDCFE"> tcp</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">dest</span><span style="--shiki-default:#E6E6E6">;</span><span style="--shiki-default:#6A9955">   // LB destination port
</span></span><span class="line highlight" line="22"><span style="--shiki-default:#9CDCFE">    in_loadbalancer</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">protocol</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#E6E6E6"> IPPROTO_TCP;</span><span style="--shiki-default:#6A9955"> // TCP protocol 
</span></span><span class="line highlight" line="23"><span style="--shiki-default:#569CD6">    struct</span><span style="--shiki-default:#E6E6E6"> endpoint client;
</span></span><span class="line highlight" line="24"><span style="--shiki-default:#9CDCFE">    client</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">ip</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#9CDCFE"> ip</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">saddr</span><span style="--shiki-default:#E6E6E6">;</span><span style="--shiki-default:#6A9955"> // Store Client IP as value in the eBPF map
</span></span><span class="line highlight" line="25"><span style="--shiki-default:#569CD6">    int</span><span style="--shiki-default:#E6E6E6"> ret </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#DCDCAA"> bpf_map_update_elem</span><span style="--shiki-default:#E6E6E6">(</span><span style="--shiki-default:#D4D4D4">&amp;</span><span style="--shiki-default:#E6E6E6">conntrack, </span><span style="--shiki-default:#D4D4D4">&amp;</span><span style="--shiki-default:#E6E6E6">in_loadbalancer, </span><span style="--shiki-default:#D4D4D4">&amp;</span><span style="--shiki-default:#E6E6E6">client, BPF_ANY);
</span></span><span class="line" line="26"><span style="--shiki-default:#E6E6E6">    ...
</span></span><span class="line" line="27"><span style="--shiki-default:#E6E6E6">  } </span><span style="--shiki-default:#C586C0">else</span><span style="--shiki-default:#E6E6E6"> {
</span></span><span class="line" line="28"><span style="--shiki-default:#DCDCAA">    bpf_printk</span><span style="--shiki-default:#E6E6E6">(</span><span style="--shiki-default:#CE9178">"Packet from backend because the connection exists - "
</span></span><span class="line" line="29"><span style="--shiki-default:#CE9178">               "redirecting back to client"</span><span style="--shiki-default:#E6E6E6">);
</span></span><span class="line" line="30"><span style="--shiki-default:#E6E6E6">    ...
</span></span><span class="line" line="31"><span style="--shiki-default:#E6E6E6">  }
</span></span><span class="line" line="32"><span style="--shiki-default:#E6E6E6">  ...
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-4578ab24="" data-v-134dddac=""><span class="sr-only" data-v-134dddac="">Copy to clipboard</span><span class="icon-wrapper" data-v-134dddac=""><svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--ph" style="font-size:18px;" width="1em" height="1em" viewBox="0 0 256 256" data-v-134dddac=""><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"></path></svg></span></button></div><!--]--><p class="prose-p" data-v-b025fb9f=""><!--[-->Well
 skip the low-level details of how the packet is actually rewritten and 
forwarded to the backend (well cover that later). For now, assume the 
packet successfully reaches the backend, and the backend sends a 
response to the load balancer:<!--]--></p><!--[--><div class="highlight-c prose-code" meta="" data-v-4578ab24=""><span class="filename" data-v-4578ab24="">lab/lb.c</span><!--[--><pre class="language-c shiki shiki-themes slack-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#E6E6E6">  ...
</span></span><span class="line" line="2"><span style="--shiki-default:#6A9955">  // Lookup conntrack (connection tracking) information - actually eBPF map
</span></span><span class="line" line="3"><span style="--shiki-default:#6A9955">  // NO EXISTING CONNECTION: client request
</span></span><span class="line" line="4"><span style="--shiki-default:#6A9955">  // EXISTING CONNECTION: backend response
</span></span><span class="line" line="5"><span style="--shiki-default:#569CD6">  struct</span><span style="--shiki-default:#4EC9B0"> five_tuple_t</span><span style="--shiki-default:#E6E6E6"> in </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#E6E6E6"> {};
</span></span><span class="line" line="6"><span style="--shiki-default:#E6E6E6">  in.src_ip </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#E6E6E6"> ip</span><span style="--shiki-default:#D4D4D4">-&gt;</span><span style="--shiki-default:#E6E6E6">daddr;</span><span style="--shiki-default:#6A9955">     // LB destination IP
</span></span><span class="line" line="7"><span style="--shiki-default:#E6E6E6">  in.dst_ip </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#E6E6E6"> ip</span><span style="--shiki-default:#D4D4D4">-&gt;</span><span style="--shiki-default:#E6E6E6">saddr;</span><span style="--shiki-default:#6A9955">     // Client or Backend source IP
</span></span><span class="line" line="8"><span style="--shiki-default:#E6E6E6">  in.src_port </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#E6E6E6"> tcp</span><span style="--shiki-default:#D4D4D4">-&gt;</span><span style="--shiki-default:#E6E6E6">dest;</span><span style="--shiki-default:#6A9955">   // LB destination port same as source port from which it redirected the request to backend
</span></span><span class="line" line="9"><span style="--shiki-default:#E6E6E6">  in.dst_port </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#E6E6E6"> tcp</span><span style="--shiki-default:#D4D4D4">-&gt;</span><span style="--shiki-default:#E6E6E6">source;</span><span style="--shiki-default:#6A9955"> // Client or Backend source port
</span></span><span class="line" line="10"><span style="--shiki-default:#E6E6E6">  in.protocol </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#E6E6E6"> IPPROTO_TCP;</span><span style="--shiki-default:#6A9955"> // TCP protocol
</span></span><span class="line highlight" line="11"><span style="--shiki-default:#569CD6">  struct</span><span style="--shiki-default:#E6E6E6"> endpoint </span><span style="--shiki-default:#D4D4D4">*</span><span style="--shiki-default:#E6E6E6">out </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#DCDCAA"> bpf_map_lookup_elem</span><span style="--shiki-default:#E6E6E6">(</span><span style="--shiki-default:#D4D4D4">&amp;</span><span style="--shiki-default:#9CDCFE">conntrack</span><span style="--shiki-default:#E6E6E6">, </span><span style="--shiki-default:#D4D4D4">&amp;</span><span style="--shiki-default:#9CDCFE">in</span><span style="--shiki-default:#E6E6E6">);</span><span style="--shiki-default:#6A9955"> // &lt;- returns the client endpoint because the connection exist!
</span></span><span class="line" line="12"><span style="--shiki-default:#C586C0">  if</span><span style="--shiki-default:#E6E6E6"> (</span><span style="--shiki-default:#D4D4D4">!</span><span style="--shiki-default:#E6E6E6">out) {
</span></span><span class="line" line="13"><span style="--shiki-default:#DCDCAA">    bpf_printk</span><span style="--shiki-default:#E6E6E6">(</span><span style="--shiki-default:#CE9178">"Packet from client because no such connection exists yet"</span><span style="--shiki-default:#E6E6E6">);
</span></span><span class="line" line="14"><span style="--shiki-default:#E6E6E6">    ...
</span></span><span class="line" line="15"><span style="--shiki-default:#6A9955">    // Store connection in the conntrack eBPF map so we can
</span></span><span class="line" line="16"><span style="--shiki-default:#6A9955">    // redirect backends response to the "correct" client
</span></span><span class="line" line="17"><span style="--shiki-default:#569CD6">    struct</span><span style="--shiki-default:#4EC9B0"> five_tuple_t</span><span style="--shiki-default:#E6E6E6"> in_loadbalancer </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#E6E6E6"> {};
</span></span><span class="line" line="18"><span style="--shiki-default:#9CDCFE">    in_loadbalancer</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">src_ip</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#9CDCFE"> ip</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">daddr</span><span style="--shiki-default:#E6E6E6">;</span><span style="--shiki-default:#6A9955">     // LB IP
</span></span><span class="line" line="19"><span style="--shiki-default:#9CDCFE">    in_loadbalancer</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">dst_ip</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#9CDCFE"> backend</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">ip</span><span style="--shiki-default:#E6E6E6">;</span><span style="--shiki-default:#6A9955">   // Backend IP
</span></span><span class="line" line="20"><span style="--shiki-default:#9CDCFE">    in_loadbalancer</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">src_port</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#9CDCFE"> tcp</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">source</span><span style="--shiki-default:#E6E6E6">;</span><span style="--shiki-default:#6A9955"> // Client source port - equal to the LB source port since we don't modify it!
</span></span><span class="line" line="21"><span style="--shiki-default:#9CDCFE">    in_loadbalancer</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">dst_port</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#9CDCFE"> tcp</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">dest</span><span style="--shiki-default:#E6E6E6">;</span><span style="--shiki-default:#6A9955">   // LB destination port
</span></span><span class="line" line="22"><span style="--shiki-default:#9CDCFE">    in_loadbalancer</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">protocol</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#E6E6E6"> IPPROTO_TCP;</span><span style="--shiki-default:#6A9955"> // TCP protocol 
</span></span><span class="line" line="23"><span style="--shiki-default:#569CD6">    struct</span><span style="--shiki-default:#E6E6E6"> endpoint client;
</span></span><span class="line" line="24"><span style="--shiki-default:#9CDCFE">    client</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">ip</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#9CDCFE"> ip</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">saddr</span><span style="--shiki-default:#E6E6E6">;</span><span style="--shiki-default:#6A9955"> // Store Client IP as value in the eBPF map
</span></span><span class="line" line="25"><span style="--shiki-default:#569CD6">    int</span><span style="--shiki-default:#E6E6E6"> ret </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#DCDCAA"> bpf_map_update_elem</span><span style="--shiki-default:#E6E6E6">(</span><span style="--shiki-default:#D4D4D4">&amp;</span><span style="--shiki-default:#E6E6E6">conntrack, </span><span style="--shiki-default:#D4D4D4">&amp;</span><span style="--shiki-default:#E6E6E6">in_loadbalancer, </span><span style="--shiki-default:#D4D4D4">&amp;</span><span style="--shiki-default:#E6E6E6">client, BPF_ANY);
</span></span><span class="line" line="26"><span style="--shiki-default:#E6E6E6">    ...
</span></span><span class="line highlight" line="27"><span style="--shiki-default:#E6E6E6">  } </span><span style="--shiki-default:#C586C0">else</span><span style="--shiki-default:#E6E6E6"> {
</span></span><span class="line highlight" line="28"><span style="--shiki-default:#DCDCAA">    bpf_printk</span><span style="--shiki-default:#E6E6E6">(</span><span style="--shiki-default:#CE9178">"Packet from backend because the connection exists - "
</span></span><span class="line highlight" line="29"><span style="--shiki-default:#CE9178">               "redirecting back to client"</span><span style="--shiki-default:#E6E6E6">);
</span></span><span class="line highlight" line="30"><span style="--shiki-default:#E6E6E6">    ...
</span></span><span class="line" line="31"><span style="--shiki-default:#E6E6E6">  }
</span></span><span class="line" line="32"><span style="--shiki-default:#E6E6E6">  ...
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-4578ab24="" data-v-134dddac=""><span class="sr-only" data-v-134dddac="">Copy to clipboard</span><span class="icon-wrapper" data-v-134dddac=""><svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--ph" style="font-size:18px;" width="1em" height="1em" viewBox="0 0 256 256" data-v-134dddac=""><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"></path></svg></span></button></div><!--]--><p class="prose-p" data-v-b025fb9f=""><!--[-->We
 can now see the full flow  how the clients initial request creates an
 entry in the eBPF map (our NAT table) and how the load balancer, on 
the backends response, retrieves that entry to identify the client that
 made the request.<!--]--></p><!--]--></details><!--]--></div><div class="border-[2px] my-[24px] px-6 py-0 rounded-lg border-warning bg-[#fdeee5]"><!--[--><p class="prose-p" data-v-b025fb9f=""><!--[-->
 For simplicity, this load balancer implementation only takes TCP 
connections into account, although UDP could easily be added.<!--]--></p><p class="prose-p" data-v-b025fb9f=""><!--[-->Im also intentionally hiding some parts of the code (<code class="prose-code-inline" data-v-a031129a=""><!--[-->...<!--]--></code> symbol), since well cover them later. Open the full code in terminal if you want to jump ahead.<!--]--></p><!--]--></div><p class="prose-p" data-v-b025fb9f=""><!--[-->Theres
 that, but this isnt really load balancing, because we still havent 
mentioned how the load balancer decides which backend to redirect the 
traffic to  nonetheless, there could be many.<!--]--></p><h2 id="load-balancing" class="prose-h2" data-v-b9b1576a=""><!--[-->Load Balancing<!--]--><!----></h2><p class="prose-p" data-v-b025fb9f=""><!--[-->When it comes to load balancing, there are many algorithms that suit different uses cases better or worse. Just to name a few:<!--]--></p><ul class="prose-ul" data-v-533e29f3=""><!--[--><li class="prose-li" data-v-2969431c=""><!--[--><strong class="prose-strong" data-v-24022f14=""><!--[-->Round Robin<!--]--></strong>  Distributes requests sequentially across all servers in order, cycling back to the first when it reaches the last.<!--]--></li><li class="prose-li" data-v-2969431c=""><!--[--><strong class="prose-strong" data-v-24022f14=""><!--[-->Weighted Round Robin<!--]--></strong>  Assigns more requests to certain backend servers using predefined weights.<!--]--></li><li class="prose-li" data-v-2969431c=""><!--[--><strong class="prose-strong" data-v-24022f14=""><!--[-->Least Connections<!--]--></strong>  Sends new requests to the server with the fewest active connections, balancing uneven workloads efficiently.<!--]--></li><li class="prose-li" data-v-2969431c=""><!--[--><strong class="prose-strong" data-v-24022f14=""><!--[-->Hashing<!--]--></strong>
  Maps requests to backend servers by hashing a 5-tuple ensuring client
 always communicates with the same backend (session affinity)<!--]--></li><li class="prose-li" data-v-2969431c=""><!--[-->and many others..<!--]--></li><!--]--></ul><p class="prose-p" data-v-b025fb9f=""><!--[-->The
 simplest one is obviously round-robin, but I want to make this tutorial
 a bit more interesting and instead show you how to implement simple 
hashing, so we can see how session affinity can be achieved.<!--]--></p><div class="border-[2px] my-[24px] px-6 py-0 rounded-lg border-primary/50 bg-[#f7fbfe]" data-v-370f298d=""><!--[--><details data-v-370f298d=""><summary class="cursor-pointer my-3 select-none text-[#4078c0]" data-v-370f298d="">What is session affinity and why is it important?</summary><!--[--><p class="prose-p" data-v-b025fb9f=""><!--[-->Session affinity (also known as sticky sessions) ensures that <strong class="prose-strong" data-v-24022f14=""><!--[-->all requests from the same client are consistently routed to the same backend server<!--]--></strong>.<!--]--></p><p class="prose-p" data-v-b025fb9f=""><!--[-->This
 is important when a backend stores session-specific data in memory, 
since switching between servers would cause the session state to be lost
 or require complex synchronization.<!--]--></p><p class="prose-p" data-v-b025fb9f=""><!--[-->Typical examples include:<!--]--></p><ul class="prose-ul" data-v-533e29f3=""><!--[--><li class="prose-li" data-v-2969431c=""><!--[-->Web applications that store user sessions or authentication data locally on the server.<!--]--></li><li class="prose-li" data-v-2969431c=""><!--[-->Shopping carts or payment flows where in-memory context must persist across multiple requests.<!--]--></li><li class="prose-li" data-v-2969431c=""><!--[-->Real-time applications like chat or gaming servers maintaining a persistent TCP session.<!--]--></li><!--]--></ul><p class="prose-p" data-v-b025fb9f=""><!--[-->Without
 session affinity, these requests could be sent to different backends, 
breaking continuity or forcing costly session synchronization.<!--]--></p><!--]--></details><!--]--></div><p class="prose-p" data-v-b025fb9f=""><!--[--><strong class="prose-strong" data-v-24022f14=""><!--[-->But now someone might ask  how on earth is hashing related to load balancing or routing in general?<!--]--></strong><!--]--></p><p class="prose-p" data-v-b025fb9f=""><!--[-->Heres
 where it gets interesting: we already learned that every client 
connection to a load balancer has a unique 5-tuple  source IP, 
destination IP, source port, destination port, and protocol  meaning a 
hash of this 5-tuple will always give us a unique numeric value.<!--]--></p><p class="prose-p" data-v-b025fb9f=""><!--[-->But not only that  it will always produce the same hash for the same 5-tuple.<!--]--></p><p class="prose-p" data-v-b025fb9f=""><!--[-->By
 mapping that hash to a range of keys in an eBPF map containing backend 
endpoints, the load balancer can deterministically select a backend and 
route the traffic there (same hash  same backend).<!--]--></p><p class="prose-p" data-v-b025fb9f=""><!--[-->Here's an image to illustrate this concept.<!--]--></p><div class="bg-base-100" style="padding:0;margin:30px auto;max-width:700px;"><div class="text-center"><img src="Building%20an%20eBPF_XDP%20NAT-Based%20Layer%204%20Load%20Balancer%20from%20Scratch_files/hashing.webp" alt="5-Tuple hash to Backend" class="cursor-pointer m-0 max-w-full" style=""><!--[--><!--]--></div><!----></div><p class="prose-p" data-v-b025fb9f=""><!--[-->There are different hashing algorithms we can choose from like <strong class="prose-strong" data-v-24022f14=""><!--[-->MurmurHash<!--]--></strong>, <strong class="prose-strong" data-v-24022f14=""><!--[-->Jenkins Hash<!--]--></strong>, <strong class="prose-strong" data-v-24022f14=""><!--[-->xxHash<!--]--></strong> and <strong class="prose-strong" data-v-24022f14=""><!--[-->FNV-1a (FowlerNollVo hash)<!--]--></strong>, which differ in speed, collision resistance, and how evenly they distribute values.<!--]--></p><p class="prose-p" data-v-b025fb9f=""><!--[-->But this isnt a math course, so I just implemented <strong class="prose-strong" data-v-24022f14=""><!--[-->FNV-1a<!--]--></strong> algorithm.<!--]--></p><!--[--><div class="highlight-c prose-code" meta="" data-v-4578ab24=""><span class="filename" data-v-4578ab24="">lab/lb.c</span><!--[--><pre class="language-c shiki shiki-themes slack-dark" style=""><!--[--><code><span class="line highlight" line="1"><span style="--shiki-default:#6A9955">// FNV-1a hash implementation for load balancing
</span></span><span class="line highlight" line="2"><span style="--shiki-default:#569CD6">static</span><span style="--shiki-default:#E6E6E6"> __always_inline __u32 </span><span style="--shiki-default:#DCDCAA">xdp_hash_tuple</span><span style="--shiki-default:#E6E6E6">(</span><span style="--shiki-default:#569CD6">struct</span><span style="--shiki-default:#4EC9B0"> five_tuple_t</span><span style="--shiki-default:#D4D4D4"> *</span><span style="--shiki-default:#9CDCFE">tuple</span><span style="--shiki-default:#E6E6E6">) {
</span></span><span class="line highlight" line="3"><span style="--shiki-default:#E6E6E6">  __u32 hash </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#B5CEA8"> 2166136261U</span><span style="--shiki-default:#E6E6E6">;
</span></span><span class="line highlight" line="4"><span style="--shiki-default:#E6E6E6">  hash </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#E6E6E6"> (hash </span><span style="--shiki-default:#D4D4D4">^</span><span style="--shiki-default:#9CDCFE"> tuple</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">src_ip</span><span style="--shiki-default:#E6E6E6">) </span><span style="--shiki-default:#D4D4D4">*</span><span style="--shiki-default:#B5CEA8"> 16777619U</span><span style="--shiki-default:#E6E6E6">;
</span></span><span class="line highlight" line="5"><span style="--shiki-default:#E6E6E6">  hash </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#E6E6E6"> (hash </span><span style="--shiki-default:#D4D4D4">^</span><span style="--shiki-default:#9CDCFE"> tuple</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">dst_ip</span><span style="--shiki-default:#E6E6E6">) </span><span style="--shiki-default:#D4D4D4">*</span><span style="--shiki-default:#B5CEA8"> 16777619U</span><span style="--shiki-default:#E6E6E6">;
</span></span><span class="line highlight" line="6"><span style="--shiki-default:#E6E6E6">  hash </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#E6E6E6"> (hash </span><span style="--shiki-default:#D4D4D4">^</span><span style="--shiki-default:#9CDCFE"> tuple</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">src_port</span><span style="--shiki-default:#E6E6E6">) </span><span style="--shiki-default:#D4D4D4">*</span><span style="--shiki-default:#B5CEA8"> 16777619U</span><span style="--shiki-default:#E6E6E6">;
</span></span><span class="line highlight" line="7"><span style="--shiki-default:#E6E6E6">  hash </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#E6E6E6"> (hash </span><span style="--shiki-default:#D4D4D4">^</span><span style="--shiki-default:#9CDCFE"> tuple</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">dst_port</span><span style="--shiki-default:#E6E6E6">) </span><span style="--shiki-default:#D4D4D4">*</span><span style="--shiki-default:#B5CEA8"> 16777619U</span><span style="--shiki-default:#E6E6E6">;
</span></span><span class="line highlight" line="8"><span style="--shiki-default:#E6E6E6">  hash </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#E6E6E6"> (hash </span><span style="--shiki-default:#D4D4D4">^</span><span style="--shiki-default:#9CDCFE"> tuple</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">protocol</span><span style="--shiki-default:#E6E6E6">) </span><span style="--shiki-default:#D4D4D4">*</span><span style="--shiki-default:#B5CEA8"> 16777619U</span><span style="--shiki-default:#E6E6E6">;
</span></span><span class="line highlight" line="9"><span style="--shiki-default:#C586C0">  return</span><span style="--shiki-default:#E6E6E6"> hash;
</span></span><span class="line highlight" line="10"><span style="--shiki-default:#E6E6E6">}
</span></span><span class="line" line="11"><span emptylineplaceholder="true">
</span></span><span class="line highlight" line="12"><span style="--shiki-default:#6A9955">// Backends eBPF Map populated from user space
</span></span><span class="line highlight" line="13"><span style="--shiki-default:#569CD6">struct</span><span style="--shiki-default:#E6E6E6"> {
</span></span><span class="line highlight" line="14"><span style="--shiki-default:#DCDCAA">  __uint</span><span style="--shiki-default:#E6E6E6">(type, BPF_MAP_TYPE_ARRAY);
</span></span><span class="line highlight" line="15"><span style="--shiki-default:#DCDCAA">  __uint</span><span style="--shiki-default:#E6E6E6">(max_entries, NUM_BACKENDS);
</span></span><span class="line highlight" line="16"><span style="--shiki-default:#DCDCAA">  __type</span><span style="--shiki-default:#E6E6E6">(key, __u32);
</span></span><span class="line highlight" line="17"><span style="--shiki-default:#DCDCAA">  __type</span><span style="--shiki-default:#E6E6E6">(value, </span><span style="--shiki-default:#569CD6">struct</span><span style="--shiki-default:#E6E6E6"> endpoint);
</span></span><span class="line highlight" line="18"><span style="--shiki-default:#E6E6E6">} backends </span><span style="--shiki-default:#DCDCAA">SEC</span><span style="--shiki-default:#E6E6E6">(</span><span style="--shiki-default:#CE9178">".maps"</span><span style="--shiki-default:#E6E6E6">);
</span></span><span class="line" line="19"><span emptylineplaceholder="true">
</span></span><span class="line" line="20"><span style="--shiki-default:#DCDCAA">SEC</span><span style="--shiki-default:#E6E6E6">(</span><span style="--shiki-default:#CE9178">"xdp"</span><span style="--shiki-default:#E6E6E6">)
</span></span><span class="line" line="21"><span style="--shiki-default:#569CD6">int</span><span style="--shiki-default:#DCDCAA"> xdp_load_balancer</span><span style="--shiki-default:#E6E6E6">(</span><span style="--shiki-default:#569CD6">struct</span><span style="--shiki-default:#E6E6E6"> xdp_md </span><span style="--shiki-default:#D4D4D4">*</span><span style="--shiki-default:#9CDCFE">ctx</span><span style="--shiki-default:#E6E6E6">) {
</span></span><span class="line" line="22"><span style="--shiki-default:#E6E6E6">  ...
</span></span><span class="line" line="23"><span style="--shiki-default:#C586C0">  if</span><span style="--shiki-default:#E6E6E6"> (</span><span style="--shiki-default:#D4D4D4">!</span><span style="--shiki-default:#E6E6E6">out) {
</span></span><span class="line" line="24"><span style="--shiki-default:#DCDCAA">    bpf_printk</span><span style="--shiki-default:#E6E6E6">(</span><span style="--shiki-default:#CE9178">"Packet from client because no such connection exists yet"</span><span style="--shiki-default:#E6E6E6">);
</span></span><span class="line" line="25"><span emptylineplaceholder="true">
</span></span><span class="line highlight" line="26"><span style="--shiki-default:#6A9955">    // Choose backend using simple hashing
</span></span><span class="line highlight" line="27"><span style="--shiki-default:#569CD6">    struct</span><span style="--shiki-default:#4EC9B0"> five_tuple_t</span><span style="--shiki-default:#E6E6E6"> five_tuple </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#E6E6E6"> {};
</span></span><span class="line highlight" line="28"><span style="--shiki-default:#9CDCFE">    five_tuple</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">src_ip</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#9CDCFE"> ip</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">saddr</span><span style="--shiki-default:#E6E6E6">;
</span></span><span class="line highlight" line="29"><span style="--shiki-default:#9CDCFE">    five_tuple</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">dst_ip</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#9CDCFE"> ip</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">daddr</span><span style="--shiki-default:#E6E6E6">;
</span></span><span class="line highlight" line="30"><span style="--shiki-default:#9CDCFE">    five_tuple</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">src_port</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#9CDCFE"> tcp</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">source</span><span style="--shiki-default:#E6E6E6">;
</span></span><span class="line highlight" line="31"><span style="--shiki-default:#9CDCFE">    five_tuple</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">dst_port</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#9CDCFE"> tcp</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">dest</span><span style="--shiki-default:#E6E6E6">;
</span></span><span class="line highlight" line="32"><span style="--shiki-default:#9CDCFE">    five_tuple</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">protocol</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#E6E6E6"> IPPROTO_TCP;
</span></span><span class="line highlight" line="33"><span style="--shiki-default:#6A9955">    // Hash the 5-tuple for persistent backend routing and
</span></span><span class="line highlight" line="34"><span style="--shiki-default:#6A9955">    // perform modulo with the number of backends (NUM_BACKENDS=2 hardcoded for simplicity)
</span></span><span class="line highlight" line="35"><span style="--shiki-default:#E6E6E6">    __u32 key </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#DCDCAA"> xdp_hash_tuple</span><span style="--shiki-default:#E6E6E6">(</span><span style="--shiki-default:#D4D4D4">&amp;</span><span style="--shiki-default:#E6E6E6">five_tuple) </span><span style="--shiki-default:#D4D4D4">%</span><span style="--shiki-default:#E6E6E6"> NUM_BACKENDS;
</span></span><span class="line highlight" line="36"><span style="--shiki-default:#6A9955">    // Lookup calculated key and retrieve the backend endpoint information
</span></span><span class="line highlight" line="37"><span style="--shiki-default:#569CD6">    struct</span><span style="--shiki-default:#E6E6E6"> endpoint </span><span style="--shiki-default:#D4D4D4">*</span><span style="--shiki-default:#E6E6E6">backend </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#DCDCAA"> bpf_map_lookup_elem</span><span style="--shiki-default:#E6E6E6">(</span><span style="--shiki-default:#D4D4D4">&amp;</span><span style="--shiki-default:#E6E6E6">backends, </span><span style="--shiki-default:#D4D4D4">&amp;</span><span style="--shiki-default:#E6E6E6">key);
</span></span><span class="line" line="38"><span style="--shiki-default:#E6E6E6">    ...
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-4578ab24="" data-v-134dddac=""><span class="sr-only" data-v-134dddac="">Copy to clipboard</span><span class="icon-wrapper" data-v-134dddac=""><svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--ph" style="font-size:18px;" width="1em" height="1em" viewBox="0 0 256 256" data-v-134dddac=""><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"></path></svg></span></button></div><!--]--><div class="border-[2px] my-[24px] px-6 py-0 rounded-lg border-primary/50 bg-[#f7fbfe]"><!--[--><p class="prose-p" data-v-b025fb9f=""><!--[--> Ideally, wed continuously monitor backend node health and update the <code class="prose-code-inline" data-v-a031129a=""><!--[-->backends<!--]--></code> eBPF map accordingly, but for simplicity, we assume no nodes are added or removed to keep this demo code lean.<!--]--></p><!--]--></div><div class="border-[2px] my-[24px] px-6 py-0 rounded-lg border-warning bg-[#fdeee5]"><!--[--><p class="prose-p" data-v-b025fb9f=""><!--[-->
 For simplicity, we also dont redirect client requests to specific 
backend ports. Instead, we assume that both the load balancer and the 
backends listen on the same port for incoming requests.<!--]--></p><!--]--></div><p class="prose-p" data-v-b025fb9f=""><!--[-->Now
 we see how both NAT and simple hashing fit neatly into the 
load-balancing logic  but we still need to rewrite the network packets
 IP header and MAC addresses.<!--]--></p><p class="prose-p" data-v-b025fb9f=""><!--[-->This
 is necessary because after the clients request passes through the load
 balancer, the packets original source and destination no longer match 
the actual source. Without rewriting these headers, the backend would 
see the load balancer as the destination and the client as the source, 
and drop the packet.<!--]--></p><h2 id="rewriting-ip-and-mac-addresses" class="prose-h2" data-v-b9b1576a=""><!--[-->Rewriting IP and MAC Addresses<!--]--><!----></h2><p class="prose-p" data-v-b025fb9f=""><!--[-->Updating
 the packet headers in load balancer logic ensures that each node along 
the path  client, load balancer, and backend  can correctly send and 
receive packets as if they were just talking to a peer node.<!--]--></p><p class="prose-p" data-v-b025fb9f=""><!--[-->For
 this proof of concept, we could technically rewrite the MAC addresses 
quite easily  by hardcoding the load balancers MAC address directly in
 our eBPF program and storing the backend MAC address beside the IP in 
the <code class="prose-code-inline" data-v-a031129a=""><!--[-->backends<!--]--></code> eBPF map.<!--]--></p><p class="prose-p" data-v-b025fb9f=""><!--[-->But why hardcode this information when it already exists in the kernels tables, such as the <strong class="prose-strong" data-v-24022f14=""><!--[-->FIB (Forwarding Information Base)<!--]--></strong> and <strong class="prose-strong" data-v-24022f14=""><!--[-->ARP<!--]--></strong> (or <strong class="prose-strong" data-v-24022f14=""><!--[-->NDP<!--]--></strong> for IPv6)?<!--]--></p><!--[--><div class="highlight-bash prose-code" meta="" data-v-4578ab24=""><!----><!--[--><pre class="language-bash shiki shiki-themes slack-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#DCDCAA">ip</span><span style="--shiki-default:#CE9178"> route</span><span style="--shiki-default:#CE9178"> show</span><span style="--shiki-default:#6A9955">   # Displays the kernel routing table  where to send traffic to reach different destinations
</span></span><span class="line" line="2"><span style="--shiki-default:#DCDCAA">ip</span><span style="--shiki-default:#CE9178"> neigh</span><span style="--shiki-default:#CE9178"> show</span><span style="--shiki-default:#6A9955">   # Displays the ARP table mapping IP addresses to MAC addresses
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-4578ab24="" data-v-134dddac=""><span class="sr-only" data-v-134dddac="">Copy to clipboard</span><span class="icon-wrapper" data-v-134dddac=""><svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--ph" style="font-size:18px;" width="1em" height="1em" viewBox="0 0 256 256" data-v-134dddac=""><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"></path></svg></span></button></div><!--]--><p class="prose-p" data-v-b025fb9f=""><!--[-->So ideally, we would somehow simply query the kernel tables from eBPF like:<!--]--></p><blockquote class="prose-blockquote" data-v-5c66202a=""><!--[--><p class="prose-p" data-v-b025fb9f=""><!--[-->How do I reach this node?<br>
 Use this interface, MAC addresses, and IPs (or possibly this next hop).<!--]--></p><!--]--></blockquote><p class="prose-p" data-v-b025fb9f=""><!--[-->And indeed, we can do exactly that using the <a href="https://docs.ebpf.io/linux/helper-function/bpf_fib_lookup/" rel="nofollow" target="_blank" class="prose-a" data-v-abeb6555=""><!--[--><code class="prose-code-inline" data-v-a031129a=""><!--[-->bpf_fib_lookup()<!--]--></code><!--]--><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="h-[1rem] inline ml-[1px] pb-[5px] stroke-[2px] w-[1rem]" data-v-abeb6555=""><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 0 0 3 8.25v10.5A2.25 2.25 0 0 0 5.25 21h10.5A2.25 2.25 0 0 0 18 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25"></path></svg></a> helper function.<!--]--></p><p class="prose-p" data-v-b025fb9f=""><!--[-->In our NAT load balancer implementation, <code class="prose-code-inline" data-v-a031129a=""><!--[-->bpf_fib_lookup()<!--]--></code>
 first queries the kernels routing table to determine where a packet 
should be forwarded, based on the device on which it was received and 
its source and destination IP addresses. If the lookup succeeds, the 
kernel then consults the neighbor tables (ARP for IPv4) to resolve the 
appropriate MAC addresses.<!--]--></p><div class="border-[2px] my-[24px] px-6 py-0 rounded-lg border-primary/50 bg-[#f7fbfe]" data-v-370f298d=""><!--[--><details data-v-370f298d=""><summary class="cursor-pointer my-3 select-none text-[#4078c0]" data-v-370f298d="">More information about `bpf_fib_lookup()` helper</summary><!--[--><p class="prose-p" data-v-b025fb9f=""><!--[-->If you look at the <a href="https://docs.ebpf.io/linux/helper-function/bpf_fib_lookup/" rel="nofollow" target="_blank" class="prose-a" data-v-abeb6555=""><!--[-->documentation for <code class="prose-code-inline" data-v-a031129a=""><!--[-->bpf_fib_lookup()<!--]--></code><!--]--><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="h-[1rem] inline ml-[1px] pb-[5px] stroke-[2px] w-[1rem]" data-v-abeb6555=""><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 0 0 3 8.25v10.5A2.25 2.25 0 0 0 5.25 21h10.5A2.25 2.25 0 0 0 18 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25"></path></svg></a>, youll notice that you can provide different <code class="prose-code-inline" data-v-a031129a=""><!--[-->flags<!--]--></code> as input arguments that determine the behavior of this helper.<!--]--></p><p class="prose-p" data-v-b025fb9f=""><!--[-->For example:<!--]--></p><ul class="prose-ul" data-v-533e29f3=""><!--[--><li class="prose-li" data-v-2969431c=""><!--[--><code class="prose-code-inline" data-v-a031129a=""><!--[-->BPF_FIB_LOOKUP_OUTPUT<!--]--></code>
  Treat the packet as if its leaving the interface, instead of 
arriving on it (the default). This matters when your routing selection 
depends on <code class="prose-code-inline" data-v-a031129a=""><!--[-->iif<!--]--></code>/<code class="prose-code-inline" data-v-a031129a=""><!--[-->oif<!--]--></code> IP rules.<!--]--></li><li class="prose-li" data-v-2969431c=""><!--[-->Combination of <code class="prose-code-inline" data-v-a031129a=""><!--[-->BPF_FIB_LOOKUP_TBID<!--]--></code> and <code class="prose-code-inline" data-v-a031129a=""><!--[-->BPF_FIB_LOOKUP_DIRECT<!--]--></code>
  Bypass IP rules and perform a direct lookup in a specified routing 
table. Its faster but not ideal if routing should follow IP rules.<!--]--></li><li class="prose-li" data-v-2969431c=""><!--[--><code class="prose-code-inline" data-v-a031129a=""><!--[-->BPF_FIB_LOOKUP_SKIP_NEIGH<!--]--></code> - Query only the kernels routing tables and skip the neighbor table lookup.<!--]--></li><!--]--></ul><p class="prose-p" data-v-b025fb9f=""><!--[-->There are other special flags, but it's best to check the official documentation for the most up-to-date list and exact names.<!--]--></p><!--]--></details><!--]--></div><!--[--><div class="highlight-c prose-code" meta="" data-v-4578ab24=""><span class="filename" data-v-4578ab24="">lab/lb.c</span><!--[--><pre class="language-c shiki shiki-themes slack-dark" style=""><!--[--><code><span class="line highlight" line="1"><span style="--shiki-default:#569CD6">static</span><span style="--shiki-default:#E6E6E6"> __always_inline </span><span style="--shiki-default:#569CD6">int</span><span style="--shiki-default:#DCDCAA"> fib_lookup_v4_full</span><span style="--shiki-default:#E6E6E6">(</span><span style="--shiki-default:#569CD6">struct</span><span style="--shiki-default:#E6E6E6"> xdp_md </span><span style="--shiki-default:#D4D4D4">*</span><span style="--shiki-default:#9CDCFE">ctx</span><span style="--shiki-default:#E6E6E6">,
</span></span><span class="line highlight" line="2"><span style="--shiki-default:#569CD6">                                              struct</span><span style="--shiki-default:#E6E6E6"> bpf_fib_lookup </span><span style="--shiki-default:#D4D4D4">*</span><span style="--shiki-default:#9CDCFE">fib</span><span style="--shiki-default:#E6E6E6">,
</span></span><span class="line highlight" line="3"><span style="--shiki-default:#E6E6E6">                                              __u32 </span><span style="--shiki-default:#9CDCFE">src</span><span style="--shiki-default:#E6E6E6">, __u32 </span><span style="--shiki-default:#9CDCFE">dst</span><span style="--shiki-default:#E6E6E6">,
</span></span><span class="line highlight" line="4"><span style="--shiki-default:#E6E6E6">                                              __u16 </span><span style="--shiki-default:#9CDCFE">tot_len</span><span style="--shiki-default:#E6E6E6">) {
</span></span><span class="line highlight" line="5"><span style="--shiki-default:#6A9955">  // Zero and populate only what a full lookup needs
</span></span><span class="line highlight" line="6"><span style="--shiki-default:#DCDCAA">  __builtin_memset</span><span style="--shiki-default:#E6E6E6">(fib, </span><span style="--shiki-default:#B5CEA8">0</span><span style="--shiki-default:#E6E6E6">, </span><span style="--shiki-default:#569CD6">sizeof</span><span style="--shiki-default:#E6E6E6">(</span><span style="--shiki-default:#D4D4D4">*</span><span style="--shiki-default:#E6E6E6">fib));
</span></span><span class="line highlight" line="7"><span style="--shiki-default:#6A9955">  // Hardcode address family: AF_INET for IPv4
</span></span><span class="line highlight" line="8"><span style="--shiki-default:#9CDCFE">  fib</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">family</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#E6E6E6"> AF_INET;
</span></span><span class="line highlight" line="9"><span style="--shiki-default:#6A9955">  // Source IPv4 address used by the kernel for policy routing and source
</span></span><span class="line highlight" line="10"><span style="--shiki-default:#6A9955">  // addressbased decisions
</span></span><span class="line highlight" line="11"><span style="--shiki-default:#9CDCFE">  fib</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">ipv4_src</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#E6E6E6"> src;
</span></span><span class="line highlight" line="12"><span style="--shiki-default:#6A9955">  // Destination IPv4 address (in network byte order)
</span></span><span class="line highlight" line="13"><span style="--shiki-default:#6A9955">  // The address we want to reach; used to find the correct egress route
</span></span><span class="line highlight" line="14"><span style="--shiki-default:#9CDCFE">  fib</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">ipv4_dst</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#E6E6E6"> dst;
</span></span><span class="line highlight" line="15"><span style="--shiki-default:#6A9955">  // Hardcoded Layer 4 protocol: TCP, UDP, ICMP
</span></span><span class="line highlight" line="16"><span style="--shiki-default:#9CDCFE">  fib</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">l4_protocol</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#E6E6E6"> IPPROTO_TCP;
</span></span><span class="line highlight" line="17"><span style="--shiki-default:#6A9955">  // Total length of the IPv4 packet (header + payload)
</span></span><span class="line highlight" line="18"><span style="--shiki-default:#9CDCFE">  fib</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">tot_len</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#E6E6E6"> tot_len;
</span></span><span class="line highlight" line="19"><span style="--shiki-default:#6A9955">  // Interface for the lookup
</span></span><span class="line highlight" line="20"><span style="--shiki-default:#9CDCFE">  fib</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">ifindex</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#9CDCFE"> ctx</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">ingress_ifindex</span><span style="--shiki-default:#E6E6E6">;
</span></span><span class="line highlight" line="21"><span style="--shiki-default:#C586C0">  return</span><span style="--shiki-default:#DCDCAA"> bpf_fib_lookup</span><span style="--shiki-default:#E6E6E6">(ctx, fib, </span><span style="--shiki-default:#569CD6">sizeof</span><span style="--shiki-default:#E6E6E6">(</span><span style="--shiki-default:#D4D4D4">*</span><span style="--shiki-default:#E6E6E6">fib), </span><span style="--shiki-default:#B5CEA8">0</span><span style="--shiki-default:#E6E6E6">);
</span></span><span class="line highlight" line="22"><span style="--shiki-default:#E6E6E6">}
</span></span><span class="line" line="23"><span emptylineplaceholder="true">
</span></span><span class="line" line="24"><span style="--shiki-default:#DCDCAA">SEC</span><span style="--shiki-default:#E6E6E6">(</span><span style="--shiki-default:#CE9178">"xdp"</span><span style="--shiki-default:#E6E6E6">)
</span></span><span class="line highlight" line="25"><span style="--shiki-default:#569CD6">int</span><span style="--shiki-default:#DCDCAA"> xdp_load_balancer</span><span style="--shiki-default:#E6E6E6">(</span><span style="--shiki-default:#569CD6">struct</span><span style="--shiki-default:#E6E6E6"> xdp_md </span><span style="--shiki-default:#D4D4D4">*</span><span style="--shiki-default:#9CDCFE">ctx</span><span style="--shiki-default:#E6E6E6">) {
</span></span><span class="line highlight" line="26"><span style="--shiki-default:#E6E6E6">  ...
</span></span><span class="line highlight" line="27"><span style="--shiki-default:#6A9955">  // Store Load Balancer IP for later
</span></span><span class="line highlight" line="28"><span style="--shiki-default:#E6E6E6">  __u32 lb_ip </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#9CDCFE"> ip</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">daddr</span><span style="--shiki-default:#E6E6E6">;
</span></span><span class="line" line="29"><span emptylineplaceholder="true">
</span></span><span class="line" line="30"><span style="--shiki-default:#569CD6">  struct</span><span style="--shiki-default:#E6E6E6"> bpf_fib_lookup fib </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#E6E6E6"> {};
</span></span><span class="line" line="31"><span style="--shiki-default:#569CD6">  struct</span><span style="--shiki-default:#E6E6E6"> endpoint </span><span style="--shiki-default:#D4D4D4">*</span><span style="--shiki-default:#E6E6E6">out </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#DCDCAA"> bpf_map_lookup_elem</span><span style="--shiki-default:#E6E6E6">(</span><span style="--shiki-default:#D4D4D4">&amp;</span><span style="--shiki-default:#E6E6E6">conntrack, </span><span style="--shiki-default:#D4D4D4">&amp;</span><span style="--shiki-default:#E6E6E6">in);
</span></span><span class="line" line="32"><span style="--shiki-default:#C586C0">  if</span><span style="--shiki-default:#E6E6E6"> (</span><span style="--shiki-default:#D4D4D4">!</span><span style="--shiki-default:#E6E6E6">out) {
</span></span><span class="line" line="33"><span style="--shiki-default:#DCDCAA">    bpf_printk</span><span style="--shiki-default:#E6E6E6">(</span><span style="--shiki-default:#CE9178">"Packet from client because no such connection exists yet"</span><span style="--shiki-default:#E6E6E6">);
</span></span><span class="line" line="34"><span emptylineplaceholder="true">
</span></span><span class="line" line="35"><span style="--shiki-default:#6A9955">    // Choose backend using simple hashing
</span></span><span class="line" line="36"><span style="--shiki-default:#569CD6">    struct</span><span style="--shiki-default:#4EC9B0"> five_tuple_t</span><span style="--shiki-default:#E6E6E6"> five_tuple </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#E6E6E6"> {};
</span></span><span class="line" line="37"><span style="--shiki-default:#9CDCFE">    five_tuple</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">src_ip</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#9CDCFE"> ip</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">saddr</span><span style="--shiki-default:#E6E6E6">;
</span></span><span class="line" line="38"><span style="--shiki-default:#9CDCFE">    five_tuple</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">dst_ip</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#9CDCFE"> ip</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">daddr</span><span style="--shiki-default:#E6E6E6">;
</span></span><span class="line" line="39"><span style="--shiki-default:#9CDCFE">    five_tuple</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">src_port</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#9CDCFE"> tcp</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">source</span><span style="--shiki-default:#E6E6E6">;
</span></span><span class="line" line="40"><span style="--shiki-default:#9CDCFE">    five_tuple</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">dst_port</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#9CDCFE"> tcp</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">dest</span><span style="--shiki-default:#E6E6E6">;
</span></span><span class="line" line="41"><span style="--shiki-default:#9CDCFE">    five_tuple</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">protocol</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#E6E6E6"> IPPROTO_TCP;
</span></span><span class="line" line="42"><span style="--shiki-default:#E6E6E6">    __u32 key </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#DCDCAA"> xdp_hash_tuple</span><span style="--shiki-default:#E6E6E6">(</span><span style="--shiki-default:#D4D4D4">&amp;</span><span style="--shiki-default:#E6E6E6">five_tuple) </span><span style="--shiki-default:#D4D4D4">%</span><span style="--shiki-default:#E6E6E6"> NUM_BACKENDS;
</span></span><span class="line" line="43"><span style="--shiki-default:#569CD6">    struct</span><span style="--shiki-default:#E6E6E6"> endpoint </span><span style="--shiki-default:#D4D4D4">*</span><span style="--shiki-default:#E6E6E6">backend </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#DCDCAA"> bpf_map_lookup_elem</span><span style="--shiki-default:#E6E6E6">(</span><span style="--shiki-default:#D4D4D4">&amp;</span><span style="--shiki-default:#E6E6E6">backends, </span><span style="--shiki-default:#D4D4D4">&amp;</span><span style="--shiki-default:#E6E6E6">key);
</span></span><span class="line" line="44"><span style="--shiki-default:#C586C0">    if</span><span style="--shiki-default:#E6E6E6"> (</span><span style="--shiki-default:#D4D4D4">!</span><span style="--shiki-default:#E6E6E6">backend) {
</span></span><span class="line" line="45"><span style="--shiki-default:#C586C0">      return</span><span style="--shiki-default:#E6E6E6"> XDP_ABORTED;
</span></span><span class="line" line="46"><span style="--shiki-default:#E6E6E6">    }
</span></span><span class="line" line="47"><span emptylineplaceholder="true">
</span></span><span class="line highlight" line="48"><span style="--shiki-default:#6A9955">    // Perform a FIB lookup
</span></span><span class="line highlight" line="49"><span style="--shiki-default:#569CD6">    int</span><span style="--shiki-default:#E6E6E6"> rc </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#DCDCAA"> fib_lookup_v4_full</span><span style="--shiki-default:#E6E6E6">(ctx, </span><span style="--shiki-default:#D4D4D4">&amp;</span><span style="--shiki-default:#E6E6E6">fib, </span><span style="--shiki-default:#9CDCFE">ip</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">daddr</span><span style="--shiki-default:#E6E6E6">, </span><span style="--shiki-default:#9CDCFE">backend</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">ip</span><span style="--shiki-default:#E6E6E6">,
</span></span><span class="line highlight" line="50"><span style="--shiki-default:#DCDCAA">                                bpf_ntohs</span><span style="--shiki-default:#E6E6E6">(</span><span style="--shiki-default:#9CDCFE">ip</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">tot_len</span><span style="--shiki-default:#E6E6E6">));
</span></span><span class="line highlight" line="51"><span style="--shiki-default:#C586C0">    if</span><span style="--shiki-default:#E6E6E6"> (rc </span><span style="--shiki-default:#D4D4D4">!=</span><span style="--shiki-default:#E6E6E6"> BPF_FIB_LKUP_RET_SUCCESS) {
</span></span><span class="line highlight" line="52"><span style="--shiki-default:#DCDCAA">      log_fib_error</span><span style="--shiki-default:#E6E6E6">(rc);
</span></span><span class="line highlight" line="53"><span style="--shiki-default:#C586C0">      return</span><span style="--shiki-default:#E6E6E6"> XDP_ABORTED;
</span></span><span class="line highlight" line="54"><span style="--shiki-default:#E6E6E6">    }
</span></span><span class="line" line="55"><span emptylineplaceholder="true">
</span></span><span class="line" line="56"><span style="--shiki-default:#6A9955">    // Store connection in the conntrack eBPF map
</span></span><span class="line" line="57"><span style="--shiki-default:#569CD6">    struct</span><span style="--shiki-default:#4EC9B0"> five_tuple_t</span><span style="--shiki-default:#E6E6E6"> in_loadbalancer </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#E6E6E6"> {};
</span></span><span class="line" line="58"><span style="--shiki-default:#9CDCFE">    in_loadbalancer</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">src_ip</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#9CDCFE"> ip</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">daddr</span><span style="--shiki-default:#E6E6E6">;
</span></span><span class="line" line="59"><span style="--shiki-default:#9CDCFE">    in_loadbalancer</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">dst_ip</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#9CDCFE"> backend</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">ip</span><span style="--shiki-default:#E6E6E6">;
</span></span><span class="line" line="60"><span style="--shiki-default:#9CDCFE">    in_loadbalancer</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">src_port</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#9CDCFE"> tcp</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">source</span><span style="--shiki-default:#E6E6E6">;
</span></span><span class="line" line="61"><span style="--shiki-default:#9CDCFE">    in_loadbalancer</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">dst_port</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#9CDCFE"> tcp</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">dest</span><span style="--shiki-default:#E6E6E6">;
</span></span><span class="line" line="62"><span style="--shiki-default:#9CDCFE">    in_loadbalancer</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">protocol</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#E6E6E6"> IPPROTO_TCP; 
</span></span><span class="line" line="63"><span style="--shiki-default:#569CD6">    struct</span><span style="--shiki-default:#E6E6E6"> endpoint client;
</span></span><span class="line" line="64"><span style="--shiki-default:#9CDCFE">    client</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">ip</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#9CDCFE"> ip</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">saddr</span><span style="--shiki-default:#E6E6E6">;
</span></span><span class="line" line="65"><span style="--shiki-default:#569CD6">    int</span><span style="--shiki-default:#E6E6E6"> ret </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#DCDCAA"> bpf_map_update_elem</span><span style="--shiki-default:#E6E6E6">(</span><span style="--shiki-default:#D4D4D4">&amp;</span><span style="--shiki-default:#E6E6E6">conntrack, </span><span style="--shiki-default:#D4D4D4">&amp;</span><span style="--shiki-default:#E6E6E6">in_loadbalancer, </span><span style="--shiki-default:#D4D4D4">&amp;</span><span style="--shiki-default:#E6E6E6">client, BPF_ANY);
</span></span><span class="line" line="66"><span style="--shiki-default:#C586C0">    if</span><span style="--shiki-default:#E6E6E6"> (ret </span><span style="--shiki-default:#D4D4D4">!=</span><span style="--shiki-default:#B5CEA8"> 0</span><span style="--shiki-default:#E6E6E6">) {
</span></span><span class="line" line="67"><span style="--shiki-default:#DCDCAA">      bpf_printk</span><span style="--shiki-default:#E6E6E6">(</span><span style="--shiki-default:#CE9178">"Failed to update conntrack eBPF map"</span><span style="--shiki-default:#E6E6E6">);
</span></span><span class="line" line="68"><span style="--shiki-default:#C586C0">      return</span><span style="--shiki-default:#E6E6E6"> XDP_ABORTED;
</span></span><span class="line" line="69"><span style="--shiki-default:#E6E6E6">    }
</span></span><span class="line" line="70"><span emptylineplaceholder="true">
</span></span><span class="line highlight" line="71"><span style="--shiki-default:#6A9955">    // Replace destination IP with backends' IP
</span></span><span class="line highlight" line="72"><span style="--shiki-default:#9CDCFE">    ip</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">daddr</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#9CDCFE"> backend</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">ip</span><span style="--shiki-default:#E6E6E6">;
</span></span><span class="line highlight" line="73"><span style="--shiki-default:#6A9955">    // Replace destination MAC with backends' MAC
</span></span><span class="line highlight" line="74"><span style="--shiki-default:#DCDCAA">    __builtin_memcpy</span><span style="--shiki-default:#E6E6E6">(</span><span style="--shiki-default:#9CDCFE">eth</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">h_dest</span><span style="--shiki-default:#E6E6E6">, </span><span style="--shiki-default:#9CDCFE">fib</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">dmac</span><span style="--shiki-default:#E6E6E6">, ETH_ALEN);
</span></span><span class="line" line="75"><span style="--shiki-default:#E6E6E6">  } </span><span style="--shiki-default:#C586C0">else</span><span style="--shiki-default:#E6E6E6"> {
</span></span><span class="line" line="76"><span style="--shiki-default:#DCDCAA">    bpf_printk</span><span style="--shiki-default:#E6E6E6">(</span><span style="--shiki-default:#CE9178">"Packet from backend because the connection exists - "
</span></span><span class="line" line="77"><span style="--shiki-default:#CE9178">               "redirecting back to client"</span><span style="--shiki-default:#E6E6E6">);
</span></span><span class="line" line="78"><span emptylineplaceholder="true">
</span></span><span class="line highlight" line="79"><span style="--shiki-default:#6A9955">    // Perform a FIB lookup
</span></span><span class="line highlight" line="80"><span style="--shiki-default:#569CD6">    int</span><span style="--shiki-default:#E6E6E6"> rc </span><span style="--shiki-default:#D4D4D4">=</span><span style="--shiki-default:#DCDCAA"> fib_lookup_v4_full</span><span style="--shiki-default:#E6E6E6">(ctx, </span><span style="--shiki-default:#D4D4D4">&amp;</span><span style="--shiki-default:#E6E6E6">fib, </span><span style="--shiki-default:#9CDCFE">ip</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">daddr</span><span style="--shiki-default:#E6E6E6">, </span><span style="--shiki-default:#9CDCFE">out</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">ip</span><span style="--shiki-default:#E6E6E6">,
</span></span><span class="line highlight" line="81"><span style="--shiki-default:#DCDCAA">                                bpf_ntohs</span><span style="--shiki-default:#E6E6E6">(</span><span style="--shiki-default:#9CDCFE">ip</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">tot_len</span><span style="--shiki-default:#E6E6E6">));
</span></span><span class="line highlight" line="82"><span style="--shiki-default:#C586C0">    if</span><span style="--shiki-default:#E6E6E6"> (rc </span><span style="--shiki-default:#D4D4D4">!=</span><span style="--shiki-default:#E6E6E6"> BPF_FIB_LKUP_RET_SUCCESS) {
</span></span><span class="line highlight" line="83"><span style="--shiki-default:#DCDCAA">      log_fib_error</span><span style="--shiki-default:#E6E6E6">(rc);
</span></span><span class="line highlight" line="84"><span style="--shiki-default:#C586C0">      return</span><span style="--shiki-default:#E6E6E6"> XDP_ABORTED;
</span></span><span class="line highlight" line="85"><span style="--shiki-default:#E6E6E6">    }
</span></span><span class="line" line="86"><span emptylineplaceholder="true">
</span></span><span class="line highlight" line="87"><span style="--shiki-default:#6A9955">    // Replace destination IP with clients' IP
</span></span><span class="line highlight" line="88"><span style="--shiki-default:#9CDCFE">    ip</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">daddr</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#9CDCFE"> out</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">ip</span><span style="--shiki-default:#E6E6E6">;
</span></span><span class="line highlight" line="89"><span style="--shiki-default:#6A9955">    // Replace destination MAC with clients' MAC
</span></span><span class="line highlight" line="90"><span style="--shiki-default:#DCDCAA">    __builtin_memcpy</span><span style="--shiki-default:#E6E6E6">(</span><span style="--shiki-default:#9CDCFE">eth</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">h_dest</span><span style="--shiki-default:#E6E6E6">, </span><span style="--shiki-default:#9CDCFE">fib</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">dmac</span><span style="--shiki-default:#E6E6E6">, ETH_ALEN);
</span></span><span class="line" line="91"><span style="--shiki-default:#E6E6E6">  }
</span></span><span class="line" line="92"><span emptylineplaceholder="true">
</span></span><span class="line highlight" line="93"><span style="--shiki-default:#6A9955">  // Replace source IP with load balancers' IP
</span></span><span class="line highlight" line="94"><span style="--shiki-default:#9CDCFE">  ip</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">saddr</span><span style="--shiki-default:#D4D4D4"> =</span><span style="--shiki-default:#E6E6E6"> lb_ip;
</span></span><span class="line highlight" line="95"><span style="--shiki-default:#6A9955">  // Replace source MAC with load balancers' MAC
</span></span><span class="line highlight" line="96"><span style="--shiki-default:#DCDCAA">  __builtin_memcpy</span><span style="--shiki-default:#E6E6E6">(</span><span style="--shiki-default:#9CDCFE">eth</span><span style="--shiki-default:#E6E6E6">-&gt;</span><span style="--shiki-default:#9CDCFE">h_source</span><span style="--shiki-default:#E6E6E6">, </span><span style="--shiki-default:#9CDCFE">fib</span><span style="--shiki-default:#E6E6E6">.</span><span style="--shiki-default:#9CDCFE">smac</span><span style="--shiki-default:#E6E6E6">, ETH_ALEN);
</span></span><span class="line" line="97"><span style="--shiki-default:#E6E6E6">  ...
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-4578ab24="" data-v-134dddac=""><span class="sr-only" data-v-134dddac="">Copy to clipboard</span><span class="icon-wrapper" data-v-134dddac=""><svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--ph" style="font-size:18px;" width="1em" height="1em" viewBox="0 0 256 256" data-v-134dddac=""><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"></path></svg></span></button></div><!--]--><div class="border-[2px] my-[24px] px-6 py-0 rounded-lg border-warning bg-[#fdeee5]"><!--[--><p class="prose-p" data-v-b025fb9f=""><!--[--> The only assumption when using <code class="prose-code-inline" data-v-a031129a=""><!--[-->bpf_fib_lookup()<!--]--></code> is that the necessary routing information already exists in the kernel tables.<!--]--></p><p class="prose-p" data-v-b025fb9f=""><!--[-->If you check the kernels routing table, youll see the route is indeed present (in the <code class="prose-code-inline" data-v-a031129a=""><!--[-->lb<!--]--></code> tab):<!--]--></p><!--[--><div class="highlight-bash prose-code" meta="" data-v-4578ab24=""><!----><!--[--><pre class="language-bash shiki shiki-themes slack-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#DCDCAA">ip</span><span style="--shiki-default:#CE9178"> route</span><span style="--shiki-default:#CE9178"> show
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-4578ab24="" data-v-134dddac=""><span class="sr-only" data-v-134dddac="">Copy to clipboard</span><span class="icon-wrapper" data-v-134dddac=""><svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--ph" style="font-size:18px;" width="1em" height="1em" viewBox="0 0 256 256" data-v-134dddac=""><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"></path></svg></span></button></div><!--]--><!--[--><div class="highlight-bash prose-code" meta="" data-v-4578ab24=""><!----><!--[--><pre class="language-bash shiki shiki-themes slack-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#DCDCAA">default</span><span style="--shiki-default:#CE9178"> via</span><span style="--shiki-default:#B5CEA8"> 192.168.178.2</span><span style="--shiki-default:#CE9178"> dev</span><span style="--shiki-default:#CE9178"> eth0</span><span style="--shiki-default:#6A9955"> # If the destination IP address doesn't match the local subnet (or any other specific route), it gets sent here
</span></span><span class="line" line="2"><span style="--shiki-default:#DCDCAA">192.168.178.0/24</span><span style="--shiki-default:#CE9178"> dev</span><span style="--shiki-default:#CE9178"> eth0</span><span style="--shiki-default:#CE9178"> proto</span><span style="--shiki-default:#CE9178"> kernel</span><span style="--shiki-default:#CE9178"> scope</span><span style="--shiki-default:#CE9178"> link</span><span style="--shiki-default:#CE9178"> src</span><span style="--shiki-default:#B5CEA8"> 192.168.178.10</span><span style="--shiki-default:#6A9955"> # Routes any destination IP in 192.168.178.0/24 through the eth0 interface
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-4578ab24="" data-v-134dddac=""><span class="sr-only" data-v-134dddac="">Copy to clipboard</span><span class="icon-wrapper" data-v-134dddac=""><svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--ph" style="font-size:18px;" width="1em" height="1em" viewBox="0 0 256 256" data-v-134dddac=""><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"></path></svg></span></button></div><!--]--><p class="prose-p" data-v-b025fb9f=""><!--[-->However, thats not necessarily true for the ARP table (or NDP for IPv6). If we inspect it (in the <code class="prose-code-inline" data-v-a031129a=""><!--[-->lb<!--]--></code> tab):<!--]--></p><!--[--><div class="highlight-bash prose-code" meta="" data-v-4578ab24=""><!----><!--[--><pre class="language-bash shiki shiki-themes slack-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#DCDCAA">ip</span><span style="--shiki-default:#CE9178"> neigh</span><span style="--shiki-default:#CE9178"> show
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-4578ab24="" data-v-134dddac=""><span class="sr-only" data-v-134dddac="">Copy to clipboard</span><span class="icon-wrapper" data-v-134dddac=""><svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--ph" style="font-size:18px;" width="1em" height="1em" viewBox="0 0 256 256" data-v-134dddac=""><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"></path></svg></span></button></div><!--]--><!--[--><div class="highlight-bash prose-code" meta="" data-v-4578ab24=""><!----><!--[--><pre class="language-bash shiki shiki-themes slack-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#DCDCAA">192.168.178.1</span><span style="--shiki-default:#CE9178"> dev</span><span style="--shiki-default:#CE9178"> eth0</span><span style="--shiki-default:#CE9178"> lladdr</span><span style="--shiki-default:#CE9178"> 26:d7:2a:71:94:c4</span><span style="--shiki-default:#CE9178"> REACHABLE</span><span style="--shiki-default:#E6E6E6"> 
</span></span><span class="line" line="2"><span style="--shiki-default:#DCDCAA">192.168.178.2</span><span style="--shiki-default:#CE9178"> dev</span><span style="--shiki-default:#CE9178"> eth0</span><span style="--shiki-default:#CE9178"> lladdr</span><span style="--shiki-default:#CE9178"> ce:4a:a3:20:23:a2</span><span style="--shiki-default:#CE9178"> REACHABLE
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-4578ab24="" data-v-134dddac=""><span class="sr-only" data-v-134dddac="">Copy to clipboard</span><span class="icon-wrapper" data-v-134dddac=""><svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--ph" style="font-size:18px;" width="1em" height="1em" viewBox="0 0 256 256" data-v-134dddac=""><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"></path></svg></span></button></div><!--]--><p class="prose-p" data-v-b025fb9f=""><!--[-->youll notice that entries for our backend nodes (<code class="prose-code-inline" data-v-a031129a=""><!--[-->backend-1<!--]--></code>, <code class="prose-code-inline" data-v-a031129a=""><!--[-->backend-2<!--]--></code> tab) are missing. But we can easily populate it using  (in the <code class="prose-code-inline" data-v-a031129a=""><!--[-->lb<!--]--></code> tab):<!--]--></p><!--[--><div class="highlight-bash prose-code" meta="" data-v-4578ab24=""><!----><!--[--><pre class="language-bash shiki shiki-themes slack-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#DCDCAA">sudo</span><span style="--shiki-default:#CE9178"> ping</span><span style="--shiki-default:#CE9178"> -c1</span><span style="--shiki-default:#B5CEA8"> 192.168.178.11
</span></span><span class="line" line="2"><span style="--shiki-default:#DCDCAA">sudo</span><span style="--shiki-default:#CE9178"> ping</span><span style="--shiki-default:#CE9178"> -c1</span><span style="--shiki-default:#B5CEA8"> 192.168.178.12
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-4578ab24="" data-v-134dddac=""><span class="sr-only" data-v-134dddac="">Copy to clipboard</span><span class="icon-wrapper" data-v-134dddac=""><svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--ph" style="font-size:18px;" width="1em" height="1em" viewBox="0 0 256 256" data-v-134dddac=""><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"></path></svg></span></button></div><!--]--><p class="prose-p" data-v-b025fb9f=""><!--[-->Now you should see:<!--]--></p><!--[--><div class="highlight-bash prose-code" meta="" data-v-4578ab24=""><!----><!--[--><pre class="language-bash shiki shiki-themes slack-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#DCDCAA">192.168.178.1</span><span style="--shiki-default:#CE9178"> dev</span><span style="--shiki-default:#CE9178"> eth0</span><span style="--shiki-default:#CE9178"> lladdr</span><span style="--shiki-default:#CE9178"> 26:d7:2a:71:94:c4</span><span style="--shiki-default:#CE9178"> REACHABLE</span><span style="--shiki-default:#E6E6E6"> 
</span></span><span class="line" line="2"><span style="--shiki-default:#DCDCAA">192.168.178.2</span><span style="--shiki-default:#CE9178"> dev</span><span style="--shiki-default:#CE9178"> eth0</span><span style="--shiki-default:#CE9178"> lladdr</span><span style="--shiki-default:#CE9178"> ce:4a:a3:20:23:a2</span><span style="--shiki-default:#CE9178"> REACHABLE</span><span style="--shiki-default:#E6E6E6"> 
</span></span><span class="line" line="3"><span style="--shiki-default:#DCDCAA">192.168.178.11</span><span style="--shiki-default:#CE9178"> dev</span><span style="--shiki-default:#CE9178"> eth0</span><span style="--shiki-default:#CE9178"> lladdr</span><span style="--shiki-default:#CE9178"> 32:da:f7:c0:34:04</span><span style="--shiki-default:#CE9178"> REACHABLE</span><span style="--shiki-default:#E6E6E6"> 
</span></span><span class="line" line="4"><span style="--shiki-default:#DCDCAA">192.168.178.12</span><span style="--shiki-default:#CE9178"> dev</span><span style="--shiki-default:#CE9178"> eth0</span><span style="--shiki-default:#CE9178"> lladdr</span><span style="--shiki-default:#CE9178"> ba:ba:f6:ea:11:34</span><span style="--shiki-default:#CE9178"> REACHABLE
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-4578ab24="" data-v-134dddac=""><span class="sr-only" data-v-134dddac="">Copy to clipboard</span><span class="icon-wrapper" data-v-134dddac=""><svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--ph" style="font-size:18px;" width="1em" height="1em" viewBox="0 0 256 256" data-v-134dddac=""><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"></path></svg></span></button></div><!--]--><p class="prose-p" data-v-b025fb9f=""><!--[-->In
 production setups, this isnt really an issue, since the load balancer 
continuously performs health checks against the backends and keeps these
 tables updated.<!--]--></p><!--]--></div><h2 id="running-the-load-balancer" class="prose-h2" data-v-b9b1576a=""><!--[-->Running the Load Balancer<!--]--><!----></h2><p class="prose-p" data-v-b025fb9f=""><!--[-->This playground has a network topology with five separate machines on two different networks:<!--]--></p><ul class="prose-ul" data-v-533e29f3=""><!--[--><li class="prose-li" data-v-2969431c=""><!--[--><code class="prose-code-inline" data-v-a031129a=""><!--[-->lb<!--]--></code> in network <code class="prose-code-inline" data-v-a031129a=""><!--[-->192.168.178.10/24<!--]--></code><!--]--></li><li class="prose-li" data-v-2969431c=""><!--[--><code class="prose-code-inline" data-v-a031129a=""><!--[-->backend-01<!--]--></code> in network <code class="prose-code-inline" data-v-a031129a=""><!--[-->192.168.178.11/24<!--]--></code><!--]--></li><li class="prose-li" data-v-2969431c=""><!--[--><code class="prose-code-inline" data-v-a031129a=""><!--[-->backend-02<!--]--></code> in network <code class="prose-code-inline" data-v-a031129a=""><!--[-->192.168.178.12/24<!--]--></code><!--]--></li><li class="prose-li" data-v-2969431c=""><!--[--><code class="prose-code-inline" data-v-a031129a=""><!--[-->client<!--]--></code> in network <code class="prose-code-inline" data-v-a031129a=""><!--[-->10.0.0.20/16<!--]--></code><!--]--></li><li class="prose-li" data-v-2969431c=""><!--[--><code class="prose-code-inline" data-v-a031129a=""><!--[-->gateway<!--]--></code> between networks <code class="prose-code-inline" data-v-a031129a=""><!--[-->192.168.178.2/24<!--]--></code> and <code class="prose-code-inline" data-v-a031129a=""><!--[-->10.0.0.2/16<!--]--></code><!--]--></li><!--]--></ul><div class="bg-base-100" style="padding:0;margin:30px auto;max-width:800px;"><div class="text-center"><img src="Building%20an%20eBPF_XDP%20NAT-Based%20Layer%204%20Load%20Balancer%20from%20Scratch_files/nat-playground.webp" alt="XDP NAT Load Balancing Playground" class="cursor-pointer m-0 max-w-full" style=""><!--[--><!--]--></div><!----></div><p class="prose-p" data-v-b025fb9f=""><!--[-->Before we can actually run our load balancer, we also need to enable packet forwarding between network interfaces (in the <code class="prose-code-inline" data-v-a031129a=""><!--[-->lb<!--]--></code> tab):<!--]--></p><!--[--><div class="highlight-bash prose-code" meta="" data-v-4578ab24=""><!----><!--[--><pre class="language-bash shiki shiki-themes slack-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#DCDCAA">sudo</span><span style="--shiki-default:#CE9178"> sysctl</span><span style="--shiki-default:#CE9178"> -w</span><span style="--shiki-default:#CE9178"> net.ipv4.ip_forward=</span><span style="--shiki-default:#B5CEA8">1
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-4578ab24="" data-v-134dddac=""><span class="sr-only" data-v-134dddac="">Copy to clipboard</span><span class="icon-wrapper" data-v-134dddac=""><svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--ph" style="font-size:18px;" width="1em" height="1em" viewBox="0 0 256 256" data-v-134dddac=""><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"></path></svg></span></button></div><!--]--><p class="prose-p" data-v-b025fb9f=""><!--[-->This
 allows the kernel to route packets it receives on one interface out 
through another  a requirement for the load balancer to forward client 
traffic to backend nodes.<!--]--></p><div class="border-[2px] my-[24px] px-6 py-0 rounded-lg border-warning bg-[#fdeee5]"><!--[--><p class="prose-p" data-v-b025fb9f=""><!--[--> Make sure you've populated the ARP table with backends information using (in the <code class="prose-code-inline" data-v-a031129a=""><!--[-->lb<!--]--></code> tab):<!--]--></p><!--[--><div class="highlight-bash prose-code" meta="" data-v-4578ab24=""><!----><!--[--><pre class="language-bash shiki shiki-themes slack-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#DCDCAA">sudo</span><span style="--shiki-default:#CE9178"> ping</span><span style="--shiki-default:#CE9178"> -c1</span><span style="--shiki-default:#B5CEA8"> 192.168.178.11
</span></span><span class="line" line="2"><span style="--shiki-default:#DCDCAA">sudo</span><span style="--shiki-default:#CE9178"> ping</span><span style="--shiki-default:#CE9178"> -c1</span><span style="--shiki-default:#B5CEA8"> 192.168.178.12
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-4578ab24="" data-v-134dddac=""><span class="sr-only" data-v-134dddac="">Copy to clipboard</span><span class="icon-wrapper" data-v-134dddac=""><svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--ph" style="font-size:18px;" width="1em" height="1em" viewBox="0 0 256 256" data-v-134dddac=""><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"></path></svg></span></button></div><!--]--><p class="prose-p" data-v-b025fb9f=""><!--[-->See the previous section above for an explanation of why this is required.<!--]--></p><!--]--></div><p class="prose-p" data-v-b025fb9f=""><!--[-->Now build and run the XDP Load Balancer in the <code class="prose-code-inline" data-v-a031129a=""><!--[-->lb<!--]--></code> tab (inside the <code class="prose-code-inline" data-v-a031129a=""><!--[-->/lab<!--]--></code> directory), using:<!--]--></p><!--[--><div class="highlight-bash prose-code" meta="" data-v-4578ab24=""><!----><!--[--><pre class="language-bash shiki shiki-themes slack-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#DCDCAA">go</span><span style="--shiki-default:#CE9178"> generate
</span></span><span class="line" line="2"><span style="--shiki-default:#DCDCAA">go</span><span style="--shiki-default:#CE9178"> build
</span></span><span class="line" line="3"><span style="--shiki-default:#DCDCAA">sudo</span><span style="--shiki-default:#CE9178"> ./lb</span><span style="--shiki-default:#CE9178"> -i</span><span style="--shiki-default:#CE9178"> eth0</span><span style="--shiki-default:#CE9178"> -backends</span><span style="--shiki-default:#CE9178"> 192.168.178.11,192.168.178.12
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-4578ab24="" data-v-134dddac=""><span class="sr-only" data-v-134dddac="">Copy to clipboard</span><span class="icon-wrapper" data-v-134dddac=""><svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--ph" style="font-size:18px;" width="1em" height="1em" viewBox="0 0 256 256" data-v-134dddac=""><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"></path></svg></span></button></div><!--]--><div class="border-[2px] my-[24px] px-6 py-0 rounded-lg border-primary/50 bg-[#f7fbfe]" data-v-370f298d=""><!--[--><details data-v-370f298d=""><summary class="cursor-pointer my-3 select-none text-[#4078c0]" data-v-370f298d="">What are these input parameters?</summary><!--[--><p class="prose-p" data-v-b025fb9f=""><!--[-->In short:<!--]--></p><ul class="prose-ul" data-v-533e29f3=""><!--[--><li class="prose-li" data-v-2969431c=""><!--[--><code class="prose-code-inline" data-v-a031129a=""><!--[-->i<!--]--></code> expects the network interface on which this XDP Load Balancer program will run<!--]--></li><li class="prose-li" data-v-2969431c=""><!--[--><code class="prose-code-inline" data-v-a031129a=""><!--[-->backends<!--]--></code>
 The list of backend IPs in this playground (you need to provide exactly
 two backends, due to the simplification described above for simple 
hashing)<!--]--></li><!--]--></ul><!--]--></details><!--]--></div><p class="prose-p" data-v-b025fb9f=""><!--[-->Now run an HTTP server on every backend node in tabs <code class="prose-code-inline" data-v-a031129a=""><!--[-->backend-1<!--]--></code>, <code class="prose-code-inline" data-v-a031129a=""><!--[-->backend-2<!--]--></code>, using:<!--]--></p><!--[--><div class="highlight-bash prose-code" meta="" data-v-4578ab24=""><!----><!--[--><pre class="language-bash shiki shiki-themes slack-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#DCDCAA">python3</span><span style="--shiki-default:#CE9178"> -m</span><span style="--shiki-default:#CE9178"> http.server</span><span style="--shiki-default:#B5CEA8"> 8000
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-4578ab24="" data-v-134dddac=""><span class="sr-only" data-v-134dddac="">Copy to clipboard</span><span class="icon-wrapper" data-v-134dddac=""><svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--ph" style="font-size:18px;" width="1em" height="1em" viewBox="0 0 256 256" data-v-134dddac=""><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"></path></svg></span></button></div><!--]--><p class="prose-p" data-v-b025fb9f=""><!--[-->And query the Load Balancers node IP from the <code class="prose-code-inline" data-v-a031129a=""><!--[-->client<!--]--></code> tab, using:<!--]--></p><!--[--><div class="highlight-bash prose-code" meta="" data-v-4578ab24=""><!----><!--[--><pre class="language-bash shiki shiki-themes slack-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#DCDCAA">curl</span><span style="--shiki-default:#CE9178"> http://192.168.178.10:8000
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-4578ab24="" data-v-134dddac=""><span class="sr-only" data-v-134dddac="">Copy to clipboard</span><span class="icon-wrapper" data-v-134dddac=""><svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--ph" style="font-size:18px;" width="1em" height="1em" viewBox="0 0 256 256" data-v-134dddac=""><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"></path></svg></span></button></div><!--]--><p class="prose-p" data-v-b025fb9f=""><!--[-->and
 confirm you see the requests indeed get routed through the load 
balancer node to one of the backends, by inspect eBPF load balancer logs
 (in the <code class="prose-code-inline" data-v-a031129a=""><!--[-->lb<!--]--></code> tab):<!--]--></p><!--[--><div class="highlight-bash prose-code" meta="" data-v-4578ab24=""><!----><!--[--><pre class="language-bash shiki shiki-themes slack-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#DCDCAA">sudo</span><span style="--shiki-default:#CE9178"> bpftool</span><span style="--shiki-default:#CE9178"> prog</span><span style="--shiki-default:#CE9178"> trace
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-4578ab24="" data-v-134dddac=""><span class="sr-only" data-v-134dddac="">Copy to clipboard</span><span class="icon-wrapper" data-v-134dddac=""><svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--ph" style="font-size:18px;" width="1em" height="1em" viewBox="0 0 256 256" data-v-134dddac=""><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"></path></svg></span></button></div><!--]--><div class="bg-base-100" style="padding:0;margin:30px auto;max-width:800px;"><div class="text-center"><img src="Building%20an%20eBPF_XDP%20NAT-Based%20Layer%204%20Load%20Balancer%20from%20Scratch_files/nat-playground-solution.webp" alt="XDP NAT Load Balancing Playground Solution" class="cursor-pointer m-0 max-w-full" style=""><!--[--><!--]--></div><!----></div><p class="prose-p" data-v-b025fb9f=""><!--[-->Congrats - you've came to the end of this tutorial <!--]--></p><hr class="prose-hr" data-v-34b8dd49=""><p class="prose-p" data-v-b025fb9f=""><!--[-->Before I let you go, some final remarks.<!--]--></p><p class="prose-p" data-v-b025fb9f=""><!--[-->The
 nice thing about this setup is that it also works across different 
networks  the client, load balancer, and backend dont need to be on 
the same subnet. This is possible because <code class="prose-code-inline" data-v-a031129a=""><!--[-->bpf_fib_lookup<!--]--></code> can retrieve the MAC address from a gateway or router when the backend resides on a different subnet.<!--]--></p><p class="prose-p" data-v-b025fb9f=""><!--[-->Another
 benefit is that both the request and response pass through the load 
balancer, making it easier to apply custom network policies or perform 
additional inspection in both directions.<!--]--></p><p class="prose-p" data-v-b025fb9f=""><!--[--><strong class="prose-strong" data-v-24022f14=""><!--[-->However, this approach isnt always optimal.<!--]--></strong><!--]--></p><p class="prose-p" data-v-b025fb9f=""><!--[-->Since
 the load balancer handles traffic in both directions, it consumes more 
resources and can become a bottleneck. Just think about it  the backend
 could simply respond directly to the client without routing the 
response back through the load balancer.<!--]--></p><p class="prose-p" data-v-b025fb9f=""><!--[-->Another
 drawback is that the backend isnt really aware of which client made 
the request. If you check the HTTP server logs, it appears as if the 
load balancer itself made the request (the IP at the beginning of the 
line).<!--]--></p><!--[--><div class="highlight-bash prose-code" meta="" data-v-4578ab24=""><!----><!--[--><pre class="language-bash shiki shiki-themes slack-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#DCDCAA">192.168.178.10</span><span style="--shiki-default:#CE9178"> -</span><span style="--shiki-default:#CE9178"> -</span><span style="--shiki-default:#E6E6E6"> [05/Jan/2026 </span><span style="--shiki-default:#CE9178">02:06:07]</span><span style="--shiki-default:#CE9178"> "GET / HTTP/1.1"</span><span style="--shiki-default:#B5CEA8"> 200</span><span style="--shiki-default:#CE9178"> -
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-4578ab24="" data-v-134dddac=""><span class="sr-only" data-v-134dddac="">Copy to clipboard</span><span class="icon-wrapper" data-v-134dddac=""><svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--ph" style="font-size:18px;" width="1em" height="1em" viewBox="0 0 256 256" data-v-134dddac=""><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"></path></svg></span></button></div><!--]--><p class="prose-p" data-v-b025fb9f=""><!--[-->In the next tutorial, well address these shortcomings using XDP Layer 4 DSR (Direct Server Return) load balancing.<!--]--></p><style nonce="">html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}</style></div><!----></div></div><!--]--><div class="px-4 md:px-8 xl:px-12 mt-auto" data-v-200caef3=""><!--[--><div class="bg-frost-light border-[2px] border-primary/30 flex flex-wrap gap-6 items-center px-6 py-6 rounded-lg my-10" data-v-0d30d5a9=""><p class="basis-[480px] grow my-0 py-0 text-slate-700 text-xl"><!--[--> Level up your Server Side game  Join 20,000 engineers who receive insightful learning materials straight to their inbox <!--]--></p><div class="basis-[150px] flex flex-wrap gap-x-5 gap-y-2 grow min-w-[150px]"><input class="focus:ring-0 grow-[4] input input-bordered min-w-[150px]" placeholder="Email" data-ddg-inputtype="identities.emailAddress" data-ddg-autofill="true" style="background-size: auto 24px !important; background-position: right center !important; background-repeat: no-repeat !important; background-origin: content-box !important; background-image: url(&quot;data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgdmlld0JveD0iMCAwIDEyOCAxMjgiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgICA8cGF0aCBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGNsaXAtcnVsZT0iZXZlbm9kZCIgZD0iTTY0IDEyOEM5OS4zNTg2IDEyOCAxMjggOTkuMzU4NiAxMjggNjRDMTI4IDI4LjY0MTQgOTkuMzU4NiAwIDY0IDBDMjguNjQxNCAwIDAgMjguNjQxNCAwIDY0QzAgOTkuMzU4NiAyOC42NDE0IDEyOCA2NCAxMjhaIiBmaWxsPSIjNDQ0NDQ0Ii8+CiAgICA8cGF0aCBkPSJNNzYuOTk5MSA1Mi4yMTM3Qzc3LjQ5NjYgNTIuMjEzNyA3Ny45MDA5IDUxLjgwOTQgNzcuOTAwOSA1MS4zMTE4Qzc3LjkwMDkgNTAuODE0MyA3Ny40OTY2IDUwLjQxIDc2Ljk5OTEgNTAuNDFDNzYuNTAxNSA1MC40MSA3Ni4wOTcyIDUwLjgxNDMgNzYuMDk3MiA1MS4zMTE4Qzc2LjA5NzIgNTEuODA5NCA3Ni41MDE1IDUyLjIxMzcgNzYuOTk5MSA1Mi4yMTM3WiIgZmlsbD0id2hpdGUiLz4KICAgIDxwYXRoIGQ9Ik01MC4xOTI0IDU0LjU0NkM1MC43ODMzIDU0LjU0NiA1MS4yNDk3IDU0LjA3OTYgNTEuMjQ5NyA1My40ODg3QzUxLjI0OTcgNTIuODk3OCA1MC43ODMzIDUyLjQzMTQgNTAuMTkyNCA1Mi40MzE0QzQ5LjYwMTUgNTIuNDMxNCA0OS4xMzUxIDUyLjg5NzggNDkuMTM1MSA1My40ODg3QzQ5LjEzNTEgNTQuMDc5NiA0OS42MDE1IDU0LjU0NiA1MC4xOTI0IDU0LjU0NloiIGZpbGw9IndoaXRlIi8+CiAgICA8cGF0aCBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGNsaXAtcnVsZT0iZXZlbm9kZCIgZD0iTTEyMi43NSA2NEMxMjIuNzUgOTYuNDQ2OCA5Ni40NDY3IDEyMi43NSA2NCAxMjIuNzVDMzEuNTUzMyAxMjIuNzUgNS4yNSA5Ni40NDY4IDUuMjUgNjRDNS4yNSAzMS41NTMzIDMxLjU1MzMgNS4yNSA2NCA1LjI1Qzk2LjQ0NjcgNS4yNSAxMjIuNzUgMzEuNTUzMyAxMjIuNzUgNjRaTTQ2Ljc4MzcgMTE0LjkzNEM0NS41MjI5IDExMC41NTggNDIuNjQzNCAxMDAuMjYgMzguMjUwNyA4Mi42NTlDMzEuOTM3OCA1Ny4zNzYyIDI3LjI0MTkgMzYuNzU4MSA1MC45Mzg3IDMwLjMyMDhDNTEuMTg3NSAzMC4yNTg2IDUxLjI4MDggMjkuOTc4NyA1MS4wOTQyIDI5LjgyMzJDNDguMzU3NiAyNy4zMzUzIDQzLjcyNCAyNi45IDM5LjE4MzYgMjcuODAxOEMzOC45NjU5IDI3LjgzMjkgMzguODEwNSAyNy42Nzc0IDM4LjgxMDUgMjcuNDkwOEMzOC44MTA1IDI3LjQyODYgMzguODEwNSAyNy4zNjY0IDM4Ljg3MjYgMjcuMzA0MkMzOS45NjExIDI1Ljc4MDQgNDEuOTIwMyAyNC41OTg3IDQzLjI1NzUgMjMuODgzNEM0Mi4zMjQ1IDIzLjA0MzggNDEuMDgwNiAyMi40ODQgNDAuMDIzMyAyMi4xMTA5QzM5LjcxMjMgMjEuOTg2NSAzOS43MTIzIDIxLjQ1NzggMzkuOTkyMiAyMS4zMzM0QzQwLjAyMzMgMjEuMzAyMyA0MC4wNTQ0IDIxLjI3MTIgNDAuMTE2NiAyMS4yNzEyQzQ5LjQ0NiAyMC4wMjczIDU5LjI0MTkgMjIuODI2MSA2NC4wNjIyIDI4Ljk4MzVDNjQuMTI0MyAyOS4wNDU3IDY0LjE4NjUgMjkuMDc2OCA2NC4yNDg3IDI5LjEwNzlDODAuMDc3NyAzMi40OTc2IDgyLjk2OTggNTQuOTE5NCA4Mi4wMDU4IDYxLjEwNzlDODcuNTcyNCA2MC40NTQ5IDkxLjczOTUgNTkuMDg2NiA5NC41MDcyIDU4LjAyOTJDOTguNDg3OCA1Ni41MDU0IDk5Ljg4NzIgNTYuODQ3NSAxMDAuMzg1IDU3Ljc0OTNDMTAwLjkxMyA1OC43NzU2IDEwMC4yOTIgNjAuNDg2IDk4Ljg5MjEgNjIuMDcyQzk2LjI0ODcgNjUuMDg4NSA5MS40NTk2IDY3LjQ1MiA4My4wMzIgNjguMTM2MUM4MC4xMTg5IDY4LjM3MjYgNzcuNTQ0IDY4LjI1OTggNzUuMzIyNSA2OC4xNjI1QzcxLjExNzQgNjcuOTc4NCA2OC4xNzkxIDY3Ljg0OTcgNjYuNjEyMiA3MC4yNTA4QzY1LjU4NiA3MS44MzY4IDY2LjM5NDUgNzUuNTY4NiA3NC41NDIyIDc2Ljc1MDNDODAuMzU4NiA3Ny41ODgzIDg1LjYyODEgNzcuMDAyNiA4OS40NzAxIDc2LjU3NTVDOTIuODk5OCA3Ni4xOTQzIDk1LjE5MiA3NS45Mzk1IDk1LjcyMDEgNzYuOTM2OUM5Ni44Mzk2IDc5LjA4MjcgOTAuNDAyMyA4My4zNzQyIDc5LjM2MjQgODMuNDY3NUM3OC41MjI4IDgzLjQ2NzUgNzcuNjgzMSA4My40MzY0IDc2Ljg3NDYgODMuNDA1M0M3MC4wMzMgODMuMDYzMyA2NC45OTUxIDgxLjE5NzQgNjEuODU0MiA3OS40ODdDNjEuNzYwOSA3OS40NTU5IDYxLjY5ODcgNzkuNDI0OCA2MS42Njc2IDc5LjM5MzdDNjEuMTA3OCA3OS4wODI3IDYwLjAxOTQgNzkuNjQyNCA2MC42NzI1IDgwLjgyNDJDNjEuMDQ1NiA4MS41Mzk0IDYzLjAzNTkgODMuMzc0MiA2Ni4wMjEzIDg0Ljk2MDJDNjUuNzEwNCA4Ny40NDgxIDY2LjQ4NzggOTEuMjczMiA2Ny44MjUgOTUuNjI2OUM2Ny45ODA0IDk1LjYwMSA2OC4xMzU3IDk1LjU2OTcgNjguMjk1NSA5NS41Mzc2QzY4LjUxOTYgOTUuNDkyNCA2OC43NTI2IDk1LjQ0NTUgNjkuMDA2OCA5NS40MDkyQzcxLjcxMjMgOTQuOTczOCA3My4xNDI4IDk1LjQ3MTQgNzMuOTUxNCA5Ni4zNDIyQzc3Ljc3NjQgOTMuNDgxMSA4NC4xNTE2IDg5LjQzODQgODQuNzczNSA5MC4xODQ3Qzg3Ljg4MzMgOTMuODg1NCA4OC4yODc2IDEwMi42MjQgODcuNjAzNSAxMDYuMTM4Qzg3LjU3MjQgMTA2LjIgODcuNTEwMiAxMDYuMjYyIDg3LjM4NTggMTA2LjMyNUM4NS45MjQyIDEwNi45NDcgNzcuODY5OCAxMDQuNzQ2IDc3Ljg2OTggMTAzLjU5NkM3Ny41NTg4IDk3Ljg2NiA3Ni40OTM3IDk3LjMzNzMgNzUuMjQ5OCA5Ny4wNTc0SDc0LjQxNzhDNzQuNDQ4OSA5Ny4wODg1IDc0LjQ4IDk3LjE1MDcgNzQuNTExMSA5Ny4yMTI5TDc0Ljc5MSA5Ny44NjZDNzUuMjg4NiA5OS4yMzQzIDc2LjA2NiAxMDMuNTI2IDc1LjQ3NTIgMTA0LjU4M0M3NC44ODQzIDEwNS42NDEgNzEuMDI4MSAxMDYuMTY5IDY4LjYzMzYgMTA2LjJDNjYuMjcwMSAxMDYuMjMxIDY1Ljc0MTUgMTA1LjM2MSA2NS4yNDM5IDEwNC4wMjNDNjQuODcwNyAxMDIuOTM1IDY0LjY4NDEgMTAwLjQxNiA2NC42ODQxIDk4Ljk1NDRDNjQuNjUzIDk4LjUxOSA2NC42ODQxIDk4LjE0NTkgNjQuNzQ2MyA5Ny44MDM4QzY0LjAzMTEgOTguMTE0OCA2Mi45ODE2IDk4LjgzIDYyLjYzOTUgOTkuMjk2NEM2Mi41NDYyIDEwMC42OTYgNjIuNTQ2MiAxMDIuOTM1IDYzLjI5MjUgMTA1LjQyM0M2My42NjU3IDEwNi42MDUgNTUuMTk5MiAxMTEuNjQyIDU0LjAxNzQgMTEwLjcxQzUyLjgwNDYgMTA5Ljc0NSA1MC42Mjc4IDEwMC4yOTIgNTEuNTYwNyA5Ni40NjY2QzUwLjU2NTYgOTYuNTU5OSA0OS43NTcgOTYuODcwOCA0OS4zMjE2IDk3LjQ5MjhDNDcuMzYyNCAxMDAuMTk4IDQ5LjgxOTIgMTEzLjEzNSA1Mi40MzE0IDExNC44MTRDNTMuNzk5OCAxMTUuNzE2IDYwLjY0MTQgMTExLjg2IDY0LjAzMTEgMTA4Ljk2OEM2NC41OTA4IDEwOS43NDUgNjUuNjYzOCAxMDkuODA4IDY2Ljk4NTQgMTA5LjgwOEM2OC43MjY5IDEwOS43NDUgNzEuMTUyNSAxMDkuNDk3IDcyLjg2MjkgMTA4Ljk2OEM3My44ODY3IDExMS4zNjcgNzUuMTIxOSAxMTQuMTU3IDc2LjEzNTMgMTE2LjM3NEM5OS45NzU5IDExMC44NzMgMTE3Ljc1IDg5LjUxMjEgMTE3Ljc1IDY0QzExNy43NSAzNC4zMTQ3IDkzLjY4NTMgMTAuMjUgNjQgMTAuMjVDMzQuMzE0NyAxMC4yNSAxMC4yNSAzNC4zMTQ3IDEwLjI1IDY0QzEwLjI1IDg3LjY2NCAyNS41NDIzIDEwNy43NTYgNDYuNzgzNyAxMTQuOTM0Wk03Ny4xMjc1IDQyLjUxOThDNzcuMTY4IDQyLjUzNzkgNzcuMjA4MSA0Mi41NTU4IDc3LjI0NzggNDIuNTczNEM3Ny40NjU1IDQyLjY2NjcgNzcuNzE0MiA0Mi40MTggNzcuNTU4NyA0Mi4yMzE0Qzc2Ljg0MzUgNDEuMjY3MyA3NS43ODYyIDQwLjM2NTUgNzMuNTQ3MSA0MC4zNjU1QzcxLjMwOCA0MC4zNjU1IDY5LjkzOTcgNDEuMTQyOSA2OS4zMTc3IDQyLjEzODFDNjkuMTkzMyA0Mi4zODY5IDY5LjU2NjUgNDIuNjM1NiA2OS44MTUzIDQyLjUxMTJDNzAuNTYxNyA0Mi4xMDcgNzEuNzEyMyA0MS42NDA1IDczLjU0NzEgNDEuNjcxNkM3NS4yOTUyIDQxLjcwMTIgNzYuMzA5NCA0Mi4xNTQzIDc3LjEyNzUgNDIuNTE5OFpNNzUuNDQ0MSA1NS45MTQ2Qzc3LjM3MjIgNTUuOTE0NiA3OC45MjcxIDU0LjM1OTYgNzguOTI3MSA1Mi40NjI3Qzc4LjkyNzEgNTAuNTM0NiA3Ny4zNzIyIDQ5LjAxMDggNzUuNDQ0MSA0OS4wMTA4QzczLjUxNiA0OS4wMTA4IDcxLjk2MTEgNTAuNTY1NyA3MS45NjExIDUyLjQ2MjdDNzEuOTYxMSA1NC4zNTk2IDczLjUxNiA1NS45MTQ2IDc1LjQ0NDEgNTUuOTE0NlpNNTIuNDMxNCA1NC44NTcyQzUyLjQzMTQgNTIuNjE4MSA1MC42Mjc4IDUwLjgxNDUgNDguMzg4NyA1MC44MTQ1QzQ2LjE0OTYgNTAuODE0NSA0NC4zMTQ4IDUyLjYxODEgNDQuMzQ1OSA1NC44NTcyQzQ0LjM0NTkgNTcuMDk2MyA0Ni4xNDk2IDU4LjkgNDguMzg4NyA1OC45QzUwLjYyNzggNTguOSA1Mi40MzE0IDU3LjA5NjMgNTIuNDMxNCA1NC44NTcyWk00MC44NjI5IDQ1Ljk2MzFDNDEuMjk4MyA0NS4zMTAxIDQxLjk4MjUgNDQuMzE0OSA0NC4xNTkzIDQzLjQxMzFDNDYuMzM2MiA0Mi41MTEyIDQ4LjA0NjYgNDIuNjM1NiA0OS4yMjgzIDQyLjkxNTVDNDkuNDc3MSA0Mi45Nzc3IDQ5LjY2MzcgNDIuNjk3OCA0OS40NDYgNDIuNTQyM0M0OC41MTMxIDQxLjc2NDkgNDYuNDI5NSA0MC44MzE5IDQzLjY5MjkgNDEuODU4MkM0MS4yNjcyIDQyLjc2IDQwLjExNjYgNDQuNjU3IDQwLjExNjYgNDUuOTAwOUM0MC4xMTY2IDQ2LjE4MDggNDAuNzA3NCA0Ni4yMTE5IDQwLjg2MjkgNDUuOTYzMVoiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPg==&quot;) !important; transition: background !important;"><button type="button" class="btn relative btn-primary grow min-w-[150px]"><div class="flex grow items-center justify-center"><!--[--> Subscribe <!--]--></div><!----></button></div></div><!--]--></div><!--]--></div><!--[--><!--]--></div><!--]--></article><!--]--></div></div><!--[--><!----><div class="hidden duration-300 ease-in-out h-[calc(100vh-3rem)] lg:pb-[3px] overflow-y-auto pb-14 pl-[3px] pr-[3px] pt-1.5 scrollbar-styled top-[3rem] transition-[flex-basis]"><!--[--><!--]--></div><!--]--></div><dialog id="contentEditDialog-tutorial-xdp-load-balancer-700a1d74" class="modal" data-v-0d30d5a9=""><form method="dialog" class="lg:max-w-3xl modal-box overflow-hidden p-0 relative scrollbar-hidden"><button class="absolute btn btn-circle btn-ghost btn-xs hover:rotate-90 right-2 top-2 transition-transform z-10">  </button><div class="max-h-[calc(100vh-8rem)] overflow-y-auto px-8 py-6 scrollbar-hidden"><h3 class="font-bold mb-2 text-lg"> How to Author Tutorials on iximiuz Labs</h3><p class="py-3 text-base-content/90"> Instead of providing a subpar online editing experience, iximiuz Labs offers a helper CLI tool called <a href="https://github.com/iximiuz/labctl" rel="noopener noreferrer" target="_blank noopener noreferrer" class="link">labctl</a>,
 allowing you to use your favorite text editor (or a full-featured IDE) 
to write content from the comfort of your local machine. </p><div class="flex flex-col gap-y-6 mt-4"><div class="bg-frost-light border border-primary/50 hover:shadow-md p-5 rounded-xl shadow-sm transition-all"><h4 class="flex font-semibold items-center mb-4"> Install labctl CLI </h4><div class="bg-base-content flex items-center justify-between px-3 py-2 rounded-md my-2"><div class="flex grow min-w-0"><code class="break-all md:break-normal md:truncate text-base-200 text-sm"><!--[--> curl -sf https://labs.iximiuz.com/cli/install.sh | sh <!--]--></code></div><button type="button" class="btn relative bg-base-content border-base-content btn-sm btn-square hover:bg-base-content hover:border-base-300/20 hover:text-base-100 text-base-200"><div class="flex grow items-center justify-center"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--ph" style="font-size:22px;" width="1em" height="1em" viewBox="0 0 256 256"><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"></path></svg><!--]--></div><!----></button></div><p class="italic mt-3 text-base-content/90 text-sm"> This will download and install the latest version of the labctl CLI. You only need to do this once per workstation. </p></div><div class="bg-frost-light border border-primary/50 hover:shadow-md p-5 rounded-xl shadow-sm transition-all"><h4 class="flex font-semibold items-center mb-4"> Authorize labctl </h4><div class="bg-base-content flex items-center justify-between px-3 py-2 rounded-md my-2"><div class="flex grow min-w-0"><code class="break-all md:break-normal md:truncate text-base-200 text-sm"><!--[--> labctl auth login <!--]--></code></div><button type="button" class="btn relative bg-base-content border-base-content btn-sm btn-square hover:bg-base-content hover:border-base-300/20 hover:text-base-100 text-base-200"><div class="flex grow items-center justify-center"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--ph" style="font-size:22px;" width="1em" height="1em" viewBox="0 0 256 256"><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"></path></svg><!--]--></div><!----></button></div><p class="italic mt-3 text-base-content/90 text-sm">
 This will open a browser window asking you to authorize labctl to 
access your account. You need to do it after a fresh install of labctl 
and repeat it whenever the auth session expires. </p></div><div class="bg-frost-light border border-primary/50 hover:shadow-md p-5 rounded-xl shadow-sm transition-all"><h4 class="flex font-semibold items-center mb-4"> Pull tutorial content </h4><div class="bg-base-content flex items-center justify-between px-3 py-2 rounded-md my-2"><div class="flex grow min-w-0"><code class="break-all md:break-normal md:truncate text-base-200 text-sm"><!--[--> labctl content pull tutorial xdp-load-balancer-700a1d74<!--]--></code></div><button type="button" class="btn relative bg-base-content border-base-content btn-sm btn-square hover:bg-base-content hover:border-base-300/20 hover:text-base-100 text-base-200"><div class="flex grow items-center justify-center"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--ph" style="font-size:22px;" width="1em" height="1em" viewBox="0 0 256 256"><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"></path></svg><!--]--></div><!----></button></div><p class="italic mt-3 text-base-content/90 text-sm"> This will create a local copy of the tutorial content in a directory named <code class="bg-base-300 px-1 py-0.5 rounded">xdp-load-balancer-700a1d74</code>. You only need to do this once per tutorial. </p></div><div class="bg-frost-light border border-primary/50 hover:shadow-md p-5 rounded-xl shadow-sm transition-all"><h4 class="flex font-semibold items-center mb-4"> Stream your changes </h4><div class="bg-base-content flex items-center justify-between px-3 py-2 rounded-md my-2"><div class="flex grow min-w-0"><code class="break-all md:break-normal md:truncate text-base-200 text-sm"><!--[--> labctl content push -fw tutorial xdp-load-balancer-700a1d74<!--]--></code></div><button type="button" class="btn relative bg-base-content border-base-content btn-sm btn-square hover:bg-base-content hover:border-base-300/20 hover:text-base-100 text-base-200"><div class="flex grow items-center justify-center"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--ph" style="font-size:22px;" width="1em" height="1em" viewBox="0 0 256 256"><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"></path></svg><!--]--></div><!----></button></div><p class="italic mt-3 text-base-content/90 text-sm">
 Run this command in a separate terminal to continuously upload your 
changes to the server while editing the tutorial in your favorite text 
editor or IDE. </p></div><p class="leading-relaxed p-4 text-base-content/90 text-sm"> You can also use labctl to create, list, and delete your content. Learn more about the available commands: <code class="bg-base-300 px-1 py-0.5 rounded">labctl content --help</code></p></div></div></form><form method="dialog" class="backdrop-blur-sm modal-backdrop"><button>close</button></form></dialog><div class="border-slate-400 border-t bottom-0 fixed left-0 lg:hidden right-0 z-50" data-v-0d30d5a9=""><div class="flex glass items-center justify-center p-2.5"><!--[--><a href="https://labs.iximiuz.com/signup?return_to=%2Ftutorials%2Fxdp-load-balancer-700a1d74" class="btn bg-base-100 btn-neutral btn-outline btn-sm gap-2 shadow-md" role="button"><!--[--><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" class="h-4 mr-1 w-4"><path fill-rule="evenodd" d="M4.5 5.653c0-1.427 1.529-2.33 2.779-1.643l11.54 6.347c1.295.712 1.295 2.573 0 3.286L7.28 19.99c-1.25.687-2.779-.217-2.779-1.643V5.653Z" clip-rule="evenodd"></path></svg> Start tutorial<!--]--></a><!--]--></div></div></div><!--]--></div></div><div id="teleports"></div><script nonce="">window.__NUXT__={};window.__NUXT__.config={public:{environment:"production",siteName:"iximiuz Labs",siteEmail:"ivan@iximiuz.com",siteUrl:"https://labs.iximiuz.com",site:{url:"https://labs.iximiuz.com"},siteTitle:"iximiuz Labs - Indie Learning Platform to Master Server Side Craft",siteDescription:"Skill up in Linux, Networking, Containers, and Kubernetes by taking courses, following interactive tutorials, and solving fun DevOps challenges.",discordServerUrl:"https://discord.gg/p6nxaHm46p",gumroadProfileUrl:"https://products.iximiuz.com",newsletterUrl:"https://newsletter.iximiuz.com/",emailSubsCount:"20,000",mdc:{components:{prose:true,map:{p:"prose-p",a:"prose-a",blockquote:"prose-blockquote",pre:"prose-pre","code-inline":"prose-code-inline",code:"prose-code-inline",em:"prose-em",h1:"prose-h1",h2:"prose-h2",h3:"prose-h3",h4:"prose-h4",h5:"prose-h5",h6:"prose-h6",hr:"prose-hr",img:"prose-img",ul:"prose-ul",ol:"prose-ol",li:"prose-li",strong:"prose-strong",script:"prose-script",table:"prose-table",thead:"prose-thead",tbody:"prose-tbody",td:"prose-td",th:"prose-th",tr:"prose-tr"},customElements:[]},headings:{anchorLinks:{h1:false,h2:true,h3:true,h4:true,h5:false,h6:false}},highlight:{theme:"slack-dark",preload:["ada","c","csharp","diff","java","js","json","docker","go","hcl","make","md","php","proto","python","rust","shell","ts","yaml","toml"],highlighter:"shiki",shikiEngine:"oniguruma",langs:["js","jsx","json","ts","tsx","vue","css","html","bash","md","mdc","yaml","ada","c","csharp","diff","java","js","json","docker","go","hcl","make","md","php","proto","python","rust","shell","ts","yaml","toml"]}},plausible:{enabled:true,hashMode:false,domain:"labs.iximiuz.com",ignoredHostnames:["localhost"],ignoreSubDomains:false,trackLocalhost:"",apiHost:"https://plausible.io",autoPageviews:true,autoOutboundTracking:false,logIgnoredEvents:false,proxy:false,proxyBaseEndpoint:"/_plausible"},"nuxt-robots":{version:"5.7.0",isNuxtContentV2:false,debug:false,credits:false,groups:[{userAgent:["*"],disallow:["/account","/dashboard","/new","/enter","/main","/signin","/signup","/*/settings","*?returnTo=","*?return_to=","_nuxt"],allow:[],contentUsage:[],contentSignal:[],_indexable:true,_rules:[{pattern:"/account",allow:false},{pattern:"/dashboard",allow:false},{pattern:"/new",allow:false},{pattern:"/enter",allow:false},{pattern:"/main",allow:false},{pattern:"/signin",allow:false},{pattern:"/signup",allow:false},{pattern:"/*/settings",allow:false},{pattern:"*?returnTo=",allow:false},{pattern:"*?return_to=",allow:false},{pattern:"_nuxt",allow:false}],_normalized:true}],sitemap:["https://labs.iximiuz.com/sitemap.xml","/sitemap.xml"],header:true,robotsEnabledValue:"index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1",robotsDisabledValue:"noindex, nofollow",cacheControl:"max-age=14400, must-revalidate",botDetection:true,pageMetaRobots:{}}},app:{baseURL:"/",buildId:"b756282a-436d-4378-9e80-d3bbd54cd54a",buildAssetsDir:"/_nuxt/",cdnURL:""}}</script><script nonce="" type="application/json" data-nuxt-data="nuxt-app" data-ssr="true" id="__NUXT_DATA__">[["ShallowReactive",1],{"data":2,"state":7189,"once":7204,"_errors":7205,"serverRendered":11,"path":7207},["ShallowReactive",3],{"tutorial-page-tutorial-xdp-load-balancer-700a1d74":4,"content-tutorial-xdp-load-balancer-700a1d74-v1767696312484":65,"i-material-symbols-light:expand-content":7183,"i-ph:copy":7186},{"id":5,"kind":6,"name":7,"title":8,"description":9,"createdAt":10,"updatedAt":10,"independent":11,"trusted":11,"published":11,"playground":12,"units":13,"owner":18,"authors":19,"contentVersion":26,"pageUrl":27,"cover":28,"categories":29,"tags":32,"status":34,"tasks":35,"attemptCount":56,"completionCount":57,"accessControl":58,"userAccess":64},"68f39e5adfa98d1769378246","tutorial","xdp-load-balancer-700a1d74","Building an eBPF/XDP NAT-Based Layer 4 Load Balancer from Scratch","Learn how an eBPF/XDP-based NAT Layer 4 load balancer works by building one from scratch. We implement simple connection tracking, deterministic hashing, and IP/MAC rewriting with a small, easy-to-follow example.","2026-01-06T00:00:00.000Z",true,"flexbox",[14],{"name":7,"hash":15,"title":8,"description":9,"createdAt":16,"updatedAt":16,"file":17},"#xdp-load-balancer-700a1d74","2026-01-06","tutorials/xdp-load-balancer-700a1d74/index.md","6620fa0e724db85e6791a6e2",[20],{"id":21,"createdAt":22,"userId":18,"name":23,"displayName":24,"avatarUrl":25,"independent":11,"certified":11},"68a57e83267bd767257a8c00","2025-08-20T07:51:31.012Z","teodor-janez-podobnik","Teodor Janez Podobnik","https://avatars.githubusercontent.com/u/48418580",1767696312484,"https://labs.iximiuz.com/tutorials/xdp-load-balancer-700a1d74","/content/files/tutorials/xdp-load-balancer-700a1d74/__static__/cover-lb.png",[30,31],"linux","programming",[33],"eBPF","todo",{"setup_networking_lb":36,"setup_networking_backend_01":41,"setup_networking_backend_02":44,"setup_networking_gateway":47,"setup_networking_client_01":50,"clone_lab":53},{"init":11,"machine":37,"user":38,"name":39,"status":40},"lb","root","setup_networking_lb",0,{"init":11,"machine":42,"user":38,"name":43,"status":40},"backend-01","setup_networking_backend_01",{"init":11,"machine":45,"user":38,"name":46,"status":40},"backend-02","setup_networking_backend_02",{"init":11,"machine":48,"user":38,"name":49,"status":40},"gateway","setup_networking_gateway",{"init":11,"machine":51,"user":38,"name":52,"status":40},"client","setup_networking_client_01",{"init":11,"machine":37,"user":54,"name":55,"status":40},"laborant","clone_lab",54,7,{"canList":59,"canPreview":61,"canRead":62,"canStart":63},[60],"anyone",[60],[60],[60],{"canList":11,"canPreview":11,"canRead":11,"canStart":11},[66],{"title":8,"description":67,"kind":6,"categories":68,"tagz":69,"createdAt":10,"updatedAt":10,"cover":28,"playground":70,"type":38,"children":147,"hash":15,"preview":-1,"pageUrl":27,"tasks":7169,"toc":7170,"tutorials":7176,"challenges":7178,"courses":7180,"key":7182},"Learn how an eBPF/XDP-based NAT Layer 4 load balancer works by building one from scratch. We implement simple connection tracking, deterministic hashing, and IP/MAC rewriting with a small, easy-to-follow example.\n",[30,31],[33],{"name":12,"networks":71,"machines":81},[72,75,78],{"name":73,"subnet":74,"private":11},"net-1","192.168.178.0/24",{"name":76,"subnet":77,"private":11},"net-2","10.0.0.0/16",{"name":79,"subnet":80},"net-3","172.16.0.0/24",[82,99,110,121,136],{"name":37,"kernel":83,"drives":84,"users":89,"network":92,"resources":96},"6.1",[85],{"source":86,"mount":87,"size":88},"oci://ghcr.io/dorkamotorka/ebpf-labs:latest","/","10GiB",[90],{"name":54,"default":11,"welcome":91},"This is the load balancer node.\n\nIP: 192.168.178.10/24\n",{"interfaces":93},[94],{"network":73,"address":95},"192.168.178.10",{"cpuCount":97,"ramSize":98},1,"1GiB",{"name":42,"kernel":83,"drives":100,"users":102,"network":105,"resources":109},[101],{"source":86,"mount":87,"size":88},[103],{"name":54,"default":11,"welcome":104},"This is a backend node.\n\nIP: 192.168.178.11/24\n",{"interfaces":106},[107],{"network":73,"address":108},"192.168.178.11",{"cpuCount":97,"ramSize":98},{"name":45,"kernel":83,"drives":111,"users":113,"network":116,"resources":120},[112],{"source":86,"mount":87,"size":88},[114],{"name":54,"default":11,"welcome":115},"This is a backend node.\n\nIP: 192.168.178.12/24\n",{"interfaces":117},[118],{"network":73,"address":119},"192.168.178.12",{"cpuCount":97,"ramSize":98},{"name":48,"kernel":83,"drives":122,"users":124,"network":127,"resources":135},[123],{"source":86,"mount":87,"size":88},[125],{"name":54,"default":11,"welcome":126},"This is a gateway node that is attached to both networks.\n\nIP #1: 192.168.178.2/24\nIP #2: 10.0.0.2/16\nIP #3: 172.16.0.2/24 (Just for internet access)\n",{"interfaces":128},[129,131,133],{"network":73,"address":130},"192.168.178.2",{"network":76,"address":132},"10.0.0.2",{"network":79,"address":134},"172.16.0.2",{"cpuCount":97,"ramSize":98},{"name":51,"kernel":83,"drives":137,"users":139,"network":142,"resources":146},[138],{"source":86,"mount":87,"size":88},[140],{"name":54,"default":11,"welcome":141},"This is a client node.\n\nIP: 10.0.0.20/16\n",{"interfaces":143},[144],{"network":76,"address":145},"10.0.0.20",{"cpuCount":97,"ramSize":98},[148,176,181,203,210,220,229,234,239,246,251,256,275,280,286,291,316,321,326,331,341,346,351,356,361,366,1190,2582,2604,2609,2615,2620,2668,2673,2721,2729,2734,2739,2744,2749,2754,2784,2796,3727,3743,3751,3756,3761,3767,3772,3784,3809,3861,3866,3881,3899,3911,4011,6143,6603,6609,6614,6701,6706,6717,6751,6756,6819,6839,6902,6935,6953,6983,6995,7015,7026,7055,7060,7065,7069,7074,7087,7092,7100,7105,7110,7158,7163],{"type":149,"tag":150,"props":151,"children":152},"element","p",{},[153,156,165,167,174],{"type":154,"value":155},"text","Traditional load balancers like ",{"type":149,"tag":157,"props":158,"children":162},"a",{"href":159,"rel":160},"https://nginx.org/",[161],"nofollow",[163],{"type":154,"value":164},"NGINX",{"type":154,"value":166}," and ",{"type":149,"tag":157,"props":168,"children":171},{"href":169,"rel":170},"https://www.haproxy.org/",[161],[172],{"type":154,"value":173},"HAProxy",{"type":154,"value":175}," typically operate in user space. Even when used purely for Layer 4 forwarding, every incoming packet must traverse the kernels networking stack to reach the user-space socket and then travel back down to the kernel before being forwarded to a backend.",{"type":149,"tag":150,"props":177,"children":178},{},[179],{"type":154,"value":180},"Each of these traversals  crossing the userkernel boundary, context switching, and buffer copying  adds microseconds of latency. It may sound small, but at millions of packets per second, this overhead quickly becomes a performance bottleneck that even modern hardware struggles to overcome.",{"type":149,"tag":150,"props":182,"children":183},{},[184,186,193,194,201],{"type":154,"value":185},"To address this, eBPF/XDP-based Layer 4 load balancers were introduced  a concept that companies like ",{"type":149,"tag":157,"props":187,"children":190},{"href":188,"rel":189},"https://github.com/facebookincubator/katran",[161],[191],{"type":154,"value":192},"Meta (Katran)",{"type":154,"value":166},{"type":149,"tag":157,"props":195,"children":198},{"href":196,"rel":197},"https://cilium.io/use-cases/load-balancer/",[161],[199],{"type":154,"value":200},"Cisco/Isovalent (Cilium)",{"type":154,"value":202}," have already turned into production-grade systems.",{"type":149,"tag":204,"props":205,"children":209},"image-box",{":alt":206,":src":207,":max-width":208},"eBPF/XDP NAT Load Balancer","/content/files/tutorials/xdp-load-balancer-700a1d74/__static__/transparent-lb.png","700px",[],{"type":149,"tag":211,"props":212,"children":214},"remark-box",{"kind":213},"info",[215],{"type":149,"tag":150,"props":216,"children":217},{},[218],{"type":154,"value":219}," Im referring specifically to Layer 4, since while eBPF-based Layer 7 load balancing is possible, so far I haven't seen any mature production solution yetlikely because implementing L7 features is too complex, outweighing the potential performance gains.",{"type":149,"tag":150,"props":221,"children":222},{},[223],{"type":149,"tag":224,"props":225,"children":226},"strong",{},[227],{"type":154,"value":228},"But how do these eBPF-based load balancers actually work?",{"type":149,"tag":150,"props":230,"children":231},{},[232],{"type":154,"value":233},"Understanding how these projects leverage eBPF is quite hard  especially because there are no minimal, easy-to-run examples that clearly demonstrate the fundamentals.",{"type":149,"tag":150,"props":235,"children":236},{},[237],{"type":154,"value":238},"This tutorial aims to fill that gap. Well walk through a simple XDP NAT Load Balancer implementation in roughly 200 lines of code (plus some boilerplate). And then in the upcoming tutorial, well build on this foundation with features like DSR (Direct Server Return) Layer 2 load balancing and IPIP encapsulation.",{"type":149,"tag":240,"props":241,"children":243},"h2",{"id":242},"nat-network-address-translation-and-ebpf",[244],{"type":154,"value":245},"NAT (Network Address Translation) and eBPF",{"type":149,"tag":150,"props":247,"children":248},{},[249],{"type":154,"value":250},"Before even putting load balancing into context, its important to first understand NAT (Network Address Translation) and how it would fit into the eBPF implementation.",{"type":149,"tag":150,"props":252,"children":253},{},[254],{"type":154,"value":255},"In short, NAT is a mechanism that modifies/replaces IP address (and often port as well) in the packet header as it passes through the (routing) node that runs it.",{"type":149,"tag":150,"props":257,"children":258},{},[259,261,266,268,273],{"type":154,"value":260},"We typically see it used on ",{"type":149,"tag":224,"props":262,"children":263},{},[264],{"type":154,"value":265},"routers or gateways",{"type":154,"value":267}," that connect two different networks (for example, a private LAN and the public internet), and on ",{"type":149,"tag":224,"props":269,"children":270},{},[271],{"type":154,"value":272},"load balancers",{"type":154,"value":274}," that rewrite packet destinations when forwarding traffic to backend servers.",{"type":149,"tag":150,"props":276,"children":277},{},[278],{"type":154,"value":279},"Regardless of the use case, if you are new to this topic think of it like this (intentionally simplified):",{"type":149,"tag":204,"props":281,"children":285},{":alt":282,":src":283,":max-width":284},"NAT Concept","/content/files/tutorials/xdp-load-balancer-700a1d74/__static__/nat-basic.png","800px",[],{"type":149,"tag":150,"props":287,"children":288},{},[289],{"type":154,"value":290},"Without going into too much details, NAT relies on a NAT table to define these translation rules and uses:",{"type":149,"tag":292,"props":293,"children":294},"ul",{},[295,306],{"type":149,"tag":296,"props":297,"children":298},"li",{},[299,304],{"type":149,"tag":224,"props":300,"children":301},{},[302],{"type":154,"value":303},"Source Network Address Translation (SNAT)",{"type":154,"value":305}," (outbound request) to replace the source IP address, and",{"type":149,"tag":296,"props":307,"children":308},{},[309,314],{"type":149,"tag":224,"props":310,"children":311},{},[312],{"type":154,"value":313},"Destination Network Address Translation (DNAT)",{"type":154,"value":315}," (incoming response) to replace the destination IP address.",{"type":149,"tag":150,"props":317,"children":318},{},[319],{"type":154,"value":320},"And this is similar to what a NAT-based Load Balancer (LB) also does (intentionally simplified):",{"type":149,"tag":204,"props":322,"children":325},{":alt":323,":src":324,":max-width":284},"NAT Concept in Load Balancer","/content/files/tutorials/xdp-load-balancer-700a1d74/__static__/xdp-nat-lb-new.png",[],{"type":149,"tag":150,"props":327,"children":328},{},[329],{"type":154,"value":330},"Its actually a bit trickier than that when you put virtual IPs (VIPs) and Direct Server Return (DSR) into the context, but well get to that.",{"type":149,"tag":150,"props":332,"children":333},{},[334,336],{"type":154,"value":335},"And while a load balancer doesnt necessarily store this information in a NAT table like a router or gateway, it instead keeps it in some local variable or table  but the concept remains the same  ",{"type":149,"tag":224,"props":337,"children":338},{},[339],{"type":154,"value":340},"it must remember which client made the request so it can send the backends response back to that same client.",{"type":149,"tag":150,"props":342,"children":343},{},[344],{"type":154,"value":345},"Depending on the setup, the load balancer typically retains a 5-tuple client information  the client source IP, load balancer destination IP, client source port, load balancer destination port, and protocol (TCP/UDP).",{"type":149,"tag":150,"props":347,"children":348},{},[349],{"type":154,"value":350},"This way, when the response comes back, the load balancer receives it from a connection defined by the backends source IP and port, the load balancers destination IP and port, and the specific protocol. Using this information, it knows exactly which client initiated the request.",{"type":149,"tag":150,"props":352,"children":353},{},[354],{"type":154,"value":355},"Heres an image that illustrates these mappings.",{"type":149,"tag":204,"props":357,"children":360},{":alt":358,":src":359,":max-width":208},"NAT Mappings","/content/files/tutorials/xdp-load-balancer-700a1d74/__static__/nat-mappings.png",[],{"type":149,"tag":150,"props":362,"children":363},{},[364],{"type":154,"value":365},"And when you think about this conceptstoring client information on the request as it travels through the load balancer and retrieving it on the backends responseits relatively straightforward to implement in eBPF. We just need an eBPF map to hold this 5-tuple connection information.",{"type":149,"tag":367,"props":368,"children":395},"pre",{"className":369,"code":370,"filename":371,"highlights":372,"language":393,"meta":394,"style":394},"language-c shiki shiki-themes slack-dark","  ...\n  // Lookup conntrack (connection tracking) information - actually eBPF map\n  // NO EXISTING CONNECTION: client request\n  // EXISTING CONNECTION: backend response\n  struct five_tuple_t in = {};\n  in.src_ip = ip->daddr;     // LB destination IP\n  in.dst_ip = ip->saddr;     // Client or Backend source IP\n  in.src_port = tcp->dest;   // LB destination port same as source port from which it redirected the request to backend\n  in.dst_port = tcp->source; // Client or Backend source port\n  in.protocol = IPPROTO_TCP; // TCP protocol\n  struct endpoint *out = bpf_map_lookup_elem(&conntrack, &in);\n  if (!out) {\n    bpf_printk(\"Packet from client because no such connection exists yet\");\n    ...\n    // Store connection in the conntrack eBPF map so we can\n    // redirect backends response to the \"correct\" client\n    struct five_tuple_t in_loadbalancer = {};\n    in_loadbalancer.src_ip = ip->daddr;     // LB IP\n    in_loadbalancer.dst_ip = backend->ip;   // Backend IP\n    in_loadbalancer.src_port = tcp->source; // Client source port - equal to the LB source port since we don't modify it!\n    in_loadbalancer.dst_port = tcp->dest;   // LB destination port\n    in_loadbalancer.protocol = IPPROTO_TCP; // TCP protocol \n    struct endpoint client;\n    client.ip = ip->saddr; // Store Client IP as value in the eBPF map\n    int ret = bpf_map_update_elem(&conntrack, &in_loadbalancer, &client, BPF_ANY);\n    ...\n  } else {\n    bpf_printk(\"Packet from backend because the connection exists - \"\n               \"redirecting back to client\");\n    ...\n  }\n  ...\n","lab/lb.c",[373,374,375,376,377,57,378,379,380,381,382,383,384,385,386,387,388,389,390,391,392],2,3,4,5,6,8,9,10,11,15,16,17,18,19,20,21,22,23,24,25,"c","",[396],{"type":149,"tag":397,"props":398,"children":399},"code",{"__ignoreMap":394},[400,411,422,431,440,472,505,536,568,599,622,690,715,738,747,756,765,791,838,882,925,968,998,1011,1054,1108,1116,1135,1152,1165,1173,1182],{"type":149,"tag":401,"props":402,"children":404},"span",{"class":403,"line":97},"line",[405],{"type":149,"tag":401,"props":406,"children":408},{"style":407},"--shiki-default:#E6E6E6",[409],{"type":154,"value":410},"  ...\n",{"type":149,"tag":401,"props":412,"children":415},{"class":413,"line":373},[403,414],"highlight",[416],{"type":149,"tag":401,"props":417,"children":419},{"style":418},"--shiki-default:#6A9955",[420],{"type":154,"value":421},"  // Lookup conntrack (connection tracking) information - actually eBPF map\n",{"type":149,"tag":401,"props":423,"children":425},{"class":424,"line":374},[403,414],[426],{"type":149,"tag":401,"props":427,"children":428},{"style":418},[429],{"type":154,"value":430},"  // NO EXISTING CONNECTION: client request\n",{"type":149,"tag":401,"props":432,"children":434},{"class":433,"line":375},[403,414],[435],{"type":149,"tag":401,"props":436,"children":437},{"style":418},[438],{"type":154,"value":439},"  // EXISTING CONNECTION: backend response\n",{"type":149,"tag":401,"props":441,"children":443},{"class":442,"line":376},[403,414],[444,450,456,461,467],{"type":149,"tag":401,"props":445,"children":447},{"style":446},"--shiki-default:#569CD6",[448],{"type":154,"value":449},"  struct",{"type":149,"tag":401,"props":451,"children":453},{"style":452},"--shiki-default:#4EC9B0",[454],{"type":154,"value":455}," five_tuple_t",{"type":149,"tag":401,"props":457,"children":458},{"style":407},[459],{"type":154,"value":460}," in ",{"type":149,"tag":401,"props":462,"children":464},{"style":463},"--shiki-default:#D4D4D4",[465],{"type":154,"value":466},"=",{"type":149,"tag":401,"props":468,"children":469},{"style":407},[470],{"type":154,"value":471}," {};\n",{"type":149,"tag":401,"props":473,"children":475},{"class":474,"line":377},[403,414],[476,481,485,490,495,500],{"type":149,"tag":401,"props":477,"children":478},{"style":407},[479],{"type":154,"value":480},"  in.src_ip ",{"type":149,"tag":401,"props":482,"children":483},{"style":463},[484],{"type":154,"value":466},{"type":149,"tag":401,"props":486,"children":487},{"style":407},[488],{"type":154,"value":489}," ip",{"type":149,"tag":401,"props":491,"children":492},{"style":463},[493],{"type":154,"value":494},"->",{"type":149,"tag":401,"props":496,"children":497},{"style":407},[498],{"type":154,"value":499},"daddr;",{"type":149,"tag":401,"props":501,"children":502},{"style":418},[503],{"type":154,"value":504},"     // LB destination IP\n",{"type":149,"tag":401,"props":506,"children":508},{"class":507,"line":57},[403,414],[509,514,518,522,526,531],{"type":149,"tag":401,"props":510,"children":511},{"style":407},[512],{"type":154,"value":513},"  in.dst_ip ",{"type":149,"tag":401,"props":515,"children":516},{"style":463},[517],{"type":154,"value":466},{"type":149,"tag":401,"props":519,"children":520},{"style":407},[521],{"type":154,"value":489},{"type":149,"tag":401,"props":523,"children":524},{"style":463},[525],{"type":154,"value":494},{"type":149,"tag":401,"props":527,"children":528},{"style":407},[529],{"type":154,"value":530},"saddr;",{"type":149,"tag":401,"props":532,"children":533},{"style":418},[534],{"type":154,"value":535},"     // Client or Backend source IP\n",{"type":149,"tag":401,"props":537,"children":539},{"class":538,"line":378},[403,414],[540,545,549,554,558,563],{"type":149,"tag":401,"props":541,"children":542},{"style":407},[543],{"type":154,"value":544},"  in.src_port ",{"type":149,"tag":401,"props":546,"children":547},{"style":463},[548],{"type":154,"value":466},{"type":149,"tag":401,"props":550,"children":551},{"style":407},[552],{"type":154,"value":553}," tcp",{"type":149,"tag":401,"props":555,"children":556},{"style":463},[557],{"type":154,"value":494},{"type":149,"tag":401,"props":559,"children":560},{"style":407},[561],{"type":154,"value":562},"dest;",{"type":149,"tag":401,"props":564,"children":565},{"style":418},[566],{"type":154,"value":567},"   // LB destination port same as source port from which it redirected the request to backend\n",{"type":149,"tag":401,"props":569,"children":571},{"class":570,"line":379},[403,414],[572,577,581,585,589,594],{"type":149,"tag":401,"props":573,"children":574},{"style":407},[575],{"type":154,"value":576},"  in.dst_port ",{"type":149,"tag":401,"props":578,"children":579},{"style":463},[580],{"type":154,"value":466},{"type":149,"tag":401,"props":582,"children":583},{"style":407},[584],{"type":154,"value":553},{"type":149,"tag":401,"props":586,"children":587},{"style":463},[588],{"type":154,"value":494},{"type":149,"tag":401,"props":590,"children":591},{"style":407},[592],{"type":154,"value":593},"source;",{"type":149,"tag":401,"props":595,"children":596},{"style":418},[597],{"type":154,"value":598}," // Client or Backend source port\n",{"type":149,"tag":401,"props":600,"children":602},{"class":601,"line":380},[403,414],[603,608,612,617],{"type":149,"tag":401,"props":604,"children":605},{"style":407},[606],{"type":154,"value":607},"  in.protocol ",{"type":149,"tag":401,"props":609,"children":610},{"style":463},[611],{"type":154,"value":466},{"type":149,"tag":401,"props":613,"children":614},{"style":407},[615],{"type":154,"value":616}," IPPROTO_TCP;",{"type":149,"tag":401,"props":618,"children":619},{"style":418},[620],{"type":154,"value":621}," // TCP protocol\n",{"type":149,"tag":401,"props":623,"children":625},{"class":624,"line":381},[403,414],[626,630,635,640,645,649,655,660,665,671,676,680,685],{"type":149,"tag":401,"props":627,"children":628},{"style":446},[629],{"type":154,"value":449},{"type":149,"tag":401,"props":631,"children":632},{"style":407},[633],{"type":154,"value":634}," endpoint ",{"type":149,"tag":401,"props":636,"children":637},{"style":463},[638],{"type":154,"value":639},"*",{"type":149,"tag":401,"props":641,"children":642},{"style":407},[643],{"type":154,"value":644},"out ",{"type":149,"tag":401,"props":646,"children":647},{"style":463},[648],{"type":154,"value":466},{"type":149,"tag":401,"props":650,"children":652},{"style":651},"--shiki-default:#DCDCAA",[653],{"type":154,"value":654}," bpf_map_lookup_elem",{"type":149,"tag":401,"props":656,"children":657},{"style":407},[658],{"type":154,"value":659},"(",{"type":149,"tag":401,"props":661,"children":662},{"style":463},[663],{"type":154,"value":664},"&",{"type":149,"tag":401,"props":666,"children":668},{"style":667},"--shiki-default:#9CDCFE",[669],{"type":154,"value":670},"conntrack",{"type":149,"tag":401,"props":672,"children":673},{"style":407},[674],{"type":154,"value":675},", ",{"type":149,"tag":401,"props":677,"children":678},{"style":463},[679],{"type":154,"value":664},{"type":149,"tag":401,"props":681,"children":682},{"style":667},[683],{"type":154,"value":684},"in",{"type":149,"tag":401,"props":686,"children":687},{"style":407},[688],{"type":154,"value":689},");\n",{"type":149,"tag":401,"props":691,"children":693},{"class":403,"line":692},12,[694,700,705,710],{"type":149,"tag":401,"props":695,"children":697},{"style":696},"--shiki-default:#C586C0",[698],{"type":154,"value":699},"  if",{"type":149,"tag":401,"props":701,"children":702},{"style":407},[703],{"type":154,"value":704}," (",{"type":149,"tag":401,"props":706,"children":707},{"style":463},[708],{"type":154,"value":709},"!",{"type":149,"tag":401,"props":711,"children":712},{"style":407},[713],{"type":154,"value":714},"out) {\n",{"type":149,"tag":401,"props":716,"children":718},{"class":403,"line":717},13,[719,724,728,734],{"type":149,"tag":401,"props":720,"children":721},{"style":651},[722],{"type":154,"value":723},"    bpf_printk",{"type":149,"tag":401,"props":725,"children":726},{"style":407},[727],{"type":154,"value":659},{"type":149,"tag":401,"props":729,"children":731},{"style":730},"--shiki-default:#CE9178",[732],{"type":154,"value":733},"\"Packet from client because no such connection exists yet\"",{"type":149,"tag":401,"props":735,"children":736},{"style":407},[737],{"type":154,"value":689},{"type":149,"tag":401,"props":739,"children":741},{"class":403,"line":740},14,[742],{"type":149,"tag":401,"props":743,"children":744},{"style":407},[745],{"type":154,"value":746},"    ...\n",{"type":149,"tag":401,"props":748,"children":750},{"class":749,"line":382},[403,414],[751],{"type":149,"tag":401,"props":752,"children":753},{"style":418},[754],{"type":154,"value":755},"    // Store connection in the conntrack eBPF map so we can\n",{"type":149,"tag":401,"props":757,"children":759},{"class":758,"line":383},[403,414],[760],{"type":149,"tag":401,"props":761,"children":762},{"style":418},[763],{"type":154,"value":764},"    // redirect backends response to the \"correct\" client\n",{"type":149,"tag":401,"props":766,"children":768},{"class":767,"line":384},[403,414],[769,774,778,783,787],{"type":149,"tag":401,"props":770,"children":771},{"style":446},[772],{"type":154,"value":773},"    struct",{"type":149,"tag":401,"props":775,"children":776},{"style":452},[777],{"type":154,"value":455},{"type":149,"tag":401,"props":779,"children":780},{"style":407},[781],{"type":154,"value":782}," in_loadbalancer ",{"type":149,"tag":401,"props":784,"children":785},{"style":463},[786],{"type":154,"value":466},{"type":149,"tag":401,"props":788,"children":789},{"style":407},[790],{"type":154,"value":471},{"type":149,"tag":401,"props":792,"children":794},{"class":793,"line":385},[403,414],[795,800,805,810,815,819,823,828,833],{"type":149,"tag":401,"props":796,"children":797},{"style":667},[798],{"type":154,"value":799},"    in_loadbalancer",{"type":149,"tag":401,"props":801,"children":802},{"style":407},[803],{"type":154,"value":804},".",{"type":149,"tag":401,"props":806,"children":807},{"style":667},[808],{"type":154,"value":809},"src_ip",{"type":149,"tag":401,"props":811,"children":812},{"style":463},[813],{"type":154,"value":814}," =",{"type":149,"tag":401,"props":816,"children":817},{"style":667},[818],{"type":154,"value":489},{"type":149,"tag":401,"props":820,"children":821},{"style":407},[822],{"type":154,"value":494},{"type":149,"tag":401,"props":824,"children":825},{"style":667},[826],{"type":154,"value":827},"daddr",{"type":149,"tag":401,"props":829,"children":830},{"style":407},[831],{"type":154,"value":832},";",{"type":149,"tag":401,"props":834,"children":835},{"style":418},[836],{"type":154,"value":837},"     // LB IP\n",{"type":149,"tag":401,"props":839,"children":841},{"class":840,"line":386},[403,414],[842,846,850,855,859,864,868,873,877],{"type":149,"tag":401,"props":843,"children":844},{"style":667},[845],{"type":154,"value":799},{"type":149,"tag":401,"props":847,"children":848},{"style":407},[849],{"type":154,"value":804},{"type":149,"tag":401,"props":851,"children":852},{"style":667},[853],{"type":154,"value":854},"dst_ip",{"type":149,"tag":401,"props":856,"children":857},{"style":463},[858],{"type":154,"value":814},{"type":149,"tag":401,"props":860,"children":861},{"style":667},[862],{"type":154,"value":863}," backend",{"type":149,"tag":401,"props":865,"children":866},{"style":407},[867],{"type":154,"value":494},{"type":149,"tag":401,"props":869,"children":870},{"style":667},[871],{"type":154,"value":872},"ip",{"type":149,"tag":401,"props":874,"children":875},{"style":407},[876],{"type":154,"value":832},{"type":149,"tag":401,"props":878,"children":879},{"style":418},[880],{"type":154,"value":881},"   // Backend IP\n",{"type":149,"tag":401,"props":883,"children":885},{"class":884,"line":387},[403,414],[886,890,894,899,903,907,911,916,920],{"type":149,"tag":401,"props":887,"children":888},{"style":667},[889],{"type":154,"value":799},{"type":149,"tag":401,"props":891,"children":892},{"style":407},[893],{"type":154,"value":804},{"type":149,"tag":401,"props":895,"children":896},{"style":667},[897],{"type":154,"value":898},"src_port",{"type":149,"tag":401,"props":900,"children":901},{"style":463},[902],{"type":154,"value":814},{"type":149,"tag":401,"props":904,"children":905},{"style":667},[906],{"type":154,"value":553},{"type":149,"tag":401,"props":908,"children":909},{"style":407},[910],{"type":154,"value":494},{"type":149,"tag":401,"props":912,"children":913},{"style":667},[914],{"type":154,"value":915},"source",{"type":149,"tag":401,"props":917,"children":918},{"style":407},[919],{"type":154,"value":832},{"type":149,"tag":401,"props":921,"children":922},{"style":418},[923],{"type":154,"value":924}," // Client source port - equal to the LB source port since we don't modify it!\n",{"type":149,"tag":401,"props":926,"children":928},{"class":927,"line":388},[403,414],[929,933,937,942,946,950,954,959,963],{"type":149,"tag":401,"props":930,"children":931},{"style":667},[932],{"type":154,"value":799},{"type":149,"tag":401,"props":934,"children":935},{"style":407},[936],{"type":154,"value":804},{"type":149,"tag":401,"props":938,"children":939},{"style":667},[940],{"type":154,"value":941},"dst_port",{"type":149,"tag":401,"props":943,"children":944},{"style":463},[945],{"type":154,"value":814},{"type":149,"tag":401,"props":947,"children":948},{"style":667},[949],{"type":154,"value":553},{"type":149,"tag":401,"props":951,"children":952},{"style":407},[953],{"type":154,"value":494},{"type":149,"tag":401,"props":955,"children":956},{"style":667},[957],{"type":154,"value":958},"dest",{"type":149,"tag":401,"props":960,"children":961},{"style":407},[962],{"type":154,"value":832},{"type":149,"tag":401,"props":964,"children":965},{"style":418},[966],{"type":154,"value":967},"   // LB destination port\n",{"type":149,"tag":401,"props":969,"children":971},{"class":970,"line":389},[403,414],[972,976,980,985,989,993],{"type":149,"tag":401,"props":973,"children":974},{"style":667},[975],{"type":154,"value":799},{"type":149,"tag":401,"props":977,"children":978},{"style":407},[979],{"type":154,"value":804},{"type":149,"tag":401,"props":981,"children":982},{"style":667},[983],{"type":154,"value":984},"protocol",{"type":149,"tag":401,"props":986,"children":987},{"style":463},[988],{"type":154,"value":814},{"type":149,"tag":401,"props":990,"children":991},{"style":407},[992],{"type":154,"value":616},{"type":149,"tag":401,"props":994,"children":995},{"style":418},[996],{"type":154,"value":997}," // TCP protocol \n",{"type":149,"tag":401,"props":999,"children":1001},{"class":1000,"line":390},[403,414],[1002,1006],{"type":149,"tag":401,"props":1003,"children":1004},{"style":446},[1005],{"type":154,"value":773},{"type":149,"tag":401,"props":1007,"children":1008},{"style":407},[1009],{"type":154,"value":1010}," endpoint client;\n",{"type":149,"tag":401,"props":1012,"children":1014},{"class":1013,"line":391},[403,414],[1015,1020,1024,1028,1032,1036,1040,1045,1049],{"type":149,"tag":401,"props":1016,"children":1017},{"style":667},[1018],{"type":154,"value":1019},"    client",{"type":149,"tag":401,"props":1021,"children":1022},{"style":407},[1023],{"type":154,"value":804},{"type":149,"tag":401,"props":1025,"children":1026},{"style":667},[1027],{"type":154,"value":872},{"type":149,"tag":401,"props":1029,"children":1030},{"style":463},[1031],{"type":154,"value":814},{"type":149,"tag":401,"props":1033,"children":1034},{"style":667},[1035],{"type":154,"value":489},{"type":149,"tag":401,"props":1037,"children":1038},{"style":407},[1039],{"type":154,"value":494},{"type":149,"tag":401,"props":1041,"children":1042},{"style":667},[1043],{"type":154,"value":1044},"saddr",{"type":149,"tag":401,"props":1046,"children":1047},{"style":407},[1048],{"type":154,"value":832},{"type":149,"tag":401,"props":1050,"children":1051},{"style":418},[1052],{"type":154,"value":1053}," // Store Client IP as value in the eBPF map\n",{"type":149,"tag":401,"props":1055,"children":1057},{"class":1056,"line":392},[403,414],[1058,1063,1068,1072,1077,1081,1085,1090,1094,1099,1103],{"type":149,"tag":401,"props":1059,"children":1060},{"style":446},[1061],{"type":154,"value":1062},"    int",{"type":149,"tag":401,"props":1064,"children":1065},{"style":407},[1066],{"type":154,"value":1067}," ret ",{"type":149,"tag":401,"props":1069,"children":1070},{"style":463},[1071],{"type":154,"value":466},{"type":149,"tag":401,"props":1073,"children":1074},{"style":651},[1075],{"type":154,"value":1076}," bpf_map_update_elem",{"type":149,"tag":401,"props":1078,"children":1079},{"style":407},[1080],{"type":154,"value":659},{"type":149,"tag":401,"props":1082,"children":1083},{"style":463},[1084],{"type":154,"value":664},{"type":149,"tag":401,"props":1086,"children":1087},{"style":407},[1088],{"type":154,"value":1089},"conntrack, ",{"type":149,"tag":401,"props":1091,"children":1092},{"style":463},[1093],{"type":154,"value":664},{"type":149,"tag":401,"props":1095,"children":1096},{"style":407},[1097],{"type":154,"value":1098},"in_loadbalancer, ",{"type":149,"tag":401,"props":1100,"children":1101},{"style":463},[1102],{"type":154,"value":664},{"type":149,"tag":401,"props":1104,"children":1105},{"style":407},[1106],{"type":154,"value":1107},"client, BPF_ANY);\n",{"type":149,"tag":401,"props":1109,"children":1111},{"class":403,"line":1110},26,[1112],{"type":149,"tag":401,"props":1113,"children":1114},{"style":407},[1115],{"type":154,"value":746},{"type":149,"tag":401,"props":1117,"children":1119},{"class":403,"line":1118},27,[1120,1125,1130],{"type":149,"tag":401,"props":1121,"children":1122},{"style":407},[1123],{"type":154,"value":1124},"  } ",{"type":149,"tag":401,"props":1126,"children":1127},{"style":696},[1128],{"type":154,"value":1129},"else",{"type":149,"tag":401,"props":1131,"children":1132},{"style":407},[1133],{"type":154,"value":1134}," {\n",{"type":149,"tag":401,"props":1136,"children":1138},{"class":403,"line":1137},28,[1139,1143,1147],{"type":149,"tag":401,"props":1140,"children":1141},{"style":651},[1142],{"type":154,"value":723},{"type":149,"tag":401,"props":1144,"children":1145},{"style":407},[1146],{"type":154,"value":659},{"type":149,"tag":401,"props":1148,"children":1149},{"style":730},[1150],{"type":154,"value":1151},"\"Packet from backend because the connection exists - \"\n",{"type":149,"tag":401,"props":1153,"children":1155},{"class":403,"line":1154},29,[1156,1161],{"type":149,"tag":401,"props":1157,"children":1158},{"style":730},[1159],{"type":154,"value":1160},"               \"redirecting back to client\"",{"type":149,"tag":401,"props":1162,"children":1163},{"style":407},[1164],{"type":154,"value":689},{"type":149,"tag":401,"props":1166,"children":1168},{"class":403,"line":1167},30,[1169],{"type":149,"tag":401,"props":1170,"children":1171},{"style":407},[1172],{"type":154,"value":746},{"type":149,"tag":401,"props":1174,"children":1176},{"class":403,"line":1175},31,[1177],{"type":149,"tag":401,"props":1178,"children":1179},{"style":407},[1180],{"type":154,"value":1181},"  }\n",{"type":149,"tag":401,"props":1183,"children":1185},{"class":403,"line":1184},32,[1186],{"type":149,"tag":401,"props":1187,"children":1188},{"style":407},[1189],{"type":154,"value":410},{"type":149,"tag":1191,"props":1192,"children":1194},"details-box",{"summary":1193},"Still confusing?",[1195,1200,1890,1895,2577],{"type":149,"tag":150,"props":1196,"children":1197},{},[1198],{"type":154,"value":1199},"Whenever a client sends a request, our eBPF map (which acts like a simple NAT table) doesnt yet contain any connection information. In that case, we create and store a new entry:",{"type":149,"tag":367,"props":1201,"children":1204},{"className":369,"code":1202,"filename":371,"highlights":1203,"language":393,"meta":394,"style":394},"  ...\n  // Lookup conntrack (connection tracking) information - actually eBPF map\n  // NO EXISTING CONNECTION: client request\n  // EXISTING CONNECTION: backend response\n  struct five_tuple_t in = {};\n  in.src_ip = ip->daddr;     // LB destination IP\n  in.dst_ip = ip->saddr;     // Client or Backend source IP\n  in.src_port = tcp->dest;   // LB destination port same as source port from which it redirected the request to backend\n  in.dst_port = tcp->source; // Client or Backend source port\n  in.protocol = IPPROTO_TCP; // TCP protocol\n  struct endpoint *out = bpf_map_lookup_elem(&conntrack, &in); // \u003C- returns a NULL!\n  if (!out) {\n    bpf_printk(\"Packet from client because no such connection exists yet\");\n    ...\n    // Store connection in the conntrack eBPF map so we can\n    // redirect backends response to the \"correct\" client\n    struct five_tuple_t in_loadbalancer = {};\n    in_loadbalancer.src_ip = ip->daddr;     // LB IP\n    in_loadbalancer.dst_ip = backend->ip;   // Backend IP\n    in_loadbalancer.src_port = tcp->source; // Client source port - equal to the LB source port since we don't modify it!\n    in_loadbalancer.dst_port = tcp->dest;   // LB destination port\n    in_loadbalancer.protocol = IPPROTO_TCP; // TCP protocol \n    struct endpoint client;\n    client.ip = ip->saddr; // Store Client IP as value in the eBPF map\n    int ret = bpf_map_update_elem(&conntrack, &in_loadbalancer, &client, BPF_ANY);\n    ...\n  } else {\n    bpf_printk(\"Packet from backend because the connection exists - \"\n               \"redirecting back to client\");\n    ...\n  }\n  ...\n",[381,382,383,384,385,386,387,388,389,390,391,392],[1205],{"type":149,"tag":397,"props":1206,"children":1207},{"__ignoreMap":394},[1208,1215,1222,1229,1236,1259,1286,1313,1340,1367,1386,1448,1467,1486,1493,1501,1509,1533,1573,1613,1653,1693,1721,1733,1773,1821,1828,1843,1858,1869,1876,1883],{"type":149,"tag":401,"props":1209,"children":1210},{"class":403,"line":97},[1211],{"type":149,"tag":401,"props":1212,"children":1213},{"style":407},[1214],{"type":154,"value":410},{"type":149,"tag":401,"props":1216,"children":1217},{"class":403,"line":373},[1218],{"type":149,"tag":401,"props":1219,"children":1220},{"style":418},[1221],{"type":154,"value":421},{"type":149,"tag":401,"props":1223,"children":1224},{"class":403,"line":374},[1225],{"type":149,"tag":401,"props":1226,"children":1227},{"style":418},[1228],{"type":154,"value":430},{"type":149,"tag":401,"props":1230,"children":1231},{"class":403,"line":375},[1232],{"type":149,"tag":401,"props":1233,"children":1234},{"style":418},[1235],{"type":154,"value":439},{"type":149,"tag":401,"props":1237,"children":1238},{"class":403,"line":376},[1239,1243,1247,1251,1255],{"type":149,"tag":401,"props":1240,"children":1241},{"style":446},[1242],{"type":154,"value":449},{"type":149,"tag":401,"props":1244,"children":1245},{"style":452},[1246],{"type":154,"value":455},{"type":149,"tag":401,"props":1248,"children":1249},{"style":407},[1250],{"type":154,"value":460},{"type":149,"tag":401,"props":1252,"children":1253},{"style":463},[1254],{"type":154,"value":466},{"type":149,"tag":401,"props":1256,"children":1257},{"style":407},[1258],{"type":154,"value":471},{"type":149,"tag":401,"props":1260,"children":1261},{"class":403,"line":377},[1262,1266,1270,1274,1278,1282],{"type":149,"tag":401,"props":1263,"children":1264},{"style":407},[1265],{"type":154,"value":480},{"type":149,"tag":401,"props":1267,"children":1268},{"style":463},[1269],{"type":154,"value":466},{"type":149,"tag":401,"props":1271,"children":1272},{"style":407},[1273],{"type":154,"value":489},{"type":149,"tag":401,"props":1275,"children":1276},{"style":463},[1277],{"type":154,"value":494},{"type":149,"tag":401,"props":1279,"children":1280},{"style":407},[1281],{"type":154,"value":499},{"type":149,"tag":401,"props":1283,"children":1284},{"style":418},[1285],{"type":154,"value":504},{"type":149,"tag":401,"props":1287,"children":1288},{"class":403,"line":57},[1289,1293,1297,1301,1305,1309],{"type":149,"tag":401,"props":1290,"children":1291},{"style":407},[1292],{"type":154,"value":513},{"type":149,"tag":401,"props":1294,"children":1295},{"style":463},[1296],{"type":154,"value":466},{"type":149,"tag":401,"props":1298,"children":1299},{"style":407},[1300],{"type":154,"value":489},{"type":149,"tag":401,"props":1302,"children":1303},{"style":463},[1304],{"type":154,"value":494},{"type":149,"tag":401,"props":1306,"children":1307},{"style":407},[1308],{"type":154,"value":530},{"type":149,"tag":401,"props":1310,"children":1311},{"style":418},[1312],{"type":154,"value":535},{"type":149,"tag":401,"props":1314,"children":1315},{"class":403,"line":378},[1316,1320,1324,1328,1332,1336],{"type":149,"tag":401,"props":1317,"children":1318},{"style":407},[1319],{"type":154,"value":544},{"type":149,"tag":401,"props":1321,"children":1322},{"style":463},[1323],{"type":154,"value":466},{"type":149,"tag":401,"props":1325,"children":1326},{"style":407},[1327],{"type":154,"value":553},{"type":149,"tag":401,"props":1329,"children":1330},{"style":463},[1331],{"type":154,"value":494},{"type":149,"tag":401,"props":1333,"children":1334},{"style":407},[1335],{"type":154,"value":562},{"type":149,"tag":401,"props":1337,"children":1338},{"style":418},[1339],{"type":154,"value":567},{"type":149,"tag":401,"props":1341,"children":1342},{"class":403,"line":379},[1343,1347,1351,1355,1359,1363],{"type":149,"tag":401,"props":1344,"children":1345},{"style":407},[1346],{"type":154,"value":576},{"type":149,"tag":401,"props":1348,"children":1349},{"style":463},[1350],{"type":154,"value":466},{"type":149,"tag":401,"props":1352,"children":1353},{"style":407},[1354],{"type":154,"value":553},{"type":149,"tag":401,"props":1356,"children":1357},{"style":463},[1358],{"type":154,"value":494},{"type":149,"tag":401,"props":1360,"children":1361},{"style":407},[1362],{"type":154,"value":593},{"type":149,"tag":401,"props":1364,"children":1365},{"style":418},[1366],{"type":154,"value":598},{"type":149,"tag":401,"props":1368,"children":1369},{"class":403,"line":380},[1370,1374,1378,1382],{"type":149,"tag":401,"props":1371,"children":1372},{"style":407},[1373],{"type":154,"value":607},{"type":149,"tag":401,"props":1375,"children":1376},{"style":463},[1377],{"type":154,"value":466},{"type":149,"tag":401,"props":1379,"children":1380},{"style":407},[1381],{"type":154,"value":616},{"type":149,"tag":401,"props":1383,"children":1384},{"style":418},[1385],{"type":154,"value":621},{"type":149,"tag":401,"props":1387,"children":1389},{"class":1388,"line":381},[403,414],[1390,1394,1398,1402,1406,1410,1414,1418,1422,1426,1430,1434,1438,1443],{"type":149,"tag":401,"props":1391,"children":1392},{"style":446},[1393],{"type":154,"value":449},{"type":149,"tag":401,"props":1395,"children":1396},{"style":407},[1397],{"type":154,"value":634},{"type":149,"tag":401,"props":1399,"children":1400},{"style":463},[1401],{"type":154,"value":639},{"type":149,"tag":401,"props":1403,"children":1404},{"style":407},[1405],{"type":154,"value":644},{"type":149,"tag":401,"props":1407,"children":1408},{"style":463},[1409],{"type":154,"value":466},{"type":149,"tag":401,"props":1411,"children":1412},{"style":651},[1413],{"type":154,"value":654},{"type":149,"tag":401,"props":1415,"children":1416},{"style":407},[1417],{"type":154,"value":659},{"type":149,"tag":401,"props":1419,"children":1420},{"style":463},[1421],{"type":154,"value":664},{"type":149,"tag":401,"props":1423,"children":1424},{"style":667},[1425],{"type":154,"value":670},{"type":149,"tag":401,"props":1427,"children":1428},{"style":407},[1429],{"type":154,"value":675},{"type":149,"tag":401,"props":1431,"children":1432},{"style":463},[1433],{"type":154,"value":664},{"type":149,"tag":401,"props":1435,"children":1436},{"style":667},[1437],{"type":154,"value":684},{"type":149,"tag":401,"props":1439,"children":1440},{"style":407},[1441],{"type":154,"value":1442},");",{"type":149,"tag":401,"props":1444,"children":1445},{"style":418},[1446],{"type":154,"value":1447}," // \u003C- returns a NULL!\n",{"type":149,"tag":401,"props":1449,"children":1450},{"class":403,"line":692},[1451,1455,1459,1463],{"type":149,"tag":401,"props":1452,"children":1453},{"style":696},[1454],{"type":154,"value":699},{"type":149,"tag":401,"props":1456,"children":1457},{"style":407},[1458],{"type":154,"value":704},{"type":149,"tag":401,"props":1460,"children":1461},{"style":463},[1462],{"type":154,"value":709},{"type":149,"tag":401,"props":1464,"children":1465},{"style":407},[1466],{"type":154,"value":714},{"type":149,"tag":401,"props":1468,"children":1469},{"class":403,"line":717},[1470,1474,1478,1482],{"type":149,"tag":401,"props":1471,"children":1472},{"style":651},[1473],{"type":154,"value":723},{"type":149,"tag":401,"props":1475,"children":1476},{"style":407},[1477],{"type":154,"value":659},{"type":149,"tag":401,"props":1479,"children":1480},{"style":730},[1481],{"type":154,"value":733},{"type":149,"tag":401,"props":1483,"children":1484},{"style":407},[1485],{"type":154,"value":689},{"type":149,"tag":401,"props":1487,"children":1488},{"class":403,"line":740},[1489],{"type":149,"tag":401,"props":1490,"children":1491},{"style":407},[1492],{"type":154,"value":746},{"type":149,"tag":401,"props":1494,"children":1496},{"class":1495,"line":382},[403,414],[1497],{"type":149,"tag":401,"props":1498,"children":1499},{"style":418},[1500],{"type":154,"value":755},{"type":149,"tag":401,"props":1502,"children":1504},{"class":1503,"line":383},[403,414],[1505],{"type":149,"tag":401,"props":1506,"children":1507},{"style":418},[1508],{"type":154,"value":764},{"type":149,"tag":401,"props":1510,"children":1512},{"class":1511,"line":384},[403,414],[1513,1517,1521,1525,1529],{"type":149,"tag":401,"props":1514,"children":1515},{"style":446},[1516],{"type":154,"value":773},{"type":149,"tag":401,"props":1518,"children":1519},{"style":452},[1520],{"type":154,"value":455},{"type":149,"tag":401,"props":1522,"children":1523},{"style":407},[1524],{"type":154,"value":782},{"type":149,"tag":401,"props":1526,"children":1527},{"style":463},[1528],{"type":154,"value":466},{"type":149,"tag":401,"props":1530,"children":1531},{"style":407},[1532],{"type":154,"value":471},{"type":149,"tag":401,"props":1534,"children":1536},{"class":1535,"line":385},[403,414],[1537,1541,1545,1549,1553,1557,1561,1565,1569],{"type":149,"tag":401,"props":1538,"children":1539},{"style":667},[1540],{"type":154,"value":799},{"type":149,"tag":401,"props":1542,"children":1543},{"style":407},[1544],{"type":154,"value":804},{"type":149,"tag":401,"props":1546,"children":1547},{"style":667},[1548],{"type":154,"value":809},{"type":149,"tag":401,"props":1550,"children":1551},{"style":463},[1552],{"type":154,"value":814},{"type":149,"tag":401,"props":1554,"children":1555},{"style":667},[1556],{"type":154,"value":489},{"type":149,"tag":401,"props":1558,"children":1559},{"style":407},[1560],{"type":154,"value":494},{"type":149,"tag":401,"props":1562,"children":1563},{"style":667},[1564],{"type":154,"value":827},{"type":149,"tag":401,"props":1566,"children":1567},{"style":407},[1568],{"type":154,"value":832},{"type":149,"tag":401,"props":1570,"children":1571},{"style":418},[1572],{"type":154,"value":837},{"type":149,"tag":401,"props":1574,"children":1576},{"class":1575,"line":386},[403,414],[1577,1581,1585,1589,1593,1597,1601,1605,1609],{"type":149,"tag":401,"props":1578,"children":1579},{"style":667},[1580],{"type":154,"value":799},{"type":149,"tag":401,"props":1582,"children":1583},{"style":407},[1584],{"type":154,"value":804},{"type":149,"tag":401,"props":1586,"children":1587},{"style":667},[1588],{"type":154,"value":854},{"type":149,"tag":401,"props":1590,"children":1591},{"style":463},[1592],{"type":154,"value":814},{"type":149,"tag":401,"props":1594,"children":1595},{"style":667},[1596],{"type":154,"value":863},{"type":149,"tag":401,"props":1598,"children":1599},{"style":407},[1600],{"type":154,"value":494},{"type":149,"tag":401,"props":1602,"children":1603},{"style":667},[1604],{"type":154,"value":872},{"type":149,"tag":401,"props":1606,"children":1607},{"style":407},[1608],{"type":154,"value":832},{"type":149,"tag":401,"props":1610,"children":1611},{"style":418},[1612],{"type":154,"value":881},{"type":149,"tag":401,"props":1614,"children":1616},{"class":1615,"line":387},[403,414],[1617,1621,1625,1629,1633,1637,1641,1645,1649],{"type":149,"tag":401,"props":1618,"children":1619},{"style":667},[1620],{"type":154,"value":799},{"type":149,"tag":401,"props":1622,"children":1623},{"style":407},[1624],{"type":154,"value":804},{"type":149,"tag":401,"props":1626,"children":1627},{"style":667},[1628],{"type":154,"value":898},{"type":149,"tag":401,"props":1630,"children":1631},{"style":463},[1632],{"type":154,"value":814},{"type":149,"tag":401,"props":1634,"children":1635},{"style":667},[1636],{"type":154,"value":553},{"type":149,"tag":401,"props":1638,"children":1639},{"style":407},[1640],{"type":154,"value":494},{"type":149,"tag":401,"props":1642,"children":1643},{"style":667},[1644],{"type":154,"value":915},{"type":149,"tag":401,"props":1646,"children":1647},{"style":407},[1648],{"type":154,"value":832},{"type":149,"tag":401,"props":1650,"children":1651},{"style":418},[1652],{"type":154,"value":924},{"type":149,"tag":401,"props":1654,"children":1656},{"class":1655,"line":388},[403,414],[1657,1661,1665,1669,1673,1677,1681,1685,1689],{"type":149,"tag":401,"props":1658,"children":1659},{"style":667},[1660],{"type":154,"value":799},{"type":149,"tag":401,"props":1662,"children":1663},{"style":407},[1664],{"type":154,"value":804},{"type":149,"tag":401,"props":1666,"children":1667},{"style":667},[1668],{"type":154,"value":941},{"type":149,"tag":401,"props":1670,"children":1671},{"style":463},[1672],{"type":154,"value":814},{"type":149,"tag":401,"props":1674,"children":1675},{"style":667},[1676],{"type":154,"value":553},{"type":149,"tag":401,"props":1678,"children":1679},{"style":407},[1680],{"type":154,"value":494},{"type":149,"tag":401,"props":1682,"children":1683},{"style":667},[1684],{"type":154,"value":958},{"type":149,"tag":401,"props":1686,"children":1687},{"style":407},[1688],{"type":154,"value":832},{"type":149,"tag":401,"props":1690,"children":1691},{"style":418},[1692],{"type":154,"value":967},{"type":149,"tag":401,"props":1694,"children":1696},{"class":1695,"line":389},[403,414],[1697,1701,1705,1709,1713,1717],{"type":149,"tag":401,"props":1698,"children":1699},{"style":667},[1700],{"type":154,"value":799},{"type":149,"tag":401,"props":1702,"children":1703},{"style":407},[1704],{"type":154,"value":804},{"type":149,"tag":401,"props":1706,"children":1707},{"style":667},[1708],{"type":154,"value":984},{"type":149,"tag":401,"props":1710,"children":1711},{"style":463},[1712],{"type":154,"value":814},{"type":149,"tag":401,"props":1714,"children":1715},{"style":407},[1716],{"type":154,"value":616},{"type":149,"tag":401,"props":1718,"children":1719},{"style":418},[1720],{"type":154,"value":997},{"type":149,"tag":401,"props":1722,"children":1724},{"class":1723,"line":390},[403,414],[1725,1729],{"type":149,"tag":401,"props":1726,"children":1727},{"style":446},[1728],{"type":154,"value":773},{"type":149,"tag":401,"props":1730,"children":1731},{"style":407},[1732],{"type":154,"value":1010},{"type":149,"tag":401,"props":1734,"children":1736},{"class":1735,"line":391},[403,414],[1737,1741,1745,1749,1753,1757,1761,1765,1769],{"type":149,"tag":401,"props":1738,"children":1739},{"style":667},[1740],{"type":154,"value":1019},{"type":149,"tag":401,"props":1742,"children":1743},{"style":407},[1744],{"type":154,"value":804},{"type":149,"tag":401,"props":1746,"children":1747},{"style":667},[1748],{"type":154,"value":872},{"type":149,"tag":401,"props":1750,"children":1751},{"style":463},[1752],{"type":154,"value":814},{"type":149,"tag":401,"props":1754,"children":1755},{"style":667},[1756],{"type":154,"value":489},{"type":149,"tag":401,"props":1758,"children":1759},{"style":407},[1760],{"type":154,"value":494},{"type":149,"tag":401,"props":1762,"children":1763},{"style":667},[1764],{"type":154,"value":1044},{"type":149,"tag":401,"props":1766,"children":1767},{"style":407},[1768],{"type":154,"value":832},{"type":149,"tag":401,"props":1770,"children":1771},{"style":418},[1772],{"type":154,"value":1053},{"type":149,"tag":401,"props":1774,"children":1776},{"class":1775,"line":392},[403,414],[1777,1781,1785,1789,1793,1797,1801,1805,1809,1813,1817],{"type":149,"tag":401,"props":1778,"children":1779},{"style":446},[1780],{"type":154,"value":1062},{"type":149,"tag":401,"props":1782,"children":1783},{"style":407},[1784],{"type":154,"value":1067},{"type":149,"tag":401,"props":1786,"children":1787},{"style":463},[1788],{"type":154,"value":466},{"type":149,"tag":401,"props":1790,"children":1791},{"style":651},[1792],{"type":154,"value":1076},{"type":149,"tag":401,"props":1794,"children":1795},{"style":407},[1796],{"type":154,"value":659},{"type":149,"tag":401,"props":1798,"children":1799},{"style":463},[1800],{"type":154,"value":664},{"type":149,"tag":401,"props":1802,"children":1803},{"style":407},[1804],{"type":154,"value":1089},{"type":149,"tag":401,"props":1806,"children":1807},{"style":463},[1808],{"type":154,"value":664},{"type":149,"tag":401,"props":1810,"children":1811},{"style":407},[1812],{"type":154,"value":1098},{"type":149,"tag":401,"props":1814,"children":1815},{"style":463},[1816],{"type":154,"value":664},{"type":149,"tag":401,"props":1818,"children":1819},{"style":407},[1820],{"type":154,"value":1107},{"type":149,"tag":401,"props":1822,"children":1823},{"class":403,"line":1110},[1824],{"type":149,"tag":401,"props":1825,"children":1826},{"style":407},[1827],{"type":154,"value":746},{"type":149,"tag":401,"props":1829,"children":1830},{"class":403,"line":1118},[1831,1835,1839],{"type":149,"tag":401,"props":1832,"children":1833},{"style":407},[1834],{"type":154,"value":1124},{"type":149,"tag":401,"props":1836,"children":1837},{"style":696},[1838],{"type":154,"value":1129},{"type":149,"tag":401,"props":1840,"children":1841},{"style":407},[1842],{"type":154,"value":1134},{"type":149,"tag":401,"props":1844,"children":1845},{"class":403,"line":1137},[1846,1850,1854],{"type":149,"tag":401,"props":1847,"children":1848},{"style":651},[1849],{"type":154,"value":723},{"type":149,"tag":401,"props":1851,"children":1852},{"style":407},[1853],{"type":154,"value":659},{"type":149,"tag":401,"props":1855,"children":1856},{"style":730},[1857],{"type":154,"value":1151},{"type":149,"tag":401,"props":1859,"children":1860},{"class":403,"line":1154},[1861,1865],{"type":149,"tag":401,"props":1862,"children":1863},{"style":730},[1864],{"type":154,"value":1160},{"type":149,"tag":401,"props":1866,"children":1867},{"style":407},[1868],{"type":154,"value":689},{"type":149,"tag":401,"props":1870,"children":1871},{"class":403,"line":1167},[1872],{"type":149,"tag":401,"props":1873,"children":1874},{"style":407},[1875],{"type":154,"value":746},{"type":149,"tag":401,"props":1877,"children":1878},{"class":403,"line":1175},[1879],{"type":149,"tag":401,"props":1880,"children":1881},{"style":407},[1882],{"type":154,"value":1181},{"type":149,"tag":401,"props":1884,"children":1885},{"class":403,"line":1184},[1886],{"type":149,"tag":401,"props":1887,"children":1888},{"style":407},[1889],{"type":154,"value":410},{"type":149,"tag":150,"props":1891,"children":1892},{},[1893],{"type":154,"value":1894},"Well skip the low-level details of how the packet is actually rewritten and forwarded to the backend (well cover that later). For now, assume the packet successfully reaches the backend, and the backend sends a response to the load balancer:",{"type":149,"tag":367,"props":1896,"children":1899},{"className":369,"code":1897,"filename":371,"highlights":1898,"language":393,"meta":394,"style":394},"  ...\n  // Lookup conntrack (connection tracking) information - actually eBPF map\n  // NO EXISTING CONNECTION: client request\n  // EXISTING CONNECTION: backend response\n  struct five_tuple_t in = {};\n  in.src_ip = ip->daddr;     // LB destination IP\n  in.dst_ip = ip->saddr;     // Client or Backend source IP\n  in.src_port = tcp->dest;   // LB destination port same as source port from which it redirected the request to backend\n  in.dst_port = tcp->source; // Client or Backend source port\n  in.protocol = IPPROTO_TCP; // TCP protocol\n  struct endpoint *out = bpf_map_lookup_elem(&conntrack, &in); // \u003C- returns the client endpoint because the connection exist!\n  if (!out) {\n    bpf_printk(\"Packet from client because no such connection exists yet\");\n    ...\n    // Store connection in the conntrack eBPF map so we can\n    // redirect backends response to the \"correct\" client\n    struct five_tuple_t in_loadbalancer = {};\n    in_loadbalancer.src_ip = ip->daddr;     // LB IP\n    in_loadbalancer.dst_ip = backend->ip;   // Backend IP\n    in_loadbalancer.src_port = tcp->source; // Client source port - equal to the LB source port since we don't modify it!\n    in_loadbalancer.dst_port = tcp->dest;   // LB destination port\n    in_loadbalancer.protocol = IPPROTO_TCP; // TCP protocol \n    struct endpoint client;\n    client.ip = ip->saddr; // Store Client IP as value in the eBPF map\n    int ret = bpf_map_update_elem(&conntrack, &in_loadbalancer, &client, BPF_ANY);\n    ...\n  } else {\n    bpf_printk(\"Packet from backend because the connection exists - \"\n               \"redirecting back to client\");\n    ...\n  }\n  ...\n",[381,1118,1137,1154,1167],[1900],{"type":149,"tag":397,"props":1901,"children":1902},{"__ignoreMap":394},[1903,1910,1917,1924,1931,1954,1981,2008,2035,2062,2081,2142,2161,2180,2187,2194,2201,2224,2263,2302,2341,2380,2407,2418,2457,2504,2511,2527,2543,2555,2563,2570],{"type":149,"tag":401,"props":1904,"children":1905},{"class":403,"line":97},[1906],{"type":149,"tag":401,"props":1907,"children":1908},{"style":407},[1909],{"type":154,"value":410},{"type":149,"tag":401,"props":1911,"children":1912},{"class":403,"line":373},[1913],{"type":149,"tag":401,"props":1914,"children":1915},{"style":418},[1916],{"type":154,"value":421},{"type":149,"tag":401,"props":1918,"children":1919},{"class":403,"line":374},[1920],{"type":149,"tag":401,"props":1921,"children":1922},{"style":418},[1923],{"type":154,"value":430},{"type":149,"tag":401,"props":1925,"children":1926},{"class":403,"line":375},[1927],{"type":149,"tag":401,"props":1928,"children":1929},{"style":418},[1930],{"type":154,"value":439},{"type":149,"tag":401,"props":1932,"children":1933},{"class":403,"line":376},[1934,1938,1942,1946,1950],{"type":149,"tag":401,"props":1935,"children":1936},{"style":446},[1937],{"type":154,"value":449},{"type":149,"tag":401,"props":1939,"children":1940},{"style":452},[1941],{"type":154,"value":455},{"type":149,"tag":401,"props":1943,"children":1944},{"style":407},[1945],{"type":154,"value":460},{"type":149,"tag":401,"props":1947,"children":1948},{"style":463},[1949],{"type":154,"value":466},{"type":149,"tag":401,"props":1951,"children":1952},{"style":407},[1953],{"type":154,"value":471},{"type":149,"tag":401,"props":1955,"children":1956},{"class":403,"line":377},[1957,1961,1965,1969,1973,1977],{"type":149,"tag":401,"props":1958,"children":1959},{"style":407},[1960],{"type":154,"value":480},{"type":149,"tag":401,"props":1962,"children":1963},{"style":463},[1964],{"type":154,"value":466},{"type":149,"tag":401,"props":1966,"children":1967},{"style":407},[1968],{"type":154,"value":489},{"type":149,"tag":401,"props":1970,"children":1971},{"style":463},[1972],{"type":154,"value":494},{"type":149,"tag":401,"props":1974,"children":1975},{"style":407},[1976],{"type":154,"value":499},{"type":149,"tag":401,"props":1978,"children":1979},{"style":418},[1980],{"type":154,"value":504},{"type":149,"tag":401,"props":1982,"children":1983},{"class":403,"line":57},[1984,1988,1992,1996,2000,2004],{"type":149,"tag":401,"props":1985,"children":1986},{"style":407},[1987],{"type":154,"value":513},{"type":149,"tag":401,"props":1989,"children":1990},{"style":463},[1991],{"type":154,"value":466},{"type":149,"tag":401,"props":1993,"children":1994},{"style":407},[1995],{"type":154,"value":489},{"type":149,"tag":401,"props":1997,"children":1998},{"style":463},[1999],{"type":154,"value":494},{"type":149,"tag":401,"props":2001,"children":2002},{"style":407},[2003],{"type":154,"value":530},{"type":149,"tag":401,"props":2005,"children":2006},{"style":418},[2007],{"type":154,"value":535},{"type":149,"tag":401,"props":2009,"children":2010},{"class":403,"line":378},[2011,2015,2019,2023,2027,2031],{"type":149,"tag":401,"props":2012,"children":2013},{"style":407},[2014],{"type":154,"value":544},{"type":149,"tag":401,"props":2016,"children":2017},{"style":463},[2018],{"type":154,"value":466},{"type":149,"tag":401,"props":2020,"children":2021},{"style":407},[2022],{"type":154,"value":553},{"type":149,"tag":401,"props":2024,"children":2025},{"style":463},[2026],{"type":154,"value":494},{"type":149,"tag":401,"props":2028,"children":2029},{"style":407},[2030],{"type":154,"value":562},{"type":149,"tag":401,"props":2032,"children":2033},{"style":418},[2034],{"type":154,"value":567},{"type":149,"tag":401,"props":2036,"children":2037},{"class":403,"line":379},[2038,2042,2046,2050,2054,2058],{"type":149,"tag":401,"props":2039,"children":2040},{"style":407},[2041],{"type":154,"value":576},{"type":149,"tag":401,"props":2043,"children":2044},{"style":463},[2045],{"type":154,"value":466},{"type":149,"tag":401,"props":2047,"children":2048},{"style":407},[2049],{"type":154,"value":553},{"type":149,"tag":401,"props":2051,"children":2052},{"style":463},[2053],{"type":154,"value":494},{"type":149,"tag":401,"props":2055,"children":2056},{"style":407},[2057],{"type":154,"value":593},{"type":149,"tag":401,"props":2059,"children":2060},{"style":418},[2061],{"type":154,"value":598},{"type":149,"tag":401,"props":2063,"children":2064},{"class":403,"line":380},[2065,2069,2073,2077],{"type":149,"tag":401,"props":2066,"children":2067},{"style":407},[2068],{"type":154,"value":607},{"type":149,"tag":401,"props":2070,"children":2071},{"style":463},[2072],{"type":154,"value":466},{"type":149,"tag":401,"props":2074,"children":2075},{"style":407},[2076],{"type":154,"value":616},{"type":149,"tag":401,"props":2078,"children":2079},{"style":418},[2080],{"type":154,"value":621},{"type":149,"tag":401,"props":2082,"children":2084},{"class":2083,"line":381},[403,414],[2085,2089,2093,2097,2101,2105,2109,2113,2117,2121,2125,2129,2133,2137],{"type":149,"tag":401,"props":2086,"children":2087},{"style":446},[2088],{"type":154,"value":449},{"type":149,"tag":401,"props":2090,"children":2091},{"style":407},[2092],{"type":154,"value":634},{"type":149,"tag":401,"props":2094,"children":2095},{"style":463},[2096],{"type":154,"value":639},{"type":149,"tag":401,"props":2098,"children":2099},{"style":407},[2100],{"type":154,"value":644},{"type":149,"tag":401,"props":2102,"children":2103},{"style":463},[2104],{"type":154,"value":466},{"type":149,"tag":401,"props":2106,"children":2107},{"style":651},[2108],{"type":154,"value":654},{"type":149,"tag":401,"props":2110,"children":2111},{"style":407},[2112],{"type":154,"value":659},{"type":149,"tag":401,"props":2114,"children":2115},{"style":463},[2116],{"type":154,"value":664},{"type":149,"tag":401,"props":2118,"children":2119},{"style":667},[2120],{"type":154,"value":670},{"type":149,"tag":401,"props":2122,"children":2123},{"style":407},[2124],{"type":154,"value":675},{"type":149,"tag":401,"props":2126,"children":2127},{"style":463},[2128],{"type":154,"value":664},{"type":149,"tag":401,"props":2130,"children":2131},{"style":667},[2132],{"type":154,"value":684},{"type":149,"tag":401,"props":2134,"children":2135},{"style":407},[2136],{"type":154,"value":1442},{"type":149,"tag":401,"props":2138,"children":2139},{"style":418},[2140],{"type":154,"value":2141}," // \u003C- returns the client endpoint because the connection exist!\n",{"type":149,"tag":401,"props":2143,"children":2144},{"class":403,"line":692},[2145,2149,2153,2157],{"type":149,"tag":401,"props":2146,"children":2147},{"style":696},[2148],{"type":154,"value":699},{"type":149,"tag":401,"props":2150,"children":2151},{"style":407},[2152],{"type":154,"value":704},{"type":149,"tag":401,"props":2154,"children":2155},{"style":463},[2156],{"type":154,"value":709},{"type":149,"tag":401,"props":2158,"children":2159},{"style":407},[2160],{"type":154,"value":714},{"type":149,"tag":401,"props":2162,"children":2163},{"class":403,"line":717},[2164,2168,2172,2176],{"type":149,"tag":401,"props":2165,"children":2166},{"style":651},[2167],{"type":154,"value":723},{"type":149,"tag":401,"props":2169,"children":2170},{"style":407},[2171],{"type":154,"value":659},{"type":149,"tag":401,"props":2173,"children":2174},{"style":730},[2175],{"type":154,"value":733},{"type":149,"tag":401,"props":2177,"children":2178},{"style":407},[2179],{"type":154,"value":689},{"type":149,"tag":401,"props":2181,"children":2182},{"class":403,"line":740},[2183],{"type":149,"tag":401,"props":2184,"children":2185},{"style":407},[2186],{"type":154,"value":746},{"type":149,"tag":401,"props":2188,"children":2189},{"class":403,"line":382},[2190],{"type":149,"tag":401,"props":2191,"children":2192},{"style":418},[2193],{"type":154,"value":755},{"type":149,"tag":401,"props":2195,"children":2196},{"class":403,"line":383},[2197],{"type":149,"tag":401,"props":2198,"children":2199},{"style":418},[2200],{"type":154,"value":764},{"type":149,"tag":401,"props":2202,"children":2203},{"class":403,"line":384},[2204,2208,2212,2216,2220],{"type":149,"tag":401,"props":2205,"children":2206},{"style":446},[2207],{"type":154,"value":773},{"type":149,"tag":401,"props":2209,"children":2210},{"style":452},[2211],{"type":154,"value":455},{"type":149,"tag":401,"props":2213,"children":2214},{"style":407},[2215],{"type":154,"value":782},{"type":149,"tag":401,"props":2217,"children":2218},{"style":463},[2219],{"type":154,"value":466},{"type":149,"tag":401,"props":2221,"children":2222},{"style":407},[2223],{"type":154,"value":471},{"type":149,"tag":401,"props":2225,"children":2226},{"class":403,"line":385},[2227,2231,2235,2239,2243,2247,2251,2255,2259],{"type":149,"tag":401,"props":2228,"children":2229},{"style":667},[2230],{"type":154,"value":799},{"type":149,"tag":401,"props":2232,"children":2233},{"style":407},[2234],{"type":154,"value":804},{"type":149,"tag":401,"props":2236,"children":2237},{"style":667},[2238],{"type":154,"value":809},{"type":149,"tag":401,"props":2240,"children":2241},{"style":463},[2242],{"type":154,"value":814},{"type":149,"tag":401,"props":2244,"children":2245},{"style":667},[2246],{"type":154,"value":489},{"type":149,"tag":401,"props":2248,"children":2249},{"style":407},[2250],{"type":154,"value":494},{"type":149,"tag":401,"props":2252,"children":2253},{"style":667},[2254],{"type":154,"value":827},{"type":149,"tag":401,"props":2256,"children":2257},{"style":407},[2258],{"type":154,"value":832},{"type":149,"tag":401,"props":2260,"children":2261},{"style":418},[2262],{"type":154,"value":837},{"type":149,"tag":401,"props":2264,"children":2265},{"class":403,"line":386},[2266,2270,2274,2278,2282,2286,2290,2294,2298],{"type":149,"tag":401,"props":2267,"children":2268},{"style":667},[2269],{"type":154,"value":799},{"type":149,"tag":401,"props":2271,"children":2272},{"style":407},[2273],{"type":154,"value":804},{"type":149,"tag":401,"props":2275,"children":2276},{"style":667},[2277],{"type":154,"value":854},{"type":149,"tag":401,"props":2279,"children":2280},{"style":463},[2281],{"type":154,"value":814},{"type":149,"tag":401,"props":2283,"children":2284},{"style":667},[2285],{"type":154,"value":863},{"type":149,"tag":401,"props":2287,"children":2288},{"style":407},[2289],{"type":154,"value":494},{"type":149,"tag":401,"props":2291,"children":2292},{"style":667},[2293],{"type":154,"value":872},{"type":149,"tag":401,"props":2295,"children":2296},{"style":407},[2297],{"type":154,"value":832},{"type":149,"tag":401,"props":2299,"children":2300},{"style":418},[2301],{"type":154,"value":881},{"type":149,"tag":401,"props":2303,"children":2304},{"class":403,"line":387},[2305,2309,2313,2317,2321,2325,2329,2333,2337],{"type":149,"tag":401,"props":2306,"children":2307},{"style":667},[2308],{"type":154,"value":799},{"type":149,"tag":401,"props":2310,"children":2311},{"style":407},[2312],{"type":154,"value":804},{"type":149,"tag":401,"props":2314,"children":2315},{"style":667},[2316],{"type":154,"value":898},{"type":149,"tag":401,"props":2318,"children":2319},{"style":463},[2320],{"type":154,"value":814},{"type":149,"tag":401,"props":2322,"children":2323},{"style":667},[2324],{"type":154,"value":553},{"type":149,"tag":401,"props":2326,"children":2327},{"style":407},[2328],{"type":154,"value":494},{"type":149,"tag":401,"props":2330,"children":2331},{"style":667},[2332],{"type":154,"value":915},{"type":149,"tag":401,"props":2334,"children":2335},{"style":407},[2336],{"type":154,"value":832},{"type":149,"tag":401,"props":2338,"children":2339},{"style":418},[2340],{"type":154,"value":924},{"type":149,"tag":401,"props":2342,"children":2343},{"class":403,"line":388},[2344,2348,2352,2356,2360,2364,2368,2372,2376],{"type":149,"tag":401,"props":2345,"children":2346},{"style":667},[2347],{"type":154,"value":799},{"type":149,"tag":401,"props":2349,"children":2350},{"style":407},[2351],{"type":154,"value":804},{"type":149,"tag":401,"props":2353,"children":2354},{"style":667},[2355],{"type":154,"value":941},{"type":149,"tag":401,"props":2357,"children":2358},{"style":463},[2359],{"type":154,"value":814},{"type":149,"tag":401,"props":2361,"children":2362},{"style":667},[2363],{"type":154,"value":553},{"type":149,"tag":401,"props":2365,"children":2366},{"style":407},[2367],{"type":154,"value":494},{"type":149,"tag":401,"props":2369,"children":2370},{"style":667},[2371],{"type":154,"value":958},{"type":149,"tag":401,"props":2373,"children":2374},{"style":407},[2375],{"type":154,"value":832},{"type":149,"tag":401,"props":2377,"children":2378},{"style":418},[2379],{"type":154,"value":967},{"type":149,"tag":401,"props":2381,"children":2382},{"class":403,"line":389},[2383,2387,2391,2395,2399,2403],{"type":149,"tag":401,"props":2384,"children":2385},{"style":667},[2386],{"type":154,"value":799},{"type":149,"tag":401,"props":2388,"children":2389},{"style":407},[2390],{"type":154,"value":804},{"type":149,"tag":401,"props":2392,"children":2393},{"style":667},[2394],{"type":154,"value":984},{"type":149,"tag":401,"props":2396,"children":2397},{"style":463},[2398],{"type":154,"value":814},{"type":149,"tag":401,"props":2400,"children":2401},{"style":407},[2402],{"type":154,"value":616},{"type":149,"tag":401,"props":2404,"children":2405},{"style":418},[2406],{"type":154,"value":997},{"type":149,"tag":401,"props":2408,"children":2409},{"class":403,"line":390},[2410,2414],{"type":149,"tag":401,"props":2411,"children":2412},{"style":446},[2413],{"type":154,"value":773},{"type":149,"tag":401,"props":2415,"children":2416},{"style":407},[2417],{"type":154,"value":1010},{"type":149,"tag":401,"props":2419,"children":2420},{"class":403,"line":391},[2421,2425,2429,2433,2437,2441,2445,2449,2453],{"type":149,"tag":401,"props":2422,"children":2423},{"style":667},[2424],{"type":154,"value":1019},{"type":149,"tag":401,"props":2426,"children":2427},{"style":407},[2428],{"type":154,"value":804},{"type":149,"tag":401,"props":2430,"children":2431},{"style":667},[2432],{"type":154,"value":872},{"type":149,"tag":401,"props":2434,"children":2435},{"style":463},[2436],{"type":154,"value":814},{"type":149,"tag":401,"props":2438,"children":2439},{"style":667},[2440],{"type":154,"value":489},{"type":149,"tag":401,"props":2442,"children":2443},{"style":407},[2444],{"type":154,"value":494},{"type":149,"tag":401,"props":2446,"children":2447},{"style":667},[2448],{"type":154,"value":1044},{"type":149,"tag":401,"props":2450,"children":2451},{"style":407},[2452],{"type":154,"value":832},{"type":149,"tag":401,"props":2454,"children":2455},{"style":418},[2456],{"type":154,"value":1053},{"type":149,"tag":401,"props":2458,"children":2459},{"class":403,"line":392},[2460,2464,2468,2472,2476,2480,2484,2488,2492,2496,2500],{"type":149,"tag":401,"props":2461,"children":2462},{"style":446},[2463],{"type":154,"value":1062},{"type":149,"tag":401,"props":2465,"children":2466},{"style":407},[2467],{"type":154,"value":1067},{"type":149,"tag":401,"props":2469,"children":2470},{"style":463},[2471],{"type":154,"value":466},{"type":149,"tag":401,"props":2473,"children":2474},{"style":651},[2475],{"type":154,"value":1076},{"type":149,"tag":401,"props":2477,"children":2478},{"style":407},[2479],{"type":154,"value":659},{"type":149,"tag":401,"props":2481,"children":2482},{"style":463},[2483],{"type":154,"value":664},{"type":149,"tag":401,"props":2485,"children":2486},{"style":407},[2487],{"type":154,"value":1089},{"type":149,"tag":401,"props":2489,"children":2490},{"style":463},[2491],{"type":154,"value":664},{"type":149,"tag":401,"props":2493,"children":2494},{"style":407},[2495],{"type":154,"value":1098},{"type":149,"tag":401,"props":2497,"children":2498},{"style":463},[2499],{"type":154,"value":664},{"type":149,"tag":401,"props":2501,"children":2502},{"style":407},[2503],{"type":154,"value":1107},{"type":149,"tag":401,"props":2505,"children":2506},{"class":403,"line":1110},[2507],{"type":149,"tag":401,"props":2508,"children":2509},{"style":407},[2510],{"type":154,"value":746},{"type":149,"tag":401,"props":2512,"children":2514},{"class":2513,"line":1118},[403,414],[2515,2519,2523],{"type":149,"tag":401,"props":2516,"children":2517},{"style":407},[2518],{"type":154,"value":1124},{"type":149,"tag":401,"props":2520,"children":2521},{"style":696},[2522],{"type":154,"value":1129},{"type":149,"tag":401,"props":2524,"children":2525},{"style":407},[2526],{"type":154,"value":1134},{"type":149,"tag":401,"props":2528,"children":2530},{"class":2529,"line":1137},[403,414],[2531,2535,2539],{"type":149,"tag":401,"props":2532,"children":2533},{"style":651},[2534],{"type":154,"value":723},{"type":149,"tag":401,"props":2536,"children":2537},{"style":407},[2538],{"type":154,"value":659},{"type":149,"tag":401,"props":2540,"children":2541},{"style":730},[2542],{"type":154,"value":1151},{"type":149,"tag":401,"props":2544,"children":2546},{"class":2545,"line":1154},[403,414],[2547,2551],{"type":149,"tag":401,"props":2548,"children":2549},{"style":730},[2550],{"type":154,"value":1160},{"type":149,"tag":401,"props":2552,"children":2553},{"style":407},[2554],{"type":154,"value":689},{"type":149,"tag":401,"props":2556,"children":2558},{"class":2557,"line":1167},[403,414],[2559],{"type":149,"tag":401,"props":2560,"children":2561},{"style":407},[2562],{"type":154,"value":746},{"type":149,"tag":401,"props":2564,"children":2565},{"class":403,"line":1175},[2566],{"type":149,"tag":401,"props":2567,"children":2568},{"style":407},[2569],{"type":154,"value":1181},{"type":149,"tag":401,"props":2571,"children":2572},{"class":403,"line":1184},[2573],{"type":149,"tag":401,"props":2574,"children":2575},{"style":407},[2576],{"type":154,"value":410},{"type":149,"tag":150,"props":2578,"children":2579},{},[2580],{"type":154,"value":2581},"We can now see the full flow  how the clients initial request creates an entry in the eBPF map (our NAT table) and how the load balancer, on the backends response, retrieves that entry to identify the client that made the request.",{"type":149,"tag":211,"props":2583,"children":2585},{"kind":2584},"warning",[2586,2591],{"type":149,"tag":150,"props":2587,"children":2588},{},[2589],{"type":154,"value":2590}," For simplicity, this load balancer implementation only takes TCP connections into account, although UDP could easily be added.",{"type":149,"tag":150,"props":2592,"children":2593},{},[2594,2596,2602],{"type":154,"value":2595},"Im also intentionally hiding some parts of the code (",{"type":149,"tag":397,"props":2597,"children":2599},{"className":2598},[],[2600],{"type":154,"value":2601},"...",{"type":154,"value":2603}," symbol), since well cover them later. Open the full code in terminal if you want to jump ahead.",{"type":149,"tag":150,"props":2605,"children":2606},{},[2607],{"type":154,"value":2608},"Theres that, but this isnt really load balancing, because we still havent mentioned how the load balancer decides which backend to redirect the traffic to  nonetheless, there could be many.",{"type":149,"tag":240,"props":2610,"children":2612},{"id":2611},"load-balancing",[2613],{"type":154,"value":2614},"Load Balancing",{"type":149,"tag":150,"props":2616,"children":2617},{},[2618],{"type":154,"value":2619},"When it comes to load balancing, there are many algorithms that suit different uses cases better or worse. Just to name a few:",{"type":149,"tag":292,"props":2621,"children":2622},{},[2623,2633,2643,2653,2663],{"type":149,"tag":296,"props":2624,"children":2625},{},[2626,2631],{"type":149,"tag":224,"props":2627,"children":2628},{},[2629],{"type":154,"value":2630},"Round Robin",{"type":154,"value":2632},"  Distributes requests sequentially across all servers in order, cycling back to the first when it reaches the last.",{"type":149,"tag":296,"props":2634,"children":2635},{},[2636,2641],{"type":149,"tag":224,"props":2637,"children":2638},{},[2639],{"type":154,"value":2640},"Weighted Round Robin",{"type":154,"value":2642},"  Assigns more requests to certain backend servers using predefined weights.",{"type":149,"tag":296,"props":2644,"children":2645},{},[2646,2651],{"type":149,"tag":224,"props":2647,"children":2648},{},[2649],{"type":154,"value":2650},"Least Connections",{"type":154,"value":2652},"  Sends new requests to the server with the fewest active connections, balancing uneven workloads efficiently.",{"type":149,"tag":296,"props":2654,"children":2655},{},[2656,2661],{"type":149,"tag":224,"props":2657,"children":2658},{},[2659],{"type":154,"value":2660},"Hashing",{"type":154,"value":2662},"  Maps requests to backend servers by hashing a 5-tuple ensuring client always communicates with the same backend (session affinity)",{"type":149,"tag":296,"props":2664,"children":2665},{},[2666],{"type":154,"value":2667},"and many others..",{"type":149,"tag":150,"props":2669,"children":2670},{},[2671],{"type":154,"value":2672},"The simplest one is obviously round-robin, but I want to make this tutorial a bit more interesting and instead show you how to implement simple hashing, so we can see how session affinity can be achieved.",{"type":149,"tag":1191,"props":2674,"children":2676},{":summary":2675},"What is session affinity and why is it important?",[2677,2688,2693,2698,2716],{"type":149,"tag":150,"props":2678,"children":2679},{},[2680,2682,2687],{"type":154,"value":2681},"Session affinity (also known as sticky sessions) ensures that ",{"type":149,"tag":224,"props":2683,"children":2684},{},[2685],{"type":154,"value":2686},"all requests from the same client are consistently routed to the same backend server",{"type":154,"value":804},{"type":149,"tag":150,"props":2689,"children":2690},{},[2691],{"type":154,"value":2692},"This is important when a backend stores session-specific data in memory, since switching between servers would cause the session state to be lost or require complex synchronization.",{"type":149,"tag":150,"props":2694,"children":2695},{},[2696],{"type":154,"value":2697},"Typical examples include:",{"type":149,"tag":292,"props":2699,"children":2700},{},[2701,2706,2711],{"type":149,"tag":296,"props":2702,"children":2703},{},[2704],{"type":154,"value":2705},"Web applications that store user sessions or authentication data locally on the server.",{"type":149,"tag":296,"props":2707,"children":2708},{},[2709],{"type":154,"value":2710},"Shopping carts or payment flows where in-memory context must persist across multiple requests.",{"type":149,"tag":296,"props":2712,"children":2713},{},[2714],{"type":154,"value":2715},"Real-time applications like chat or gaming servers maintaining a persistent TCP session.",{"type":149,"tag":150,"props":2717,"children":2718},{},[2719],{"type":154,"value":2720},"Without session affinity, these requests could be sent to different backends, breaking continuity or forcing costly session synchronization.",{"type":149,"tag":150,"props":2722,"children":2723},{},[2724],{"type":149,"tag":224,"props":2725,"children":2726},{},[2727],{"type":154,"value":2728},"But now someone might ask  how on earth is hashing related to load balancing or routing in general?",{"type":149,"tag":150,"props":2730,"children":2731},{},[2732],{"type":154,"value":2733},"Heres where it gets interesting: we already learned that every client connection to a load balancer has a unique 5-tuple  source IP, destination IP, source port, destination port, and protocol  meaning a hash of this 5-tuple will always give us a unique numeric value.",{"type":149,"tag":150,"props":2735,"children":2736},{},[2737],{"type":154,"value":2738},"But not only that  it will always produce the same hash for the same 5-tuple.",{"type":149,"tag":150,"props":2740,"children":2741},{},[2742],{"type":154,"value":2743},"By mapping that hash to a range of keys in an eBPF map containing backend endpoints, the load balancer can deterministically select a backend and route the traffic there (same hash  same backend).",{"type":149,"tag":150,"props":2745,"children":2746},{},[2747],{"type":154,"value":2748},"Here's an image to illustrate this concept.",{"type":149,"tag":204,"props":2750,"children":2753},{":alt":2751,":src":2752,":max-width":208},"5-Tuple hash to Backend","/content/files/tutorials/xdp-load-balancer-700a1d74/__static__/hashing.png",[],{"type":149,"tag":150,"props":2755,"children":2756},{},[2757,2759,2764,2765,2770,2771,2776,2777,2782],{"type":154,"value":2758},"There are different hashing algorithms we can choose from like ",{"type":149,"tag":224,"props":2760,"children":2761},{},[2762],{"type":154,"value":2763},"MurmurHash",{"type":154,"value":675},{"type":149,"tag":224,"props":2766,"children":2767},{},[2768],{"type":154,"value":2769},"Jenkins Hash",{"type":154,"value":675},{"type":149,"tag":224,"props":2772,"children":2773},{},[2774],{"type":154,"value":2775},"xxHash",{"type":154,"value":166},{"type":149,"tag":224,"props":2778,"children":2779},{},[2780],{"type":154,"value":2781},"FNV-1a (FowlerNollVo hash)",{"type":154,"value":2783},", which differ in speed, collision resistance, and how evenly they distribute values.",{"type":149,"tag":150,"props":2785,"children":2786},{},[2787,2789,2794],{"type":154,"value":2788},"But this isnt a math course, so I just implemented ",{"type":149,"tag":224,"props":2790,"children":2791},{},[2792],{"type":154,"value":2793},"FNV-1a",{"type":154,"value":2795}," algorithm.",{"type":149,"tag":367,"props":2797,"children":2805},{"className":369,"code":2798,"filename":371,"highlights":2799,"language":393,"meta":394,"style":394},"// FNV-1a hash implementation for load balancing\nstatic __always_inline __u32 xdp_hash_tuple(struct five_tuple_t *tuple) {\n  __u32 hash = 2166136261U;\n  hash = (hash ^ tuple->src_ip) * 16777619U;\n  hash = (hash ^ tuple->dst_ip) * 16777619U;\n  hash = (hash ^ tuple->src_port) * 16777619U;\n  hash = (hash ^ tuple->dst_port) * 16777619U;\n  hash = (hash ^ tuple->protocol) * 16777619U;\n  return hash;\n}\n\n// Backends eBPF Map populated from user space\nstruct {\n  __uint(type, BPF_MAP_TYPE_ARRAY);\n  __uint(max_entries, NUM_BACKENDS);\n  __type(key, __u32);\n  __type(value, struct endpoint);\n} backends SEC(\".maps\");\n\nSEC(\"xdp\")\nint xdp_load_balancer(struct xdp_md *ctx) {\n  ...\n  if (!out) {\n    bpf_printk(\"Packet from client because no such connection exists yet\");\n\n    // Choose backend using simple hashing\n    struct five_tuple_t five_tuple = {};\n    five_tuple.src_ip = ip->saddr;\n    five_tuple.dst_ip = ip->daddr;\n    five_tuple.src_port = tcp->source;\n    five_tuple.dst_port = tcp->dest;\n    five_tuple.protocol = IPPROTO_TCP;\n    // Hash the 5-tuple for persistent backend routing and\n    // perform modulo with the number of backends (NUM_BACKENDS=2 hardcoded for simplicity)\n    __u32 key = xdp_hash_tuple(&five_tuple) % NUM_BACKENDS;\n    // Lookup calculated key and retrieve the backend endpoint information\n    struct endpoint *backend = bpf_map_lookup_elem(&backends, &key);\n    ...\n",[97,373,374,375,376,377,57,378,379,380,692,717,740,382,383,384,385,1110,1118,1137,1154,1167,1175,1184,2800,2801,2802,2803,2804],33,34,35,36,37,[2806],{"type":149,"tag":397,"props":2807,"children":2808},{"__ignoreMap":394},[2809,2818,2865,2889,2943,2991,3039,3087,3135,3149,3158,3166,3175,3187,3201,3214,3228,3250,3277,3284,3305,3344,3351,3370,3389,3396,3405,3430,3467,3503,3539,3575,3600,3609,3618,3659,3668,3719],{"type":149,"tag":401,"props":2810,"children":2812},{"class":2811,"line":97},[403,414],[2813],{"type":149,"tag":401,"props":2814,"children":2815},{"style":418},[2816],{"type":154,"value":2817},"// FNV-1a hash implementation for load balancing\n",{"type":149,"tag":401,"props":2819,"children":2821},{"class":2820,"line":373},[403,414],[2822,2827,2832,2837,2841,2846,2850,2855,2860],{"type":149,"tag":401,"props":2823,"children":2824},{"style":446},[2825],{"type":154,"value":2826},"static",{"type":149,"tag":401,"props":2828,"children":2829},{"style":407},[2830],{"type":154,"value":2831}," __always_inline __u32 ",{"type":149,"tag":401,"props":2833,"children":2834},{"style":651},[2835],{"type":154,"value":2836},"xdp_hash_tuple",{"type":149,"tag":401,"props":2838,"children":2839},{"style":407},[2840],{"type":154,"value":659},{"type":149,"tag":401,"props":2842,"children":2843},{"style":446},[2844],{"type":154,"value":2845},"struct",{"type":149,"tag":401,"props":2847,"children":2848},{"style":452},[2849],{"type":154,"value":455},{"type":149,"tag":401,"props":2851,"children":2852},{"style":463},[2853],{"type":154,"value":2854}," *",{"type":149,"tag":401,"props":2856,"children":2857},{"style":667},[2858],{"type":154,"value":2859},"tuple",{"type":149,"tag":401,"props":2861,"children":2862},{"style":407},[2863],{"type":154,"value":2864},") {\n",{"type":149,"tag":401,"props":2866,"children":2868},{"class":2867,"line":374},[403,414],[2869,2874,2878,2884],{"type":149,"tag":401,"props":2870,"children":2871},{"style":407},[2872],{"type":154,"value":2873},"  __u32 hash ",{"type":149,"tag":401,"props":2875,"children":2876},{"style":463},[2877],{"type":154,"value":466},{"type":149,"tag":401,"props":2879,"children":2881},{"style":2880},"--shiki-default:#B5CEA8",[2882],{"type":154,"value":2883}," 2166136261U",{"type":149,"tag":401,"props":2885,"children":2886},{"style":407},[2887],{"type":154,"value":2888},";\n",{"type":149,"tag":401,"props":2890,"children":2892},{"class":2891,"line":375},[403,414],[2893,2898,2902,2907,2912,2917,2921,2925,2930,2934,2939],{"type":149,"tag":401,"props":2894,"children":2895},{"style":407},[2896],{"type":154,"value":2897},"  hash ",{"type":149,"tag":401,"props":2899,"children":2900},{"style":463},[2901],{"type":154,"value":466},{"type":149,"tag":401,"props":2903,"children":2904},{"style":407},[2905],{"type":154,"value":2906}," (hash ",{"type":149,"tag":401,"props":2908,"children":2909},{"style":463},[2910],{"type":154,"value":2911},"^",{"type":149,"tag":401,"props":2913,"children":2914},{"style":667},[2915],{"type":154,"value":2916}," tuple",{"type":149,"tag":401,"props":2918,"children":2919},{"style":407},[2920],{"type":154,"value":494},{"type":149,"tag":401,"props":2922,"children":2923},{"style":667},[2924],{"type":154,"value":809},{"type":149,"tag":401,"props":2926,"children":2927},{"style":407},[2928],{"type":154,"value":2929},") ",{"type":149,"tag":401,"props":2931,"children":2932},{"style":463},[2933],{"type":154,"value":639},{"type":149,"tag":401,"props":2935,"children":2936},{"style":2880},[2937],{"type":154,"value":2938}," 16777619U",{"type":149,"tag":401,"props":2940,"children":2941},{"style":407},[2942],{"type":154,"value":2888},{"type":149,"tag":401,"props":2944,"children":2946},{"class":2945,"line":376},[403,414],[2947,2951,2955,2959,2963,2967,2971,2975,2979,2983,2987],{"type":149,"tag":401,"props":2948,"children":2949},{"style":407},[2950],{"type":154,"value":2897},{"type":149,"tag":401,"props":2952,"children":2953},{"style":463},[2954],{"type":154,"value":466},{"type":149,"tag":401,"props":2956,"children":2957},{"style":407},[2958],{"type":154,"value":2906},{"type":149,"tag":401,"props":2960,"children":2961},{"style":463},[2962],{"type":154,"value":2911},{"type":149,"tag":401,"props":2964,"children":2965},{"style":667},[2966],{"type":154,"value":2916},{"type":149,"tag":401,"props":2968,"children":2969},{"style":407},[2970],{"type":154,"value":494},{"type":149,"tag":401,"props":2972,"children":2973},{"style":667},[2974],{"type":154,"value":854},{"type":149,"tag":401,"props":2976,"children":2977},{"style":407},[2978],{"type":154,"value":2929},{"type":149,"tag":401,"props":2980,"children":2981},{"style":463},[2982],{"type":154,"value":639},{"type":149,"tag":401,"props":2984,"children":2985},{"style":2880},[2986],{"type":154,"value":2938},{"type":149,"tag":401,"props":2988,"children":2989},{"style":407},[2990],{"type":154,"value":2888},{"type":149,"tag":401,"props":2992,"children":2994},{"class":2993,"line":377},[403,414],[2995,2999,3003,3007,3011,3015,3019,3023,3027,3031,3035],{"type":149,"tag":401,"props":2996,"children":2997},{"style":407},[2998],{"type":154,"value":2897},{"type":149,"tag":401,"props":3000,"children":3001},{"style":463},[3002],{"type":154,"value":466},{"type":149,"tag":401,"props":3004,"children":3005},{"style":407},[3006],{"type":154,"value":2906},{"type":149,"tag":401,"props":3008,"children":3009},{"style":463},[3010],{"type":154,"value":2911},{"type":149,"tag":401,"props":3012,"children":3013},{"style":667},[3014],{"type":154,"value":2916},{"type":149,"tag":401,"props":3016,"children":3017},{"style":407},[3018],{"type":154,"value":494},{"type":149,"tag":401,"props":3020,"children":3021},{"style":667},[3022],{"type":154,"value":898},{"type":149,"tag":401,"props":3024,"children":3025},{"style":407},[3026],{"type":154,"value":2929},{"type":149,"tag":401,"props":3028,"children":3029},{"style":463},[3030],{"type":154,"value":639},{"type":149,"tag":401,"props":3032,"children":3033},{"style":2880},[3034],{"type":154,"value":2938},{"type":149,"tag":401,"props":3036,"children":3037},{"style":407},[3038],{"type":154,"value":2888},{"type":149,"tag":401,"props":3040,"children":3042},{"class":3041,"line":57},[403,414],[3043,3047,3051,3055,3059,3063,3067,3071,3075,3079,3083],{"type":149,"tag":401,"props":3044,"children":3045},{"style":407},[3046],{"type":154,"value":2897},{"type":149,"tag":401,"props":3048,"children":3049},{"style":463},[3050],{"type":154,"value":466},{"type":149,"tag":401,"props":3052,"children":3053},{"style":407},[3054],{"type":154,"value":2906},{"type":149,"tag":401,"props":3056,"children":3057},{"style":463},[3058],{"type":154,"value":2911},{"type":149,"tag":401,"props":3060,"children":3061},{"style":667},[3062],{"type":154,"value":2916},{"type":149,"tag":401,"props":3064,"children":3065},{"style":407},[3066],{"type":154,"value":494},{"type":149,"tag":401,"props":3068,"children":3069},{"style":667},[3070],{"type":154,"value":941},{"type":149,"tag":401,"props":3072,"children":3073},{"style":407},[3074],{"type":154,"value":2929},{"type":149,"tag":401,"props":3076,"children":3077},{"style":463},[3078],{"type":154,"value":639},{"type":149,"tag":401,"props":3080,"children":3081},{"style":2880},[3082],{"type":154,"value":2938},{"type":149,"tag":401,"props":3084,"children":3085},{"style":407},[3086],{"type":154,"value":2888},{"type":149,"tag":401,"props":3088,"children":3090},{"class":3089,"line":378},[403,414],[3091,3095,3099,3103,3107,3111,3115,3119,3123,3127,3131],{"type":149,"tag":401,"props":3092,"children":3093},{"style":407},[3094],{"type":154,"value":2897},{"type":149,"tag":401,"props":3096,"children":3097},{"style":463},[3098],{"type":154,"value":466},{"type":149,"tag":401,"props":3100,"children":3101},{"style":407},[3102],{"type":154,"value":2906},{"type":149,"tag":401,"props":3104,"children":3105},{"style":463},[3106],{"type":154,"value":2911},{"type":149,"tag":401,"props":3108,"children":3109},{"style":667},[3110],{"type":154,"value":2916},{"type":149,"tag":401,"props":3112,"children":3113},{"style":407},[3114],{"type":154,"value":494},{"type":149,"tag":401,"props":3116,"children":3117},{"style":667},[3118],{"type":154,"value":984},{"type":149,"tag":401,"props":3120,"children":3121},{"style":407},[3122],{"type":154,"value":2929},{"type":149,"tag":401,"props":3124,"children":3125},{"style":463},[3126],{"type":154,"value":639},{"type":149,"tag":401,"props":3128,"children":3129},{"style":2880},[3130],{"type":154,"value":2938},{"type":149,"tag":401,"props":3132,"children":3133},{"style":407},[3134],{"type":154,"value":2888},{"type":149,"tag":401,"props":3136,"children":3138},{"class":3137,"line":379},[403,414],[3139,3144],{"type":149,"tag":401,"props":3140,"children":3141},{"style":696},[3142],{"type":154,"value":3143},"  return",{"type":149,"tag":401,"props":3145,"children":3146},{"style":407},[3147],{"type":154,"value":3148}," hash;\n",{"type":149,"tag":401,"props":3150,"children":3152},{"class":3151,"line":380},[403,414],[3153],{"type":149,"tag":401,"props":3154,"children":3155},{"style":407},[3156],{"type":154,"value":3157},"}\n",{"type":149,"tag":401,"props":3159,"children":3160},{"class":403,"line":381},[3161],{"type":149,"tag":401,"props":3162,"children":3163},{"emptyLinePlaceholder":11},[3164],{"type":154,"value":3165},"\n",{"type":149,"tag":401,"props":3167,"children":3169},{"class":3168,"line":692},[403,414],[3170],{"type":149,"tag":401,"props":3171,"children":3172},{"style":418},[3173],{"type":154,"value":3174},"// Backends eBPF Map populated from user space\n",{"type":149,"tag":401,"props":3176,"children":3178},{"class":3177,"line":717},[403,414],[3179,3183],{"type":149,"tag":401,"props":3180,"children":3181},{"style":446},[3182],{"type":154,"value":2845},{"type":149,"tag":401,"props":3184,"children":3185},{"style":407},[3186],{"type":154,"value":1134},{"type":149,"tag":401,"props":3188,"children":3190},{"class":3189,"line":740},[403,414],[3191,3196],{"type":149,"tag":401,"props":3192,"children":3193},{"style":651},[3194],{"type":154,"value":3195},"  __uint",{"type":149,"tag":401,"props":3197,"children":3198},{"style":407},[3199],{"type":154,"value":3200},"(type, BPF_MAP_TYPE_ARRAY);\n",{"type":149,"tag":401,"props":3202,"children":3204},{"class":3203,"line":382},[403,414],[3205,3209],{"type":149,"tag":401,"props":3206,"children":3207},{"style":651},[3208],{"type":154,"value":3195},{"type":149,"tag":401,"props":3210,"children":3211},{"style":407},[3212],{"type":154,"value":3213},"(max_entries, NUM_BACKENDS);\n",{"type":149,"tag":401,"props":3215,"children":3217},{"class":3216,"line":383},[403,414],[3218,3223],{"type":149,"tag":401,"props":3219,"children":3220},{"style":651},[3221],{"type":154,"value":3222},"  __type",{"type":149,"tag":401,"props":3224,"children":3225},{"style":407},[3226],{"type":154,"value":3227},"(key, __u32);\n",{"type":149,"tag":401,"props":3229,"children":3231},{"class":3230,"line":384},[403,414],[3232,3236,3241,3245],{"type":149,"tag":401,"props":3233,"children":3234},{"style":651},[3235],{"type":154,"value":3222},{"type":149,"tag":401,"props":3237,"children":3238},{"style":407},[3239],{"type":154,"value":3240},"(value, ",{"type":149,"tag":401,"props":3242,"children":3243},{"style":446},[3244],{"type":154,"value":2845},{"type":149,"tag":401,"props":3246,"children":3247},{"style":407},[3248],{"type":154,"value":3249}," endpoint);\n",{"type":149,"tag":401,"props":3251,"children":3253},{"class":3252,"line":385},[403,414],[3254,3259,3264,3268,3273],{"type":149,"tag":401,"props":3255,"children":3256},{"style":407},[3257],{"type":154,"value":3258},"} backends ",{"type":149,"tag":401,"props":3260,"children":3261},{"style":651},[3262],{"type":154,"value":3263},"SEC",{"type":149,"tag":401,"props":3265,"children":3266},{"style":407},[3267],{"type":154,"value":659},{"type":149,"tag":401,"props":3269,"children":3270},{"style":730},[3271],{"type":154,"value":3272},"\".maps\"",{"type":149,"tag":401,"props":3274,"children":3275},{"style":407},[3276],{"type":154,"value":689},{"type":149,"tag":401,"props":3278,"children":3279},{"class":403,"line":386},[3280],{"type":149,"tag":401,"props":3281,"children":3282},{"emptyLinePlaceholder":11},[3283],{"type":154,"value":3165},{"type":149,"tag":401,"props":3285,"children":3286},{"class":403,"line":387},[3287,3291,3295,3300],{"type":149,"tag":401,"props":3288,"children":3289},{"style":651},[3290],{"type":154,"value":3263},{"type":149,"tag":401,"props":3292,"children":3293},{"style":407},[3294],{"type":154,"value":659},{"type":149,"tag":401,"props":3296,"children":3297},{"style":730},[3298],{"type":154,"value":3299},"\"xdp\"",{"type":149,"tag":401,"props":3301,"children":3302},{"style":407},[3303],{"type":154,"value":3304},")\n",{"type":149,"tag":401,"props":3306,"children":3307},{"class":403,"line":388},[3308,3313,3318,3322,3326,3331,3335,3340],{"type":149,"tag":401,"props":3309,"children":3310},{"style":446},[3311],{"type":154,"value":3312},"int",{"type":149,"tag":401,"props":3314,"children":3315},{"style":651},[3316],{"type":154,"value":3317}," xdp_load_balancer",{"type":149,"tag":401,"props":3319,"children":3320},{"style":407},[3321],{"type":154,"value":659},{"type":149,"tag":401,"props":3323,"children":3324},{"style":446},[3325],{"type":154,"value":2845},{"type":149,"tag":401,"props":3327,"children":3328},{"style":407},[3329],{"type":154,"value":3330}," xdp_md ",{"type":149,"tag":401,"props":3332,"children":3333},{"style":463},[3334],{"type":154,"value":639},{"type":149,"tag":401,"props":3336,"children":3337},{"style":667},[3338],{"type":154,"value":3339},"ctx",{"type":149,"tag":401,"props":3341,"children":3342},{"style":407},[3343],{"type":154,"value":2864},{"type":149,"tag":401,"props":3345,"children":3346},{"class":403,"line":389},[3347],{"type":149,"tag":401,"props":3348,"children":3349},{"style":407},[3350],{"type":154,"value":410},{"type":149,"tag":401,"props":3352,"children":3353},{"class":403,"line":390},[3354,3358,3362,3366],{"type":149,"tag":401,"props":3355,"children":3356},{"style":696},[3357],{"type":154,"value":699},{"type":149,"tag":401,"props":3359,"children":3360},{"style":407},[3361],{"type":154,"value":704},{"type":149,"tag":401,"props":3363,"children":3364},{"style":463},[3365],{"type":154,"value":709},{"type":149,"tag":401,"props":3367,"children":3368},{"style":407},[3369],{"type":154,"value":714},{"type":149,"tag":401,"props":3371,"children":3372},{"class":403,"line":391},[3373,3377,3381,3385],{"type":149,"tag":401,"props":3374,"children":3375},{"style":651},[3376],{"type":154,"value":723},{"type":149,"tag":401,"props":3378,"children":3379},{"style":407},[3380],{"type":154,"value":659},{"type":149,"tag":401,"props":3382,"children":3383},{"style":730},[3384],{"type":154,"value":733},{"type":149,"tag":401,"props":3386,"children":3387},{"style":407},[3388],{"type":154,"value":689},{"type":149,"tag":401,"props":3390,"children":3391},{"class":403,"line":392},[3392],{"type":149,"tag":401,"props":3393,"children":3394},{"emptyLinePlaceholder":11},[3395],{"type":154,"value":3165},{"type":149,"tag":401,"props":3397,"children":3399},{"class":3398,"line":1110},[403,414],[3400],{"type":149,"tag":401,"props":3401,"children":3402},{"style":418},[3403],{"type":154,"value":3404},"    // Choose backend using simple hashing\n",{"type":149,"tag":401,"props":3406,"children":3408},{"class":3407,"line":1118},[403,414],[3409,3413,3417,3422,3426],{"type":149,"tag":401,"props":3410,"children":3411},{"style":446},[3412],{"type":154,"value":773},{"type":149,"tag":401,"props":3414,"children":3415},{"style":452},[3416],{"type":154,"value":455},{"type":149,"tag":401,"props":3418,"children":3419},{"style":407},[3420],{"type":154,"value":3421}," five_tuple ",{"type":149,"tag":401,"props":3423,"children":3424},{"style":463},[3425],{"type":154,"value":466},{"type":149,"tag":401,"props":3427,"children":3428},{"style":407},[3429],{"type":154,"value":471},{"type":149,"tag":401,"props":3431,"children":3433},{"class":3432,"line":1137},[403,414],[3434,3439,3443,3447,3451,3455,3459,3463],{"type":149,"tag":401,"props":3435,"children":3436},{"style":667},[3437],{"type":154,"value":3438},"    five_tuple",{"type":149,"tag":401,"props":3440,"children":3441},{"style":407},[3442],{"type":154,"value":804},{"type":149,"tag":401,"props":3444,"children":3445},{"style":667},[3446],{"type":154,"value":809},{"type":149,"tag":401,"props":3448,"children":3449},{"style":463},[3450],{"type":154,"value":814},{"type":149,"tag":401,"props":3452,"children":3453},{"style":667},[3454],{"type":154,"value":489},{"type":149,"tag":401,"props":3456,"children":3457},{"style":407},[3458],{"type":154,"value":494},{"type":149,"tag":401,"props":3460,"children":3461},{"style":667},[3462],{"type":154,"value":1044},{"type":149,"tag":401,"props":3464,"children":3465},{"style":407},[3466],{"type":154,"value":2888},{"type":149,"tag":401,"props":3468,"children":3470},{"class":3469,"line":1154},[403,414],[3471,3475,3479,3483,3487,3491,3495,3499],{"type":149,"tag":401,"props":3472,"children":3473},{"style":667},[3474],{"type":154,"value":3438},{"type":149,"tag":401,"props":3476,"children":3477},{"style":407},[3478],{"type":154,"value":804},{"type":149,"tag":401,"props":3480,"children":3481},{"style":667},[3482],{"type":154,"value":854},{"type":149,"tag":401,"props":3484,"children":3485},{"style":463},[3486],{"type":154,"value":814},{"type":149,"tag":401,"props":3488,"children":3489},{"style":667},[3490],{"type":154,"value":489},{"type":149,"tag":401,"props":3492,"children":3493},{"style":407},[3494],{"type":154,"value":494},{"type":149,"tag":401,"props":3496,"children":3497},{"style":667},[3498],{"type":154,"value":827},{"type":149,"tag":401,"props":3500,"children":3501},{"style":407},[3502],{"type":154,"value":2888},{"type":149,"tag":401,"props":3504,"children":3506},{"class":3505,"line":1167},[403,414],[3507,3511,3515,3519,3523,3527,3531,3535],{"type":149,"tag":401,"props":3508,"children":3509},{"style":667},[3510],{"type":154,"value":3438},{"type":149,"tag":401,"props":3512,"children":3513},{"style":407},[3514],{"type":154,"value":804},{"type":149,"tag":401,"props":3516,"children":3517},{"style":667},[3518],{"type":154,"value":898},{"type":149,"tag":401,"props":3520,"children":3521},{"style":463},[3522],{"type":154,"value":814},{"type":149,"tag":401,"props":3524,"children":3525},{"style":667},[3526],{"type":154,"value":553},{"type":149,"tag":401,"props":3528,"children":3529},{"style":407},[3530],{"type":154,"value":494},{"type":149,"tag":401,"props":3532,"children":3533},{"style":667},[3534],{"type":154,"value":915},{"type":149,"tag":401,"props":3536,"children":3537},{"style":407},[3538],{"type":154,"value":2888},{"type":149,"tag":401,"props":3540,"children":3542},{"class":3541,"line":1175},[403,414],[3543,3547,3551,3555,3559,3563,3567,3571],{"type":149,"tag":401,"props":3544,"children":3545},{"style":667},[3546],{"type":154,"value":3438},{"type":149,"tag":401,"props":3548,"children":3549},{"style":407},[3550],{"type":154,"value":804},{"type":149,"tag":401,"props":3552,"children":3553},{"style":667},[3554],{"type":154,"value":941},{"type":149,"tag":401,"props":3556,"children":3557},{"style":463},[3558],{"type":154,"value":814},{"type":149,"tag":401,"props":3560,"children":3561},{"style":667},[3562],{"type":154,"value":553},{"type":149,"tag":401,"props":3564,"children":3565},{"style":407},[3566],{"type":154,"value":494},{"type":149,"tag":401,"props":3568,"children":3569},{"style":667},[3570],{"type":154,"value":958},{"type":149,"tag":401,"props":3572,"children":3573},{"style":407},[3574],{"type":154,"value":2888},{"type":149,"tag":401,"props":3576,"children":3578},{"class":3577,"line":1184},[403,414],[3579,3583,3587,3591,3595],{"type":149,"tag":401,"props":3580,"children":3581},{"style":667},[3582],{"type":154,"value":3438},{"type":149,"tag":401,"props":3584,"children":3585},{"style":407},[3586],{"type":154,"value":804},{"type":149,"tag":401,"props":3588,"children":3589},{"style":667},[3590],{"type":154,"value":984},{"type":149,"tag":401,"props":3592,"children":3593},{"style":463},[3594],{"type":154,"value":814},{"type":149,"tag":401,"props":3596,"children":3597},{"style":407},[3598],{"type":154,"value":3599}," IPPROTO_TCP;\n",{"type":149,"tag":401,"props":3601,"children":3603},{"class":3602,"line":2800},[403,414],[3604],{"type":149,"tag":401,"props":3605,"children":3606},{"style":418},[3607],{"type":154,"value":3608},"    // Hash the 5-tuple for persistent backend routing and\n",{"type":149,"tag":401,"props":3610,"children":3612},{"class":3611,"line":2801},[403,414],[3613],{"type":149,"tag":401,"props":3614,"children":3615},{"style":418},[3616],{"type":154,"value":3617},"    // perform modulo with the number of backends (NUM_BACKENDS=2 hardcoded for simplicity)\n",{"type":149,"tag":401,"props":3619,"children":3621},{"class":3620,"line":2802},[403,414],[3622,3627,3631,3636,3640,3644,3649,3654],{"type":149,"tag":401,"props":3623,"children":3624},{"style":407},[3625],{"type":154,"value":3626},"    __u32 key ",{"type":149,"tag":401,"props":3628,"children":3629},{"style":463},[3630],{"type":154,"value":466},{"type":149,"tag":401,"props":3632,"children":3633},{"style":651},[3634],{"type":154,"value":3635}," xdp_hash_tuple",{"type":149,"tag":401,"props":3637,"children":3638},{"style":407},[3639],{"type":154,"value":659},{"type":149,"tag":401,"props":3641,"children":3642},{"style":463},[3643],{"type":154,"value":664},{"type":149,"tag":401,"props":3645,"children":3646},{"style":407},[3647],{"type":154,"value":3648},"five_tuple) ",{"type":149,"tag":401,"props":3650,"children":3651},{"style":463},[3652],{"type":154,"value":3653},"%",{"type":149,"tag":401,"props":3655,"children":3656},{"style":407},[3657],{"type":154,"value":3658}," NUM_BACKENDS;\n",{"type":149,"tag":401,"props":3660,"children":3662},{"class":3661,"line":2803},[403,414],[3663],{"type":149,"tag":401,"props":3664,"children":3665},{"style":418},[3666],{"type":154,"value":3667},"    // Lookup calculated key and retrieve the backend endpoint information\n",{"type":149,"tag":401,"props":3669,"children":3671},{"class":3670,"line":2804},[403,414],[3672,3676,3680,3684,3689,3693,3697,3701,3705,3710,3714],{"type":149,"tag":401,"props":3673,"children":3674},{"style":446},[3675],{"type":154,"value":773},{"type":149,"tag":401,"props":3677,"children":3678},{"style":407},[3679],{"type":154,"value":634},{"type":149,"tag":401,"props":3681,"children":3682},{"style":463},[3683],{"type":154,"value":639},{"type":149,"tag":401,"props":3685,"children":3686},{"style":407},[3687],{"type":154,"value":3688},"backend ",{"type":149,"tag":401,"props":3690,"children":3691},{"style":463},[3692],{"type":154,"value":466},{"type":149,"tag":401,"props":3694,"children":3695},{"style":651},[3696],{"type":154,"value":654},{"type":149,"tag":401,"props":3698,"children":3699},{"style":407},[3700],{"type":154,"value":659},{"type":149,"tag":401,"props":3702,"children":3703},{"style":463},[3704],{"type":154,"value":664},{"type":149,"tag":401,"props":3706,"children":3707},{"style":407},[3708],{"type":154,"value":3709},"backends, ",{"type":149,"tag":401,"props":3711,"children":3712},{"style":463},[3713],{"type":154,"value":664},{"type":149,"tag":401,"props":3715,"children":3716},{"style":407},[3717],{"type":154,"value":3718},"key);\n",{"type":149,"tag":401,"props":3720,"children":3722},{"class":403,"line":3721},38,[3723],{"type":149,"tag":401,"props":3724,"children":3725},{"style":407},[3726],{"type":154,"value":746},{"type":149,"tag":211,"props":3728,"children":3729},{"kind":213},[3730],{"type":149,"tag":150,"props":3731,"children":3732},{},[3733,3735,3741],{"type":154,"value":3734}," Ideally, wed continuously monitor backend node health and update the ",{"type":149,"tag":397,"props":3736,"children":3738},{"className":3737},[],[3739],{"type":154,"value":3740},"backends",{"type":154,"value":3742}," eBPF map accordingly, but for simplicity, we assume no nodes are added or removed to keep this demo code lean.",{"type":149,"tag":211,"props":3744,"children":3745},{"kind":2584},[3746],{"type":149,"tag":150,"props":3747,"children":3748},{},[3749],{"type":154,"value":3750}," For simplicity, we also dont redirect client requests to specific backend ports. Instead, we assume that both the load balancer and the backends listen on the same port for incoming requests.",{"type":149,"tag":150,"props":3752,"children":3753},{},[3754],{"type":154,"value":3755},"Now we see how both NAT and simple hashing fit neatly into the load-balancing logic  but we still need to rewrite the network packets IP header and MAC addresses.",{"type":149,"tag":150,"props":3757,"children":3758},{},[3759],{"type":154,"value":3760},"This is necessary because after the clients request passes through the load balancer, the packets original source and destination no longer match the actual source. Without rewriting these headers, the backend would see the load balancer as the destination and the client as the source, and drop the packet.",{"type":149,"tag":240,"props":3762,"children":3764},{"id":3763},"rewriting-ip-and-mac-addresses",[3765],{"type":154,"value":3766},"Rewriting IP and MAC Addresses",{"type":149,"tag":150,"props":3768,"children":3769},{},[3770],{"type":154,"value":3771},"Updating the packet headers in load balancer logic ensures that each node along the path  client, load balancer, and backend  can correctly send and receive packets as if they were just talking to a peer node.",{"type":149,"tag":150,"props":3773,"children":3774},{},[3775,3777,3782],{"type":154,"value":3776},"For this proof of concept, we could technically rewrite the MAC addresses quite easily  by hardcoding the load balancers MAC address directly in our eBPF program and storing the backend MAC address beside the IP in the ",{"type":149,"tag":397,"props":3778,"children":3780},{"className":3779},[],[3781],{"type":154,"value":3740},{"type":154,"value":3783}," eBPF map.",{"type":149,"tag":150,"props":3785,"children":3786},{},[3787,3789,3794,3795,3800,3802,3807],{"type":154,"value":3788},"But why hardcode this information when it already exists in the kernels tables, such as the ",{"type":149,"tag":224,"props":3790,"children":3791},{},[3792],{"type":154,"value":3793},"FIB (Forwarding Information Base)",{"type":154,"value":166},{"type":149,"tag":224,"props":3796,"children":3797},{},[3798],{"type":154,"value":3799},"ARP",{"type":154,"value":3801}," (or ",{"type":149,"tag":224,"props":3803,"children":3804},{},[3805],{"type":154,"value":3806},"NDP",{"type":154,"value":3808}," for IPv6)?",{"type":149,"tag":367,"props":3810,"children":3814},{"className":3811,"code":3812,"language":3813,"meta":394,"style":394},"language-bash shiki shiki-themes slack-dark","ip route show   # Displays the kernel routing table  where to send traffic to reach different destinations\nip neigh show   # Displays the ARP table mapping IP addresses to MAC addresses\n","bash",[3815],{"type":149,"tag":397,"props":3816,"children":3817},{"__ignoreMap":394},[3818,3840],{"type":149,"tag":401,"props":3819,"children":3820},{"class":403,"line":97},[3821,3825,3830,3835],{"type":149,"tag":401,"props":3822,"children":3823},{"style":651},[3824],{"type":154,"value":872},{"type":149,"tag":401,"props":3826,"children":3827},{"style":730},[3828],{"type":154,"value":3829}," route",{"type":149,"tag":401,"props":3831,"children":3832},{"style":730},[3833],{"type":154,"value":3834}," show",{"type":149,"tag":401,"props":3836,"children":3837},{"style":418},[3838],{"type":154,"value":3839},"   # Displays the kernel routing table  where to send traffic to reach different destinations\n",{"type":149,"tag":401,"props":3841,"children":3842},{"class":403,"line":373},[3843,3847,3852,3856],{"type":149,"tag":401,"props":3844,"children":3845},{"style":651},[3846],{"type":154,"value":872},{"type":149,"tag":401,"props":3848,"children":3849},{"style":730},[3850],{"type":154,"value":3851}," neigh",{"type":149,"tag":401,"props":3853,"children":3854},{"style":730},[3855],{"type":154,"value":3834},{"type":149,"tag":401,"props":3857,"children":3858},{"style":418},[3859],{"type":154,"value":3860},"   # Displays the ARP table mapping IP addresses to MAC addresses\n",{"type":149,"tag":150,"props":3862,"children":3863},{},[3864],{"type":154,"value":3865},"So ideally, we would somehow simply query the kernel tables from eBPF like:",{"type":149,"tag":3867,"props":3868,"children":3869},"blockquote",{},[3870],{"type":149,"tag":150,"props":3871,"children":3872},{},[3873,3875,3879],{"type":154,"value":3874},"How do I reach this node?",{"type":149,"tag":3876,"props":3877,"children":3878},"br",{},[],{"type":154,"value":3880},"\n Use this interface, MAC addresses, and IPs (or possibly this next hop).",{"type":149,"tag":150,"props":3882,"children":3883},{},[3884,3886,3897],{"type":154,"value":3885},"And indeed, we can do exactly that using the ",{"type":149,"tag":157,"props":3887,"children":3890},{"href":3888,"rel":3889},"https://docs.ebpf.io/linux/helper-function/bpf_fib_lookup/",[161],[3891],{"type":149,"tag":397,"props":3892,"children":3894},{"className":3893},[],[3895],{"type":154,"value":3896},"bpf_fib_lookup()",{"type":154,"value":3898}," helper function.",{"type":149,"tag":150,"props":3900,"children":3901},{},[3902,3904,3909],{"type":154,"value":3903},"In our NAT load balancer implementation, ",{"type":149,"tag":397,"props":3905,"children":3907},{"className":3906},[],[3908],{"type":154,"value":3896},{"type":154,"value":3910}," first queries the kernels routing table to determine where a packet should be forwarded, based on the device on which it was received and its source and destination IP addresses. If the lookup succeeds, the kernel then consults the neighbor tables (ARP for IPv4) to resolve the appropriate MAC addresses.",{"type":149,"tag":1191,"props":3912,"children":3914},{":summary":3913},"More information about `bpf_fib_lookup()` helper",[3915,3941,3946,4006],{"type":149,"tag":150,"props":3916,"children":3917},{},[3918,3920,3931,3933,3939],{"type":154,"value":3919},"If you look at the ",{"type":149,"tag":157,"props":3921,"children":3923},{"href":3888,"rel":3922},[161],[3924,3926],{"type":154,"value":3925},"documentation for ",{"type":149,"tag":397,"props":3927,"children":3929},{"className":3928},[],[3930],{"type":154,"value":3896},{"type":154,"value":3932},", youll notice that you can provide different ",{"type":149,"tag":397,"props":3934,"children":3936},{"className":3935},[],[3937],{"type":154,"value":3938},"flags",{"type":154,"value":3940}," as input arguments that determine the behavior of this helper.",{"type":149,"tag":150,"props":3942,"children":3943},{},[3944],{"type":154,"value":3945},"For example:",{"type":149,"tag":292,"props":3947,"children":3948},{},[3949,3975,3995],{"type":149,"tag":296,"props":3950,"children":3951},{},[3952,3958,3960,3966,3967,3973],{"type":149,"tag":397,"props":3953,"children":3955},{"className":3954},[],[3956],{"type":154,"value":3957},"BPF_FIB_LOOKUP_OUTPUT",{"type":154,"value":3959},"  Treat the packet as if its leaving the interface, instead of arriving on it (the default). This matters when your routing selection depends on ",{"type":149,"tag":397,"props":3961,"children":3963},{"className":3962},[],[3964],{"type":154,"value":3965},"iif",{"type":154,"value":87},{"type":149,"tag":397,"props":3968,"children":3970},{"className":3969},[],[3971],{"type":154,"value":3972},"oif",{"type":154,"value":3974}," IP rules.",{"type":149,"tag":296,"props":3976,"children":3977},{},[3978,3980,3986,3987,3993],{"type":154,"value":3979},"Combination of ",{"type":149,"tag":397,"props":3981,"children":3983},{"className":3982},[],[3984],{"type":154,"value":3985},"BPF_FIB_LOOKUP_TBID",{"type":154,"value":166},{"type":149,"tag":397,"props":3988,"children":3990},{"className":3989},[],[3991],{"type":154,"value":3992},"BPF_FIB_LOOKUP_DIRECT",{"type":154,"value":3994},"  Bypass IP rules and perform a direct lookup in a specified routing table. Its faster but not ideal if routing should follow IP rules.",{"type":149,"tag":296,"props":3996,"children":3997},{},[3998,4004],{"type":149,"tag":397,"props":3999,"children":4001},{"className":4000},[],[4002],{"type":154,"value":4003},"BPF_FIB_LOOKUP_SKIP_NEIGH",{"type":154,"value":4005}," - Query only the kernels routing tables and skip the neighbor table lookup.",{"type":149,"tag":150,"props":4007,"children":4008},{},[4009],{"type":154,"value":4010},"There are other special flags, but it's best to check the official documentation for the most up-to-date list and exact names.",{"type":149,"tag":367,"props":4012,"children":4040},{"className":369,"code":4013,"filename":371,"highlights":4014,"language":393,"meta":394,"style":394},"static __always_inline int fib_lookup_v4_full(struct xdp_md *ctx,\n                                              struct bpf_fib_lookup *fib,\n                                              __u32 src, __u32 dst,\n                                              __u16 tot_len) {\n  // Zero and populate only what a full lookup needs\n  __builtin_memset(fib, 0, sizeof(*fib));\n  // Hardcode address family: AF_INET for IPv4\n  fib->family = AF_INET;\n  // Source IPv4 address used by the kernel for policy routing and source\n  // addressbased decisions\n  fib->ipv4_src = src;\n  // Destination IPv4 address (in network byte order)\n  // The address we want to reach; used to find the correct egress route\n  fib->ipv4_dst = dst;\n  // Hardcoded Layer 4 protocol: TCP, UDP, ICMP\n  fib->l4_protocol = IPPROTO_TCP;\n  // Total length of the IPv4 packet (header + payload)\n  fib->tot_len = tot_len;\n  // Interface for the lookup\n  fib->ifindex = ctx->ingress_ifindex;\n  return bpf_fib_lookup(ctx, fib, sizeof(*fib), 0);\n}\n\nSEC(\"xdp\")\nint xdp_load_balancer(struct xdp_md *ctx) {\n  ...\n  // Store Load Balancer IP for later\n  __u32 lb_ip = ip->daddr;\n\n  struct bpf_fib_lookup fib = {};\n  struct endpoint *out = bpf_map_lookup_elem(&conntrack, &in);\n  if (!out) {\n    bpf_printk(\"Packet from client because no such connection exists yet\");\n\n    // Choose backend using simple hashing\n    struct five_tuple_t five_tuple = {};\n    five_tuple.src_ip = ip->saddr;\n    five_tuple.dst_ip = ip->daddr;\n    five_tuple.src_port = tcp->source;\n    five_tuple.dst_port = tcp->dest;\n    five_tuple.protocol = IPPROTO_TCP;\n    __u32 key = xdp_hash_tuple(&five_tuple) % NUM_BACKENDS;\n    struct endpoint *backend = bpf_map_lookup_elem(&backends, &key);\n    if (!backend) {\n      return XDP_ABORTED;\n    }\n\n    // Perform a FIB lookup\n    int rc = fib_lookup_v4_full(ctx, &fib, ip->daddr, backend->ip,\n                                bpf_ntohs(ip->tot_len));\n    if (rc != BPF_FIB_LKUP_RET_SUCCESS) {\n      log_fib_error(rc);\n      return XDP_ABORTED;\n    }\n\n    // Store connection in the conntrack eBPF map\n    struct five_tuple_t in_loadbalancer = {};\n    in_loadbalancer.src_ip = ip->daddr;\n    in_loadbalancer.dst_ip = backend->ip;\n    in_loadbalancer.src_port = tcp->source;\n    in_loadbalancer.dst_port = tcp->dest;\n    in_loadbalancer.protocol = IPPROTO_TCP; \n    struct endpoint client;\n    client.ip = ip->saddr;\n    int ret = bpf_map_update_elem(&conntrack, &in_loadbalancer, &client, BPF_ANY);\n    if (ret != 0) {\n      bpf_printk(\"Failed to update conntrack eBPF map\");\n      return XDP_ABORTED;\n    }\n\n    // Replace destination IP with backends' IP\n    ip->daddr = backend->ip;\n    // Replace destination MAC with backends' MAC\n    __builtin_memcpy(eth->h_dest, fib.dmac, ETH_ALEN);\n  } else {\n    bpf_printk(\"Packet from backend because the connection exists - \"\n               \"redirecting back to client\");\n\n    // Perform a FIB lookup\n    int rc = fib_lookup_v4_full(ctx, &fib, ip->daddr, out->ip,\n                                bpf_ntohs(ip->tot_len));\n    if (rc != BPF_FIB_LKUP_RET_SUCCESS) {\n      log_fib_error(rc);\n      return XDP_ABORTED;\n    }\n\n    // Replace destination IP with clients' IP\n    ip->daddr = out->ip;\n    // Replace destination MAC with clients' MAC\n    __builtin_memcpy(eth->h_dest, fib.dmac, ETH_ALEN);\n  }\n\n  // Replace source IP with load balancers' IP\n  ip->saddr = lb_ip;\n  // Replace source MAC with load balancers' MAC\n  __builtin_memcpy(eth->h_source, fib.smac, ETH_ALEN);\n  ...\n",[40,97,373,374,375,376,377,57,378,379,380,381,692,717,740,382,383,384,385,386,387,388,389,392,1110,1118,1137,4015,4016,4017,4018,4019,4020,56,4021,4022,4023,4024,4025,4026,4027,4028,4029,4030,4031,4032,4033,4034,4035,4036,4037,4038,4039],48,49,50,51,52,53,71,72,73,74,79,80,81,82,83,84,85,87,88,89,90,93,94,95,96,[4041],{"type":149,"tag":397,"props":4042,"children":4043},{"__ignoreMap":394},[4044,4091,4118,4146,4164,4173,4214,4223,4250,4259,4268,4294,4303,4312,4338,4347,4372,4381,4406,4415,4454,4497,4505,4512,4531,4567,4575,4584,4613,4620,4640,4688,4707,4726,4733,4740,4763,4798,4833,4869,4905,4929,4965,5013,5035,5049,5058,5066,5075,5143,5173,5196,5210,5222,5230,5238,5247,5271,5307,5343,5379,5415,5440,5452,5488,5536,5562,5584,5596,5604,5612,5621,5658,5667,5716,5732,5748,5760,5768,5776,5841,5869,5889,5901,5913,5921,5929,5938,5975,5984,6028,6036,6044,6053,6079,6088,6135],{"type":149,"tag":401,"props":4045,"children":4047},{"class":4046,"line":97},[403,414],[4048,4052,4057,4061,4066,4070,4074,4078,4082,4086],{"type":149,"tag":401,"props":4049,"children":4050},{"style":446},[4051],{"type":154,"value":2826},{"type":149,"tag":401,"props":4053,"children":4054},{"style":407},[4055],{"type":154,"value":4056}," __always_inline ",{"type":149,"tag":401,"props":4058,"children":4059},{"style":446},[4060],{"type":154,"value":3312},{"type":149,"tag":401,"props":4062,"children":4063},{"style":651},[4064],{"type":154,"value":4065}," fib_lookup_v4_full",{"type":149,"tag":401,"props":4067,"children":4068},{"style":407},[4069],{"type":154,"value":659},{"type":149,"tag":401,"props":4071,"children":4072},{"style":446},[4073],{"type":154,"value":2845},{"type":149,"tag":401,"props":4075,"children":4076},{"style":407},[4077],{"type":154,"value":3330},{"type":149,"tag":401,"props":4079,"children":4080},{"style":463},[4081],{"type":154,"value":639},{"type":149,"tag":401,"props":4083,"children":4084},{"style":667},[4085],{"type":154,"value":3339},{"type":149,"tag":401,"props":4087,"children":4088},{"style":407},[4089],{"type":154,"value":4090},",\n",{"type":149,"tag":401,"props":4092,"children":4094},{"class":4093,"line":373},[403,414],[4095,4100,4105,4109,4114],{"type":149,"tag":401,"props":4096,"children":4097},{"style":446},[4098],{"type":154,"value":4099},"                                              struct",{"type":149,"tag":401,"props":4101,"children":4102},{"style":407},[4103],{"type":154,"value":4104}," bpf_fib_lookup ",{"type":149,"tag":401,"props":4106,"children":4107},{"style":463},[4108],{"type":154,"value":639},{"type":149,"tag":401,"props":4110,"children":4111},{"style":667},[4112],{"type":154,"value":4113},"fib",{"type":149,"tag":401,"props":4115,"children":4116},{"style":407},[4117],{"type":154,"value":4090},{"type":149,"tag":401,"props":4119,"children":4121},{"class":4120,"line":374},[403,414],[4122,4127,4132,4137,4142],{"type":149,"tag":401,"props":4123,"children":4124},{"style":407},[4125],{"type":154,"value":4126},"                                              __u32 ",{"type":149,"tag":401,"props":4128,"children":4129},{"style":667},[4130],{"type":154,"value":4131},"src",{"type":149,"tag":401,"props":4133,"children":4134},{"style":407},[4135],{"type":154,"value":4136},", __u32 ",{"type":149,"tag":401,"props":4138,"children":4139},{"style":667},[4140],{"type":154,"value":4141},"dst",{"type":149,"tag":401,"props":4143,"children":4144},{"style":407},[4145],{"type":154,"value":4090},{"type":149,"tag":401,"props":4147,"children":4149},{"class":4148,"line":375},[403,414],[4150,4155,4160],{"type":149,"tag":401,"props":4151,"children":4152},{"style":407},[4153],{"type":154,"value":4154},"                                              __u16 ",{"type":149,"tag":401,"props":4156,"children":4157},{"style":667},[4158],{"type":154,"value":4159},"tot_len",{"type":149,"tag":401,"props":4161,"children":4162},{"style":407},[4163],{"type":154,"value":2864},{"type":149,"tag":401,"props":4165,"children":4167},{"class":4166,"line":376},[403,414],[4168],{"type":149,"tag":401,"props":4169,"children":4170},{"style":418},[4171],{"type":154,"value":4172},"  // Zero and populate only what a full lookup needs\n",{"type":149,"tag":401,"props":4174,"children":4176},{"class":4175,"line":377},[403,414],[4177,4182,4187,4192,4196,4201,4205,4209],{"type":149,"tag":401,"props":4178,"children":4179},{"style":651},[4180],{"type":154,"value":4181},"  __builtin_memset",{"type":149,"tag":401,"props":4183,"children":4184},{"style":407},[4185],{"type":154,"value":4186},"(fib, ",{"type":149,"tag":401,"props":4188,"children":4189},{"style":2880},[4190],{"type":154,"value":4191},"0",{"type":149,"tag":401,"props":4193,"children":4194},{"style":407},[4195],{"type":154,"value":675},{"type":149,"tag":401,"props":4197,"children":4198},{"style":446},[4199],{"type":154,"value":4200},"sizeof",{"type":149,"tag":401,"props":4202,"children":4203},{"style":407},[4204],{"type":154,"value":659},{"type":149,"tag":401,"props":4206,"children":4207},{"style":463},[4208],{"type":154,"value":639},{"type":149,"tag":401,"props":4210,"children":4211},{"style":407},[4212],{"type":154,"value":4213},"fib));\n",{"type":149,"tag":401,"props":4215,"children":4217},{"class":4216,"line":57},[403,414],[4218],{"type":149,"tag":401,"props":4219,"children":4220},{"style":418},[4221],{"type":154,"value":4222},"  // Hardcode address family: AF_INET for IPv4\n",{"type":149,"tag":401,"props":4224,"children":4226},{"class":4225,"line":378},[403,414],[4227,4232,4236,4241,4245],{"type":149,"tag":401,"props":4228,"children":4229},{"style":667},[4230],{"type":154,"value":4231},"  fib",{"type":149,"tag":401,"props":4233,"children":4234},{"style":407},[4235],{"type":154,"value":494},{"type":149,"tag":401,"props":4237,"children":4238},{"style":667},[4239],{"type":154,"value":4240},"family",{"type":149,"tag":401,"props":4242,"children":4243},{"style":463},[4244],{"type":154,"value":814},{"type":149,"tag":401,"props":4246,"children":4247},{"style":407},[4248],{"type":154,"value":4249}," AF_INET;\n",{"type":149,"tag":401,"props":4251,"children":4253},{"class":4252,"line":379},[403,414],[4254],{"type":149,"tag":401,"props":4255,"children":4256},{"style":418},[4257],{"type":154,"value":4258},"  // Source IPv4 address used by the kernel for policy routing and source\n",{"type":149,"tag":401,"props":4260,"children":4262},{"class":4261,"line":380},[403,414],[4263],{"type":149,"tag":401,"props":4264,"children":4265},{"style":418},[4266],{"type":154,"value":4267},"  // addressbased decisions\n",{"type":149,"tag":401,"props":4269,"children":4271},{"class":4270,"line":381},[403,414],[4272,4276,4280,4285,4289],{"type":149,"tag":401,"props":4273,"children":4274},{"style":667},[4275],{"type":154,"value":4231},{"type":149,"tag":401,"props":4277,"children":4278},{"style":407},[4279],{"type":154,"value":494},{"type":149,"tag":401,"props":4281,"children":4282},{"style":667},[4283],{"type":154,"value":4284},"ipv4_src",{"type":149,"tag":401,"props":4286,"children":4287},{"style":463},[4288],{"type":154,"value":814},{"type":149,"tag":401,"props":4290,"children":4291},{"style":407},[4292],{"type":154,"value":4293}," src;\n",{"type":149,"tag":401,"props":4295,"children":4297},{"class":4296,"line":692},[403,414],[4298],{"type":149,"tag":401,"props":4299,"children":4300},{"style":418},[4301],{"type":154,"value":4302},"  // Destination IPv4 address (in network byte order)\n",{"type":149,"tag":401,"props":4304,"children":4306},{"class":4305,"line":717},[403,414],[4307],{"type":149,"tag":401,"props":4308,"children":4309},{"style":418},[4310],{"type":154,"value":4311},"  // The address we want to reach; used to find the correct egress route\n",{"type":149,"tag":401,"props":4313,"children":4315},{"class":4314,"line":740},[403,414],[4316,4320,4324,4329,4333],{"type":149,"tag":401,"props":4317,"children":4318},{"style":667},[4319],{"type":154,"value":4231},{"type":149,"tag":401,"props":4321,"children":4322},{"style":407},[4323],{"type":154,"value":494},{"type":149,"tag":401,"props":4325,"children":4326},{"style":667},[4327],{"type":154,"value":4328},"ipv4_dst",{"type":149,"tag":401,"props":4330,"children":4331},{"style":463},[4332],{"type":154,"value":814},{"type":149,"tag":401,"props":4334,"children":4335},{"style":407},[4336],{"type":154,"value":4337}," dst;\n",{"type":149,"tag":401,"props":4339,"children":4341},{"class":4340,"line":382},[403,414],[4342],{"type":149,"tag":401,"props":4343,"children":4344},{"style":418},[4345],{"type":154,"value":4346},"  // Hardcoded Layer 4 protocol: TCP, UDP, ICMP\n",{"type":149,"tag":401,"props":4348,"children":4350},{"class":4349,"line":383},[403,414],[4351,4355,4359,4364,4368],{"type":149,"tag":401,"props":4352,"children":4353},{"style":667},[4354],{"type":154,"value":4231},{"type":149,"tag":401,"props":4356,"children":4357},{"style":407},[4358],{"type":154,"value":494},{"type":149,"tag":401,"props":4360,"children":4361},{"style":667},[4362],{"type":154,"value":4363},"l4_protocol",{"type":149,"tag":401,"props":4365,"children":4366},{"style":463},[4367],{"type":154,"value":814},{"type":149,"tag":401,"props":4369,"children":4370},{"style":407},[4371],{"type":154,"value":3599},{"type":149,"tag":401,"props":4373,"children":4375},{"class":4374,"line":384},[403,414],[4376],{"type":149,"tag":401,"props":4377,"children":4378},{"style":418},[4379],{"type":154,"value":4380},"  // Total length of the IPv4 packet (header + payload)\n",{"type":149,"tag":401,"props":4382,"children":4384},{"class":4383,"line":385},[403,414],[4385,4389,4393,4397,4401],{"type":149,"tag":401,"props":4386,"children":4387},{"style":667},[4388],{"type":154,"value":4231},{"type":149,"tag":401,"props":4390,"children":4391},{"style":407},[4392],{"type":154,"value":494},{"type":149,"tag":401,"props":4394,"children":4395},{"style":667},[4396],{"type":154,"value":4159},{"type":149,"tag":401,"props":4398,"children":4399},{"style":463},[4400],{"type":154,"value":814},{"type":149,"tag":401,"props":4402,"children":4403},{"style":407},[4404],{"type":154,"value":4405}," tot_len;\n",{"type":149,"tag":401,"props":4407,"children":4409},{"class":4408,"line":386},[403,414],[4410],{"type":149,"tag":401,"props":4411,"children":4412},{"style":418},[4413],{"type":154,"value":4414},"  // Interface for the lookup\n",{"type":149,"tag":401,"props":4416,"children":4418},{"class":4417,"line":387},[403,414],[4419,4423,4427,4432,4436,4441,4445,4450],{"type":149,"tag":401,"props":4420,"children":4421},{"style":667},[4422],{"type":154,"value":4231},{"type":149,"tag":401,"props":4424,"children":4425},{"style":407},[4426],{"type":154,"value":494},{"type":149,"tag":401,"props":4428,"children":4429},{"style":667},[4430],{"type":154,"value":4431},"ifindex",{"type":149,"tag":401,"props":4433,"children":4434},{"style":463},[4435],{"type":154,"value":814},{"type":149,"tag":401,"props":4437,"children":4438},{"style":667},[4439],{"type":154,"value":4440}," ctx",{"type":149,"tag":401,"props":4442,"children":4443},{"style":407},[4444],{"type":154,"value":494},{"type":149,"tag":401,"props":4446,"children":4447},{"style":667},[4448],{"type":154,"value":4449},"ingress_ifindex",{"type":149,"tag":401,"props":4451,"children":4452},{"style":407},[4453],{"type":154,"value":2888},{"type":149,"tag":401,"props":4455,"children":4457},{"class":4456,"line":388},[403,414],[4458,4462,4467,4472,4476,4480,4484,4489,4493],{"type":149,"tag":401,"props":4459,"children":4460},{"style":696},[4461],{"type":154,"value":3143},{"type":149,"tag":401,"props":4463,"children":4464},{"style":651},[4465],{"type":154,"value":4466}," bpf_fib_lookup",{"type":149,"tag":401,"props":4468,"children":4469},{"style":407},[4470],{"type":154,"value":4471},"(ctx, fib, ",{"type":149,"tag":401,"props":4473,"children":4474},{"style":446},[4475],{"type":154,"value":4200},{"type":149,"tag":401,"props":4477,"children":4478},{"style":407},[4479],{"type":154,"value":659},{"type":149,"tag":401,"props":4481,"children":4482},{"style":463},[4483],{"type":154,"value":639},{"type":149,"tag":401,"props":4485,"children":4486},{"style":407},[4487],{"type":154,"value":4488},"fib), ",{"type":149,"tag":401,"props":4490,"children":4491},{"style":2880},[4492],{"type":154,"value":4191},{"type":149,"tag":401,"props":4494,"children":4495},{"style":407},[4496],{"type":154,"value":689},{"type":149,"tag":401,"props":4498,"children":4500},{"class":4499,"line":389},[403,414],[4501],{"type":149,"tag":401,"props":4502,"children":4503},{"style":407},[4504],{"type":154,"value":3157},{"type":149,"tag":401,"props":4506,"children":4507},{"class":403,"line":390},[4508],{"type":149,"tag":401,"props":4509,"children":4510},{"emptyLinePlaceholder":11},[4511],{"type":154,"value":3165},{"type":149,"tag":401,"props":4513,"children":4514},{"class":403,"line":391},[4515,4519,4523,4527],{"type":149,"tag":401,"props":4516,"children":4517},{"style":651},[4518],{"type":154,"value":3263},{"type":149,"tag":401,"props":4520,"children":4521},{"style":407},[4522],{"type":154,"value":659},{"type":149,"tag":401,"props":4524,"children":4525},{"style":730},[4526],{"type":154,"value":3299},{"type":149,"tag":401,"props":4528,"children":4529},{"style":407},[4530],{"type":154,"value":3304},{"type":149,"tag":401,"props":4532,"children":4534},{"class":4533,"line":392},[403,414],[4535,4539,4543,4547,4551,4555,4559,4563],{"type":149,"tag":401,"props":4536,"children":4537},{"style":446},[4538],{"type":154,"value":3312},{"type":149,"tag":401,"props":4540,"children":4541},{"style":651},[4542],{"type":154,"value":3317},{"type":149,"tag":401,"props":4544,"children":4545},{"style":407},[4546],{"type":154,"value":659},{"type":149,"tag":401,"props":4548,"children":4549},{"style":446},[4550],{"type":154,"value":2845},{"type":149,"tag":401,"props":4552,"children":4553},{"style":407},[4554],{"type":154,"value":3330},{"type":149,"tag":401,"props":4556,"children":4557},{"style":463},[4558],{"type":154,"value":639},{"type":149,"tag":401,"props":4560,"children":4561},{"style":667},[4562],{"type":154,"value":3339},{"type":149,"tag":401,"props":4564,"children":4565},{"style":407},[4566],{"type":154,"value":2864},{"type":149,"tag":401,"props":4568,"children":4570},{"class":4569,"line":1110},[403,414],[4571],{"type":149,"tag":401,"props":4572,"children":4573},{"style":407},[4574],{"type":154,"value":410},{"type":149,"tag":401,"props":4576,"children":4578},{"class":4577,"line":1118},[403,414],[4579],{"type":149,"tag":401,"props":4580,"children":4581},{"style":418},[4582],{"type":154,"value":4583},"  // Store Load Balancer IP for later\n",{"type":149,"tag":401,"props":4585,"children":4587},{"class":4586,"line":1137},[403,414],[4588,4593,4597,4601,4605,4609],{"type":149,"tag":401,"props":4589,"children":4590},{"style":407},[4591],{"type":154,"value":4592},"  __u32 lb_ip ",{"type":149,"tag":401,"props":4594,"children":4595},{"style":463},[4596],{"type":154,"value":466},{"type":149,"tag":401,"props":4598,"children":4599},{"style":667},[4600],{"type":154,"value":489},{"type":149,"tag":401,"props":4602,"children":4603},{"style":407},[4604],{"type":154,"value":494},{"type":149,"tag":401,"props":4606,"children":4607},{"style":667},[4608],{"type":154,"value":827},{"type":149,"tag":401,"props":4610,"children":4611},{"style":407},[4612],{"type":154,"value":2888},{"type":149,"tag":401,"props":4614,"children":4615},{"class":403,"line":1154},[4616],{"type":149,"tag":401,"props":4617,"children":4618},{"emptyLinePlaceholder":11},[4619],{"type":154,"value":3165},{"type":149,"tag":401,"props":4621,"children":4622},{"class":403,"line":1167},[4623,4627,4632,4636],{"type":149,"tag":401,"props":4624,"children":4625},{"style":446},[4626],{"type":154,"value":449},{"type":149,"tag":401,"props":4628,"children":4629},{"style":407},[4630],{"type":154,"value":4631}," bpf_fib_lookup fib ",{"type":149,"tag":401,"props":4633,"children":4634},{"style":463},[4635],{"type":154,"value":466},{"type":149,"tag":401,"props":4637,"children":4638},{"style":407},[4639],{"type":154,"value":471},{"type":149,"tag":401,"props":4641,"children":4642},{"class":403,"line":1175},[4643,4647,4651,4655,4659,4663,4667,4671,4675,4679,4683],{"type":149,"tag":401,"props":4644,"children":4645},{"style":446},[4646],{"type":154,"value":449},{"type":149,"tag":401,"props":4648,"children":4649},{"style":407},[4650],{"type":154,"value":634},{"type":149,"tag":401,"props":4652,"children":4653},{"style":463},[4654],{"type":154,"value":639},{"type":149,"tag":401,"props":4656,"children":4657},{"style":407},[4658],{"type":154,"value":644},{"type":149,"tag":401,"props":4660,"children":4661},{"style":463},[4662],{"type":154,"value":466},{"type":149,"tag":401,"props":4664,"children":4665},{"style":651},[4666],{"type":154,"value":654},{"type":149,"tag":401,"props":4668,"children":4669},{"style":407},[4670],{"type":154,"value":659},{"type":149,"tag":401,"props":4672,"children":4673},{"style":463},[4674],{"type":154,"value":664},{"type":149,"tag":401,"props":4676,"children":4677},{"style":407},[4678],{"type":154,"value":1089},{"type":149,"tag":401,"props":4680,"children":4681},{"style":463},[4682],{"type":154,"value":664},{"type":149,"tag":401,"props":4684,"children":4685},{"style":407},[4686],{"type":154,"value":4687},"in);\n",{"type":149,"tag":401,"props":4689,"children":4690},{"class":403,"line":1184},[4691,4695,4699,4703],{"type":149,"tag":401,"props":4692,"children":4693},{"style":696},[4694],{"type":154,"value":699},{"type":149,"tag":401,"props":4696,"children":4697},{"style":407},[4698],{"type":154,"value":704},{"type":149,"tag":401,"props":4700,"children":4701},{"style":463},[4702],{"type":154,"value":709},{"type":149,"tag":401,"props":4704,"children":4705},{"style":407},[4706],{"type":154,"value":714},{"type":149,"tag":401,"props":4708,"children":4709},{"class":403,"line":2800},[4710,4714,4718,4722],{"type":149,"tag":401,"props":4711,"children":4712},{"style":651},[4713],{"type":154,"value":723},{"type":149,"tag":401,"props":4715,"children":4716},{"style":407},[4717],{"type":154,"value":659},{"type":149,"tag":401,"props":4719,"children":4720},{"style":730},[4721],{"type":154,"value":733},{"type":149,"tag":401,"props":4723,"children":4724},{"style":407},[4725],{"type":154,"value":689},{"type":149,"tag":401,"props":4727,"children":4728},{"class":403,"line":2801},[4729],{"type":149,"tag":401,"props":4730,"children":4731},{"emptyLinePlaceholder":11},[4732],{"type":154,"value":3165},{"type":149,"tag":401,"props":4734,"children":4735},{"class":403,"line":2802},[4736],{"type":149,"tag":401,"props":4737,"children":4738},{"style":418},[4739],{"type":154,"value":3404},{"type":149,"tag":401,"props":4741,"children":4742},{"class":403,"line":2803},[4743,4747,4751,4755,4759],{"type":149,"tag":401,"props":4744,"children":4745},{"style":446},[4746],{"type":154,"value":773},{"type":149,"tag":401,"props":4748,"children":4749},{"style":452},[4750],{"type":154,"value":455},{"type":149,"tag":401,"props":4752,"children":4753},{"style":407},[4754],{"type":154,"value":3421},{"type":149,"tag":401,"props":4756,"children":4757},{"style":463},[4758],{"type":154,"value":466},{"type":149,"tag":401,"props":4760,"children":4761},{"style":407},[4762],{"type":154,"value":471},{"type":149,"tag":401,"props":4764,"children":4765},{"class":403,"line":2804},[4766,4770,4774,4778,4782,4786,4790,4794],{"type":149,"tag":401,"props":4767,"children":4768},{"style":667},[4769],{"type":154,"value":3438},{"type":149,"tag":401,"props":4771,"children":4772},{"style":407},[4773],{"type":154,"value":804},{"type":149,"tag":401,"props":4775,"children":4776},{"style":667},[4777],{"type":154,"value":809},{"type":149,"tag":401,"props":4779,"children":4780},{"style":463},[4781],{"type":154,"value":814},{"type":149,"tag":401,"props":4783,"children":4784},{"style":667},[4785],{"type":154,"value":489},{"type":149,"tag":401,"props":4787,"children":4788},{"style":407},[4789],{"type":154,"value":494},{"type":149,"tag":401,"props":4791,"children":4792},{"style":667},[4793],{"type":154,"value":1044},{"type":149,"tag":401,"props":4795,"children":4796},{"style":407},[4797],{"type":154,"value":2888},{"type":149,"tag":401,"props":4799,"children":4800},{"class":403,"line":3721},[4801,4805,4809,4813,4817,4821,4825,4829],{"type":149,"tag":401,"props":4802,"children":4803},{"style":667},[4804],{"type":154,"value":3438},{"type":149,"tag":401,"props":4806,"children":4807},{"style":407},[4808],{"type":154,"value":804},{"type":149,"tag":401,"props":4810,"children":4811},{"style":667},[4812],{"type":154,"value":854},{"type":149,"tag":401,"props":4814,"children":4815},{"style":463},[4816],{"type":154,"value":814},{"type":149,"tag":401,"props":4818,"children":4819},{"style":667},[4820],{"type":154,"value":489},{"type":149,"tag":401,"props":4822,"children":4823},{"style":407},[4824],{"type":154,"value":494},{"type":149,"tag":401,"props":4826,"children":4827},{"style":667},[4828],{"type":154,"value":827},{"type":149,"tag":401,"props":4830,"children":4831},{"style":407},[4832],{"type":154,"value":2888},{"type":149,"tag":401,"props":4834,"children":4836},{"class":403,"line":4835},39,[4837,4841,4845,4849,4853,4857,4861,4865],{"type":149,"tag":401,"props":4838,"children":4839},{"style":667},[4840],{"type":154,"value":3438},{"type":149,"tag":401,"props":4842,"children":4843},{"style":407},[4844],{"type":154,"value":804},{"type":149,"tag":401,"props":4846,"children":4847},{"style":667},[4848],{"type":154,"value":898},{"type":149,"tag":401,"props":4850,"children":4851},{"style":463},[4852],{"type":154,"value":814},{"type":149,"tag":401,"props":4854,"children":4855},{"style":667},[4856],{"type":154,"value":553},{"type":149,"tag":401,"props":4858,"children":4859},{"style":407},[4860],{"type":154,"value":494},{"type":149,"tag":401,"props":4862,"children":4863},{"style":667},[4864],{"type":154,"value":915},{"type":149,"tag":401,"props":4866,"children":4867},{"style":407},[4868],{"type":154,"value":2888},{"type":149,"tag":401,"props":4870,"children":4872},{"class":403,"line":4871},40,[4873,4877,4881,4885,4889,4893,4897,4901],{"type":149,"tag":401,"props":4874,"children":4875},{"style":667},[4876],{"type":154,"value":3438},{"type":149,"tag":401,"props":4878,"children":4879},{"style":407},[4880],{"type":154,"value":804},{"type":149,"tag":401,"props":4882,"children":4883},{"style":667},[4884],{"type":154,"value":941},{"type":149,"tag":401,"props":4886,"children":4887},{"style":463},[4888],{"type":154,"value":814},{"type":149,"tag":401,"props":4890,"children":4891},{"style":667},[4892],{"type":154,"value":553},{"type":149,"tag":401,"props":4894,"children":4895},{"style":407},[4896],{"type":154,"value":494},{"type":149,"tag":401,"props":4898,"children":4899},{"style":667},[4900],{"type":154,"value":958},{"type":149,"tag":401,"props":4902,"children":4903},{"style":407},[4904],{"type":154,"value":2888},{"type":149,"tag":401,"props":4906,"children":4908},{"class":403,"line":4907},41,[4909,4913,4917,4921,4925],{"type":149,"tag":401,"props":4910,"children":4911},{"style":667},[4912],{"type":154,"value":3438},{"type":149,"tag":401,"props":4914,"children":4915},{"style":407},[4916],{"type":154,"value":804},{"type":149,"tag":401,"props":4918,"children":4919},{"style":667},[4920],{"type":154,"value":984},{"type":149,"tag":401,"props":4922,"children":4923},{"style":463},[4924],{"type":154,"value":814},{"type":149,"tag":401,"props":4926,"children":4927},{"style":407},[4928],{"type":154,"value":3599},{"type":149,"tag":401,"props":4930,"children":4932},{"class":403,"line":4931},42,[4933,4937,4941,4945,4949,4953,4957,4961],{"type":149,"tag":401,"props":4934,"children":4935},{"style":407},[4936],{"type":154,"value":3626},{"type":149,"tag":401,"props":4938,"children":4939},{"style":463},[4940],{"type":154,"value":466},{"type":149,"tag":401,"props":4942,"children":4943},{"style":651},[4944],{"type":154,"value":3635},{"type":149,"tag":401,"props":4946,"children":4947},{"style":407},[4948],{"type":154,"value":659},{"type":149,"tag":401,"props":4950,"children":4951},{"style":463},[4952],{"type":154,"value":664},{"type":149,"tag":401,"props":4954,"children":4955},{"style":407},[4956],{"type":154,"value":3648},{"type":149,"tag":401,"props":4958,"children":4959},{"style":463},[4960],{"type":154,"value":3653},{"type":149,"tag":401,"props":4962,"children":4963},{"style":407},[4964],{"type":154,"value":3658},{"type":149,"tag":401,"props":4966,"children":4968},{"class":403,"line":4967},43,[4969,4973,4977,4981,4985,4989,4993,4997,5001,5005,5009],{"type":149,"tag":401,"props":4970,"children":4971},{"style":446},[4972],{"type":154,"value":773},{"type":149,"tag":401,"props":4974,"children":4975},{"style":407},[4976],{"type":154,"value":634},{"type":149,"tag":401,"props":4978,"children":4979},{"style":463},[4980],{"type":154,"value":639},{"type":149,"tag":401,"props":4982,"children":4983},{"style":407},[4984],{"type":154,"value":3688},{"type":149,"tag":401,"props":4986,"children":4987},{"style":463},[4988],{"type":154,"value":466},{"type":149,"tag":401,"props":4990,"children":4991},{"style":651},[4992],{"type":154,"value":654},{"type":149,"tag":401,"props":4994,"children":4995},{"style":407},[4996],{"type":154,"value":659},{"type":149,"tag":401,"props":4998,"children":4999},{"style":463},[5000],{"type":154,"value":664},{"type":149,"tag":401,"props":5002,"children":5003},{"style":407},[5004],{"type":154,"value":3709},{"type":149,"tag":401,"props":5006,"children":5007},{"style":463},[5008],{"type":154,"value":664},{"type":149,"tag":401,"props":5010,"children":5011},{"style":407},[5012],{"type":154,"value":3718},{"type":149,"tag":401,"props":5014,"children":5016},{"class":403,"line":5015},44,[5017,5022,5026,5030],{"type":149,"tag":401,"props":5018,"children":5019},{"style":696},[5020],{"type":154,"value":5021},"    if",{"type":149,"tag":401,"props":5023,"children":5024},{"style":407},[5025],{"type":154,"value":704},{"type":149,"tag":401,"props":5027,"children":5028},{"style":463},[5029],{"type":154,"value":709},{"type":149,"tag":401,"props":5031,"children":5032},{"style":407},[5033],{"type":154,"value":5034},"backend) {\n",{"type":149,"tag":401,"props":5036,"children":5038},{"class":403,"line":5037},45,[5039,5044],{"type":149,"tag":401,"props":5040,"children":5041},{"style":696},[5042],{"type":154,"value":5043},"      return",{"type":149,"tag":401,"props":5045,"children":5046},{"style":407},[5047],{"type":154,"value":5048}," XDP_ABORTED;\n",{"type":149,"tag":401,"props":5050,"children":5052},{"class":403,"line":5051},46,[5053],{"type":149,"tag":401,"props":5054,"children":5055},{"style":407},[5056],{"type":154,"value":5057},"    }\n",{"type":149,"tag":401,"props":5059,"children":5061},{"class":403,"line":5060},47,[5062],{"type":149,"tag":401,"props":5063,"children":5064},{"emptyLinePlaceholder":11},[5065],{"type":154,"value":3165},{"type":149,"tag":401,"props":5067,"children":5069},{"class":5068,"line":4015},[403,414],[5070],{"type":149,"tag":401,"props":5071,"children":5072},{"style":418},[5073],{"type":154,"value":5074},"    // Perform a FIB lookup\n",{"type":149,"tag":401,"props":5076,"children":5078},{"class":5077,"line":4016},[403,414],[5079,5083,5088,5092,5096,5101,5105,5110,5114,5118,5122,5126,5131,5135,5139],{"type":149,"tag":401,"props":5080,"children":5081},{"style":446},[5082],{"type":154,"value":1062},{"type":149,"tag":401,"props":5084,"children":5085},{"style":407},[5086],{"type":154,"value":5087}," rc ",{"type":149,"tag":401,"props":5089,"children":5090},{"style":463},[5091],{"type":154,"value":466},{"type":149,"tag":401,"props":5093,"children":5094},{"style":651},[5095],{"type":154,"value":4065},{"type":149,"tag":401,"props":5097,"children":5098},{"style":407},[5099],{"type":154,"value":5100},"(ctx, ",{"type":149,"tag":401,"props":5102,"children":5103},{"style":463},[5104],{"type":154,"value":664},{"type":149,"tag":401,"props":5106,"children":5107},{"style":407},[5108],{"type":154,"value":5109},"fib, ",{"type":149,"tag":401,"props":5111,"children":5112},{"style":667},[5113],{"type":154,"value":872},{"type":149,"tag":401,"props":5115,"children":5116},{"style":407},[5117],{"type":154,"value":494},{"type":149,"tag":401,"props":5119,"children":5120},{"style":667},[5121],{"type":154,"value":827},{"type":149,"tag":401,"props":5123,"children":5124},{"style":407},[5125],{"type":154,"value":675},{"type":149,"tag":401,"props":5127,"children":5128},{"style":667},[5129],{"type":154,"value":5130},"backend",{"type":149,"tag":401,"props":5132,"children":5133},{"style":407},[5134],{"type":154,"value":494},{"type":149,"tag":401,"props":5136,"children":5137},{"style":667},[5138],{"type":154,"value":872},{"type":149,"tag":401,"props":5140,"children":5141},{"style":407},[5142],{"type":154,"value":4090},{"type":149,"tag":401,"props":5144,"children":5146},{"class":5145,"line":4017},[403,414],[5147,5152,5156,5160,5164,5168],{"type":149,"tag":401,"props":5148,"children":5149},{"style":651},[5150],{"type":154,"value":5151},"                                bpf_ntohs",{"type":149,"tag":401,"props":5153,"children":5154},{"style":407},[5155],{"type":154,"value":659},{"type":149,"tag":401,"props":5157,"children":5158},{"style":667},[5159],{"type":154,"value":872},{"type":149,"tag":401,"props":5161,"children":5162},{"style":407},[5163],{"type":154,"value":494},{"type":149,"tag":401,"props":5165,"children":5166},{"style":667},[5167],{"type":154,"value":4159},{"type":149,"tag":401,"props":5169,"children":5170},{"style":407},[5171],{"type":154,"value":5172},"));\n",{"type":149,"tag":401,"props":5174,"children":5176},{"class":5175,"line":4018},[403,414],[5177,5181,5186,5191],{"type":149,"tag":401,"props":5178,"children":5179},{"style":696},[5180],{"type":154,"value":5021},{"type":149,"tag":401,"props":5182,"children":5183},{"style":407},[5184],{"type":154,"value":5185}," (rc ",{"type":149,"tag":401,"props":5187,"children":5188},{"style":463},[5189],{"type":154,"value":5190},"!=",{"type":149,"tag":401,"props":5192,"children":5193},{"style":407},[5194],{"type":154,"value":5195}," BPF_FIB_LKUP_RET_SUCCESS) {\n",{"type":149,"tag":401,"props":5197,"children":5199},{"class":5198,"line":4019},[403,414],[5200,5205],{"type":149,"tag":401,"props":5201,"children":5202},{"style":651},[5203],{"type":154,"value":5204},"      log_fib_error",{"type":149,"tag":401,"props":5206,"children":5207},{"style":407},[5208],{"type":154,"value":5209},"(rc);\n",{"type":149,"tag":401,"props":5211,"children":5213},{"class":5212,"line":4020},[403,414],[5214,5218],{"type":149,"tag":401,"props":5215,"children":5216},{"style":696},[5217],{"type":154,"value":5043},{"type":149,"tag":401,"props":5219,"children":5220},{"style":407},[5221],{"type":154,"value":5048},{"type":149,"tag":401,"props":5223,"children":5225},{"class":5224,"line":56},[403,414],[5226],{"type":149,"tag":401,"props":5227,"children":5228},{"style":407},[5229],{"type":154,"value":5057},{"type":149,"tag":401,"props":5231,"children":5233},{"class":403,"line":5232},55,[5234],{"type":149,"tag":401,"props":5235,"children":5236},{"emptyLinePlaceholder":11},[5237],{"type":154,"value":3165},{"type":149,"tag":401,"props":5239,"children":5241},{"class":403,"line":5240},56,[5242],{"type":149,"tag":401,"props":5243,"children":5244},{"style":418},[5245],{"type":154,"value":5246},"    // Store connection in the conntrack eBPF map\n",{"type":149,"tag":401,"props":5248,"children":5250},{"class":403,"line":5249},57,[5251,5255,5259,5263,5267],{"type":149,"tag":401,"props":5252,"children":5253},{"style":446},[5254],{"type":154,"value":773},{"type":149,"tag":401,"props":5256,"children":5257},{"style":452},[5258],{"type":154,"value":455},{"type":149,"tag":401,"props":5260,"children":5261},{"style":407},[5262],{"type":154,"value":782},{"type":149,"tag":401,"props":5264,"children":5265},{"style":463},[5266],{"type":154,"value":466},{"type":149,"tag":401,"props":5268,"children":5269},{"style":407},[5270],{"type":154,"value":471},{"type":149,"tag":401,"props":5272,"children":5274},{"class":403,"line":5273},58,[5275,5279,5283,5287,5291,5295,5299,5303],{"type":149,"tag":401,"props":5276,"children":5277},{"style":667},[5278],{"type":154,"value":799},{"type":149,"tag":401,"props":5280,"children":5281},{"style":407},[5282],{"type":154,"value":804},{"type":149,"tag":401,"props":5284,"children":5285},{"style":667},[5286],{"type":154,"value":809},{"type":149,"tag":401,"props":5288,"children":5289},{"style":463},[5290],{"type":154,"value":814},{"type":149,"tag":401,"props":5292,"children":5293},{"style":667},[5294],{"type":154,"value":489},{"type":149,"tag":401,"props":5296,"children":5297},{"style":407},[5298],{"type":154,"value":494},{"type":149,"tag":401,"props":5300,"children":5301},{"style":667},[5302],{"type":154,"value":827},{"type":149,"tag":401,"props":5304,"children":5305},{"style":407},[5306],{"type":154,"value":2888},{"type":149,"tag":401,"props":5308,"children":5310},{"class":403,"line":5309},59,[5311,5315,5319,5323,5327,5331,5335,5339],{"type":149,"tag":401,"props":5312,"children":5313},{"style":667},[5314],{"type":154,"value":799},{"type":149,"tag":401,"props":5316,"children":5317},{"style":407},[5318],{"type":154,"value":804},{"type":149,"tag":401,"props":5320,"children":5321},{"style":667},[5322],{"type":154,"value":854},{"type":149,"tag":401,"props":5324,"children":5325},{"style":463},[5326],{"type":154,"value":814},{"type":149,"tag":401,"props":5328,"children":5329},{"style":667},[5330],{"type":154,"value":863},{"type":149,"tag":401,"props":5332,"children":5333},{"style":407},[5334],{"type":154,"value":494},{"type":149,"tag":401,"props":5336,"children":5337},{"style":667},[5338],{"type":154,"value":872},{"type":149,"tag":401,"props":5340,"children":5341},{"style":407},[5342],{"type":154,"value":2888},{"type":149,"tag":401,"props":5344,"children":5346},{"class":403,"line":5345},60,[5347,5351,5355,5359,5363,5367,5371,5375],{"type":149,"tag":401,"props":5348,"children":5349},{"style":667},[5350],{"type":154,"value":799},{"type":149,"tag":401,"props":5352,"children":5353},{"style":407},[5354],{"type":154,"value":804},{"type":149,"tag":401,"props":5356,"children":5357},{"style":667},[5358],{"type":154,"value":898},{"type":149,"tag":401,"props":5360,"children":5361},{"style":463},[5362],{"type":154,"value":814},{"type":149,"tag":401,"props":5364,"children":5365},{"style":667},[5366],{"type":154,"value":553},{"type":149,"tag":401,"props":5368,"children":5369},{"style":407},[5370],{"type":154,"value":494},{"type":149,"tag":401,"props":5372,"children":5373},{"style":667},[5374],{"type":154,"value":915},{"type":149,"tag":401,"props":5376,"children":5377},{"style":407},[5378],{"type":154,"value":2888},{"type":149,"tag":401,"props":5380,"children":5382},{"class":403,"line":5381},61,[5383,5387,5391,5395,5399,5403,5407,5411],{"type":149,"tag":401,"props":5384,"children":5385},{"style":667},[5386],{"type":154,"value":799},{"type":149,"tag":401,"props":5388,"children":5389},{"style":407},[5390],{"type":154,"value":804},{"type":149,"tag":401,"props":5392,"children":5393},{"style":667},[5394],{"type":154,"value":941},{"type":149,"tag":401,"props":5396,"children":5397},{"style":463},[5398],{"type":154,"value":814},{"type":149,"tag":401,"props":5400,"children":5401},{"style":667},[5402],{"type":154,"value":553},{"type":149,"tag":401,"props":5404,"children":5405},{"style":407},[5406],{"type":154,"value":494},{"type":149,"tag":401,"props":5408,"children":5409},{"style":667},[5410],{"type":154,"value":958},{"type":149,"tag":401,"props":5412,"children":5413},{"style":407},[5414],{"type":154,"value":2888},{"type":149,"tag":401,"props":5416,"children":5418},{"class":403,"line":5417},62,[5419,5423,5427,5431,5435],{"type":149,"tag":401,"props":5420,"children":5421},{"style":667},[5422],{"type":154,"value":799},{"type":149,"tag":401,"props":5424,"children":5425},{"style":407},[5426],{"type":154,"value":804},{"type":149,"tag":401,"props":5428,"children":5429},{"style":667},[5430],{"type":154,"value":984},{"type":149,"tag":401,"props":5432,"children":5433},{"style":463},[5434],{"type":154,"value":814},{"type":149,"tag":401,"props":5436,"children":5437},{"style":407},[5438],{"type":154,"value":5439}," IPPROTO_TCP; \n",{"type":149,"tag":401,"props":5441,"children":5443},{"class":403,"line":5442},63,[5444,5448],{"type":149,"tag":401,"props":5445,"children":5446},{"style":446},[5447],{"type":154,"value":773},{"type":149,"tag":401,"props":5449,"children":5450},{"style":407},[5451],{"type":154,"value":1010},{"type":149,"tag":401,"props":5453,"children":5455},{"class":403,"line":5454},64,[5456,5460,5464,5468,5472,5476,5480,5484],{"type":149,"tag":401,"props":5457,"children":5458},{"style":667},[5459],{"type":154,"value":1019},{"type":149,"tag":401,"props":5461,"children":5462},{"style":407},[5463],{"type":154,"value":804},{"type":149,"tag":401,"props":5465,"children":5466},{"style":667},[5467],{"type":154,"value":872},{"type":149,"tag":401,"props":5469,"children":5470},{"style":463},[5471],{"type":154,"value":814},{"type":149,"tag":401,"props":5473,"children":5474},{"style":667},[5475],{"type":154,"value":489},{"type":149,"tag":401,"props":5477,"children":5478},{"style":407},[5479],{"type":154,"value":494},{"type":149,"tag":401,"props":5481,"children":5482},{"style":667},[5483],{"type":154,"value":1044},{"type":149,"tag":401,"props":5485,"children":5486},{"style":407},[5487],{"type":154,"value":2888},{"type":149,"tag":401,"props":5489,"children":5491},{"class":403,"line":5490},65,[5492,5496,5500,5504,5508,5512,5516,5520,5524,5528,5532],{"type":149,"tag":401,"props":5493,"children":5494},{"style":446},[5495],{"type":154,"value":1062},{"type":149,"tag":401,"props":5497,"children":5498},{"style":407},[5499],{"type":154,"value":1067},{"type":149,"tag":401,"props":5501,"children":5502},{"style":463},[5503],{"type":154,"value":466},{"type":149,"tag":401,"props":5505,"children":5506},{"style":651},[5507],{"type":154,"value":1076},{"type":149,"tag":401,"props":5509,"children":5510},{"style":407},[5511],{"type":154,"value":659},{"type":149,"tag":401,"props":5513,"children":5514},{"style":463},[5515],{"type":154,"value":664},{"type":149,"tag":401,"props":5517,"children":5518},{"style":407},[5519],{"type":154,"value":1089},{"type":149,"tag":401,"props":5521,"children":5522},{"style":463},[5523],{"type":154,"value":664},{"type":149,"tag":401,"props":5525,"children":5526},{"style":407},[5527],{"type":154,"value":1098},{"type":149,"tag":401,"props":5529,"children":5530},{"style":463},[5531],{"type":154,"value":664},{"type":149,"tag":401,"props":5533,"children":5534},{"style":407},[5535],{"type":154,"value":1107},{"type":149,"tag":401,"props":5537,"children":5539},{"class":403,"line":5538},66,[5540,5544,5549,5553,5558],{"type":149,"tag":401,"props":5541,"children":5542},{"style":696},[5543],{"type":154,"value":5021},{"type":149,"tag":401,"props":5545,"children":5546},{"style":407},[5547],{"type":154,"value":5548}," (ret ",{"type":149,"tag":401,"props":5550,"children":5551},{"style":463},[5552],{"type":154,"value":5190},{"type":149,"tag":401,"props":5554,"children":5555},{"style":2880},[5556],{"type":154,"value":5557}," 0",{"type":149,"tag":401,"props":5559,"children":5560},{"style":407},[5561],{"type":154,"value":2864},{"type":149,"tag":401,"props":5563,"children":5565},{"class":403,"line":5564},67,[5566,5571,5575,5580],{"type":149,"tag":401,"props":5567,"children":5568},{"style":651},[5569],{"type":154,"value":5570},"      bpf_printk",{"type":149,"tag":401,"props":5572,"children":5573},{"style":407},[5574],{"type":154,"value":659},{"type":149,"tag":401,"props":5576,"children":5577},{"style":730},[5578],{"type":154,"value":5579},"\"Failed to update conntrack eBPF map\"",{"type":149,"tag":401,"props":5581,"children":5582},{"style":407},[5583],{"type":154,"value":689},{"type":149,"tag":401,"props":5585,"children":5587},{"class":403,"line":5586},68,[5588,5592],{"type":149,"tag":401,"props":5589,"children":5590},{"style":696},[5591],{"type":154,"value":5043},{"type":149,"tag":401,"props":5593,"children":5594},{"style":407},[5595],{"type":154,"value":5048},{"type":149,"tag":401,"props":5597,"children":5599},{"class":403,"line":5598},69,[5600],{"type":149,"tag":401,"props":5601,"children":5602},{"style":407},[5603],{"type":154,"value":5057},{"type":149,"tag":401,"props":5605,"children":5607},{"class":403,"line":5606},70,[5608],{"type":149,"tag":401,"props":5609,"children":5610},{"emptyLinePlaceholder":11},[5611],{"type":154,"value":3165},{"type":149,"tag":401,"props":5613,"children":5615},{"class":5614,"line":4021},[403,414],[5616],{"type":149,"tag":401,"props":5617,"children":5618},{"style":418},[5619],{"type":154,"value":5620},"    // Replace destination IP with backends' IP\n",{"type":149,"tag":401,"props":5622,"children":5624},{"class":5623,"line":4022},[403,414],[5625,5630,5634,5638,5642,5646,5650,5654],{"type":149,"tag":401,"props":5626,"children":5627},{"style":667},[5628],{"type":154,"value":5629},"    ip",{"type":149,"tag":401,"props":5631,"children":5632},{"style":407},[5633],{"type":154,"value":494},{"type":149,"tag":401,"props":5635,"children":5636},{"style":667},[5637],{"type":154,"value":827},{"type":149,"tag":401,"props":5639,"children":5640},{"style":463},[5641],{"type":154,"value":814},{"type":149,"tag":401,"props":5643,"children":5644},{"style":667},[5645],{"type":154,"value":863},{"type":149,"tag":401,"props":5647,"children":5648},{"style":407},[5649],{"type":154,"value":494},{"type":149,"tag":401,"props":5651,"children":5652},{"style":667},[5653],{"type":154,"value":872},{"type":149,"tag":401,"props":5655,"children":5656},{"style":407},[5657],{"type":154,"value":2888},{"type":149,"tag":401,"props":5659,"children":5661},{"class":5660,"line":4023},[403,414],[5662],{"type":149,"tag":401,"props":5663,"children":5664},{"style":418},[5665],{"type":154,"value":5666},"    // Replace destination MAC with backends' MAC\n",{"type":149,"tag":401,"props":5668,"children":5670},{"class":5669,"line":4024},[403,414],[5671,5676,5680,5685,5689,5694,5698,5702,5706,5711],{"type":149,"tag":401,"props":5672,"children":5673},{"style":651},[5674],{"type":154,"value":5675},"    __builtin_memcpy",{"type":149,"tag":401,"props":5677,"children":5678},{"style":407},[5679],{"type":154,"value":659},{"type":149,"tag":401,"props":5681,"children":5682},{"style":667},[5683],{"type":154,"value":5684},"eth",{"type":149,"tag":401,"props":5686,"children":5687},{"style":407},[5688],{"type":154,"value":494},{"type":149,"tag":401,"props":5690,"children":5691},{"style":667},[5692],{"type":154,"value":5693},"h_dest",{"type":149,"tag":401,"props":5695,"children":5696},{"style":407},[5697],{"type":154,"value":675},{"type":149,"tag":401,"props":5699,"children":5700},{"style":667},[5701],{"type":154,"value":4113},{"type":149,"tag":401,"props":5703,"children":5704},{"style":407},[5705],{"type":154,"value":804},{"type":149,"tag":401,"props":5707,"children":5708},{"style":667},[5709],{"type":154,"value":5710},"dmac",{"type":149,"tag":401,"props":5712,"children":5713},{"style":407},[5714],{"type":154,"value":5715},", ETH_ALEN);\n",{"type":149,"tag":401,"props":5717,"children":5719},{"class":403,"line":5718},75,[5720,5724,5728],{"type":149,"tag":401,"props":5721,"children":5722},{"style":407},[5723],{"type":154,"value":1124},{"type":149,"tag":401,"props":5725,"children":5726},{"style":696},[5727],{"type":154,"value":1129},{"type":149,"tag":401,"props":5729,"children":5730},{"style":407},[5731],{"type":154,"value":1134},{"type":149,"tag":401,"props":5733,"children":5735},{"class":403,"line":5734},76,[5736,5740,5744],{"type":149,"tag":401,"props":5737,"children":5738},{"style":651},[5739],{"type":154,"value":723},{"type":149,"tag":401,"props":5741,"children":5742},{"style":407},[5743],{"type":154,"value":659},{"type":149,"tag":401,"props":5745,"children":5746},{"style":730},[5747],{"type":154,"value":1151},{"type":149,"tag":401,"props":5749,"children":5751},{"class":403,"line":5750},77,[5752,5756],{"type":149,"tag":401,"props":5753,"children":5754},{"style":730},[5755],{"type":154,"value":1160},{"type":149,"tag":401,"props":5757,"children":5758},{"style":407},[5759],{"type":154,"value":689},{"type":149,"tag":401,"props":5761,"children":5763},{"class":403,"line":5762},78,[5764],{"type":149,"tag":401,"props":5765,"children":5766},{"emptyLinePlaceholder":11},[5767],{"type":154,"value":3165},{"type":149,"tag":401,"props":5769,"children":5771},{"class":5770,"line":4025},[403,414],[5772],{"type":149,"tag":401,"props":5773,"children":5774},{"style":418},[5775],{"type":154,"value":5074},{"type":149,"tag":401,"props":5777,"children":5779},{"class":5778,"line":4026},[403,414],[5780,5784,5788,5792,5796,5800,5804,5808,5812,5816,5820,5824,5829,5833,5837],{"type":149,"tag":401,"props":5781,"children":5782},{"style":446},[5783],{"type":154,"value":1062},{"type":149,"tag":401,"props":5785,"children":5786},{"style":407},[5787],{"type":154,"value":5087},{"type":149,"tag":401,"props":5789,"children":5790},{"style":463},[5791],{"type":154,"value":466},{"type":149,"tag":401,"props":5793,"children":5794},{"style":651},[5795],{"type":154,"value":4065},{"type":149,"tag":401,"props":5797,"children":5798},{"style":407},[5799],{"type":154,"value":5100},{"type":149,"tag":401,"props":5801,"children":5802},{"style":463},[5803],{"type":154,"value":664},{"type":149,"tag":401,"props":5805,"children":5806},{"style":407},[5807],{"type":154,"value":5109},{"type":149,"tag":401,"props":5809,"children":5810},{"style":667},[5811],{"type":154,"value":872},{"type":149,"tag":401,"props":5813,"children":5814},{"style":407},[5815],{"type":154,"value":494},{"type":149,"tag":401,"props":5817,"children":5818},{"style":667},[5819],{"type":154,"value":827},{"type":149,"tag":401,"props":5821,"children":5822},{"style":407},[5823],{"type":154,"value":675},{"type":149,"tag":401,"props":5825,"children":5826},{"style":667},[5827],{"type":154,"value":5828},"out",{"type":149,"tag":401,"props":5830,"children":5831},{"style":407},[5832],{"type":154,"value":494},{"type":149,"tag":401,"props":5834,"children":5835},{"style":667},[5836],{"type":154,"value":872},{"type":149,"tag":401,"props":5838,"children":5839},{"style":407},[5840],{"type":154,"value":4090},{"type":149,"tag":401,"props":5842,"children":5844},{"class":5843,"line":4027},[403,414],[5845,5849,5853,5857,5861,5865],{"type":149,"tag":401,"props":5846,"children":5847},{"style":651},[5848],{"type":154,"value":5151},{"type":149,"tag":401,"props":5850,"children":5851},{"style":407},[5852],{"type":154,"value":659},{"type":149,"tag":401,"props":5854,"children":5855},{"style":667},[5856],{"type":154,"value":872},{"type":149,"tag":401,"props":5858,"children":5859},{"style":407},[5860],{"type":154,"value":494},{"type":149,"tag":401,"props":5862,"children":5863},{"style":667},[5864],{"type":154,"value":4159},{"type":149,"tag":401,"props":5866,"children":5867},{"style":407},[5868],{"type":154,"value":5172},{"type":149,"tag":401,"props":5870,"children":5872},{"class":5871,"line":4028},[403,414],[5873,5877,5881,5885],{"type":149,"tag":401,"props":5874,"children":5875},{"style":696},[5876],{"type":154,"value":5021},{"type":149,"tag":401,"props":5878,"children":5879},{"style":407},[5880],{"type":154,"value":5185},{"type":149,"tag":401,"props":5882,"children":5883},{"style":463},[5884],{"type":154,"value":5190},{"type":149,"tag":401,"props":5886,"children":5887},{"style":407},[5888],{"type":154,"value":5195},{"type":149,"tag":401,"props":5890,"children":5892},{"class":5891,"line":4029},[403,414],[5893,5897],{"type":149,"tag":401,"props":5894,"children":5895},{"style":651},[5896],{"type":154,"value":5204},{"type":149,"tag":401,"props":5898,"children":5899},{"style":407},[5900],{"type":154,"value":5209},{"type":149,"tag":401,"props":5902,"children":5904},{"class":5903,"line":4030},[403,414],[5905,5909],{"type":149,"tag":401,"props":5906,"children":5907},{"style":696},[5908],{"type":154,"value":5043},{"type":149,"tag":401,"props":5910,"children":5911},{"style":407},[5912],{"type":154,"value":5048},{"type":149,"tag":401,"props":5914,"children":5916},{"class":5915,"line":4031},[403,414],[5917],{"type":149,"tag":401,"props":5918,"children":5919},{"style":407},[5920],{"type":154,"value":5057},{"type":149,"tag":401,"props":5922,"children":5924},{"class":403,"line":5923},86,[5925],{"type":149,"tag":401,"props":5926,"children":5927},{"emptyLinePlaceholder":11},[5928],{"type":154,"value":3165},{"type":149,"tag":401,"props":5930,"children":5932},{"class":5931,"line":4032},[403,414],[5933],{"type":149,"tag":401,"props":5934,"children":5935},{"style":418},[5936],{"type":154,"value":5937},"    // Replace destination IP with clients' IP\n",{"type":149,"tag":401,"props":5939,"children":5941},{"class":5940,"line":4033},[403,414],[5942,5946,5950,5954,5958,5963,5967,5971],{"type":149,"tag":401,"props":5943,"children":5944},{"style":667},[5945],{"type":154,"value":5629},{"type":149,"tag":401,"props":5947,"children":5948},{"style":407},[5949],{"type":154,"value":494},{"type":149,"tag":401,"props":5951,"children":5952},{"style":667},[5953],{"type":154,"value":827},{"type":149,"tag":401,"props":5955,"children":5956},{"style":463},[5957],{"type":154,"value":814},{"type":149,"tag":401,"props":5959,"children":5960},{"style":667},[5961],{"type":154,"value":5962}," out",{"type":149,"tag":401,"props":5964,"children":5965},{"style":407},[5966],{"type":154,"value":494},{"type":149,"tag":401,"props":5968,"children":5969},{"style":667},[5970],{"type":154,"value":872},{"type":149,"tag":401,"props":5972,"children":5973},{"style":407},[5974],{"type":154,"value":2888},{"type":149,"tag":401,"props":5976,"children":5978},{"class":5977,"line":4034},[403,414],[5979],{"type":149,"tag":401,"props":5980,"children":5981},{"style":418},[5982],{"type":154,"value":5983},"    // Replace destination MAC with clients' MAC\n",{"type":149,"tag":401,"props":5985,"children":5987},{"class":5986,"line":4035},[403,414],[5988,5992,5996,6000,6004,6008,6012,6016,6020,6024],{"type":149,"tag":401,"props":5989,"children":5990},{"style":651},[5991],{"type":154,"value":5675},{"type":149,"tag":401,"props":5993,"children":5994},{"style":407},[5995],{"type":154,"value":659},{"type":149,"tag":401,"props":5997,"children":5998},{"style":667},[5999],{"type":154,"value":5684},{"type":149,"tag":401,"props":6001,"children":6002},{"style":407},[6003],{"type":154,"value":494},{"type":149,"tag":401,"props":6005,"children":6006},{"style":667},[6007],{"type":154,"value":5693},{"type":149,"tag":401,"props":6009,"children":6010},{"style":407},[6011],{"type":154,"value":675},{"type":149,"tag":401,"props":6013,"children":6014},{"style":667},[6015],{"type":154,"value":4113},{"type":149,"tag":401,"props":6017,"children":6018},{"style":407},[6019],{"type":154,"value":804},{"type":149,"tag":401,"props":6021,"children":6022},{"style":667},[6023],{"type":154,"value":5710},{"type":149,"tag":401,"props":6025,"children":6026},{"style":407},[6027],{"type":154,"value":5715},{"type":149,"tag":401,"props":6029,"children":6031},{"class":403,"line":6030},91,[6032],{"type":149,"tag":401,"props":6033,"children":6034},{"style":407},[6035],{"type":154,"value":1181},{"type":149,"tag":401,"props":6037,"children":6039},{"class":403,"line":6038},92,[6040],{"type":149,"tag":401,"props":6041,"children":6042},{"emptyLinePlaceholder":11},[6043],{"type":154,"value":3165},{"type":149,"tag":401,"props":6045,"children":6047},{"class":6046,"line":4036},[403,414],[6048],{"type":149,"tag":401,"props":6049,"children":6050},{"style":418},[6051],{"type":154,"value":6052},"  // Replace source IP with load balancers' IP\n",{"type":149,"tag":401,"props":6054,"children":6056},{"class":6055,"line":4037},[403,414],[6057,6062,6066,6070,6074],{"type":149,"tag":401,"props":6058,"children":6059},{"style":667},[6060],{"type":154,"value":6061},"  ip",{"type":149,"tag":401,"props":6063,"children":6064},{"style":407},[6065],{"type":154,"value":494},{"type":149,"tag":401,"props":6067,"children":6068},{"style":667},[6069],{"type":154,"value":1044},{"type":149,"tag":401,"props":6071,"children":6072},{"style":463},[6073],{"type":154,"value":814},{"type":149,"tag":401,"props":6075,"children":6076},{"style":407},[6077],{"type":154,"value":6078}," lb_ip;\n",{"type":149,"tag":401,"props":6080,"children":6082},{"class":6081,"line":4038},[403,414],[6083],{"type":149,"tag":401,"props":6084,"children":6085},{"style":418},[6086],{"type":154,"value":6087},"  // Replace source MAC with load balancers' MAC\n",{"type":149,"tag":401,"props":6089,"children":6091},{"class":6090,"line":4039},[403,414],[6092,6097,6101,6105,6109,6114,6118,6122,6126,6131],{"type":149,"tag":401,"props":6093,"children":6094},{"style":651},[6095],{"type":154,"value":6096},"  __builtin_memcpy",{"type":149,"tag":401,"props":6098,"children":6099},{"style":407},[6100],{"type":154,"value":659},{"type":149,"tag":401,"props":6102,"children":6103},{"style":667},[6104],{"type":154,"value":5684},{"type":149,"tag":401,"props":6106,"children":6107},{"style":407},[6108],{"type":154,"value":494},{"type":149,"tag":401,"props":6110,"children":6111},{"style":667},[6112],{"type":154,"value":6113},"h_source",{"type":149,"tag":401,"props":6115,"children":6116},{"style":407},[6117],{"type":154,"value":675},{"type":149,"tag":401,"props":6119,"children":6120},{"style":667},[6121],{"type":154,"value":4113},{"type":149,"tag":401,"props":6123,"children":6124},{"style":407},[6125],{"type":154,"value":804},{"type":149,"tag":401,"props":6127,"children":6128},{"style":667},[6129],{"type":154,"value":6130},"smac",{"type":149,"tag":401,"props":6132,"children":6133},{"style":407},[6134],{"type":154,"value":5715},{"type":149,"tag":401,"props":6136,"children":6138},{"class":403,"line":6137},97,[6139],{"type":149,"tag":401,"props":6140,"children":6141},{"style":407},[6142],{"type":154,"value":410},{"type":149,"tag":211,"props":6144,"children":6145},{"kind":2584},[6146,6158,6170,6193,6283,6294,6316,6388,6414,6464,6469,6598],{"type":149,"tag":150,"props":6147,"children":6148},{},[6149,6151,6156],{"type":154,"value":6150}," The only assumption when using ",{"type":149,"tag":397,"props":6152,"children":6154},{"className":6153},[],[6155],{"type":154,"value":3896},{"type":154,"value":6157}," is that the necessary routing information already exists in the kernel tables.",{"type":149,"tag":150,"props":6159,"children":6160},{},[6161,6163,6168],{"type":154,"value":6162},"If you check the kernels routing table, youll see the route is indeed present (in the ",{"type":149,"tag":397,"props":6164,"children":6166},{"className":6165},[],[6167],{"type":154,"value":37},{"type":154,"value":6169}," tab):",{"type":149,"tag":367,"props":6171,"children":6173},{"className":3811,"code":6172,"language":3813,"meta":394,"style":394},"ip route show\n",[6174],{"type":149,"tag":397,"props":6175,"children":6176},{"__ignoreMap":394},[6177],{"type":149,"tag":401,"props":6178,"children":6179},{"class":403,"line":97},[6180,6184,6188],{"type":149,"tag":401,"props":6181,"children":6182},{"style":651},[6183],{"type":154,"value":872},{"type":149,"tag":401,"props":6185,"children":6186},{"style":730},[6187],{"type":154,"value":3829},{"type":149,"tag":401,"props":6189,"children":6190},{"style":730},[6191],{"type":154,"value":6192}," show\n",{"type":149,"tag":367,"props":6194,"children":6196},{"className":3811,"code":6195,"language":3813,"meta":394,"style":394},"default via 192.168.178.2 dev eth0 # If the destination IP address doesn't match the local subnet (or any other specific route), it gets sent here\n192.168.178.0/24 dev eth0 proto kernel scope link src 192.168.178.10 # Routes any destination IP in 192.168.178.0/24 through the eth0 interface\n",[6197],{"type":149,"tag":397,"props":6198,"children":6199},{"__ignoreMap":394},[6200,6233],{"type":149,"tag":401,"props":6201,"children":6202},{"class":403,"line":97},[6203,6208,6213,6218,6223,6228],{"type":149,"tag":401,"props":6204,"children":6205},{"style":651},[6206],{"type":154,"value":6207},"default",{"type":149,"tag":401,"props":6209,"children":6210},{"style":730},[6211],{"type":154,"value":6212}," via",{"type":149,"tag":401,"props":6214,"children":6215},{"style":2880},[6216],{"type":154,"value":6217}," 192.168.178.2",{"type":149,"tag":401,"props":6219,"children":6220},{"style":730},[6221],{"type":154,"value":6222}," dev",{"type":149,"tag":401,"props":6224,"children":6225},{"style":730},[6226],{"type":154,"value":6227}," eth0",{"type":149,"tag":401,"props":6229,"children":6230},{"style":418},[6231],{"type":154,"value":6232}," # If the destination IP address doesn't match the local subnet (or any other specific route), it gets sent here\n",{"type":149,"tag":401,"props":6234,"children":6235},{"class":403,"line":373},[6236,6240,6244,6248,6253,6258,6263,6268,6273,6278],{"type":149,"tag":401,"props":6237,"children":6238},{"style":651},[6239],{"type":154,"value":74},{"type":149,"tag":401,"props":6241,"children":6242},{"style":730},[6243],{"type":154,"value":6222},{"type":149,"tag":401,"props":6245,"children":6246},{"style":730},[6247],{"type":154,"value":6227},{"type":149,"tag":401,"props":6249,"children":6250},{"style":730},[6251],{"type":154,"value":6252}," proto",{"type":149,"tag":401,"props":6254,"children":6255},{"style":730},[6256],{"type":154,"value":6257}," kernel",{"type":149,"tag":401,"props":6259,"children":6260},{"style":730},[6261],{"type":154,"value":6262}," scope",{"type":149,"tag":401,"props":6264,"children":6265},{"style":730},[6266],{"type":154,"value":6267}," link",{"type":149,"tag":401,"props":6269,"children":6270},{"style":730},[6271],{"type":154,"value":6272}," src",{"type":149,"tag":401,"props":6274,"children":6275},{"style":2880},[6276],{"type":154,"value":6277}," 192.168.178.10",{"type":149,"tag":401,"props":6279,"children":6280},{"style":418},[6281],{"type":154,"value":6282}," # Routes any destination IP in 192.168.178.0/24 through the eth0 interface\n",{"type":149,"tag":150,"props":6284,"children":6285},{},[6286,6288,6293],{"type":154,"value":6287},"However, thats not necessarily true for the ARP table (or NDP for IPv6). If we inspect it (in the ",{"type":149,"tag":397,"props":6289,"children":6291},{"className":6290},[],[6292],{"type":154,"value":37},{"type":154,"value":6169},{"type":149,"tag":367,"props":6295,"children":6297},{"className":3811,"code":6296,"language":3813,"meta":394,"style":394},"ip neigh show\n",[6298],{"type":149,"tag":397,"props":6299,"children":6300},{"__ignoreMap":394},[6301],{"type":149,"tag":401,"props":6302,"children":6303},{"class":403,"line":97},[6304,6308,6312],{"type":149,"tag":401,"props":6305,"children":6306},{"style":651},[6307],{"type":154,"value":872},{"type":149,"tag":401,"props":6309,"children":6310},{"style":730},[6311],{"type":154,"value":3851},{"type":149,"tag":401,"props":6313,"children":6314},{"style":730},[6315],{"type":154,"value":6192},{"type":149,"tag":367,"props":6317,"children":6319},{"className":3811,"code":6318,"language":3813,"meta":394,"style":394},"192.168.178.1 dev eth0 lladdr 26:d7:2a:71:94:c4 REACHABLE \n192.168.178.2 dev eth0 lladdr ce:4a:a3:20:23:a2 REACHABLE\n",[6320],{"type":149,"tag":397,"props":6321,"children":6322},{"__ignoreMap":394},[6323,6359],{"type":149,"tag":401,"props":6324,"children":6325},{"class":403,"line":97},[6326,6331,6335,6339,6344,6349,6354],{"type":149,"tag":401,"props":6327,"children":6328},{"style":651},[6329],{"type":154,"value":6330},"192.168.178.1",{"type":149,"tag":401,"props":6332,"children":6333},{"style":730},[6334],{"type":154,"value":6222},{"type":149,"tag":401,"props":6336,"children":6337},{"style":730},[6338],{"type":154,"value":6227},{"type":149,"tag":401,"props":6340,"children":6341},{"style":730},[6342],{"type":154,"value":6343}," lladdr",{"type":149,"tag":401,"props":6345,"children":6346},{"style":730},[6347],{"type":154,"value":6348}," 26:d7:2a:71:94:c4",{"type":149,"tag":401,"props":6350,"children":6351},{"style":730},[6352],{"type":154,"value":6353}," REACHABLE",{"type":149,"tag":401,"props":6355,"children":6356},{"style":407},[6357],{"type":154,"value":6358}," \n",{"type":149,"tag":401,"props":6360,"children":6361},{"class":403,"line":373},[6362,6366,6370,6374,6378,6383],{"type":149,"tag":401,"props":6363,"children":6364},{"style":651},[6365],{"type":154,"value":130},{"type":149,"tag":401,"props":6367,"children":6368},{"style":730},[6369],{"type":154,"value":6222},{"type":149,"tag":401,"props":6371,"children":6372},{"style":730},[6373],{"type":154,"value":6227},{"type":149,"tag":401,"props":6375,"children":6376},{"style":730},[6377],{"type":154,"value":6343},{"type":149,"tag":401,"props":6379,"children":6380},{"style":730},[6381],{"type":154,"value":6382}," ce:4a:a3:20:23:a2",{"type":149,"tag":401,"props":6384,"children":6385},{"style":730},[6386],{"type":154,"value":6387}," REACHABLE\n",{"type":149,"tag":150,"props":6389,"children":6390},{},[6391,6393,6399,6400,6406,6408,6413],{"type":154,"value":6392},"youll notice that entries for our backend nodes (",{"type":149,"tag":397,"props":6394,"children":6396},{"className":6395},[],[6397],{"type":154,"value":6398},"backend-1",{"type":154,"value":675},{"type":149,"tag":397,"props":6401,"children":6403},{"className":6402},[],[6404],{"type":154,"value":6405},"backend-2",{"type":154,"value":6407}," tab) are missing. But we can easily populate it using  (in the ",{"type":149,"tag":397,"props":6409,"children":6411},{"className":6410},[],[6412],{"type":154,"value":37},{"type":154,"value":6169},{"type":149,"tag":367,"props":6415,"children":6417},{"className":3811,"code":6416,"language":3813,"meta":394,"style":394},"sudo ping -c1 192.168.178.11\nsudo ping -c1 192.168.178.12\n",[6418],{"type":149,"tag":397,"props":6419,"children":6420},{"__ignoreMap":394},[6421,6444],{"type":149,"tag":401,"props":6422,"children":6423},{"class":403,"line":97},[6424,6429,6434,6439],{"type":149,"tag":401,"props":6425,"children":6426},{"style":651},[6427],{"type":154,"value":6428},"sudo",{"type":149,"tag":401,"props":6430,"children":6431},{"style":730},[6432],{"type":154,"value":6433}," ping",{"type":149,"tag":401,"props":6435,"children":6436},{"style":730},[6437],{"type":154,"value":6438}," -c1",{"type":149,"tag":401,"props":6440,"children":6441},{"style":2880},[6442],{"type":154,"value":6443}," 192.168.178.11\n",{"type":149,"tag":401,"props":6445,"children":6446},{"class":403,"line":373},[6447,6451,6455,6459],{"type":149,"tag":401,"props":6448,"children":6449},{"style":651},[6450],{"type":154,"value":6428},{"type":149,"tag":401,"props":6452,"children":6453},{"style":730},[6454],{"type":154,"value":6433},{"type":149,"tag":401,"props":6456,"children":6457},{"style":730},[6458],{"type":154,"value":6438},{"type":149,"tag":401,"props":6460,"children":6461},{"style":2880},[6462],{"type":154,"value":6463}," 192.168.178.12\n",{"type":149,"tag":150,"props":6465,"children":6466},{},[6467],{"type":154,"value":6468},"Now you should see:",{"type":149,"tag":367,"props":6470,"children":6472},{"className":3811,"code":6471,"language":3813,"meta":394,"style":394},"192.168.178.1 dev eth0 lladdr 26:d7:2a:71:94:c4 REACHABLE \n192.168.178.2 dev eth0 lladdr ce:4a:a3:20:23:a2 REACHABLE \n192.168.178.11 dev eth0 lladdr 32:da:f7:c0:34:04 REACHABLE \n192.168.178.12 dev eth0 lladdr ba:ba:f6:ea:11:34 REACHABLE\n",[6473],{"type":149,"tag":397,"props":6474,"children":6475},{"__ignoreMap":394},[6476,6507,6538,6570],{"type":149,"tag":401,"props":6477,"children":6478},{"class":403,"line":97},[6479,6483,6487,6491,6495,6499,6503],{"type":149,"tag":401,"props":6480,"children":6481},{"style":651},[6482],{"type":154,"value":6330},{"type":149,"tag":401,"props":6484,"children":6485},{"style":730},[6486],{"type":154,"value":6222},{"type":149,"tag":401,"props":6488,"children":6489},{"style":730},[6490],{"type":154,"value":6227},{"type":149,"tag":401,"props":6492,"children":6493},{"style":730},[6494],{"type":154,"value":6343},{"type":149,"tag":401,"props":6496,"children":6497},{"style":730},[6498],{"type":154,"value":6348},{"type":149,"tag":401,"props":6500,"children":6501},{"style":730},[6502],{"type":154,"value":6353},{"type":149,"tag":401,"props":6504,"children":6505},{"style":407},[6506],{"type":154,"value":6358},{"type":149,"tag":401,"props":6508,"children":6509},{"class":403,"line":373},[6510,6514,6518,6522,6526,6530,6534],{"type":149,"tag":401,"props":6511,"children":6512},{"style":651},[6513],{"type":154,"value":130},{"type":149,"tag":401,"props":6515,"children":6516},{"style":730},[6517],{"type":154,"value":6222},{"type":149,"tag":401,"props":6519,"children":6520},{"style":730},[6521],{"type":154,"value":6227},{"type":149,"tag":401,"props":6523,"children":6524},{"style":730},[6525],{"type":154,"value":6343},{"type":149,"tag":401,"props":6527,"children":6528},{"style":730},[6529],{"type":154,"value":6382},{"type":149,"tag":401,"props":6531,"children":6532},{"style":730},[6533],{"type":154,"value":6353},{"type":149,"tag":401,"props":6535,"children":6536},{"style":407},[6537],{"type":154,"value":6358},{"type":149,"tag":401,"props":6539,"children":6540},{"class":403,"line":374},[6541,6545,6549,6553,6557,6562,6566],{"type":149,"tag":401,"props":6542,"children":6543},{"style":651},[6544],{"type":154,"value":108},{"type":149,"tag":401,"props":6546,"children":6547},{"style":730},[6548],{"type":154,"value":6222},{"type":149,"tag":401,"props":6550,"children":6551},{"style":730},[6552],{"type":154,"value":6227},{"type":149,"tag":401,"props":6554,"children":6555},{"style":730},[6556],{"type":154,"value":6343},{"type":149,"tag":401,"props":6558,"children":6559},{"style":730},[6560],{"type":154,"value":6561}," 32:da:f7:c0:34:04",{"type":149,"tag":401,"props":6563,"children":6564},{"style":730},[6565],{"type":154,"value":6353},{"type":149,"tag":401,"props":6567,"children":6568},{"style":407},[6569],{"type":154,"value":6358},{"type":149,"tag":401,"props":6571,"children":6572},{"class":403,"line":375},[6573,6577,6581,6585,6589,6594],{"type":149,"tag":401,"props":6574,"children":6575},{"style":651},[6576],{"type":154,"value":119},{"type":149,"tag":401,"props":6578,"children":6579},{"style":730},[6580],{"type":154,"value":6222},{"type":149,"tag":401,"props":6582,"children":6583},{"style":730},[6584],{"type":154,"value":6227},{"type":149,"tag":401,"props":6586,"children":6587},{"style":730},[6588],{"type":154,"value":6343},{"type":149,"tag":401,"props":6590,"children":6591},{"style":730},[6592],{"type":154,"value":6593}," ba:ba:f6:ea:11:34",{"type":149,"tag":401,"props":6595,"children":6596},{"style":730},[6597],{"type":154,"value":6387},{"type":149,"tag":150,"props":6599,"children":6600},{},[6601],{"type":154,"value":6602},"In production setups, this isnt really an issue, since the load balancer continuously performs health checks against the backends and keeps these tables updated.",{"type":149,"tag":240,"props":6604,"children":6606},{"id":6605},"running-the-load-balancer",[6607],{"type":154,"value":6608},"Running the Load Balancer",{"type":149,"tag":150,"props":6610,"children":6611},{},[6612],{"type":154,"value":6613},"This playground has a network topology with five separate machines on two different networks:",{"type":149,"tag":292,"props":6615,"children":6616},{},[6617,6633,6648,6663,6678],{"type":149,"tag":296,"props":6618,"children":6619},{},[6620,6625,6627],{"type":149,"tag":397,"props":6621,"children":6623},{"className":6622},[],[6624],{"type":154,"value":37},{"type":154,"value":6626}," in network ",{"type":149,"tag":397,"props":6628,"children":6630},{"className":6629},[],[6631],{"type":154,"value":6632},"192.168.178.10/24",{"type":149,"tag":296,"props":6634,"children":6635},{},[6636,6641,6642],{"type":149,"tag":397,"props":6637,"children":6639},{"className":6638},[],[6640],{"type":154,"value":42},{"type":154,"value":6626},{"type":149,"tag":397,"props":6643,"children":6645},{"className":6644},[],[6646],{"type":154,"value":6647},"192.168.178.11/24",{"type":149,"tag":296,"props":6649,"children":6650},{},[6651,6656,6657],{"type":149,"tag":397,"props":6652,"children":6654},{"className":6653},[],[6655],{"type":154,"value":45},{"type":154,"value":6626},{"type":149,"tag":397,"props":6658,"children":6660},{"className":6659},[],[6661],{"type":154,"value":6662},"192.168.178.12/24",{"type":149,"tag":296,"props":6664,"children":6665},{},[6666,6671,6672],{"type":149,"tag":397,"props":6667,"children":6669},{"className":6668},[],[6670],{"type":154,"value":51},{"type":154,"value":6626},{"type":149,"tag":397,"props":6673,"children":6675},{"className":6674},[],[6676],{"type":154,"value":6677},"10.0.0.20/16",{"type":149,"tag":296,"props":6679,"children":6680},{},[6681,6686,6688,6694,6695],{"type":149,"tag":397,"props":6682,"children":6684},{"className":6683},[],[6685],{"type":154,"value":48},{"type":154,"value":6687}," between networks ",{"type":149,"tag":397,"props":6689,"children":6691},{"className":6690},[],[6692],{"type":154,"value":6693},"192.168.178.2/24",{"type":154,"value":166},{"type":149,"tag":397,"props":6696,"children":6698},{"className":6697},[],[6699],{"type":154,"value":6700},"10.0.0.2/16",{"type":149,"tag":204,"props":6702,"children":6705},{":alt":6703,":src":6704},"XDP NAT Load Balancing Playground","/content/files/tutorials/xdp-load-balancer-700a1d74/__static__/nat-playground.png",[],{"type":149,"tag":150,"props":6707,"children":6708},{},[6709,6711,6716],{"type":154,"value":6710},"Before we can actually run our load balancer, we also need to enable packet forwarding between network interfaces (in the ",{"type":149,"tag":397,"props":6712,"children":6714},{"className":6713},[],[6715],{"type":154,"value":37},{"type":154,"value":6169},{"type":149,"tag":367,"props":6718,"children":6720},{"className":3811,"code":6719,"language":3813,"meta":394,"style":394},"sudo sysctl -w net.ipv4.ip_forward=1\n",[6721],{"type":149,"tag":397,"props":6722,"children":6723},{"__ignoreMap":394},[6724],{"type":149,"tag":401,"props":6725,"children":6726},{"class":403,"line":97},[6727,6731,6736,6741,6746],{"type":149,"tag":401,"props":6728,"children":6729},{"style":651},[6730],{"type":154,"value":6428},{"type":149,"tag":401,"props":6732,"children":6733},{"style":730},[6734],{"type":154,"value":6735}," sysctl",{"type":149,"tag":401,"props":6737,"children":6738},{"style":730},[6739],{"type":154,"value":6740}," -w",{"type":149,"tag":401,"props":6742,"children":6743},{"style":730},[6744],{"type":154,"value":6745}," net.ipv4.ip_forward=",{"type":149,"tag":401,"props":6747,"children":6748},{"style":2880},[6749],{"type":154,"value":6750},"1\n",{"type":149,"tag":150,"props":6752,"children":6753},{},[6754],{"type":154,"value":6755},"This allows the kernel to route packets it receives on one interface out through another  a requirement for the load balancer to forward client traffic to backend nodes.",{"type":149,"tag":211,"props":6757,"children":6758},{"kind":2584},[6759,6770,6814],{"type":149,"tag":150,"props":6760,"children":6761},{},[6762,6764,6769],{"type":154,"value":6763}," Make sure you've populated the ARP table with backends information using (in the ",{"type":149,"tag":397,"props":6765,"children":6767},{"className":6766},[],[6768],{"type":154,"value":37},{"type":154,"value":6169},{"type":149,"tag":367,"props":6771,"children":6772},{"className":3811,"code":6416,"language":3813,"meta":394,"style":394},[6773],{"type":149,"tag":397,"props":6774,"children":6775},{"__ignoreMap":394},[6776,6795],{"type":149,"tag":401,"props":6777,"children":6778},{"class":403,"line":97},[6779,6783,6787,6791],{"type":149,"tag":401,"props":6780,"children":6781},{"style":651},[6782],{"type":154,"value":6428},{"type":149,"tag":401,"props":6784,"children":6785},{"style":730},[6786],{"type":154,"value":6433},{"type":149,"tag":401,"props":6788,"children":6789},{"style":730},[6790],{"type":154,"value":6438},{"type":149,"tag":401,"props":6792,"children":6793},{"style":2880},[6794],{"type":154,"value":6443},{"type":149,"tag":401,"props":6796,"children":6797},{"class":403,"line":373},[6798,6802,6806,6810],{"type":149,"tag":401,"props":6799,"children":6800},{"style":651},[6801],{"type":154,"value":6428},{"type":149,"tag":401,"props":6803,"children":6804},{"style":730},[6805],{"type":154,"value":6433},{"type":149,"tag":401,"props":6807,"children":6808},{"style":730},[6809],{"type":154,"value":6438},{"type":149,"tag":401,"props":6811,"children":6812},{"style":2880},[6813],{"type":154,"value":6463},{"type":149,"tag":150,"props":6815,"children":6816},{},[6817],{"type":154,"value":6818},"See the previous section above for an explanation of why this is required.",{"type":149,"tag":150,"props":6820,"children":6821},{},[6822,6824,6829,6831,6837],{"type":154,"value":6823},"Now build and run the XDP Load Balancer in the ",{"type":149,"tag":397,"props":6825,"children":6827},{"className":6826},[],[6828],{"type":154,"value":37},{"type":154,"value":6830}," tab (inside the ",{"type":149,"tag":397,"props":6832,"children":6834},{"className":6833},[],[6835],{"type":154,"value":6836},"/lab",{"type":154,"value":6838}," directory), using:",{"type":149,"tag":367,"props":6840,"children":6842},{"className":3811,"code":6841,"language":3813,"meta":394,"style":394},"go generate\ngo build\nsudo ./lb -i eth0 -backends 192.168.178.11,192.168.178.12\n",[6843],{"type":149,"tag":397,"props":6844,"children":6845},{"__ignoreMap":394},[6846,6859,6871],{"type":149,"tag":401,"props":6847,"children":6848},{"class":403,"line":97},[6849,6854],{"type":149,"tag":401,"props":6850,"children":6851},{"style":651},[6852],{"type":154,"value":6853},"go",{"type":149,"tag":401,"props":6855,"children":6856},{"style":730},[6857],{"type":154,"value":6858}," generate\n",{"type":149,"tag":401,"props":6860,"children":6861},{"class":403,"line":373},[6862,6866],{"type":149,"tag":401,"props":6863,"children":6864},{"style":651},[6865],{"type":154,"value":6853},{"type":149,"tag":401,"props":6867,"children":6868},{"style":730},[6869],{"type":154,"value":6870}," build\n",{"type":149,"tag":401,"props":6872,"children":6873},{"class":403,"line":374},[6874,6878,6883,6888,6892,6897],{"type":149,"tag":401,"props":6875,"children":6876},{"style":651},[6877],{"type":154,"value":6428},{"type":149,"tag":401,"props":6879,"children":6880},{"style":730},[6881],{"type":154,"value":6882}," ./lb",{"type":149,"tag":401,"props":6884,"children":6885},{"style":730},[6886],{"type":154,"value":6887}," -i",{"type":149,"tag":401,"props":6889,"children":6890},{"style":730},[6891],{"type":154,"value":6227},{"type":149,"tag":401,"props":6893,"children":6894},{"style":730},[6895],{"type":154,"value":6896}," -backends",{"type":149,"tag":401,"props":6898,"children":6899},{"style":730},[6900],{"type":154,"value":6901}," 192.168.178.11,192.168.178.12\n",{"type":149,"tag":1191,"props":6903,"children":6905},{":summary":6904},"What are these input parameters?",[6906,6911],{"type":149,"tag":150,"props":6907,"children":6908},{},[6909],{"type":154,"value":6910},"In short:",{"type":149,"tag":292,"props":6912,"children":6913},{},[6914,6925],{"type":149,"tag":296,"props":6915,"children":6916},{},[6917,6923],{"type":149,"tag":397,"props":6918,"children":6920},{"className":6919},[],[6921],{"type":154,"value":6922},"i",{"type":154,"value":6924}," expects the network interface on which this XDP Load Balancer program will run",{"type":149,"tag":296,"props":6926,"children":6927},{},[6928,6933],{"type":149,"tag":397,"props":6929,"children":6931},{"className":6930},[],[6932],{"type":154,"value":3740},{"type":154,"value":6934}," The list of backend IPs in this playground (you need to provide exactly two backends, due to the simplification described above for simple hashing)",{"type":149,"tag":150,"props":6936,"children":6937},{},[6938,6940,6945,6946,6951],{"type":154,"value":6939},"Now run an HTTP server on every backend node in tabs ",{"type":149,"tag":397,"props":6941,"children":6943},{"className":6942},[],[6944],{"type":154,"value":6398},{"type":154,"value":675},{"type":149,"tag":397,"props":6947,"children":6949},{"className":6948},[],[6950],{"type":154,"value":6405},{"type":154,"value":6952},", using:",{"type":149,"tag":367,"props":6954,"children":6956},{"className":3811,"code":6955,"language":3813,"meta":394,"style":394},"python3 -m http.server 8000\n",[6957],{"type":149,"tag":397,"props":6958,"children":6959},{"__ignoreMap":394},[6960],{"type":149,"tag":401,"props":6961,"children":6962},{"class":403,"line":97},[6963,6968,6973,6978],{"type":149,"tag":401,"props":6964,"children":6965},{"style":651},[6966],{"type":154,"value":6967},"python3",{"type":149,"tag":401,"props":6969,"children":6970},{"style":730},[6971],{"type":154,"value":6972}," -m",{"type":149,"tag":401,"props":6974,"children":6975},{"style":730},[6976],{"type":154,"value":6977}," http.server",{"type":149,"tag":401,"props":6979,"children":6980},{"style":2880},[6981],{"type":154,"value":6982}," 8000\n",{"type":149,"tag":150,"props":6984,"children":6985},{},[6986,6988,6993],{"type":154,"value":6987},"And query the Load Balancers node IP from the ",{"type":149,"tag":397,"props":6989,"children":6991},{"className":6990},[],[6992],{"type":154,"value":51},{"type":154,"value":6994}," tab, using:",{"type":149,"tag":367,"props":6996,"children":6998},{"className":3811,"code":6997,"language":3813,"meta":394,"style":394},"curl http://192.168.178.10:8000\n",[6999],{"type":149,"tag":397,"props":7000,"children":7001},{"__ignoreMap":394},[7002],{"type":149,"tag":401,"props":7003,"children":7004},{"class":403,"line":97},[7005,7010],{"type":149,"tag":401,"props":7006,"children":7007},{"style":651},[7008],{"type":154,"value":7009},"curl",{"type":149,"tag":401,"props":7011,"children":7012},{"style":730},[7013],{"type":154,"value":7014}," http://192.168.178.10:8000\n",{"type":149,"tag":150,"props":7016,"children":7017},{},[7018,7020,7025],{"type":154,"value":7019},"and confirm you see the requests indeed get routed through the load balancer node to one of the backends, by inspect eBPF load balancer logs (in the ",{"type":149,"tag":397,"props":7021,"children":7023},{"className":7022},[],[7024],{"type":154,"value":37},{"type":154,"value":6169},{"type":149,"tag":367,"props":7027,"children":7029},{"className":3811,"code":7028,"language":3813,"meta":394,"style":394},"sudo bpftool prog trace\n",[7030],{"type":149,"tag":397,"props":7031,"children":7032},{"__ignoreMap":394},[7033],{"type":149,"tag":401,"props":7034,"children":7035},{"class":403,"line":97},[7036,7040,7045,7050],{"type":149,"tag":401,"props":7037,"children":7038},{"style":651},[7039],{"type":154,"value":6428},{"type":149,"tag":401,"props":7041,"children":7042},{"style":730},[7043],{"type":154,"value":7044}," bpftool",{"type":149,"tag":401,"props":7046,"children":7047},{"style":730},[7048],{"type":154,"value":7049}," prog",{"type":149,"tag":401,"props":7051,"children":7052},{"style":730},[7053],{"type":154,"value":7054}," trace\n",{"type":149,"tag":204,"props":7056,"children":7059},{":alt":7057,":src":7058},"XDP NAT Load Balancing Playground Solution","/content/files/tutorials/xdp-load-balancer-700a1d74/__static__/nat-playground-solution.png",[],{"type":149,"tag":150,"props":7061,"children":7062},{},[7063],{"type":154,"value":7064},"Congrats - you've came to the end of this tutorial ",{"type":149,"tag":7066,"props":7067,"children":7068},"hr",{},[],{"type":149,"tag":150,"props":7070,"children":7071},{},[7072],{"type":154,"value":7073},"Before I let you go, some final remarks.",{"type":149,"tag":150,"props":7075,"children":7076},{},[7077,7079,7085],{"type":154,"value":7078},"The nice thing about this setup is that it also works across different networks  the client, load balancer, and backend dont need to be on the same subnet. This is possible because ",{"type":149,"tag":397,"props":7080,"children":7082},{"className":7081},[],[7083],{"type":154,"value":7084},"bpf_fib_lookup",{"type":154,"value":7086}," can retrieve the MAC address from a gateway or router when the backend resides on a different subnet.",{"type":149,"tag":150,"props":7088,"children":7089},{},[7090],{"type":154,"value":7091},"Another benefit is that both the request and response pass through the load balancer, making it easier to apply custom network policies or perform additional inspection in both directions.",{"type":149,"tag":150,"props":7093,"children":7094},{},[7095],{"type":149,"tag":224,"props":7096,"children":7097},{},[7098],{"type":154,"value":7099},"However, this approach isnt always optimal.",{"type":149,"tag":150,"props":7101,"children":7102},{},[7103],{"type":154,"value":7104},"Since the load balancer handles traffic in both directions, it consumes more resources and can become a bottleneck. Just think about it  the backend could simply respond directly to the client without routing the response back through the load balancer.",{"type":149,"tag":150,"props":7106,"children":7107},{},[7108],{"type":154,"value":7109},"Another drawback is that the backend isnt really aware of which client made the request. If you check the HTTP server logs, it appears as if the load balancer itself made the request (the IP at the beginning of the line).",{"type":149,"tag":367,"props":7111,"children":7113},{"className":3811,"code":7112,"language":3813,"meta":394,"style":394},"192.168.178.10 - - [05/Jan/2026 02:06:07] \"GET / HTTP/1.1\" 200 -\n",[7114],{"type":149,"tag":397,"props":7115,"children":7116},{"__ignoreMap":394},[7117],{"type":149,"tag":401,"props":7118,"children":7119},{"class":403,"line":97},[7120,7124,7129,7133,7138,7143,7148,7153],{"type":149,"tag":401,"props":7121,"children":7122},{"style":651},[7123],{"type":154,"value":95},{"type":149,"tag":401,"props":7125,"children":7126},{"style":730},[7127],{"type":154,"value":7128}," -",{"type":149,"tag":401,"props":7130,"children":7131},{"style":730},[7132],{"type":154,"value":7128},{"type":149,"tag":401,"props":7134,"children":7135},{"style":407},[7136],{"type":154,"value":7137}," [05/Jan/2026 ",{"type":149,"tag":401,"props":7139,"children":7140},{"style":730},[7141],{"type":154,"value":7142},"02:06:07]",{"type":149,"tag":401,"props":7144,"children":7145},{"style":730},[7146],{"type":154,"value":7147}," \"GET / HTTP/1.1\"",{"type":149,"tag":401,"props":7149,"children":7150},{"style":2880},[7151],{"type":154,"value":7152}," 200",{"type":149,"tag":401,"props":7154,"children":7155},{"style":730},[7156],{"type":154,"value":7157}," -\n",{"type":149,"tag":150,"props":7159,"children":7160},{},[7161],{"type":154,"value":7162},"In the next tutorial, well address these shortcomings using XDP Layer 4 DSR (Direct Server Return) load balancing.",{"type":149,"tag":7164,"props":7165,"children":7166},"style",{},[7167],{"type":154,"value":7168},"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}",["Reactive",35],{"title":394,"searchDepth":373,"depth":373,"links":7171},[7172,7173,7174,7175],{"id":242,"depth":373,"text":245},{"id":2611,"depth":373,"text":2614},{"id":3763,"depth":373,"text":3766},{"id":6605,"depth":373,"text":6608},["Reactive",7177],{},["Reactive",7179],{},["Reactive",7181],{},"#xdp-load-balancer-700a1d74-server",{"left":40,"top":40,"width":391,"height":391,"rotate":40,"vFlip":7184,"hFlip":7184,"body":7185},false,"\u003Cpath fill=\"currentColor\" d=\"M6 18v-5h1v4h4v1zm11-7V7h-4V6h5v5z\"/>",{"left":40,"top":40,"width":7187,"height":7187,"rotate":40,"vFlip":7184,"hFlip":7184,"body":7188},256,"\u003Cpath fill=\"currentColor\" d=\"M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z\"/>",["Reactive",7190],{"$scurrentUser":7191,"$salerts":7195,"$scontentToggle":7196,"$ssite-config":7197},{"id":7192,"anonymous":11,"effectiveTier":7193,"hasEmailSubscription":7184},"697b5f64cc8f8f56faac74e1",{"name":7194},"free",[],{"/tutorials/xdp-load-balancer-700a1d74":11},{"_priority":7198,"env":7201,"name":7202,"url":7203},{"name":7199,"env":7200,"url":40},-3,-15,"production","iximiuz Labs","https://labs.iximiuz.com",["Set"],["ShallowReactive",7206],{"tutorial-page-tutorial-xdp-load-balancer-700a1d74":-1,"content-tutorial-xdp-load-balancer-700a1d74-v1767696312484":-1,"tutorial-page-play-none":-1,"i-material-symbols-light:expand-content":-1,"i-ph:copy":-1},"/tutorials/xdp-load-balancer-700a1d74"]</script></body></html>